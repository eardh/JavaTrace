# å…±äº«æ¨¡å‹ä¹‹ä¸å¯å˜

- ä¸å¯å˜ç±»çš„ä½¿ç”¨
- ä¸å¯å˜ç±»è®¾è®¡
- æ— çŠ¶æ€ç±»è®¾è®¡



## 1. æ—¥æœŸè½¬æ¢çš„é—®é¢˜

### 1. é—®é¢˜æå‡º

ä¸‹é¢çš„ä»£ç åœ¨è¿è¡Œæ—¶ï¼Œç”±äº SimpleDateFormat ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„

```java
SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
for (int i = 0; i < 10; i++) {
    new Thread(() -> {
        try {
            log.debug("{}", sdf.parse("1951-04-21"));
        } catch (Exception e) {
            log.error("{}", e);
        }
    }).start();
}
```

æœ‰å¾ˆå¤§å‡ ç‡å‡ºç° java.lang.NumberFormatException æˆ–è€…å‡ºç°ä¸æ­£ç¡®çš„æ—¥æœŸè§£æç»“æœï¼Œä¾‹å¦‚ï¼š

```java
java.lang.NumberFormatException: empty String 
 		at sun.misc.FloatingDecimal.readJavaFormatString(FloatingDecimal.java:1842) 
 		at sun.misc.FloatingDecimal.parseDouble(FloatingDecimal.java:110) 
 		at java.lang.Double.parseDouble(Double.java:538) 
 		at java.text.DigitList.getDouble(DigitList.java:169) 
 		at java.text.DecimalFormat.parse(DecimalFormat.java:2089) 
 		at java.text.SimpleDateFormat.subParse(SimpleDateFormat.java:2162) 
 		at java.text.SimpleDateFormat.parse(SimpleDateFormat.java:1514) 
 		at java.text.DateFormat.parse(DateFormat.java:364) 
 		at cn.itcast.n7.TestDateParse.lambda$test1$0(TestDateParse.java:18) 
 		at java.lang.Thread.run(Thread.java:748) 
19:10:40.857 [Thread-8] c.TestDateParse - Sat Apr 21 00:00:00 CST 1951
```



### 2. æ€è·¯ - åŒæ­¥é”

è¿™æ ·è™½èƒ½è§£å†³é—®é¢˜ï¼Œä½†å¸¦æ¥çš„æ˜¯æ€§èƒ½ä¸Šçš„æŸå¤±ï¼Œå¹¶ä¸ç®—å¾ˆå¥½ï¼š

```java
SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
for (int i = 0; i < 50; i++) {
    new Thread(() -> {
        synchronized (sdf) {
            try {
                log.debug("{}", sdf.parse("1951-04-21"));
            } catch (Exception e) {
                log.error("{}", e);
            }
        }
    }).start();
}
```



### 3. æ€è·¯ - ä¸å¯å˜

å¦‚æœä¸€ä¸ªå¯¹è±¡åœ¨ä¸èƒ½å¤Ÿä¿®æ”¹å…¶å†…éƒ¨çŠ¶æ€ï¼ˆå±æ€§ï¼‰ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºä¸å­˜åœ¨å¹¶å‘ä¿®æ”¹å•Šï¼è¿™æ ·çš„å¯¹è±¡åœ¨ Java ä¸­æœ‰å¾ˆå¤šï¼Œä¾‹å¦‚åœ¨ Java 8 åï¼Œæä¾›äº†ä¸€ä¸ªæ–°çš„æ—¥æœŸæ ¼å¼åŒ–ç±»ï¼š

```java
DateTimeFormatter dtf = DateTimeFormatter.ofPattern("yyyy-MM-dd");
for (int i = 0; i < 10; i++) {
    new Thread(() -> {
        LocalDate date = dtf.parse("2018-10-01", LocalDate::from);
        log.debug("{}", date);
    }).start();
}
```

å¯ä»¥çœ‹ DateTimeFormatter çš„æ–‡æ¡£ï¼š

```java
This class is immutable and thread-safe
```

ä¸å¯å˜å¯¹è±¡ï¼Œå®é™…æ˜¯å¦ä¸€ç§é¿å…ç«äº‰çš„æ–¹å¼ã€‚



## 2. ä¸å¯å˜è®¾è®¡

å¦ä¸€ä¸ªå¤§å®¶æ›´ä¸ºç†Ÿæ‚‰çš„ String ç±»ä¹Ÿæ˜¯ä¸å¯å˜çš„ï¼Œä»¥å®ƒä¸ºä¾‹ï¼Œè¯´æ˜ä¸€ä¸‹ä¸å¯å˜è®¾è®¡çš„è¦ç´ 

```java
public final class String
    implements java.io.Serializable, Comparable<String>, CharSequence {
    /** The value is used for character storage. */
    private final char value[];
    
    /** Cache the hash code for the string */
    private int hash; // Default to 0

    // ...
}
```



### 1. final çš„ä½¿ç”¨

å‘ç°è¯¥ç±»ã€ç±»ä¸­æ‰€æœ‰å±æ€§éƒ½æ˜¯ final çš„

- å±æ€§ç”¨ final ä¿®é¥°ä¿è¯äº†è¯¥å±æ€§æ˜¯åªè¯»çš„ï¼Œä¸èƒ½ä¿®æ”¹
- ç±»ç”¨ final ä¿®é¥°ä¿è¯äº†è¯¥ç±»ä¸­çš„æ–¹æ³•ä¸èƒ½è¢«è¦†ç›–ï¼Œé˜²æ­¢å­ç±»æ— æ„é—´ç ´åä¸å¯å˜æ€§





### 2. ä¿æŠ¤æ€§æ‹·è´

ä½†æœ‰åŒå­¦ä¼šè¯´ï¼Œä½¿ç”¨å­—ç¬¦ä¸²æ—¶ï¼Œä¹Ÿæœ‰ä¸€äº›è·Ÿä¿®æ”¹ç›¸å…³çš„æ–¹æ³•å•Šï¼Œæ¯”å¦‚ substring ç­‰ï¼Œé‚£ä¹ˆä¸‹é¢å°±çœ‹ä¸€çœ‹è¿™äº›æ–¹æ³•æ˜¯ å¦‚ä½•å®ç°çš„ï¼Œå°±ä»¥ substring ä¸ºä¾‹ï¼š

```java
public String substring(int beginIndex) {
    if (beginIndex < 0) {
        throw new StringIndexOutOfBoundsException(beginIndex);
    }
    int subLen = value.length - beginIndex;
    if (subLen < 0) {
        throw new StringIndexOutOfBoundsException(subLen);
    }
    return (beginIndex == 0) ? this : new String(value, beginIndex, subLen);
}
```

å‘ç°å…¶å†…éƒ¨æ˜¯è°ƒç”¨ String çš„æ„é€ æ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªæ–°å­—ç¬¦ä¸²ï¼Œå†è¿›å…¥è¿™ä¸ªæ„é€ çœ‹çœ‹ï¼Œæ˜¯å¦å¯¹ final char[] value åšå‡º äº†ä¿®æ”¹ï¼š

```java
public String(char value[], int offset, int count) {
    if (offset < 0) {
        throw new StringIndexOutOfBoundsException(offset);
    }
    if (count <= 0) {
        if (count < 0) {
            throw new StringIndexOutOfBoundsException(count);
        }
        if (offset <= value.length) {
            this.value = "".value;
            return;
        }
    }
    if (offset > value.length - count) {
        throw new StringIndexOutOfBoundsException(offset + count);
    }
    this.value = Arrays.copyOfRange(value, offset, offset+count);
}
```

ç»“æœå‘ç°ä¹Ÿæ²¡æœ‰ï¼Œæ„é€ æ–°å­—ç¬¦ä¸²å¯¹è±¡æ—¶ï¼Œä¼šç”Ÿæˆæ–°çš„ `char[] value`ï¼Œå¯¹å†…å®¹è¿›è¡Œå¤åˆ¶ ã€‚è¿™ç§é€šè¿‡åˆ›å»ºå‰¯æœ¬å¯¹è±¡æ¥é¿ å…å…±äº«çš„æ‰‹æ®µç§°ä¹‹ä¸ºã€**ä¿æŠ¤æ€§æ‹·è´ï¼ˆdefensive copyï¼‰**ã€‘



### 3. äº«å…ƒæ¨¡å¼ ğŸ

#### 1. ç®€ä»‹

**å®šä¹‰ **è‹±æ–‡åç§°ï¼šFlyweight pattern. å½“éœ€è¦é‡ç”¨æ•°é‡æœ‰é™çš„åŒä¸€ç±»å¯¹è±¡æ—¶

> wikipediaï¼š A flyweight is an object that minimizes memory usage by sharing as much data as possible with other similar objects

**å‡ºè‡ª** "Gang of Four" design patterns

**å½’ç±»** Structual patterns



#### 2. ä½“ç°

**1. åŒ…è£…ç±»**

åœ¨JDKä¸­ Booleanï¼ŒByteï¼ŒShortï¼ŒIntegerï¼ŒLongï¼ŒCharacter ç­‰åŒ…è£…ç±»æä¾›äº† valueOf æ–¹æ³•ï¼Œä¾‹å¦‚ Long çš„ valueOf ä¼šç¼“å­˜ -128~127 ä¹‹é—´çš„ Long å¯¹è±¡ï¼Œåœ¨è¿™ä¸ªèŒƒå›´ä¹‹é—´ä¼šé‡ç”¨å¯¹è±¡ï¼Œå¤§äºè¿™ä¸ªèŒƒå›´ï¼Œæ‰ä¼šæ–°å»º Long å¯¹ è±¡ï¼š

```java
public static Long valueOf(long l) {
    final int offset = 128;
    if (l >= -128 && l <= 127) { // will cache
        return LongCache.cache[(int)l + offset];
    }
    return new Long(l);
}
```

> **æ³¨æ„ï¼š**
>
> - Byte, Short, Long ç¼“å­˜çš„èŒƒå›´éƒ½æ˜¯ -128~127
> - Character ç¼“å­˜çš„èŒƒå›´æ˜¯ 0~127
> - Integerçš„é»˜è®¤èŒƒå›´æ˜¯ -128~127
>   - æœ€å°å€¼ä¸èƒ½å˜
>   - ä½†æœ€å¤§å€¼å¯ä»¥é€šè¿‡è°ƒæ•´è™šæ‹Ÿæœºå‚æ•° `  -Djava.lang.Integer.IntegerCache.high` æ¥æ”¹å˜
> - Boolean ç¼“å­˜äº† TRUE å’Œ FALSE



**2.  String ä¸²æ± **

```java
public final class String
    implements java.io.Serializable, Comparable<String>, CharSequence {
    /** The value is used for character storage. */
    private final char value[];
    
    /** Cache the hash code for the string */
    private int hash; // Default to 0

    // ...
}
```





**3. BigDecimal BigInteger**

```java
private static BigDecimal add(BigInteger fst, int scale1, BigInteger snd, int scale2) {
    int rscale = scale1;
    long sdiff = (long)rscale - scale2;
    if (sdiff != 0) {
        if (sdiff < 0) {
            int raise = checkScale(fst,-sdiff);
            rscale = scale2;
            fst = bigMultiplyPowerTen(fst,raise);
        } else {
            int raise = checkScale(snd,sdiff);
            snd = bigMultiplyPowerTen(snd,raise);
        }
    }
    BigInteger sum = fst.add(snd);
    return (fst.signum == snd.signum) ?
        new BigDecimal(sum, INFLATED, rscale, 0) :
    valueOf(sum, rscale, 0);
}
```





#### 3. DIY

ä¾‹å¦‚ï¼šä¸€ä¸ªçº¿ä¸Šå•†åŸåº”ç”¨ï¼ŒQPS è¾¾åˆ°æ•°åƒï¼Œå¦‚æœæ¯æ¬¡éƒ½é‡æ–°åˆ›å»ºå’Œå…³é—­æ•°æ®åº“è¿æ¥ï¼Œæ€§èƒ½ä¼šå—åˆ°æå¤§å½±å“ã€‚ è¿™æ—¶ é¢„å…ˆåˆ›å»ºå¥½ä¸€æ‰¹è¿æ¥ï¼Œæ”¾å…¥è¿æ¥æ± ã€‚ä¸€æ¬¡è¯·æ±‚åˆ°è¾¾åï¼Œä»è¿æ¥æ± è·å–è¿æ¥ï¼Œä½¿ç”¨å®Œæ¯•åå†è¿˜å›è¿æ¥æ± ï¼Œè¿™æ ·æ—¢èŠ‚çº¦ äº†è¿æ¥çš„åˆ›å»ºå’Œå…³é—­æ—¶é—´ï¼Œä¹Ÿå®ç°äº†è¿æ¥çš„é‡ç”¨ï¼Œä¸è‡³äºè®©åºå¤§çš„è¿æ¥æ•°å‹å®æ•°æ®åº“ã€‚

```java
class Pool {
    // 1. è¿æ¥æ± å¤§å°
    private final int poolSize;

    // 2. è¿æ¥å¯¹è±¡æ•°ç»„
    private Connection[] connections;

    // 3. è¿æ¥çŠ¶æ€æ•°ç»„ 0 è¡¨ç¤ºç©ºé—²ï¼Œ 1 è¡¨ç¤ºç¹å¿™
    private AtomicIntegerArray states;

    // 4. æ„é€ æ–¹æ³•åˆå§‹åŒ–
    public Pool(int poolSize) {
        this.poolSize = poolSize;
        this.connections = new Connection[poolSize];
        this.states = new AtomicIntegerArray(new int[poolSize]);
        for (int i = 0; i < poolSize; i++) {
            connections[i] = new MockConnection("è¿æ¥" + (i+1));
        }
    }

    // 5. å€Ÿè¿æ¥
    public Connection borrow() {
        while(true) {
            for (int i = 0; i < poolSize; i++) {
                // è·å–ç©ºé—²è¿æ¥
                if(states.get(i) == 0) {
                    if (states.compareAndSet(i, 0, 1)) {
                        log.debug("borrow {}", connections[i]);
                        return connections[i];
                    }
                }
            }
            // å¦‚æœæ²¡æœ‰ç©ºé—²è¿æ¥ï¼Œå½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…
            synchronized (this) {
                try {
                    log.debug("wait...");
                    this.wait();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }
    }

    // 6. å½’è¿˜è¿æ¥
    public void free(Connection conn) {
        for (int i = 0; i < poolSize; i++) {
            if (connections[i] == conn) {
                states.set(i, 0);
                synchronized (this) {
                    log.debug("free {}", conn);
                    this.notifyAll();
                }
                break;
            }
        }
    }
}

class MockConnection implements Connection {
    private String name;

    public MockConnection(String name) {
        this.name = name;
    }

    @Override
    public String toString() {
        return "MockConnection{" +
                "name='" + name + '\'' +
                '}';
    }
    
    // å®ç°ç•¥
}

```

ä½¿ç”¨è¿æ¥æ± ï¼š

```java
public class Test3 {
    public static void main(String[] args) {
        Pool pool = new Pool(2);
        for (int i = 0; i < 5; i++) {
            new Thread(() -> {
                Connection conn = pool.borrow();
                try {
                    Thread.sleep(new Random().nextInt(1000));
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                pool.free(conn);
            }).start();
        }
    }
}
```

ä»¥ä¸Šå®ç°æ²¡æœ‰è€ƒè™‘ï¼š

- è¿æ¥çš„åŠ¨æ€å¢é•¿ä¸æ”¶ç¼©
- è¿æ¥ä¿æ´»ï¼ˆå¯ç”¨æ€§æ£€æµ‹ï¼‰
- ç­‰å¾…è¶…æ—¶å¤„ç†
- åˆ†å¸ƒå¼ hash

å¯¹äºå…³ç³»å‹æ•°æ®åº“ï¼Œæœ‰æ¯”è¾ƒæˆç†Ÿçš„è¿æ¥æ± å®ç°ï¼Œä¾‹å¦‚c3p0, druidç­‰ï¼Œå¯¹äºæ›´é€šç”¨çš„å¯¹è±¡æ± ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨apache commons poolï¼Œä¾‹å¦‚redisè¿æ¥æ± å¯ä»¥å‚è€ƒjedisä¸­å…³äºè¿æ¥æ± çš„å®ç°





### 4. final åŸç†

#### 1.  è®¾ç½® final å˜é‡çš„åŸç†

ç†è§£äº† volatile åŸç†ï¼Œå†å¯¹æ¯” final çš„å®ç°å°±æ¯”è¾ƒç®€å•äº†

```java
public class TestFinal {
    final int a = 20;
}
```

å­—èŠ‚ç 

```shell
0: aload_0
1: invokespecial #1 		// Method java/lang/Object."<init>":()V
4: aload_0
5: bipush 20
7: putfield #2 				// Field a:I
 <-- å†™å±éšœ
10: retur
```

å‘ç° final å˜é‡çš„èµ‹å€¼ä¹Ÿä¼šé€šè¿‡ putfield æŒ‡ä»¤æ¥å®Œæˆï¼ŒåŒæ ·åœ¨è¿™æ¡æŒ‡ä»¤ä¹‹åä¹Ÿä¼šåŠ å…¥å†™å±éšœï¼Œä¿è¯åœ¨å…¶å®ƒçº¿ç¨‹è¯»åˆ° å®ƒçš„å€¼æ—¶ä¸ä¼šå‡ºç°ä¸º 0 çš„æƒ…å†µ





#### 2. è·å– final å˜é‡çš„åŸç†

```java
public class TestFinal {
    static int A = 10;
    static int B = Short.MAX_VALUE+1;

    final int a = 20;
    final int b = Integer.MAX_VALUE;

    final void test1() {
        final int c = 30;
        new Thread(()->{
            System.out.println(c);
        }).start();

        final int d = 30;
        class Task implements Runnable {

            @Override
            public void run() {
                System.out.println(d);
            }
        }
        new Thread(new Task()).start();
    }

}

class UseFinal1 {
    public void test() {
        System.out.println(TestFinal.A);
        System.out.println(TestFinal.B);
        System.out.println(new TestFinal().a);
        System.out.println(new TestFinal().b);
        new TestFinal().test1();
    }
}

class UseFinal2 {
    public void test() {
        System.out.println(TestFinal.A);
    }
}
```



## 3. æ— çŠ¶æ€

åœ¨ web é˜¶æ®µå­¦ä¹ æ—¶ï¼Œè®¾è®¡ Servlet æ—¶ä¸ºäº†ä¿è¯å…¶çº¿ç¨‹å®‰å…¨ï¼Œéƒ½ä¼šæœ‰è¿™æ ·çš„å»ºè®®ï¼Œä¸è¦ä¸º Servlet è®¾ç½®æˆå‘˜å˜é‡ï¼Œè¿™ ç§æ²¡æœ‰ä»»ä½•æˆå‘˜å˜é‡çš„ç±»æ˜¯çº¿ç¨‹å®‰å…¨çš„

> å› ä¸ºæˆå‘˜å˜é‡ä¿å­˜çš„æ•°æ®ä¹Ÿå¯ä»¥ç§°ä¸ºçŠ¶æ€ä¿¡æ¯ï¼Œå› æ­¤æ²¡æœ‰æˆå‘˜å˜é‡å°±ç§°ä¹‹ä¸ºã€æ— çŠ¶æ€ã€‘





## 4. å°ç»“

- ä¸å¯å˜ç±»ä½¿ç”¨
- ä¸å¯å˜ç±»è®¾è®¡
- åŸç†æ–¹é¢
  - final 
- æ¨¡å¼æ–¹é¢
  - äº«å…ƒ


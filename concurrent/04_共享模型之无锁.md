# å…±äº«æ¨¡å‹ä¹‹æ— é”

- CAS ä¸ volatile
- åŸå­æ•´æ•°
- åŸå­å¼•ç”¨
- åŸå­ç´¯åŠ å™¨
- Unsafe



## 1. é—®é¢˜æå‡º

æœ‰å¦‚ä¸‹éœ€æ±‚ï¼Œä¿è¯ `account.withdraw` å–æ¬¾æ–¹æ³•çš„çº¿ç¨‹å®‰å…¨

```java
interface Account {
    // è·å–ä½™é¢
    Integer getBalance();

    // å–æ¬¾
    void withdraw(Integer amount);

    /**
     * æ–¹æ³•å†…ä¼šå¯åŠ¨ 1000 ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åš -10 å…ƒ çš„æ“ä½œ
     * å¦‚æœåˆå§‹ä½™é¢ä¸º 10000 é‚£ä¹ˆæ­£ç¡®çš„ç»“æœåº”å½“æ˜¯ 0
     */
    static void demo(Account account) {
        List<Thread> ts = new ArrayList<>();
        for (int i = 0; i < 1000; i++) {
            ts.add(new Thread(() -> {
                account.withdraw(10);
            }));
        }
        long start = System.nanoTime();
        ts.forEach(Thread::start);
        ts.forEach(t -> {
            try {
                t.join();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        });
        long end = System.nanoTime();
        System.out.println(account.getBalance()
                + " cost: " + (end-start)/1000_000 + " ms");
    }
}
```

åŸæœ‰å®ç°å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„

```java
class AccountUnsafe implements Account {
    private Integer balance;
    public AccountUnsafe(Integer balance) {
        this.balance = balance;
    }
    @Override
    public Integer getBalance() {
        return balance;
    }
    @Override
    public void withdraw(Integer amount) {
        balance -= amount;
    }
}
```

æµ‹è¯•

```java
public static void main(String[] args) {
    Account.demo(new AccountUnsafe(10000));
}
```

```shell
# ç»“æœ
330 cost: 306 ms 
```



### 1. å®‰å…¨åˆ†æ

`withdraw` æ–¹æ³•

```java
public void withdraw(Integer amount) {
    balance -= amount;
}
```

å¯¹åº”çš„å­—èŠ‚ç 

```java
ALOAD 0                                                        // <- this
ALOAD 0
GETFIELD cn/itcast/AccountUnsafe.balance : Ljava/lang/Integer; // <- this.balance
INVOKEVIRTUAL java/lang/Integer.intValue ()I                   // æ‹†ç®±
ALOAD 1                                                        // <- amount
INVOKEVIRTUAL java/lang/Integer.intValue ()I                   // æ‹†ç®±
ISUB                                                           // å‡æ³•
INVOKESTATIC java/lang/Integer.valueOf (I)Ljava/lang/Integer;  // ç»“æœè£…ç®±
PUTFIELD cn/itcast/AccountUnsafe.balance : Ljava/lang/Integer; // -> this.balance
```

å¤šçº¿ç¨‹æ‰§è¡Œæµç¨‹

```java
ALOAD 0 								 // thread-0 <- this 
ALOAD 0 
GETFIELD cn/itcast/AccountUnsafe.balance // thread-0 <- this.balance 
INVOKEVIRTUAL java/lang/Integer.intValue // thread-0 æ‹†ç®±
ALOAD 1 // thread-0 <- amount 
INVOKEVIRTUAL java/lang/Integer.intValue // thread-0 æ‹†ç®±
ISUB // thread-0 å‡æ³•
INVOKESTATIC java/lang/Integer.valueOf   // thread-0 ç»“æœè£…ç®±
PUTFIELD cn/itcast/AccountUnsafe.balance // thread-0 -> this.balance 
 
ALOAD 0 							     // thread-1 <- this 
ALOAD 0 
GETFIELD cn/itcast/AccountUnsafe.balance // thread-1 <- this.balance 
INVOKEVIRTUAL java/lang/Integer.intValue // thread-1 æ‹†ç®±
ALOAD 1 // thread-1 <- amount 
INVOKEVIRTUAL java/lang/Integer.intValue // thread-1 æ‹†ç®±
ISUB // thread-1 å‡æ³•
INVOKESTATIC java/lang/Integer.valueOf   // thread-1 ç»“æœè£…ç®±
PUTFIELD cn/itcast/AccountUnsafe.balance // thread-1 -> this.balance 
```

- å•æ ¸çš„æŒ‡ä»¤äº¤é”™
- å¤šæ ¸çš„æŒ‡ä»¤äº¤é”™



### 2. è§£å†³æ€è·¯-é”

é¦–å…ˆæƒ³åˆ°çš„æ˜¯ç»™ Account å¯¹è±¡åŠ é”

```java
class AccountUnsafe implements Account {
    private Integer balance;
    public AccountUnsafe(Integer balance) {
        this.balance = balance;
    }
    @Override
    public synchronized Integer getBalance() {
        return balance;
    }
    @Override
    public synchronized void withdraw(Integer amount) {
        balance -= amount;
    }
}

```

```shell
# ç»“æœ
0 cost: 399 ms 
```





### 3. è§£å†³æ€è·¯-æ— é”

```java
class AccountSafe implements Account {
    private AtomicInteger balance;
    public AccountSafe(Integer balance) {
        this.balance = new AtomicInteger(balance);
    }
    @Override
    public Integer getBalance() {
        return balance.get();
    }
    @Override
    public void withdraw(Integer amount) {
        while (true) {
            int prev = balance.get();
            int next = prev - amount;
            if (balance.compareAndSet(prev, next)) {
                break;
            }
        }
        // å¯ä»¥ç®€åŒ–ä¸ºä¸‹é¢çš„æ–¹æ³•
        // balance.addAndGet(-1 * amount);
    }
}
```

æ‰§è¡Œæµ‹è¯•ä»£ç 

```java
public static void main(String[] args) {
    Account.demo(new AccountSafe(10000));
}
```

```shell
# ç»“æœ
0 cost: 302 ms 
```





## 2. CAS ä¸ volatile

å‰é¢çœ‹åˆ°çš„ `AtomicInteger` çš„è§£å†³æ–¹æ³•ï¼Œå†…éƒ¨å¹¶æ²¡æœ‰ç”¨é”æ¥ä¿æŠ¤å…±äº«å˜é‡çš„çº¿ç¨‹å®‰å…¨ã€‚é‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ

```java
public void withdraw(Integer amount) {
    while(true) {
        // éœ€è¦ä¸æ–­å°è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢
        while (true) {
            // æ¯”å¦‚æ‹¿åˆ°äº†æ—§å€¼ 1000
            int prev = balance.get();
            // åœ¨è¿™ä¸ªåŸºç¡€ä¸Š 1000-10 = 990
            int next = prev - amount;
            /*
 			compareAndSet æ­£æ˜¯åšè¿™ä¸ªæ£€æŸ¥ï¼Œåœ¨ set å‰ï¼Œå…ˆæ¯”è¾ƒ prev ä¸å½“å‰å€¼
			- ä¸ä¸€è‡´äº†ï¼Œnext ä½œåºŸï¼Œè¿”å› false è¡¨ç¤ºå¤±è´¥
 				æ¯”å¦‚ï¼Œåˆ«çš„çº¿ç¨‹å·²ç»åšäº†å‡æ³•ï¼Œå½“å‰å€¼å·²ç»è¢«å‡æˆäº† 990
 				é‚£ä¹ˆæœ¬çº¿ç¨‹çš„è¿™æ¬¡ 990 å°±ä½œåºŸäº†ï¼Œè¿›å…¥ while ä¸‹æ¬¡å¾ªç¯é‡è¯•
 			- ä¸€è‡´ï¼Œä»¥ next è®¾ç½®ä¸ºæ–°å€¼ï¼Œè¿”å› true è¡¨ç¤ºæˆåŠŸ
 			*/
            if (balance.compareAndSet(prev, next)) {
                break;
            }
        }
    }
}
```

å…¶ä¸­çš„å…³é”®æ˜¯ compareAndSetï¼Œå®ƒçš„ç®€ç§°å°±æ˜¯ CAS ï¼ˆä¹Ÿæœ‰ Compare And Swap çš„è¯´æ³•ï¼‰ï¼Œå®ƒå¿…é¡»æ˜¯åŸå­æ“ä½œã€‚

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111171302908.png)

> **æ³¨æ„**
>
> å…¶å® CAS çš„åº•å±‚æ˜¯ `lock cmpxchg` æŒ‡ä»¤ï¼ˆX86 æ¶æ„ï¼‰ï¼Œåœ¨å•æ ¸ CPU å’Œå¤šæ ¸ CPU ä¸‹éƒ½èƒ½å¤Ÿä¿è¯ã€æ¯”è¾ƒ-äº¤ æ¢ã€‘çš„åŸå­æ€§ã€‚
>
> - åœ¨å¤šæ ¸çŠ¶æ€ä¸‹ï¼ŒæŸä¸ªæ ¸æ‰§è¡Œåˆ°å¸¦ lock çš„æŒ‡ä»¤æ—¶ï¼ŒCPU ä¼šè®©æ€»çº¿é”ä½ï¼Œå½“è¿™ä¸ªæ ¸æŠŠæ­¤æŒ‡ä»¤æ‰§è¡Œå®Œæ¯•ï¼Œå†å¼€å¯æ€»çº¿ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ä¸ä¼šè¢«çº¿ç¨‹çš„è°ƒåº¦æœºåˆ¶æ‰€æ‰“æ–­ï¼Œä¿è¯äº†å¤šä¸ªçº¿ç¨‹å¯¹å†…å­˜æ“ä½œçš„å‡†ç¡®æ€§ï¼Œæ˜¯åŸå­çš„ã€‚



### 1. æ…¢åŠ¨ä½œåˆ†æ

```java
@Slf4j
public class SlowMotion {
    public static void main(String[] args) {
        AtomicInteger balance = new AtomicInteger(10000);
        int mainPrev = balance.get();
        log.debug("try get {}", mainPrev);
        new Thread(() -> {
            sleep(1000);
            int prev = balance.get();
            balance.compareAndSet(prev, 9000);
            log.debug(balance.toString());
        }, "t1").start();
        
        sleep(2000);
        log.debug("try set 8000...");
        boolean isSuccess = balance.compareAndSet(mainPrev, 8000);
        log.debug("is success ? {}", isSuccess);
        if(!isSuccess){
            mainPrev = balance.get();
            log.debug("try set 8000...");
            isSuccess = balance.compareAndSet(mainPrev, 8000);
            log.debug("is success ? {}", isSuccess);
        }
    }
    
    private static void sleep(int millis) {
        try {
            Thread.sleep(millis);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
```

```shell
# ç»“æœ
2019-10-13 11:28:37.134 [main] try get 10000 
2019-10-13 11:28:38.154 [t1] 9000 
2019-10-13 11:28:39.154 [main] try set 8000... 
2019-10-13 11:28:39.154 [main] is success ? false 
2019-10-13 11:28:39.154 [main] try set 8000... 
2019-10-13 11:28:39.154 [main] is success ? true 
```





### 2. volatile

è·å–å…±äº«å˜é‡æ—¶ï¼Œä¸ºäº†ä¿è¯è¯¥å˜é‡çš„å¯è§æ€§ï¼Œéœ€è¦ä½¿ç”¨ volatile ä¿®é¥°ã€‚

å®ƒå¯ä»¥ç”¨æ¥ä¿®é¥°æˆå‘˜å˜é‡å’Œé™æ€æˆå‘˜å˜é‡ï¼Œä»–å¯ä»¥é¿å…çº¿ç¨‹ä»è‡ªå·±çš„å·¥ä½œç¼“å­˜ä¸­æŸ¥æ‰¾å˜é‡çš„å€¼ï¼Œå¿…é¡»åˆ°ä¸»å­˜ä¸­è·å– å®ƒçš„å€¼ï¼Œçº¿ç¨‹æ“ä½œ volatile å˜é‡éƒ½æ˜¯ç›´æ¥æ“ä½œä¸»å­˜ã€‚å³ä¸€ä¸ªçº¿ç¨‹å¯¹ volatile å˜é‡çš„ä¿®æ”¹ï¼Œå¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§ã€‚

> **æ³¨æ„**
>
> volatile ä»…ä»…ä¿è¯äº†å…±äº«å˜é‡çš„å¯è§æ€§ï¼Œè®©å…¶å®ƒçº¿ç¨‹èƒ½å¤Ÿçœ‹åˆ°æœ€æ–°å€¼ï¼Œä½†ä¸èƒ½è§£å†³æŒ‡ä»¤äº¤é”™é—®é¢˜ï¼ˆä¸èƒ½ä¿è¯åŸ å­æ€§ï¼‰

CAS å¿…é¡»å€ŸåŠ© volatile æ‰èƒ½è¯»å–åˆ°å…±äº«å˜é‡çš„æœ€æ–°å€¼æ¥å®ç°ã€æ¯”è¾ƒå¹¶äº¤æ¢ã€‘çš„æ•ˆæœ





### 3. æ— é”æ•ˆç‡é«˜

- æ— é”æƒ…å†µä¸‹ï¼Œå³ä½¿é‡è¯•å¤±è´¥ï¼Œçº¿ç¨‹å§‹ç»ˆåœ¨é«˜é€Ÿè¿è¡Œï¼Œæ²¡æœ‰åœæ­‡ï¼Œè€Œ `synchronized` ä¼šè®©çº¿ç¨‹åœ¨æ²¡æœ‰è·å¾—é”çš„æ—¶ å€™ï¼Œå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿›å…¥é˜»å¡ã€‚æ‰“ä¸ªæ¯”å–»
- çº¿ç¨‹å°±å¥½åƒé«˜é€Ÿè·‘é“ä¸Šçš„èµ›è½¦ï¼Œé«˜é€Ÿè¿è¡Œæ—¶ï¼Œé€Ÿåº¦è¶…å¿«ï¼Œä¸€æ—¦å‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå°±å¥½æ¯”èµ›è½¦è¦å‡é€Ÿã€ç†„ç«ï¼Œ ç­‰è¢«å”¤é†’åˆå¾—é‡æ–°æ‰“ç«ã€å¯åŠ¨ã€åŠ é€Ÿ... æ¢å¤åˆ°é«˜é€Ÿè¿è¡Œï¼Œä»£ä»·æ¯”è¾ƒå¤§

- çº¿ç¨‹å°±å¥½åƒé«˜é€Ÿè·‘é“ä¸Šçš„èµ›è½¦ï¼Œé«˜é€Ÿè¿è¡Œæ—¶ï¼Œé€Ÿåº¦è¶…å¿«ï¼Œä¸€æ—¦å‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå°±å¥½æ¯”èµ›è½¦è¦å‡é€Ÿã€ç†„ç«ï¼Œ ç­‰è¢«å”¤é†’åˆå¾—é‡æ–°æ‰“ç«ã€å¯åŠ¨ã€åŠ é€Ÿ... æ¢å¤åˆ°é«˜é€Ÿè¿è¡Œï¼Œä»£ä»·æ¯”è¾ƒå¤§

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111171302354.png)



### 4. CAS çš„ç‰¹ç‚¹

ç»“åˆ CAS å’Œ volatile å¯ä»¥å®ç°æ— é”å¹¶å‘ï¼Œé€‚ç”¨äºçº¿ç¨‹æ•°å°‘ã€å¤šæ ¸ CPU çš„åœºæ™¯ä¸‹ã€‚

- CAS æ˜¯åŸºäº**ä¹è§‚é”**çš„æ€æƒ³ï¼šæœ€ä¹è§‚çš„ä¼°è®¡ï¼Œä¸æ€•åˆ«çš„çº¿ç¨‹æ¥ä¿®æ”¹å…±äº«å˜é‡ï¼Œå°±ç®—æ”¹äº†ä¹Ÿæ²¡å…³ç³»ï¼Œæˆ‘åƒäºç‚¹å† é‡è¯•å‘—ã€‚
- `synchronized` æ˜¯åŸºäº**æ‚²è§‚é”**çš„æ€æƒ³ï¼šæœ€æ‚²è§‚çš„ä¼°è®¡ï¼Œå¾—é˜²ç€å…¶å®ƒçº¿ç¨‹æ¥ä¿®æ”¹å…±äº«å˜é‡ï¼Œæˆ‘ä¸Šäº†é”ä½ ä»¬éƒ½åˆ«æƒ³ æ”¹ï¼Œæˆ‘æ”¹å®Œäº†è§£å¼€é”ï¼Œä½ ä»¬æ‰æœ‰æœºä¼šã€‚
- CAS ä½“ç°çš„æ˜¯æ— é”å¹¶å‘ã€æ— é˜»å¡å¹¶å‘ï¼Œè¯·ä»”ç»†ä½“ä¼šè¿™ä¸¤å¥è¯çš„æ„æ€
  - å› ä¸ºæ²¡æœ‰ä½¿ç”¨ synchronizedï¼Œæ‰€ä»¥çº¿ç¨‹ä¸ä¼šé™·å…¥é˜»å¡ï¼Œè¿™æ˜¯æ•ˆç‡æå‡çš„å› ç´ ä¹‹ä¸€
  - ä½†å¦‚æœç«äº‰æ¿€çƒˆï¼Œå¯ä»¥æƒ³åˆ°é‡è¯•å¿…ç„¶é¢‘ç¹å‘ç”Ÿï¼Œåè€Œæ•ˆç‡ä¼šå—å½±å“





## 3. åŸå­æ•´æ•°

J.U.C å¹¶å‘åŒ…æä¾›äº†ï¼š

- AtomicBoolean
- AtomicInteger
- AtomicLong

ä»¥ AtomicInteger ä¸ºä¾‹

```java
AtomicInteger i = new AtomicInteger(0);

// è·å–å¹¶è‡ªå¢ï¼ˆi = 0, ç»“æœ i = 1, è¿”å› 0ï¼‰ï¼Œç±»ä¼¼äº i++
System.out.println(i.getAndIncrement());

// è‡ªå¢å¹¶è·å–ï¼ˆi = 1, ç»“æœ i = 2, è¿”å› 2ï¼‰ï¼Œç±»ä¼¼äº ++i
System.out.println(i.incrementAndGet());

// è‡ªå‡å¹¶è·å–ï¼ˆi = 2, ç»“æœ i = 1, è¿”å› 1ï¼‰ï¼Œç±»ä¼¼äº --i
System.out.println(i.decrementAndGet());

// è·å–å¹¶è‡ªå‡ï¼ˆi = 1, ç»“æœ i = 0, è¿”å› 1ï¼‰ï¼Œç±»ä¼¼äº i--
System.out.println(i.getAndDecrement());

// è·å–å¹¶åŠ å€¼ï¼ˆi = 0, ç»“æœ i = 5, è¿”å› 0ï¼‰
System.out.println(i.getAndAdd(5));

// åŠ å€¼å¹¶è·å–ï¼ˆi = 5, ç»“æœ i = 0, è¿”å› 0ï¼‰
System.out.println(i.addAndGet(-5));

// è·å–å¹¶æ›´æ–°ï¼ˆi = 0, p ä¸º i çš„å½“å‰å€¼, ç»“æœ i = -2, è¿”å› 0ï¼‰
// å…¶ä¸­å‡½æ•°ä¸­çš„æ“ä½œèƒ½ä¿è¯åŸå­ï¼Œä½†å‡½æ•°éœ€è¦æ— å‰¯ä½œç”¨
System.out.println(i.getAndUpdate(p -> p - 2));

// æ›´æ–°å¹¶è·å–ï¼ˆi = -2, p ä¸º i çš„å½“å‰å€¼, ç»“æœ i = 0, è¿”å› 0ï¼‰
// å…¶ä¸­å‡½æ•°ä¸­çš„æ“ä½œèƒ½ä¿è¯åŸå­ï¼Œä½†å‡½æ•°éœ€è¦æ— å‰¯ä½œç”¨
System.out.println(i.updateAndGet(p -> p + 2));

// è·å–å¹¶è®¡ç®—ï¼ˆi = 0, p ä¸º i çš„å½“å‰å€¼, x ä¸ºå‚æ•°1, ç»“æœ i = 10, è¿”å› 0ï¼‰
// å…¶ä¸­å‡½æ•°ä¸­çš„æ“ä½œèƒ½ä¿è¯åŸå­ï¼Œä½†å‡½æ•°éœ€è¦æ— å‰¯ä½œç”¨
// getAndUpdate å¦‚æœåœ¨ lambda ä¸­å¼•ç”¨äº†å¤–éƒ¨çš„å±€éƒ¨å˜é‡ï¼Œè¦ä¿è¯è¯¥å±€éƒ¨å˜é‡æ˜¯ final çš„
// getAndAccumulate å¯ä»¥é€šè¿‡ å‚æ•°1 æ¥å¼•ç”¨å¤–éƒ¨çš„å±€éƒ¨å˜é‡ï¼Œä½†å› ä¸ºå…¶ä¸åœ¨ lambda ä¸­å› æ­¤ä¸å¿…æ˜¯ final
System.out.println(i.getAndAccumulate(10, (p, x) -> p + x));

// è®¡ç®—å¹¶è·å–ï¼ˆi = 10, p ä¸º i çš„å½“å‰å€¼, x ä¸ºå‚æ•°1, ç»“æœ i = 0, è¿”å› 0ï¼‰
// å…¶ä¸­å‡½æ•°ä¸­çš„æ“ä½œèƒ½ä¿è¯åŸå­ï¼Œä½†å‡½æ•°éœ€è¦æ— å‰¯ä½œç”¨
System.out.println(i.accumulateAndGet(-10, (p, x) -> p + x))
```





## 4. åŸå­å¼•ç”¨

ä¸ºä»€ä¹ˆéœ€è¦åŸå­å¼•ç”¨ç±»å‹ï¼Ÿ

- AtomicReference
- AtomicMarkableReference
- AtomicStampedReference

æœ‰å¦‚ä¸‹æ–¹æ³•

```java
public interface DecimalAccount {
    // è·å–ä½™é¢
    BigDecimal getBalance();
    // å–æ¬¾
    void withdraw(BigDecimal amount);
    /**
 	 * æ–¹æ³•å†…ä¼šå¯åŠ¨ 1000 ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åš -10 å…ƒ çš„æ“ä½œ
 	 * å¦‚æœåˆå§‹ä½™é¢ä¸º 10000 é‚£ä¹ˆæ­£ç¡®çš„ç»“æœåº”å½“æ˜¯ 0
 	 */
    static void demo(DecimalAccount account) {
        List<Thread> ts = new ArrayList<>();
        for (int i = 0; i < 1000; i++) {
            ts.add(new Thread(() -> {
                account.withdraw(BigDecimal.TEN);
            }));
        }
        ts.forEach(Thread::start);
        ts.forEach(t -> {
            try {
                t.join();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        });
        System.out.println(account.getBalance());
    }
}
```

è¯•ç€æä¾›ä¸åŒçš„ DecimalAccount å®ç°ï¼Œå®ç°å®‰å…¨çš„å–æ¬¾æ“ä½œ



### 1. éå®‰å…¨

```java
class DecimalAccountUnsafe implements DecimalAccount {
    BigDecimal balance;
    
    public DecimalAccountUnsafe(BigDecimal balance) {
        this.balance = balance;
    }
    
    @Override
    public BigDecimal getBalance() {
        return balance;
    }
    
    @Override
    public void withdraw(BigDecimal amount) {
        BigDecimal balance = this.getBalance();
        this.balance = balance.subtract(amount);
    }
}
```



### 2. å®‰å…¨-é”

```java
class DecimalAccountSafeLock implements DecimalAccount {
    private final Object lock = new Object();
    BigDecimal balance;
    
    public DecimalAccountSafeLock(BigDecimal balance) {
        this.balance = balance;
    }
    
    @Override
    public BigDecimal getBalance() {
        return balance;
    }
    
    @Override
    public void withdraw(BigDecimal amount) {
        synchronized (lock) {
            BigDecimal balance = this.getBalance();
            this.balance = balance.subtract(amount);
        }
    }
}
```



### 3. å®‰å…¨-CAS

```java
class DecimalAccountSafeCas implements DecimalAccount {
    AtomicReference<BigDecimal> ref;
    
    public DecimalAccountSafeCas(BigDecimal balance) {
        ref = new AtomicReference<>(balance);
    }
    
    @Override
    public BigDecimal getBalance() {
        return ref.get();
    }
    
    @Override
    public void withdraw(BigDecimal amount) {
        while (true) {
            BigDecimal prev = ref.get();
            BigDecimal next = prev.subtract(amount);
            if (ref.compareAndSet(prev, next)) {
                break;
            }
        }
    }
}
```

> ç”¨æ³•ä¸ AtomicInteger ç±»ä¼¼



### 4. ABA ğŸš€

#### 1. ABA é—®é¢˜

```java
static AtomicReference<String> ref = new AtomicReference<>("A");

public static void main(String[] args) throws InterruptedException {
    log.debug("main start...");
    // è·å–å€¼ A
    // è¿™ä¸ªå…±äº«å˜é‡è¢«å®ƒçº¿ç¨‹ä¿®æ”¹è¿‡ï¼Ÿ
    String prev = ref.get();
    other();
    sleep(1);
    // å°è¯•æ”¹ä¸º C
    log.debug("change A->C {}", ref.compareAndSet(prev, "C"));
}

private static void other() {
    new Thread(() -> {
        log.debug("change A->B {}", ref.compareAndSet(ref.get(), "B"));
    }, "t1").start();
    sleep(0.5);
    new Thread(() -> {
        log.debug("change B->A {}", ref.compareAndSet(ref.get(), "A"));
    }, "t2").start();
}
```

```shell
# ç»“æœ
11:29:52.325 c.Test36 [main] - main start... 
11:29:52.379 c.Test36 [t1] - change A->B true 
11:29:52.879 c.Test36 [t2] - change B->A true 
11:29:53.880 c.Test36 [main] - change A->C true 
```

ä¸»çº¿ç¨‹ä»…èƒ½åˆ¤æ–­å‡ºå…±äº«å˜é‡çš„å€¼ä¸æœ€åˆå€¼ A æ˜¯å¦ç›¸åŒï¼Œä¸èƒ½æ„ŸçŸ¥åˆ°è¿™ç§ä» A æ”¹ä¸º B åˆ æ”¹å› A çš„æƒ…å†µï¼Œå¦‚æœä¸»çº¿ç¨‹ å¸Œæœ›ï¼š

åªè¦æœ‰å…¶å®ƒçº¿ç¨‹ã€åŠ¨è¿‡äº†ã€‘å…±äº«å˜é‡ï¼Œé‚£ä¹ˆè‡ªå·±çš„ cas å°±ç®—å¤±è´¥ï¼Œè¿™æ—¶ï¼Œä»…æ¯”è¾ƒå€¼æ˜¯ä¸å¤Ÿçš„ï¼Œéœ€è¦å†åŠ ä¸€ä¸ªç‰ˆæœ¬å·



#### 2. AtomicStampedReference

```java
@Slf4j(topic = "c.Test36")
public class Test36 {

    static AtomicStampedReference<String> ref = new AtomicStampedReference<>("A", 0);

    public static void main(String[] args) throws InterruptedException {
        log.debug("main start...");
        // è·å–å€¼ A
        String prev = ref.getReference();
        // è·å–ç‰ˆæœ¬å·
        int stamp = ref.getStamp();
        log.debug("ç‰ˆæœ¬ {}", stamp);
        // å¦‚æœä¸­é—´æœ‰å…¶å®ƒçº¿ç¨‹å¹²æ‰°ï¼Œå‘ç”Ÿäº† ABA ç°è±¡
        other();
        sleep(1);
        // å°è¯•æ”¹ä¸º C
        log.debug("change A->C {}", ref.compareAndSet(prev, "C", stamp, stamp + 1));
    }

    private static void other() {
        new Thread(() -> {
            log.debug("change A->B {}", ref.compareAndSet(ref.getReference(), "B", ref.getStamp(), ref.getStamp() + 1));
            log.debug("æ›´æ–°ç‰ˆæœ¬ä¸º {}", ref.getStamp());
        }, "t1").start();
        sleep(0.5);
        new Thread(() -> {
            log.debug("change B->A {}", ref.compareAndSet(ref.getReference(), "A", ref.getStamp(), ref.getStamp() + 1));
            log.debug("æ›´æ–°ç‰ˆæœ¬ä¸º {}", ref.getStamp());
        }, "t2").start();
    }
}
```

```shell
# ç»“æœ
10:45:22.059 c.Test36 [main] - main start...
10:45:22.071 c.Test36 [main] - ç‰ˆæœ¬ 0
10:45:22.195 c.Test36 [t1] - change A->B true
10:45:22.195 c.Test36 [t1] - æ›´æ–°ç‰ˆæœ¬ä¸º 1
10:45:22.728 c.Test36 [t2] - change B->A true
10:45:22.728 c.Test36 [t2] - æ›´æ–°ç‰ˆæœ¬ä¸º 2
10:45:23.725 c.Test36 [main] - change A->C false
```

`AtomicStampedReference` å¯ä»¥ç»™åŸå­å¼•ç”¨åŠ ä¸Šç‰ˆæœ¬å·ï¼Œè¿½è¸ªåŸå­å¼•ç”¨æ•´ä¸ªçš„å˜åŒ–è¿‡ç¨‹ï¼Œå¦‚ï¼š `A -> B -> A -> C` ï¼Œé€šè¿‡ `AtomicStampedReference`ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå¼•ç”¨å˜é‡ä¸­é€”è¢«æ›´æ”¹äº†å‡ æ¬¡ã€‚



#### 3. AtomicMarkableReference

ä½†æ˜¯æœ‰æ—¶å€™ï¼Œå¹¶ä¸å…³å¿ƒå¼•ç”¨å˜é‡æ›´æ”¹äº†å‡ æ¬¡ï¼Œåªæ˜¯å•çº¯çš„å…³å¿ƒ**æ˜¯å¦æ›´æ”¹è¿‡**ï¼Œæ‰€ä»¥å°±æœ‰äº† `AtomicMarkableReference`

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111171303067.png)

```java
@Slf4j(topic = "c.Test38")
public class Test38 {
    public static void main(String[] args) throws InterruptedException {
        GarbageBag bag = new GarbageBag("è£…æ»¡äº†åƒåœ¾");
        // å‚æ•°2 mark å¯ä»¥çœ‹ä½œä¸€ä¸ªæ ‡è®°ï¼Œè¡¨ç¤ºåƒåœ¾è¢‹æ»¡äº†
        AtomicMarkableReference<GarbageBag> ref = new AtomicMarkableReference<>(bag, true);

        log.debug("start...");
        GarbageBag prev = ref.getReference();
        log.debug(prev.toString());

        new Thread(() -> {
            log.debug("start...");
            bag.setDesc("ç©ºåƒåœ¾è¢‹");
            ref.compareAndSet(bag, bag, true, false);
            log.debug(bag.toString());
        },"ä¿æ´é˜¿å§¨").start();

        sleep(1);
        log.debug("æƒ³æ¢ä¸€åªæ–°åƒåœ¾è¢‹ï¼Ÿ");
        boolean success = ref.compareAndSet(prev, new GarbageBag("ç©ºåƒåœ¾è¢‹"), true, false);
        log.debug("æ¢äº†ä¹ˆï¼Ÿ" + success);
        log.debug(ref.getReference().toString());
    }
}

class GarbageBag {
    String desc;

    public GarbageBag(String desc) {
        this.desc = desc;
    }

    public void setDesc(String desc) {
        this.desc = desc;
    }

    @Override
    public String toString() {
        return super.toString() + " " + desc;
    }
}
```





## 5. åŸå­æ•°ç»„

- AtomicIntegerArray
- AtomicLongArray
- AtomicReferenceArray

```java
/**
 * å‚æ•°1ï¼Œæä¾›æ•°ç»„ã€å¯ä»¥æ˜¯çº¿ç¨‹ä¸å®‰å…¨æ•°ç»„æˆ–çº¿ç¨‹å®‰å…¨æ•°ç»„
 * å‚æ•°2ï¼Œè·å–æ•°ç»„é•¿åº¦çš„æ–¹æ³•
 * å‚æ•°3ï¼Œè‡ªå¢æ–¹æ³•ï¼Œå›ä¼  array, index
 * å‚æ•°4ï¼Œæ‰“å°æ•°ç»„çš„æ–¹æ³•
 */
// supplier æä¾›è€… æ— ä¸­ç”Ÿæœ‰  ()->ç»“æœ
// function å‡½æ•°   ä¸€ä¸ªå‚æ•°ä¸€ä¸ªç»“æœ   (å‚æ•°)->ç»“æœ  ,  BiFunction (å‚æ•°1,å‚æ•°2)->ç»“æœ
// consumer æ¶ˆè´¹è€… ä¸€ä¸ªå‚æ•°æ²¡ç»“æœ  (å‚æ•°)->void,      BiConsumer (å‚æ•°1,å‚æ•°2)->void
private static <T> void demo(
    Supplier<T> arraySupplier,
    Function<T, Integer> lengthFun,
    BiConsumer<T, Integer> putConsumer,
    Consumer<T> printConsumer ) {
    List<Thread> ts = new ArrayList<>();
    T array = arraySupplier.get();
    int length = lengthFun.apply(array);
    for (int i = 0; i < length; i++) {
        // æ¯ä¸ªçº¿ç¨‹å¯¹æ•°ç»„ä½œ 10000 æ¬¡æ“ä½œ
        ts.add(new Thread(() -> {
            for (int j = 0; j < 10000; j++) {
                putConsumer.accept(array, j%length);
            }
        }));
    }

    ts.forEach(t -> t.start()); // å¯åŠ¨æ‰€æœ‰çº¿ç¨‹
    ts.forEach(t -> {
        try {
            t.join();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    });     // ç­‰æ‰€æœ‰çº¿ç¨‹ç»“æŸ
    printConsumer.accept(array);
}
```



### 1. ä¸å®‰å…¨æ•°ç»„

```java
public static void main(String[] args) {
    demo(
        ()->new int[10],
        array -> array.length,
        (array, index) -> array[index]++,
        array -> System.out.println(Arrays.toString(array))
    );
}
```

```shell
# ç»“æœ
[9965, 9977, 9974, 9970, 9965, 9978, 9977, 9977, 9977, 9975]
```





### 2. å®‰å…¨æ•°ç»„

```java
public static void main(String[] args) {
    demo(
        ()-> new AtomicIntegerArray(10),
        (array) -> array.length(),
        (array, index) -> array.getAndIncrement(index),
        array -> System.out.println(array)
    );
}
```

```shell
# ç»“æœ
[10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000]
```





## 6. å­—æ®µæ›´æ–°å™¨

- AtomicReferenceFieldUpdater
- AtomicIntegerFieldUpdater
- AtomicLongFieldUpdater

åˆ©ç”¨å­—æ®µæ›´æ–°å™¨ï¼Œå¯ä»¥é’ˆå¯¹å¯¹è±¡çš„æŸä¸ªåŸŸï¼ˆFieldï¼‰è¿›è¡ŒåŸå­æ“ä½œï¼Œåªèƒ½é…åˆ volatile ä¿®é¥°çš„å­—æ®µä½¿ç”¨ï¼Œå¦åˆ™ä¼šå‡ºç°å¼‚å¸¸

```java
Exception in thread "main" java.lang.IllegalArgumentException: Must be volatile type
```

```java
public class Test40 {

    public static void main(String[] args) {
        Student stu = new Student();

        AtomicReferenceFieldUpdater updater =
                AtomicReferenceFieldUpdater.newUpdater(Student.class, String.class, "name");

        System.out.println(updater.compareAndSet(stu, null, "å¼ ä¸‰"));
        System.out.println(stu);
    }
}

class Student {
    volatile String name;

    @Override
    public String toString() {
        return "Student{" +
                "name='" + name + '\'' +
                '}';
    }
}
```





## 7. åŸå­ç´¯åŠ å™¨

### 1. ç´¯åŠ å™¨æ€§èƒ½æ¯”è¾ƒ

```java
/**
 * () -> ç»“æœ        æä¾›ç´¯åŠ å™¨å¯¹è±¡
 * (å‚æ•°) -> void    æ‰§è¡Œç´¯åŠ æ“ä½œ
 */
private static <T> void demo(Supplier<T> adderSupplier, Consumer<T> action) {
    T adder = adderSupplier.get();
    List<Thread> ts = new ArrayList<>();
    // 4 ä¸ªçº¿ç¨‹ï¼Œæ¯äººç´¯åŠ  50 ä¸‡
    for (int i = 0; i < 4; i++) {
        ts.add(new Thread(() -> {
            for (int j = 0; j < 500000; j++) {
                action.accept(adder);
            }
        }));
    }
    long start = System.nanoTime();
    ts.forEach(t -> t.start());
    ts.forEach(t -> {
        try {
            t.join();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    });

    long end = System.nanoTime();
    System.out.println(adder + " cost:" + (end - start) / 1000_000);
}
```

æ¯”è¾ƒ AtomicLong ä¸ LongAdder

```java
public static void main(String[] args) {
    for (int i = 0; i < 5; i++) {
        demo(
            () -> new LongAdder(),
            adder -> adder.increment()
        );
    }

    for (int i = 0; i < 5; i++) {
        demo(
            () -> new AtomicLong(0),
            (adder) -> adder.getAndIncrement()
        );
    }
}
```

```shell
# ç»“æœ
2000000 cost:38
2000000 cost:29
2000000 cost:17
2000000 cost:15
2000000 cost:16

2000000 cost:37
2000000 cost:34
2000000 cost:25
2000000 cost:29
2000000 cost:33
```

æ€§èƒ½æå‡çš„åŸå› å¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨æœ‰ç«äº‰æ—¶ï¼Œè®¾ç½®å¤šä¸ªç´¯åŠ å•å…ƒï¼ŒTherad-0 ç´¯åŠ  Cell[0]ï¼Œè€Œ Thread-1 ç´¯åŠ  Cell[1]... æœ€åå°†ç»“æœæ±‡æ€»ã€‚è¿™æ ·å®ƒä»¬åœ¨ç´¯åŠ æ—¶æ“ä½œçš„ä¸åŒçš„ Cell å˜é‡ï¼Œå› æ­¤å‡å°‘äº† CAS é‡è¯•å¤±è´¥ï¼Œä»è€Œæé«˜æ€§ èƒ½ã€‚





### 2. LongAdderæºç 

LongAdder æ˜¯å¹¶å‘å¤§å¸ˆ @author Doug Lea ï¼ˆå¤§å“¥æï¼‰çš„ä½œå“ï¼Œè®¾è®¡çš„éå¸¸ç²¾å·§

LongAdder ç±»æœ‰å‡ ä¸ªå…³é”®åŸŸ

```java
// ç´¯åŠ å•å…ƒæ•°ç»„, æ‡’æƒ°åˆå§‹åŒ–
transient volatile Cell[] cells;

// åŸºç¡€å€¼, å¦‚æœæ²¡æœ‰ç«äº‰, åˆ™ç”¨ cas ç´¯åŠ è¿™ä¸ªåŸŸ
transient volatile long base;

// åœ¨ cells åˆ›å»ºæˆ–æ‰©å®¹æ—¶, ç½®ä¸º 1, è¡¨ç¤ºåŠ é”
transient volatile int cellsBusy;
```

**cas é”**

```java
public class LockCas {
    // 0 æ²¡åŠ é”
    // 1 åŠ é”
    private AtomicInteger state = new AtomicInteger(0);

    public void lock() {
        while (true) {
            if (state.compareAndSet(0, 1)) {
                break;
            }
        }
    }

    public void unlock() {
        log.debug("unlock...");
        state.set(0);
    }

    public static void main(String[] args) {
        LockCas lock = new LockCas();
        new Thread(() -> {
            log.debug("begin...");
            lock.lock();
            try {
                log.debug("lock...");
                sleep(1);
            } finally {
                lock.unlock();
            }
        }).start();

        new Thread(() -> {
            log.debug("begin...");
            lock.lock();
            try {
                log.debug("lock...");
            } finally {
                lock.unlock();
            }
        }).start();
    }
}
```

```shell
# ç»“æœ
11:56:42.532 c.Test42 [Thread-0] - begin...
11:56:42.529 c.Test42 [Thread-1] - begin...
11:56:42.536 c.Test42 [Thread-0] - lock...
11:56:43.540 c.Test42 [Thread-0] - unlock...
11:56:43.540 c.Test42 [Thread-1] - lock...
11:56:43.540 c.Test42 [Thread-1] - unlock...
```





### 3. ä¼ªå…±äº«åŸç†

 Cell å³ä¸ºç´¯åŠ å•å…ƒ

```java
// é˜²æ­¢ç¼“å­˜è¡Œä¼ªå…±äº«
@sun.misc.Contended
    static final class Cell {
        volatile long value;
        Cell(long x) { value = x; }

        // æœ€é‡è¦çš„æ–¹æ³•, ç”¨æ¥ cas æ–¹å¼è¿›è¡Œç´¯åŠ , prev è¡¨ç¤ºæ—§å€¼, next è¡¨ç¤ºæ–°å€¼
        final boolean cas(long prev, long next) {
            return UNSAFE.compareAndSwapLong(this, valueOffset, prev, next);
        }
        // çœç•¥ä¸é‡è¦ä»£ç 
    }
```



#### 1. å†…å­˜ä¸ç¼“å­˜

ç¼“å­˜ä¸å†…å­˜çš„é€Ÿåº¦æ¯”è¾ƒ

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111171303349.png)

| ä» cpu åˆ° | å¤§çº¦éœ€è¦çš„æ—¶é’Ÿå‘¨æœŸ               |
| --------- | -------------------------------- |
| å¯„å­˜å™¨    | 1 cycle (4GHz çš„ CPU çº¦ä¸º0.25ns) |
| L1        | 3~4 cycle                        |
| L2        | 10~20 cycle                      |
| L3        | 40~45 cycle                      |
| å†…å­˜      | 120~240 cycle                    |

å› ä¸º CPU ä¸ å†…å­˜çš„é€Ÿåº¦å·®å¼‚å¾ˆå¤§ï¼Œéœ€è¦é é¢„è¯»æ•°æ®è‡³ç¼“å­˜æ¥æå‡æ•ˆç‡ã€‚

è€Œç¼“å­˜ä»¥ç¼“å­˜è¡Œä¸ºå•ä½ï¼Œæ¯ä¸ªç¼“å­˜è¡Œå¯¹åº”ç€ä¸€å—å†…å­˜ï¼Œä¸€èˆ¬æ˜¯ 64 byteï¼ˆ8 ä¸ª longï¼‰

ç¼“å­˜çš„åŠ å…¥ä¼šé€ æˆæ•°æ®å‰¯æœ¬çš„äº§ç”Ÿï¼Œå³åŒä¸€ä»½æ•°æ®ä¼šç¼“å­˜åœ¨ä¸åŒæ ¸å¿ƒçš„ç¼“å­˜è¡Œä¸­

CPU è¦ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œå¦‚æœæŸä¸ª CPU æ ¸å¿ƒæ›´æ”¹äº†æ•°æ®ï¼Œå…¶å®ƒ CPU æ ¸å¿ƒå¯¹åº”çš„æ•´ä¸ªç¼“å­˜è¡Œå¿…é¡»å¤±æ•ˆ

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111171304137.png)

å› ä¸º Cell æ˜¯æ•°ç»„å½¢å¼ï¼Œåœ¨å†…å­˜ä¸­æ˜¯è¿ç»­å­˜å‚¨çš„ï¼Œä¸€ä¸ª Cell ä¸º 24 å­—èŠ‚ï¼ˆ16 å­—èŠ‚çš„å¯¹è±¡å¤´å’Œ 8 å­—èŠ‚çš„ valueï¼‰ï¼Œå›  æ­¤ç¼“å­˜è¡Œå¯ä»¥å­˜ä¸‹ 2 ä¸ªçš„ Cell å¯¹è±¡ã€‚è¿™æ ·é—®é¢˜æ¥äº†ï¼š

- Core-0 è¦ä¿®æ”¹ Cell[0]
- Core-1 è¦ä¿®æ”¹ Cell[1]

æ— è®ºè°ä¿®æ”¹æˆåŠŸï¼Œéƒ½ä¼šå¯¼è‡´å¯¹æ–¹ Core çš„ç¼“å­˜è¡Œå¤±æ•ˆï¼Œæ¯”å¦‚ Core-0 ä¸­ `Cell[0]=6000, Cell[1]=8000` è¦ç´¯åŠ  `Cell[0]=6001, Cell[1]=8000` ï¼Œè¿™æ—¶ä¼šè®© Core-1 çš„ç¼“å­˜è¡Œå¤±æ•ˆ

@sun.misc.Contended ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒçš„åŸç†æ˜¯åœ¨ä½¿ç”¨æ­¤æ³¨è§£çš„å¯¹è±¡æˆ–å­—æ®µçš„å‰åå„å¢åŠ  128 å­—èŠ‚å¤§å°çš„ paddingï¼Œä»è€Œè®© CPU å°†å¯¹è±¡é¢„è¯»è‡³ç¼“å­˜æ—¶å ç”¨ä¸åŒçš„ç¼“å­˜è¡Œï¼Œè¿™æ ·ï¼Œä¸ä¼šé€ æˆå¯¹æ–¹ç¼“å­˜è¡Œçš„å¤±æ•ˆ

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111171304949.png)





#### 2. add

```java
public void add(long x) {
    // as ä¸ºç´¯åŠ å•å…ƒæ•°ç»„
    // b ä¸ºåŸºç¡€å€¼
    // x ä¸ºç´¯åŠ å€¼
    Cell[] as; long b, v; int m; Cell a;
    // è¿›å…¥ if çš„ä¸¤ä¸ªæ¡ä»¶
    // 1. as æœ‰å€¼, è¡¨ç¤ºå·²ç»å‘ç”Ÿè¿‡ç«äº‰, è¿›å…¥ if
    // 2. cas ç»™ base ç´¯åŠ æ—¶å¤±è´¥äº†, è¡¨ç¤º base å‘ç”Ÿäº†ç«äº‰, è¿›å…¥ if
    if ((as = cells) != null || !casBase(b = base, b + x)) {
        // uncontended è¡¨ç¤º cell æ²¡æœ‰ç«äº‰
        boolean uncontended = true;
        if (
            // as è¿˜æ²¡æœ‰åˆ›å»º
            as == null || (m = as.length - 1) < 0 ||
            // å½“å‰çº¿ç¨‹å¯¹åº”çš„ cell è¿˜æ²¡æœ‰
            (a = as[getProbe() & m]) == null ||
            // cas ç»™å½“å‰çº¿ç¨‹çš„ cell ç´¯åŠ å¤±è´¥ uncontended=false ( a ä¸ºå½“å‰çº¿ç¨‹çš„ cell )
            !(uncontended = a.cas(v = a.value, v + x))
        ) {
            // è¿›å…¥ cell æ•°ç»„åˆ›å»ºã€cell åˆ›å»ºçš„æµç¨‹
            longAccumulate(x, null, uncontended);
        }
    }
}
```

**add æµç¨‹å›¾**

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111171304650.png)



#### 3. longAccumulate 

```java
final void longAccumulate(long x, LongBinaryOperator fn,
                          boolean wasUncontended) {
    int h;
    // å½“å‰çº¿ç¨‹è¿˜æ²¡æœ‰å¯¹åº”çš„ cell, éœ€è¦éšæœºç”Ÿæˆä¸€ä¸ª h å€¼ç”¨æ¥å°†å½“å‰çº¿ç¨‹ç»‘å®šåˆ° cell
    if ((h = getProbe()) == 0) {
        // åˆå§‹åŒ– probe
        ThreadLocalRandom.current();
        // h å¯¹åº”æ–°çš„ probe å€¼, ç”¨æ¥å¯¹åº” cell
        h = getProbe();
        wasUncontended = true;
    }
    // collide ä¸º true è¡¨ç¤ºéœ€è¦æ‰©å®¹
    boolean collide = false; 
    for (;;) {
        Cell[] as; Cell a; int n; long v;
        // å·²ç»æœ‰äº† cells
        if ((as = cells) != null && (n = as.length) > 0) {
            // è¿˜æ²¡æœ‰ cell
            if ((a = as[(n - 1) & h]) == null) {
                // ä¸º cellsBusy åŠ é”, åˆ›å»º cell, cell çš„åˆå§‹ç´¯åŠ å€¼ä¸º x
                // æˆåŠŸåˆ™ break, å¦åˆ™ç»§ç»­ continue å¾ªç¯
            }
            // æœ‰ç«äº‰, æ”¹å˜çº¿ç¨‹å¯¹åº”çš„ cell æ¥é‡è¯• cas
            else if (!wasUncontended)
                wasUncontended = true;
            // cas å°è¯•ç´¯åŠ , fn é…åˆ LongAccumulator ä¸ä¸º null, é…åˆ LongAdder ä¸º null
            else if (a.cas(v = a.value, ((fn == null) ? v + x : fn.applyAsLong(v, x))))
                break;
            // å¦‚æœ cells é•¿åº¦å·²ç»è¶…è¿‡äº†æœ€å¤§é•¿åº¦, æˆ–è€…å·²ç»æ‰©å®¹, æ”¹å˜çº¿ç¨‹å¯¹åº”çš„ cell æ¥é‡è¯• cas
            else if (n >= NCPU || cells != as)
                collide = false;
            // ç¡®ä¿ collide ä¸º false è¿›å…¥æ­¤åˆ†æ”¯, å°±ä¸ä¼šè¿›å…¥ä¸‹é¢çš„ else if è¿›è¡Œæ‰©å®¹äº†
            else if (!collide)
                collide = true;
            // åŠ é”
            else if (cellsBusy == 0 && casCellsBusy()) {
                // åŠ é”æˆåŠŸ, æ‰©å®¹
                continue;
            }
            // æ”¹å˜çº¿ç¨‹å¯¹åº”çš„ cell
            h = advanceProbe(h);
        }
        // è¿˜æ²¡æœ‰ cells, å°è¯•ç»™ cellsBusy åŠ é”
        else if (cellsBusy == 0 && cells == as && casCellsBusy()) {
            // åŠ é”æˆåŠŸ, åˆå§‹åŒ– cells, æœ€å¼€å§‹é•¿åº¦ä¸º 2, å¹¶å¡«å……ä¸€ä¸ª cell
            // æˆåŠŸåˆ™ break;
        }
        // ä¸Šä¸¤ç§æƒ…å†µå¤±è´¥, å°è¯•ç»™ base ç´¯åŠ 
        else if (casBase(v = base, ((fn == null) ? v + x : fn.applyAsLong(v, x))))
            break;
    }
}
```

**longAccumulate æµç¨‹å›¾**

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111171304971.png)

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111171304084.png)



æ¯ä¸ªçº¿ç¨‹åˆšè¿›å…¥ longAccumulate æ—¶ï¼Œä¼šå°è¯•å¯¹åº”ä¸€ä¸ª cell å¯¹è±¡ï¼ˆæ‰¾åˆ°ä¸€ä¸ªå‘ä½ï¼‰

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111171304923.png)



è·å–æœ€ç»ˆç»“æœé€šè¿‡ sum æ–¹æ³•

```java
public long sum() {
    Cell[] as = cells; Cell a;
    long sum = base;
    if (as != null) {
        for (int i = 0; i < as.length; ++i) {
            if ((a = as[i]) != null)
                sum += a.value;
        }
    }
    return sum;
}
```





## 8. Unsafe

### 1. æ¦‚è¿°

Unsafe å¯¹è±¡æä¾›äº†éå¸¸åº•å±‚çš„ï¼Œæ“ä½œå†…å­˜ã€çº¿ç¨‹çš„æ–¹æ³•ï¼ŒUnsafe å¯¹è±¡ä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œåªèƒ½é€šè¿‡åå°„è·å¾—

```java
public class UnsafeAccessor {
    static Unsafe unsafe;
    
    static {
        try { 
            Field theUnsafe = Unsafe.class.getDeclaredField("theUnsafe");
            theUnsafe.setAccessible(true);
            unsafe = (Unsafe) theUnsafe.get(null);
        } catch (NoSuchFieldException | IllegalAccessException e) {
            throw new Error(e);
        }
    }
    
    static Unsafe getUnsafe() {
        return unsafe;
    }
```





### 2. Unsafe CAS æ“ä½œ

```java
public class TestUnsafe {

    public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException {
        Field theUnsafe = Unsafe.class.getDeclaredField("theUnsafe");
        theUnsafe.setAccessible(true);
        Unsafe unsafe = (Unsafe) theUnsafe.get(null);

        System.out.println(unsafe);

        // 1. è·å–åŸŸçš„åç§»åœ°å€
        long idOffset = unsafe.objectFieldOffset(Teacher.class.getDeclaredField("id"));
        long nameOffset = unsafe.objectFieldOffset(Teacher.class.getDeclaredField("name"));

        Teacher t = new Teacher();
        // 2. æ‰§è¡Œ cas æ“ä½œ
        unsafe.compareAndSwapInt(t, idOffset, 0, 1);
        unsafe.compareAndSwapObject(t, nameOffset, null, "å¼ ä¸‰");

        // 3. éªŒè¯
        System.out.println(t);
    }
}

@Data
class Teacher {
    volatile int id;
    volatile String name;
}
```

```shell
# ç»“æœ
sun.misc.Unsafe@5acf9800
Teacher(id=1, name=å¼ ä¸‰)
```





### 3. è‡ªå®šä¹‰åŸå­ç±»

ä½¿ç”¨è‡ªå®šä¹‰çš„ AtomicData å®ç°ä¹‹å‰çº¿ç¨‹å®‰å…¨çš„åŸå­æ•´æ•° Account å®ç°

```java
class AtomicData implements Account {
    private volatile int value;
    private static final long valueOffset;
    private static final Unsafe UNSAFE;
    static {
        UNSAFE = UnsafeAccessor.getUnsafe();
        try {
            valueOffset = UNSAFE.objectFieldOffset(AtomicData.class.getDeclaredField("value"));
        } catch (NoSuchFieldException e) {
            e.printStackTrace();
            throw new RuntimeException(e);
        }
    }

    public int getValue() {
        return value;
    }

    public void decrement(int amount) {
        while(true) {
            int prev = this.value;
            int next = prev - amount;
            if (UNSAFE.compareAndSwapInt(this, valueOffset, prev, next)) {
                break;
            }
        }
    }

    public AtomicData(int value) {
        this.value = value;
    }

    @Override
    public Integer getBalance() {
        return getValue();
    }

    @Override
    public void withdraw(Integer amount) {
        decrement(amount);
    }
}

interface Account {
    // è·å–ä½™é¢
    Integer getBalance();

    // å–æ¬¾
    void withdraw(Integer amount);

    /**
     * æ–¹æ³•å†…ä¼šå¯åŠ¨ 1000 ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åš -10 å…ƒ çš„æ“ä½œ
     * å¦‚æœåˆå§‹ä½™é¢ä¸º 10000 é‚£ä¹ˆæ­£ç¡®çš„ç»“æœåº”å½“æ˜¯ 0
     */
    static void demo(Account account) {
        List<Thread> ts = new ArrayList<>();
        for (int i = 0; i < 1000; i++) {
            ts.add(new Thread(() -> {
                account.withdraw(10);
            }));
        }
        long start = System.nanoTime();
        ts.forEach(Thread::start);
        ts.forEach(t -> {
            try {
                t.join();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        });
        long end = System.nanoTime();
        System.out.println(account.getBalance()
                + " cost: " + (end-start)/1000_000 + " ms");
    }
}
```

æµ‹è¯•

```java
public static void main(String[] args) {
    Account.demo(new AtomicData(10000));
}
```

```shell
# ç»“æœ
0 cost: 166 ms
```





## 9. å°ç»“

- CAS ä¸ volatile
- API
  - åŸå­æ•´æ•°
  - åŸå­å¼•ç”¨
  - åŸå­æ•°ç»„
  - å­—æ®µæ›´æ–°å™¨
  - åŸå­ç´¯åŠ å™¨

- Unsafe
- åŸç†æ–¹é¢
  - LongAdder æºç 
  - ä¼ªå…±äº«


# å…±äº«æ¨¡å‹ä¹‹ç®¡ç¨‹

## 1. å…±äº«å¸¦æ¥çš„é—®é¢˜

**å°æ•…äº‹**

- è€ç‹ï¼ˆæ“ä½œç³»ç»Ÿï¼‰æœ‰ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ç®—ç›˜ï¼ˆCPUï¼‰ï¼Œç°åœ¨æƒ³æŠŠå®ƒç§Ÿå‡ºå»ï¼Œèµšä¸€ç‚¹å¤–å¿«

- ![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162211496.png)

- å°å—ã€å°å¥³ï¼ˆçº¿ç¨‹ï¼‰æ¥ä½¿ç”¨è¿™ä¸ªç®—ç›˜æ¥è¿›è¡Œä¸€äº›è®¡ç®—ï¼Œå¹¶æŒ‰ç…§æ—¶é—´ç»™è€ç‹æ”¯ä»˜è´¹ç”¨
- ä½†å°å—ä¸èƒ½ä¸€å¤©24å°æ—¶ä½¿ç”¨ç®—ç›˜ï¼Œä»–ç»å¸¸è¦å°æ†©ä¸€ä¼šï¼ˆsleepï¼‰ï¼Œåˆæˆ–æ˜¯å»åƒé¥­ä¸Šå•æ‰€ï¼ˆé˜»å¡ io æ“ä½œï¼‰ï¼Œæœ‰ æ—¶è¿˜éœ€è¦ä¸€æ ¹çƒŸï¼Œæ²¡çƒŸæ—¶æ€è·¯å…¨æ— ï¼ˆwaitï¼‰è¿™äº›æƒ…å†µç»Ÿç§°ä¸ºï¼ˆé˜»å¡ï¼‰

- ![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162211433.png)

- åœ¨è¿™äº›æ—¶å€™ï¼Œç®—ç›˜æ²¡åˆ©ç”¨èµ·æ¥ï¼ˆä¸èƒ½æ”¶é’±äº†ï¼‰ï¼Œè€ç‹è§‰å¾—æœ‰ç‚¹ä¸åˆ’ç®—
- å¦å¤–ï¼Œå°å¥³ä¹Ÿæƒ³ç”¨ç”¨ç®—ç›˜ï¼Œå¦‚æœæ€»æ˜¯å°å—å ç€ç®—ç›˜ï¼Œè®©å°å¥³è§‰å¾—ä¸å…¬å¹³
- äºæ˜¯ï¼Œè€ç‹çµæœºä¸€åŠ¨ï¼Œæƒ³äº†ä¸ªåŠæ³• [ è®©ä»–ä»¬æ¯äººç”¨ä¸€ä¼šï¼Œè½®æµä½¿ç”¨ç®—ç›˜ ]
- è¿™æ ·ï¼Œå½“å°å—é˜»å¡çš„æ—¶å€™ï¼Œç®—ç›˜å¯ä»¥åˆ†ç»™å°å¥³ä½¿ç”¨ï¼Œä¸ä¼šæµªè´¹ï¼Œåä¹‹äº¦ç„¶
- æœ€è¿‘æ‰§è¡Œçš„è®¡ç®—æ¯”è¾ƒå¤æ‚ï¼Œéœ€è¦å­˜å‚¨ä¸€äº›ä¸­é—´ç»“æœï¼Œè€Œå­¦ç”Ÿä»¬çš„è„‘å®¹é‡ï¼ˆå·¥ä½œå†…å­˜ï¼‰ä¸å¤Ÿï¼Œæ‰€ä»¥è€ç‹ç”³è¯·äº† ä¸€ä¸ªç¬”è®°æœ¬ï¼ˆä¸»å­˜ï¼‰ï¼ŒæŠŠä¸€äº›ä¸­é—´ç»“æœå…ˆè®°åœ¨æœ¬ä¸Š
- è®¡ç®—æµç¨‹æ˜¯è¿™æ ·çš„
- ![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162211853.png)

- ä½†æ˜¯ç”±äºåˆ†æ—¶ç³»ç»Ÿï¼Œæœ‰ä¸€å¤©è¿˜æ˜¯å‘ç”Ÿäº†äº‹æ•…
- å°å—åˆšè¯»å–äº†åˆå§‹å€¼ 0 åšäº†ä¸ª +1 è¿ç®—ï¼Œè¿˜æ²¡æ¥å¾—åŠå†™å›ç»“æœ
- è€ç‹è¯´ [ å°å—ï¼Œä½ çš„æ—¶é—´åˆ°äº†ï¼Œè¯¥åˆ«äººäº†ï¼Œè®°ä½ç»“æœèµ°å§ ]ï¼Œäºæ˜¯å°å—å¿µå¨ç€ [ ç»“æœæ˜¯1ï¼Œç»“æœæ˜¯1...] ä¸ç”˜å¿ƒåœ° åˆ°ä¸€è¾¹å¾…ç€å»äº†ï¼ˆä¸Šä¸‹æ–‡åˆ‡æ¢ï¼‰
- è€ç‹è¯´ [ å°å¥³ï¼Œè¯¥ä½ äº† ]ï¼Œå°å¥³çœ‹åˆ°äº†ç¬”è®°æœ¬ä¸Šè¿˜å†™ç€ 0 åšäº†ä¸€ä¸ª -1 è¿ç®—ï¼Œå°†ç»“æœ -1 å†™å…¥ç¬”è®°æœ¬
- è¿™æ—¶å°å¥³çš„æ—¶é—´ä¹Ÿç”¨å®Œäº†ï¼Œè€ç‹åˆå«é†’äº†å°å—ï¼š[å°å—ï¼ŒæŠŠä½ ä¸Šæ¬¡çš„é¢˜ç›®ç®—å®Œå§]ï¼Œå°å—å°†ä»–è„‘æµ·ä¸­çš„ç»“æœ 1 å†™ å…¥äº†ç¬”è®°æœ¬
- ![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162211419.png)

- å°å—å’Œå°å¥³éƒ½è§‰å¾—è‡ªå·±æ²¡åšé”™ï¼Œä½†ç¬”è®°æœ¬é‡Œçš„ç»“æœæ˜¯ 1 è€Œä¸æ˜¯ 0



### 1. java ä½“ç°

ä¸¤ä¸ªçº¿ç¨‹å¯¹åˆå§‹å€¼ä¸º 0 çš„é™æ€å˜é‡ä¸€ä¸ªåšè‡ªå¢ï¼Œä¸€ä¸ªåšè‡ªå‡ï¼Œå„åš 5000 æ¬¡ï¼Œç»“æœæ˜¯ 0 å—ï¼Ÿ

```java
static int counter = 0;
public static void main(String[] args) throws InterruptedException {
    Thread t1 = new Thread(() -> {
        for (int i = 0; i < 5000; i++) {
            counter++;
        }
    }, "t1");
    Thread t2 = new Thread(() -> {
        for (int i = 0; i < 5000; i++) {
            counter--;
        }
    }, "t2");
    t1.start();
    t2.start();
    t1.join();
    t2.join();
    log.debug("{}",counter);
}
```



### 2. é—®é¢˜åˆ†æ

ä»¥ä¸Šçš„ç»“æœå¯èƒ½æ˜¯æ­£æ•°ã€è´Ÿæ•°ã€é›¶ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸º Java ä¸­å¯¹é™æ€å˜é‡çš„è‡ªå¢ï¼Œè‡ªå‡å¹¶ä¸æ˜¯åŸå­æ“ä½œï¼Œè¦å½»åº•ç† è§£ï¼Œå¿…é¡»ä»å­—èŠ‚ç æ¥è¿›è¡Œåˆ†æ

ä¾‹å¦‚å¯¹äº `i++` è€Œè¨€ï¼ˆi ä¸ºé™æ€å˜é‡ï¼‰ï¼Œå®é™…ä¼šäº§ç”Ÿå¦‚ä¸‹çš„ JVM å­—èŠ‚ç æŒ‡ä»¤ï¼š

```java
getstatic i // è·å–é™æ€å˜é‡içš„å€¼
iconst_1 	// å‡†å¤‡å¸¸é‡1
iadd 		// è‡ªå¢
putstatic i // å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i
```

è€Œå¯¹åº” `i--` ä¹Ÿæ˜¯ç±»ä¼¼ï¼š

```java
getstatic i // è·å–é™æ€å˜é‡içš„å€¼
iconst_1 	// å‡†å¤‡å¸¸é‡1
isub 		// è‡ªå‡
putstatic i // å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i
```

è€Œ Java çš„å†…å­˜æ¨¡å‹å¦‚ä¸‹ï¼Œå®Œæˆé™æ€å˜é‡çš„è‡ªå¢ï¼Œè‡ªå‡éœ€è¦åœ¨ä¸»å­˜å’Œå·¥ä½œå†…å­˜ä¸­è¿›è¡Œæ•°æ®äº¤æ¢ï¼š

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162211534.png)

å¦‚æœæ˜¯å•çº¿ç¨‹ä»¥ä¸Š 8 è¡Œä»£ç æ˜¯é¡ºåºæ‰§è¡Œï¼ˆä¸ä¼šäº¤é”™ï¼‰æ²¡æœ‰é—®é¢˜ï¼š

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162212941.png)

ä½†å¤šçº¿ç¨‹ä¸‹è¿™ 8 è¡Œä»£ç å¯èƒ½äº¤é”™è¿è¡Œï¼š 

å‡ºç°è´Ÿæ•°çš„æƒ…å†µï¼š

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162212532.png)

å‡ºç°æ­£æ•°çš„æƒ…å†µï¼š

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162212998.png)



### 3. ä¸´ç•ŒåŒº Critical Section

- ä¸€ä¸ªç¨‹åºè¿è¡Œå¤šä¸ªçº¿ç¨‹æœ¬èº«æ˜¯æ²¡æœ‰é—®é¢˜çš„
- é—®é¢˜å‡ºåœ¨å¤šä¸ªçº¿ç¨‹è®¿é—®**å…±äº«èµ„æº**
  - å¤šä¸ªçº¿ç¨‹è¯»**å…±äº«èµ„æº**å…¶å®ä¹Ÿæ²¡æœ‰é—®é¢˜
  - åœ¨å¤šä¸ªçº¿ç¨‹å¯¹**å…±äº«èµ„æº**è¯»å†™æ“ä½œæ—¶å‘ç”ŸæŒ‡ä»¤äº¤é”™ï¼Œå°±ä¼šå‡ºç°é—®é¢˜

- ä¸€æ®µä»£ç å—å†…å¦‚æœå­˜åœ¨å¯¹å…±äº«èµ„æºçš„å¤šçº¿ç¨‹è¯»å†™æ“ä½œï¼Œç§°è¿™æ®µä»£ç å—ä¸º**ä¸´ç•ŒåŒº**

ä¾‹å¦‚ï¼Œä¸‹é¢ä»£ç ä¸­çš„ä¸´ç•ŒåŒº

```java
static int counter = 0;
static void increment() 
    // ä¸´ç•ŒåŒº
{ 
    counter++;
}
static void decrement() 
    // ä¸´ç•ŒåŒº
{ 
    counter--;
}
```



### 4. ç«æ€æ¡ä»¶ Race Condition

å¤šä¸ªçº¿ç¨‹åœ¨ä¸´ç•ŒåŒºå†…æ‰§è¡Œï¼Œç”±äºä»£ç çš„**æ‰§è¡Œåºåˆ—ä¸åŒ**è€Œå¯¼è‡´ç»“æœæ— æ³•é¢„æµ‹ï¼Œç§°ä¹‹ä¸ºå‘ç”Ÿäº†**ç«æ€æ¡ä»¶**





## 2.  synchronized å…³é”®å­—

ä¸ºäº†é¿å…ä¸´ç•ŒåŒºä¸­çš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼Œç”±å¤šç§æ‰‹æ®µå¯ä»¥è¾¾åˆ°

- é˜»å¡å¼è§£å†³æ–¹æ¡ˆï¼šsynchronized ï¼ŒLock
- éé˜»å¡å¼è§£å†³æ–¹æ¡ˆï¼šåŸå­å˜é‡

æœ¬æ¬¡è¯¾ä½¿ç”¨é˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šsynchronizedï¼Œæ¥è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œå³ä¿—ç§°çš„ã€å¯¹è±¡é”ã€‘ï¼Œå®ƒé‡‡ç”¨äº’æ–¥çš„æ–¹å¼è®©åŒä¸€ æ—¶åˆ»è‡³å¤šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰ã€å¯¹è±¡é”ã€‘ï¼Œå…¶å®ƒçº¿ç¨‹å†æƒ³è·å–è¿™ä¸ªã€å¯¹è±¡é”ã€‘æ—¶å°±ä¼šé˜»å¡ä½ã€‚è¿™æ ·å°±èƒ½ä¿è¯æ‹¥æœ‰é” çš„çº¿ç¨‹å¯ä»¥å®‰å…¨çš„æ‰§è¡Œä¸´ç•ŒåŒºå†…çš„ä»£ç ï¼Œä¸ç”¨æ‹…å¿ƒçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢

> æ³¨æ„
>
> è™½ç„¶ java ä¸­äº’æ–¥å’ŒåŒæ­¥éƒ½å¯ä»¥é‡‡ç”¨ synchronized å…³é”®å­—æ¥å®Œæˆï¼Œä½†å®ƒä»¬è¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼š
>
> - äº’æ–¥æ˜¯ä¿è¯ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä¸´ç•ŒåŒºä»£ç 
> - åŒæ­¥æ˜¯ç”±äºçº¿ç¨‹æ‰§è¡Œçš„å…ˆåã€é¡ºåºä¸åŒã€éœ€è¦ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å…¶å®ƒçº¿ç¨‹è¿è¡Œåˆ°æŸä¸ªç‚¹



### 1. synchronized é”å¯¹è±¡

**è¯­æ³•**

```java
synchronized(å¯¹è±¡) // çº¿ç¨‹1ï¼Œ çº¿ç¨‹2(blocked)
{
    ä¸´ç•ŒåŒº
}
```



**è§£å†³**

```java
static int counter = 0;
static final Object lock = new Object();
public static void main(String[] args) throws InterruptedException {
    Thread t1 = new Thread(() -> {
        for (int i = 0; i < 5000; i++) {
            synchronized (lock) {
                counter++;
            }
        }
    }, "t1");
    Thread t2 = new Thread(() -> {
        for (int i = 0; i < 5000; i++) {
            synchronized (lock) {
                counter--;
            }
        }
    }, "t2");
    t1.start();
    t2.start();
    t1.join();
    t2.join();
    log.debug("{}",counter);
}
```



**åŸç†ï¼š**

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162212006.png)

ä½ å¯ä»¥åšè¿™æ ·çš„ç±»æ¯”ï¼š

- `synchronized(å¯¹è±¡)` ä¸­çš„å¯¹è±¡ï¼Œå¯ä»¥æƒ³è±¡ä¸ºä¸€ä¸ªæˆ¿é—´ï¼ˆroomï¼‰ï¼Œæœ‰å”¯ä¸€å…¥å£ï¼ˆé—¨ï¼‰æˆ¿é—´åªèƒ½ä¸€æ¬¡è¿›å…¥ä¸€äºº è¿›è¡Œè®¡ç®—ï¼Œçº¿ç¨‹ t1ï¼Œt2 æƒ³è±¡æˆä¸¤ä¸ªäºº
- å½“çº¿ç¨‹ t1 æ‰§è¡Œåˆ° `synchronized(room)` æ—¶å°±å¥½æ¯” t1 è¿›å…¥äº†è¿™ä¸ªæˆ¿é—´ï¼Œå¹¶é”ä½äº†é—¨æ‹¿èµ°äº†é’¥åŒ™ï¼Œåœ¨é—¨å†…æ‰§è¡Œ `count++` ä»£ç 
- è¿™æ—¶å€™å¦‚æœ t2 ä¹Ÿè¿è¡Œåˆ°äº† `synchronized(room)` æ—¶ï¼Œå®ƒå‘ç°é—¨è¢«é”ä½äº†ï¼Œåªèƒ½åœ¨é—¨å¤–ç­‰å¾…ï¼Œå‘ç”Ÿäº†ä¸Šä¸‹æ–‡åˆ‡ æ¢ï¼Œé˜»å¡ä½äº†
- è¿™ä¸­é—´å³ä½¿ t1 çš„ cpu æ—¶é—´ç‰‡ä¸å¹¸ç”¨å®Œï¼Œè¢«è¸¢å‡ºäº†é—¨å¤–ï¼ˆä¸è¦é”™è¯¯ç†è§£ä¸ºé”ä½äº†å¯¹è±¡å°±èƒ½ä¸€ç›´æ‰§è¡Œä¸‹å»å“¦ï¼‰ï¼Œ è¿™æ—¶é—¨è¿˜æ˜¯é”ä½çš„ï¼Œt1 ä»æ‹¿ç€é’¥åŒ™ï¼Œt2 çº¿ç¨‹è¿˜åœ¨é˜»å¡çŠ¶æ€è¿›ä¸æ¥ï¼Œåªæœ‰ä¸‹æ¬¡è½®åˆ° t1è‡ªå·±å†æ¬¡è·å¾—æ—¶é—´ç‰‡æ—¶æ‰ èƒ½å¼€é—¨è¿›å…¥
- å½“ t1 æ‰§è¡Œå®Œ `synchronized{}` å—å†…çš„ä»£ç ï¼Œè¿™æ—¶å€™æ‰ä¼šä» obj æˆ¿é—´å‡ºæ¥å¹¶è§£å¼€é—¨ä¸Šçš„é”ï¼Œå”¤é†’ t2 çº¿ç¨‹æŠŠé’¥ åŒ™ç»™ä»–ã€‚t2 çº¿ç¨‹è¿™æ—¶æ‰å¯ä»¥è¿›å…¥ obj æˆ¿é—´ï¼Œé”ä½äº†é—¨æ‹¿ä¸Šé’¥åŒ™ï¼Œæ‰§è¡Œå®ƒçš„ `count--` ä»£ç 



**ç”¨å›¾æ¥è¡¨ç¤º**

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162213237.png)



==**æ€è€ƒ**==

synchronized å®é™…æ˜¯ç”¨**å¯¹è±¡é”**ä¿è¯äº†**==ä¸´ç•ŒåŒºå†…ä»£ç ==**çš„åŸå­æ€§ï¼Œä¸´ç•ŒåŒºå†…çš„ä»£ç å¯¹å¤–æ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œä¸ä¼šè¢«çº¿ç¨‹åˆ‡ æ¢æ‰€æ‰“æ–­ã€‚

ä¸ºäº†åŠ æ·±ç†è§£ï¼Œè¯·æ€è€ƒä¸‹é¢çš„é—®é¢˜

- å¦‚æœæŠŠ `synchronized(obj)` æ”¾åœ¨ for å¾ªç¯çš„å¤–é¢ï¼Œå¦‚ä½•ç†è§£ï¼Ÿ					-- åŸå­æ€§
- å¦‚æœ t1 `synchronized(obj1)` è€Œ t2 `synchronized(obj2)` ä¼šæ€æ ·è¿ä½œï¼Ÿ  -- é”å¯¹è±¡
- å¦‚æœ t1 `synchronized(obj)` è€Œ t2 æ²¡æœ‰åŠ ä¼šæ€ä¹ˆæ ·ï¼Ÿå¦‚ä½•ç†è§£ï¼Ÿ                 -- é”å¯¹è±¡



**é¢å‘å¯¹è±¡æ”¹è¿›**

 ```java
 class Room {
     int value = 0;
     public void increment() {
         synchronized (this) {
             value++;
         }
     }
     public void decrement() {
         synchronized (this) {
             value--;
         }
     }
     public int get() {
         synchronized (this) {
             return value;
         }
     }
 }
 @Slf4j
 public class Test1 {
 
     public static void main(String[] args) throws InterruptedException {
         Room room = new Room();
         Thread t1 = new Thread(() -> {
             for (int j = 0; j < 5000; j++) {
                 room.increment();
             }
         }, "t1");
         Thread t2 = new Thread(() -> {
             for (int j = 0; j < 5000; j++) {
                 room.decrement();
             }
         }, "t2");
         t1.start();
         t2.start();
         t1.join();
         t2.join();
         log.debug("count: {}" , room.get());
     }
 }
 ```



### 2. synchronized é”æ–¹æ³•

#### 1. æˆå‘˜æ–¹æ³•

```java
class Test{
    public synchronized void test() {

    }
}
/// ç­‰ä»·äº
class Test{
    public void test() {
        synchronized(this) {

        }
    }
}
```



#### 2. ç±»æ–¹æ³•

 ```java
 class Test{
     public synchronized static void test() {
     }
 }
 // ç­‰ä»·äº
 class Test{
     public static void test() {
         synchronized(Test.class) {
 
         }
     }
 }
 ```



#### 3. ä¸åŠ  synchronized çš„æ–¹æ³•

ä¸åŠ  synchronzied çš„æ–¹æ³•å°±å¥½æ¯”ä¸éµå®ˆè§„åˆ™çš„äººï¼Œä¸å»è€å®æ’é˜Ÿï¼ˆå¥½æ¯”ç¿»çª—æˆ·è¿›å»çš„ï¼‰





### 3. çº¿ç¨‹å…«é”

æ‰€è°“çš„ **â€œçº¿ç¨‹å…«é”â€**ï¼Œå…¶å®å°±æ˜¯è€ƒå¯Ÿ synchronized é”ä½çš„æ˜¯å“ªä¸ªå¯¹è±¡

**æƒ…å†µ1ï¼š<u>12 æˆ– 21</u>**

```java
@Slf4j(topic = "c.Number")
class Number{
    public synchronized void a() {
        log.debug("1");
    }
    public synchronized void b() {
        log.debug("2");
    }
}
public static void main(String[] args) {
    Number n1 = new Number();
    new Thread(()->{ n1.a(); }).start();
    new Thread(()->{ n1.b(); }).start();
}
```



**æƒ…å†µ2ï¼š<u>1så12ï¼Œæˆ– 2 1så 1</u>**

```java
@Slf4j(topic = "c.Number")
class Number{
    public synchronized void a() {
        sleep(1);
        log.debug("1");
    }
    public synchronized void b() {
        log.debug("2");
    }
}
public static void main(String[] args) {
    Number n1 = new Number();
    new Thread(()->{ n1.a(); }).start();
    new Thread(()->{ n1.b(); }).start();
}
```



**æƒ…å†µ3ï¼š<u>3 1s 12 æˆ– 23 1s 1 æˆ– 32 1s 1</u>**

```java
@Slf4j(topic = "c.Number")
class Number{
    public synchronized void a() {
        sleep(1);
        log.debug("1");
    }
    public synchronized void b() {
        log.debug("2");
    }
    public void c() {
        log.debug("3");
    }
}
public static void main(String[] args) {
    Number n1 = new Number();
    new Thread(()->{ n1.a(); }).start();
    new Thread(()->{ n1.b(); }).start();
    new Thread(()->{ n1.c(); }).start();
}
```



**æƒ…å†µ4ï¼š<u>2 1s å 1</u>**

```java
@Slf4j(topic = "c.Number")
class Number{
    public synchronized void a() {
        sleep(1);
        log.debug("1");
    }
    public synchronized void b() {
        log.debug("2");
    }
}
public static void main(String[] args) {
    Number n1 = new Number();
    Number n2 = new Number();
    new Thread(()->{ n1.a(); }).start();
    new Thread(()->{ n2.b(); }).start();
}
```



**æƒ…å†µ5ï¼š<u>2 1s å 1</u>**

```java
@Slf4j(topic = "c.Number")
class Number{
    public static synchronized void a() {
        sleep(1);
        log.debug("1");
    }
    public synchronized void b() {
        log.debug("2");
    }
}
public static void main(String[] args) {
    Number n1 = new Number();
    new Thread(()->{ n1.a(); }).start();
    new Thread(()->{ n1.b(); }).start();
}
```



**æƒ…å†µ6ï¼š<u>1s å12ï¼Œ æˆ– 2 1så 1</u>**

```java
@Slf4j(topic = "c.Number")
class Number{
    public static synchronized void a() {
        sleep(1);
        log.debug("1");
    }
    public static synchronized void b() {
        log.debug("2");
    }
}
public static void main(String[] args) {
    Number n1 = new Number();
    new Thread(()->{ n1.a(); }).start();
    new Thread(()->{ n1.b(); }).start();
}

```



**æƒ…å†µ7ï¼š<u>2 1s å 1</u>**

```java
@Slf4j(topic = "c.Number")
class Number{
    public static synchronized void a() {
        sleep(1);
        log.debug("1");
    }
    public synchronized void b() {
        log.debug("2");
    }
}
public static void main(String[] args) {
    Number n1 = new Number();
    Number n2 = new Number();
    new Thread(()->{ n1.a(); }).start();
    new Thread(()->{ n2.b(); }).start();
}

```



**æƒ…å†µ8ï¼š<u>1s å12ï¼Œ æˆ– 2 1så 1</u>**

```java
@Slf4j(topic = "c.Number")
class Number{
    public static synchronized void a() {
        sleep(1);
        log.debug("1");
    }
    public static synchronized void b() {
        log.debug("2");
    }
}
public static void main(String[] args) {
    Number n1 = new Number();
    Number n2 = new Number();
    new Thread(()->{ n1.a(); }).start();
    new Thread(()->{ n2.b(); }).start();
}
```





## 3. å˜é‡çš„çº¿ç¨‹å®‰å…¨åˆ†æ

### 1. æˆå‘˜å˜é‡å’Œé™æ€å˜é‡çº¿ç¨‹å®‰å…¨åˆ†æ

- å¦‚æœå®ƒä»¬æ²¡æœ‰å…±äº«ï¼Œåˆ™çº¿ç¨‹å®‰å…¨
- å¦‚æœå®ƒä»¬è¢«å…±äº«äº†ï¼Œæ ¹æ®å®ƒä»¬çš„çŠ¶æ€æ˜¯å¦èƒ½å¤Ÿæ”¹å˜ï¼Œåˆåˆ†ä¸¤ç§æƒ…å†µ
  - å¦‚æœåªæœ‰è¯»æ“ä½œï¼Œåˆ™çº¿ç¨‹å®‰å…¨
  - å¦‚æœæœ‰è¯»å†™æ“ä½œï¼Œåˆ™è¿™æ®µä»£ç æ˜¯ä¸´ç•ŒåŒºï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨



### 2. å±€éƒ¨å˜é‡çº¿ç¨‹å®‰å…¨åˆ†æ

- å±€éƒ¨å˜é‡æ˜¯çº¿ç¨‹å®‰å…¨çš„
- ä½†å±€éƒ¨å˜é‡å¼•ç”¨çš„å¯¹è±¡åˆ™æœªå¿…
  - å¦‚æœè¯¥å¯¹è±¡æ²¡æœ‰é€ƒç¦»æ–¹æ³•çš„ä½œç”¨è®¿é—®ï¼Œå®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„
  - å¦‚æœè¯¥å¯¹è±¡é€ƒç¦»æ–¹æ³•çš„ä½œç”¨èŒƒå›´ï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨



#### 1. çº¿ç¨‹å®‰å…¨æƒ…å†µ

æ¯ä¸ªçº¿ç¨‹è°ƒç”¨ test1() æ–¹æ³•æ—¶å±€éƒ¨å˜é‡ iï¼Œä¼šåœ¨æ¯ä¸ªçº¿ç¨‹çš„æ ˆå¸§å†…å­˜ä¸­è¢«åˆ›å»ºå¤šä»½ï¼Œå› æ­¤ä¸å­˜åœ¨å…±äº«

```java
public static void test1() {
    int i = 10;
    i++;
}
```

```shell
# å­—èŠ‚ç æŒ‡ä»¤
public static void test1();
descriptor: ()V
flags: ACC_PUBLIC, ACC_STATIC
Code:
stack=1, locals=1, args_size=0
0: bipush 10
2: istore_0
3: iinc 0, 1
6: return
LineNumberTable:
line 10: 0
line 11: 3
line 12: 6
LocalVariableTable:
Start Length Slot Name Signature
3 4 0 i I
```

å¦‚å›¾ï¼š

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162213824.png)



#### 2. çº¿ç¨‹ä¸å®‰å…¨æƒ…å†µ

å¦‚æœè¯¥å¯¹è±¡é€ƒç¦»æ–¹æ³•çš„ä½œç”¨èŒƒå›´ï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨

```java
class ThreadUnsafe {
    ArrayList<String> list = new ArrayList<>();
    public void method1(int loopNumber) {
        for (int i = 0; i < loopNumber; i++) {
            // { ä¸´ç•ŒåŒº, ä¼šäº§ç”Ÿç«æ€æ¡ä»¶
            method2();
            method3();
            // } ä¸´ç•ŒåŒº
        }
    }
    private void method2() {
        list.add("1");
    }
    private void method3() {
        list.remove(0);
    }
}
```

æ‰§è¡Œ

```java
static final int THREAD_NUMBER = 2;
static final int LOOP_NUMBER = 200;
public static void main(String[] args) {
    ThreadUnsafe test = new ThreadUnsafe();
    for (int i = 0; i < THREAD_NUMBER; i++) {
        new Thread(() -> {
            test.method1(LOOP_NUMBER);
        }, "Thread" + i).start();
    }
}
```

å…¶ä¸­ä¸€ç§æƒ…å†µæ˜¯ï¼Œå¦‚æœçº¿ç¨‹2 è¿˜æœª addï¼Œçº¿ç¨‹1 remove å°±ä¼šæŠ¥é”™



**åˆ†æï¼š**

- æ— è®ºå“ªä¸ªçº¿ç¨‹ä¸­çš„ method2 å¼•ç”¨çš„éƒ½æ˜¯åŒä¸€ä¸ªå¯¹è±¡ä¸­çš„ list æˆå‘˜å˜é‡
- method3 ä¸ method2 åˆ†æç›¸åŒ

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162213911.png)





**å°† list ä¿®æ”¹ä¸ºå±€éƒ¨å˜é‡**

```java
class ThreadSafe {
    public final void method1(int loopNumber) {
        ArrayList<String> list = new ArrayList<>();
        for (int i = 0; i < loopNumber; i++) {
            method2(list);
            method3(list);
        }
    }
    private void method2(ArrayList<String> list) {
        list.add("1");
    }
    private void method3(ArrayList<String> list) {
        list.remove(0);
    }
}
```

åˆ†æï¼š

- list æ˜¯å±€éƒ¨å˜é‡ï¼Œæ¯ä¸ªçº¿ç¨‹è°ƒç”¨æ—¶ä¼šåˆ›å»ºå…¶ä¸åŒå®ä¾‹ï¼Œæ²¡æœ‰å…±äº«
- è€Œ method2 çš„å‚æ•°æ˜¯ä» method1 ä¸­ä¼ é€’è¿‡æ¥çš„ï¼Œä¸ method1 ä¸­å¼•ç”¨åŒä¸€ä¸ªå¯¹è±¡
- method3 çš„å‚æ•°åˆ†æä¸ method2 ç›¸åŒ

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162213503.png)



æ–¹æ³•è®¿é—®ä¿®é¥°ç¬¦å¸¦æ¥çš„æ€è€ƒï¼Œå¦‚æœæŠŠ method2 å’Œ method3 çš„æ–¹æ³•ä¿®æ”¹ä¸º public ä¼šä¸ä¼šä»£ç†çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿ

- æƒ…å†µ1ï¼šæœ‰å…¶å®ƒçº¿ç¨‹è°ƒç”¨ method2 å’Œ method3
- æƒ…å†µ2ï¼šåœ¨ æƒ…å†µ1 çš„åŸºç¡€ä¸Šï¼Œä¸º ThreadSafe ç±»æ·»åŠ å­ç±»ï¼Œå­ç±»è¦†ç›– method2 æˆ– method3 æ–¹æ³•

```java
class ThreadSafe {
    public final void method1(int loopNumber) {
        ArrayList<String> list = new ArrayList<>();
        for (int i = 0; i < loopNumber; i++) {
            method2(list);
            method3(list);
        }
    }
    private void method2(ArrayList<String> list) {
        list.add("1");
    }
    private void method3(ArrayList<String> list) {
        list.remove(0);
    }
}
class ThreadSafeSubClass extends ThreadSafe{
    @Override
    public void method3(ArrayList<String> list) {
        new Thread(() -> {
            list.remove(0);
        }).start();
    }
}
```

> ä»è¿™ä¸ªä¾‹å­å¯ä»¥çœ‹å‡º private æˆ– final æä¾›ã€å®‰å…¨ã€‘çš„æ„ä¹‰æ‰€åœ¨ï¼Œè¯·ä½“ä¼šå¼€é—­åŸåˆ™ä¸­çš„ã€é—­ã€‘





### 3. å¸¸è§çº¿ç¨‹å®‰å…¨ç±»

- String
- Integer
- StringBuffer
- Random
- Vector
- Hashtable
- java.util.concurrent åŒ…ä¸‹çš„ç±»

è¿™é‡Œè¯´å®ƒä»¬æ˜¯çº¿ç¨‹å®‰å…¨çš„æ˜¯æŒ‡ï¼Œå¤šä¸ªçº¿ç¨‹è°ƒç”¨å®ƒä»¬åŒä¸€ä¸ªå®ä¾‹çš„æŸä¸ªæ–¹æ³•æ—¶ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ä¹Ÿå¯ä»¥ç†è§£ä¸º

```java
Hashtable table = new Hashtable();
new Thread(()->{
    table.put("key", "value1");
}).start();
new Thread(()->{
    table.put("key", "value2");
}).start();
```

- å®ƒä»¬çš„æ¯ä¸ªæ–¹æ³•æ˜¯åŸå­çš„
- ä½†æ³¨æ„å®ƒä»¬å¤šä¸ªæ–¹æ³•çš„ç»„åˆä¸æ˜¯åŸå­çš„ï¼Œè§åé¢åˆ†æ



#### 1. çº¿ç¨‹å®‰å…¨ç±»æ–¹æ³•çš„ç»„åˆ

åˆ†æä¸‹é¢ä»£ç æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ

 ```java
 Hashtable table = new Hashtable();
 // çº¿ç¨‹1ï¼Œçº¿ç¨‹2
 if( table.get("key") == null) {
     table.put("key", value);
 }
 ```

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162214027.png)



#### 2. ä¸å¯å˜ç±»çº¿ç¨‹å®‰å…¨æ€§

`String`ã€`Integer` ç­‰éƒ½æ˜¯ä¸å¯å˜ç±»ï¼Œå› ä¸ºå…¶å†…éƒ¨çš„çŠ¶æ€ä¸å¯ä»¥æ”¹å˜ï¼Œå› æ­¤å®ƒä»¬çš„æ–¹æ³•éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„

æœ‰åŒå­¦æˆ–è®¸æœ‰ç–‘é—®ï¼Œ`String` æœ‰ `replace`ï¼Œ`substring` ç­‰æ–¹æ³•ã€å¯ä»¥ã€‘æ”¹å˜å€¼å•Šï¼Œé‚£ä¹ˆè¿™äº›æ–¹æ³•åˆæ˜¯å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰ å…¨çš„å‘¢ï¼Ÿ

```java
public class Immutable{
    private int value = 0;
    public Immutable(int value){
        this.value = value;
    }
    public int getValue(){
        return this.value;
    }

    public Immutable add(int v){
        return new Immutable(this.value + v);
    } 
}
```





### 4. å®ä¾‹åˆ†æ

**ä¾‹1ï¼š**

```java
public class MyServlet extends HttpServlet {
    // æ˜¯å¦å®‰å…¨ï¼Ÿ
    Map<String,Object> map = new HashMap<>();
    // æ˜¯å¦å®‰å…¨ï¼Ÿ
    String S1 = "...";
    // æ˜¯å¦å®‰å…¨ï¼Ÿ
    final String S2 = "...";
    // æ˜¯å¦å®‰å…¨ï¼Ÿ
    Date D1 = new Date();
    // æ˜¯å¦å®‰å…¨ï¼Ÿ
    final Date D2 = new Date();

    public void doGet(HttpServletRequest request, HttpServletResponse response) {
        // ä½¿ç”¨ä¸Šè¿°å˜é‡
    }
}

```



**ä¾‹2ï¼š**

```java
public class MyServlet extends HttpServlet {
    // æ˜¯å¦å®‰å…¨ï¼Ÿ
    private UserService userService = new UserServiceImpl();

    public void doGet(HttpServletRequest request, HttpServletResponse response) {
        userService.update(...);
    }
}
public class UserServiceImpl implements UserService {
    // è®°å½•è°ƒç”¨æ¬¡æ•°
    private int count = 0;

    public void update() {
        // ...
        count++;
    }
}
```



**ä¾‹3ï¼š**

```java
@Aspect
@Component
public class MyAspect {
    // æ˜¯å¦å®‰å…¨ï¼Ÿ
    private long start = 0L;

    @Before("execution(* *(..))")
    public void before() {
        start = System.nanoTime();
    }

    @After("execution(* *(..))")
    public void after() {
        long end = System.nanoTime();
        System.out.println("cost time:" + (end-start));
    }
}
```



**ä¾‹4ï¼š**

```java
public class MyServlet extends HttpServlet {
    // æ˜¯å¦å®‰å…¨
    private UserService userService = new UserServiceImpl();

    public void doGet(HttpServletRequest request, HttpServletResponse response) {
        userService.update(...);
    }
}
public class UserServiceImpl implements UserService {
    // æ˜¯å¦å®‰å…¨
    private UserDao userDao = new UserDaoImpl();

    public void update() {
        userDao.update();
    }
}
public class UserDaoImpl implements UserDao { 
    public void update() {
        String sql = "update user set password = ? where username = ?";
        // æ˜¯å¦å®‰å…¨
        try (Connection conn = DriverManager.getConnection("","","")){
            // ...
        } catch (Exception e) {
            // ...
        }
    }
}
```



**ä¾‹5ï¼š**

```java
public class MyServlet extends HttpServlet {
    // æ˜¯å¦å®‰å…¨
    private UserService userService = new UserServiceImpl();

    public void doGet(HttpServletRequest request, HttpServletResponse response) {
        userService.update(...);
    }
}
public class UserServiceImpl implements UserService {
    // æ˜¯å¦å®‰å…¨
    private UserDao userDao = new UserDaoImpl();

    public void update() {
        userDao.update();
    }
}
public class UserDaoImpl implements UserDao {
    // æ˜¯å¦å®‰å…¨
    private Connection conn = null;
    public void update() throws SQLException {
        String sql = "update user set password = ? where username = ?";
        conn = DriverManager.getConnection("","","");
        // ...
        conn.close();
    }
}
```



**ä¾‹6ï¼š**

```java
public class MyServlet extends HttpServlet {
    // æ˜¯å¦å®‰å…¨
    private UserService userService = new UserServiceImpl();

    public void doGet(HttpServletRequest request, HttpServletResponse response) {
        userService.update(...);
    }
}
public class UserServiceImpl implements UserService { 
    public void update() {
        UserDao userDao = new UserDaoImpl();
        userDao.update();
    }
}
public class UserDaoImpl implements UserDao {
    // æ˜¯å¦å®‰å…¨
    private Connection = null;
    public void update() throws SQLException {
        String sql = "update user set password = ? where username = ?";
        conn = DriverManager.getConnection("","","");
        // ...
        conn.close();
    }
}

```



**ä¾‹7ï¼š**

```java
public abstract class Test {

    public void bar() {
        // æ˜¯å¦å®‰å…¨
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
        foo(sdf);
    }

    public abstract foo(SimpleDateFormat sdf);


    public static void main(String[] args) {
        new Test().bar();
    }
}
```

å…¶ä¸­ foo çš„è¡Œä¸ºæ˜¯ä¸ç¡®å®šçš„ï¼Œå¯èƒ½å¯¼è‡´ä¸å®‰å…¨çš„å‘ç”Ÿï¼Œè¢«ç§°ä¹‹ä¸º**å¤–æ˜Ÿæ–¹æ³•**

```java
public void foo(SimpleDateFormat sdf) {
    String dateStr = "1999-10-11 00:00:00";
    for (int i = 0; i < 20; i++) {
        new Thread(() -> {
            try {
                sdf.parse(dateStr);
            } catch (ParseException e) {
                e.printStackTrace();
            }
        }).start();
    }
}
```

è¯·æ¯”è¾ƒ JDK ä¸­ String ç±»çš„å®ç°



**ä¾‹8ï¼š**

```java
private static Integer i = 0;
public static void main(String[] args) throws InterruptedException {
    List<Thread> list = new ArrayList<>();
    for (int j = 0; j < 2; j++) {
        Thread thread = new Thread(() -> {
            for (int k = 0; k < 5000; k++) {
                synchronized (i) {
                    i++;
                }
            }
        }, "" + j);
        list.add(thread);
    }
    list.stream().forEach(t -> t.start());
    list.stream().forEach(t -> {
        try {
            t.join();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    });
    log.debug("{}", i);
}
```





### 5. ä¹ é¢˜åˆ†æ

#### 1. å–ç¥¨ç»ƒä¹ 

```java
public class ExerciseSell {
    public static void main(String[] args) {
        TicketWindow ticketWindow = new TicketWindow(2000);
        List<Thread> list = new ArrayList<>();
        // ç”¨æ¥å­˜å‚¨ä¹°å‡ºå»å¤šå°‘å¼ ç¥¨
        List<Integer> sellCount = new Vector<>();
        for (int i = 0; i < 2000; i++) {
            Thread t = new Thread(() -> {
                // åˆ†æè¿™é‡Œçš„ç«æ€æ¡ä»¶
                int count = ticketWindow.sell(randomAmount());
                sellCount.add(count);
            });
            list.add(t);
            t.start();
        }
        list.forEach((t) -> {
            try {
                t.join();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        });
        // ä¹°å‡ºå»çš„ç¥¨æ±‚å’Œ
        log.debug("selled count:{}",sellCount.stream().mapToInt(c -> c).sum());
        // å‰©ä½™ç¥¨æ•°
        log.debug("remainder count:{}", ticketWindow.getCount());
    }
    // Random ä¸ºçº¿ç¨‹å®‰å…¨
    static Random random = new Random();
    // éšæœº 1~5
    public static int randomAmount() {
        return random.nextInt(5) + 1;
    }
}
class TicketWindow {
    private int count;
    public TicketWindow(int count) {
        this.count = count;
    }
    public int getCount() {
        return count;
    }
    public int sell(int amount) {
        if (this.count >= amount) {
            this.count -= amount;
            return amount;
        } else {
            return 0;
        }
    }
}
```

å¦å¤–ï¼Œç”¨ä¸‹é¢çš„ä»£ç è¡Œä¸è¡Œï¼Œä¸ºä»€ä¹ˆï¼ŸArrayList éçº¿ç¨‹å®‰å…¨

```java
List<Integer> sellCount = new ArrayList<>();
```



#### 2. è½¬è´¦ç»ƒä¹ 

 ```java
 public class ExerciseTransfer {
     public static void main(String[] args) throws InterruptedException {
         Account a = new Account(1000);
         Account b = new Account(1000);
         Thread t1 = new Thread(() -> {
             for (int i = 0; i < 1000; i++) {
                 a.transfer(b, randomAmount());
             }
         }, "t1");
         Thread t2 = new Thread(() -> {
             for (int i = 0; i < 1000; i++) {
                 b.transfer(a, randomAmount());
             }
         }, "t2");
         t1.start();
         t2.start();
         t1.join();
         t2.join();
         // æŸ¥çœ‹è½¬è´¦2000æ¬¡åçš„æ€»é‡‘é¢
         log.debug("total:{}",(a.getMoney() + b.getMoney()));
     }
     // Random ä¸ºçº¿ç¨‹å®‰å…¨
     static Random random = new Random();
     // éšæœº 1~100
     public static int randomAmount() {
         return random.nextInt(100) +1;
     }
 }
 class Account {
     private int money;
     public Account(int money) {
         this.money = money;
     }
     public int getMoney() {
         return money;
     }
     public void setMoney(int money) {
         this.money = money;
     }
     public void transfer(Account target, int amount) {
         synchronized(Account.class) {
             if (this.money >= amount) {
                 this.setMoney(this.getMoney() - amount);
                 target.setMoney(target.getMoney() + amount);
             }
         }
     }
 }
 ```

è¿™æ ·æ”¹æ­£è¡Œä¸è¡Œï¼Œä¸ºä»€ä¹ˆï¼Ÿä¸èƒ½ï¼Œé”çš„æ˜¯ thisï¼Œå¯¹ target æ²¡ä½œç”¨

```java
public synchronized void transfer(Account target, int amount) {
    if (this.money > amount) {
        this.setMoney(this.getMoney() - amount);
        target.setMoney(target.getMoney() + amount);
    }
}
```





## 4. Monitor æ¦‚å¿µ

### 1. å¯¹è±¡å†…å­˜å¸ƒå±€å’Œå¤´ğŸ’¦

#### 1. å¯¹è±¡å†…å­˜å¸ƒå±€

åœ¨HotSpotè™šæ‹Ÿæœºé‡Œï¼Œå¯¹è±¡åœ¨å †å†…å­˜ä¸­çš„å­˜å‚¨å¸ƒå±€å¯ä»¥åˆ’åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†:å¯¹è±¡å¤´ï¼ˆHeader)ã€å®ä¾‹æ•°æ®ï¼ˆ Instance Dataï¼‰å’Œå¯¹é½å¡«å……(Padding) ã€‚

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162215721.png)

![](https://gitlab.com/eardh/picture/-/raw/main/common_img/202207161850410.png)

å¯¹è±¡å†…éƒ¨ç»“æ„åˆ†ä¸ºï¼šå¯¹è±¡å¤´ã€å®ä¾‹æ•°æ®ã€å¯¹é½å¡«å……ï¼ˆä¿è¯8ä¸ªå­—èŠ‚çš„å€æ•°ï¼‰ã€‚ å¯¹è±¡å¤´åˆ†ä¸ºå¯¹è±¡æ ‡è®°ï¼ˆmarkOopï¼‰å’Œç±»å…ƒä¿¡æ¯ï¼ˆklassOopï¼‰ï¼Œç±»å…ƒä¿¡æ¯å­˜å‚¨çš„æ˜¯æŒ‡å‘è¯¥å¯¹è±¡ç±»å…ƒæ•°æ®ï¼ˆklassï¼‰çš„é¦–åœ°å€ã€‚



#### 2. å¯¹è±¡å¤´

<img src="https://gitlab.com/eardh/picture/-/raw/main/common_img/202207161850411.png" style="zoom:50%;" />

##### 1. Mark Work

HotSpotè™šæ‹Ÿæœºå¯¹è±¡å¤´Mark Work

|               å­˜å‚¨å†…å®¹               | æ ‡å¿—ä½ |       çŠ¶æ€       |
| :----------------------------------: | :----: | :--------------: |
|       å¯¹è±¡å“ˆå¸Œç ã€å¯¹è±¡åˆ†ä»£å¹´é¾„       |   01   |      æœªé”å®š      |
|           æŒ‡å‘é”è®°å½•çš„æŒ‡é’ˆ           |   00   |    è½»é‡çº§é”å®š    |
|          æŒ‡å‘é‡é‡çº§é”çš„æŒ‡é’ˆ          |   10   | è†¨èƒ€ï¼ˆé‡é‡çº§é”å®š |
|          ç©ºï¼Œä¸éœ€è¦è®°å½•ä¿¡æ¯          |   11   |      GCæ ‡è®°      |
| åå‘çº¿ç¨‹IDã€åå‘æ—¶é—´æˆ³ã€å¯¹è±¡åˆ†ä»£å¹´é¾„ |   01   |      å¯åå‘      |

![](https://gitlab.com/eardh/picture/-/raw/main/common_img/202207161850412.png)

![](https://gitlab.com/eardh/picture/-/raw/main/common_img/202207161850413.png)

é»˜è®¤å­˜å‚¨å¯¹è±¡çš„HashCodeã€åˆ†ä»£å¹´é¾„å’Œé”æ ‡å¿—ä½ç­‰ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯éƒ½æ˜¯ä¸å¯¹è±¡è‡ªèº«å®šä¹‰æ— å…³çš„æ•°æ®ï¼Œæ‰€ä»¥MarkWordè¢«è®¾è®¡æˆä¸€ä¸ªéå›ºå®šçš„æ•°æ®ç»“æ„ä»¥ä¾¿åœ¨æå°çš„ç©ºé—´å†…å­˜å­˜å‚¨å°½é‡å¤šçš„æ•°æ®ã€‚å®ƒä¼šæ ¹æ®å¯¹è±¡çš„çŠ¶æ€å¤ç”¨è‡ªå·±çš„å­˜å‚¨ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨è¿è¡ŒæœŸé—´MarkWordé‡Œå­˜å‚¨çš„æ•°æ®ä¼šéšç€é”æ ‡å¿—ä½çš„å˜åŒ–è€Œå˜åŒ–ã€‚



##### 2. ç±»å…ƒä¿¡æ¯

![](https://gitlab.com/eardh/picture/-/raw/main/jvm_img/202110242333431.jpg)

å¯¹è±¡æŒ‡å‘å®ƒçš„ç±»å…ƒæ•°æ®çš„æŒ‡é’ˆï¼Œè™šæ‹Ÿæœºé€šè¿‡è¿™ä¸ªæŒ‡é’ˆæ¥ç¡®å®šè¿™ä¸ªå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹ã€‚



#### 3. å®ä¾‹æ•°æ®å’Œå¯¹é½å¡«å……

**å®ä¾‹æ•°æ®**ï¼šå­˜æ”¾ç±»çš„å±æ€§(Field)æ•°æ®ä¿¡æ¯ï¼ŒåŒ…æ‹¬çˆ¶ç±»çš„å±æ€§ä¿¡æ¯ï¼Œå¦‚æœæ˜¯æ•°ç»„çš„å®ä¾‹éƒ¨åˆ†è¿˜åŒ…æ‹¬æ•°ç»„çš„é•¿åº¦ï¼Œè¿™éƒ¨åˆ†å†…å­˜æŒ‰4å­—èŠ‚å¯¹é½ã€‚

**å¯¹é½å¡«å……**ï¼šè™šæ‹Ÿæœºè¦æ±‚å¯¹è±¡èµ·å§‹åœ°å€å¿…é¡»æ˜¯8å­—èŠ‚çš„æ•´æ•°å€ã€‚å¡«å……æ•°æ®ä¸æ˜¯å¿…é¡»å­˜åœ¨çš„ï¼Œä»…ä»…æ˜¯ä¸ºäº†å­—èŠ‚å¯¹é½è¿™éƒ¨åˆ†å†…å­˜æŒ‰8å­—èŠ‚è¡¥å……å¯¹é½ã€‚

http://openjdk.java.net/groups/hotspot/docs/HotSpotGlossary.html

http://hg.openjdk.java.net/jdk/jdk11/file/1ddf9a99e4ad/src/hotspot/share/oops



#### 4. æºç åˆ†æ

```sh
//  32 bits:
//  --------
//             hash:25 ------------>| age:4    biased_lock:1 lock:2 (normal object)
//             JavaThread*:23 epoch:2 age:4    biased_lock:1 lock:2 (biased object)
//             size:32 ------------------------------------------>| (CMS free block)
//             PromotedObject*:29 ---------->| promo_bits:3 ----->| (CMS promoted object)

//  64 bits:
//  --------
//  unused:25 hash:31 -->| unused:1   age:4    biased_lock:1 lock:2 (normal object)
//  JavaThread*:54 epoch:2 unused:1   age:4    biased_lock:1 lock:2 (biased object)
//  PromotedObject*:61 --------------------->| promo_bits:3 ----->| (CMS promoted object)
//  size:64 ----------------------------------------------------->| (CMS free block)
```

- `hash`ï¼š ä¿å­˜å¯¹è±¡çš„å“ˆå¸Œç 
- `age`ï¼š ä¿å­˜å¯¹è±¡çš„åˆ†ä»£å¹´é¾„
- `biased_lock`ï¼š åå‘é”æ ‡è¯†ä½
- `lock`ï¼š é”çŠ¶æ€æ ‡è¯†ä½
- `JavaThread*`ï¼šä¿å­˜æŒæœ‰åå‘é”çš„çº¿ç¨‹ID
- `epoch`ï¼š ä¿å­˜åå‘æ—¶é—´æˆ³

markword(64ä½)åˆ†å¸ƒå›¾ï¼Œå¯¹è±¡å¸ƒå±€ã€GCå›æ”¶å’Œåé¢çš„é”å‡çº§å°±æ˜¯å¯¹è±¡æ ‡è®°MarkWordé‡Œé¢æ ‡å¿—ä½çš„å˜åŒ–



#### 5. å¯¹è±¡å¤´åˆ†æ

http://openjdk.java.net/projects/code-tools/jol/

```xml
<dependency>
    <groupId>org.openjdk.jol</groupId>
    <artifactId>jol-core</artifactId>
    <version>0.16</version>
</dependency>
```

```java
public class JOLDemo {
    public static void main(String[] args) {
        Object o = new Object();//16 bytes

        //System.out.println(ClassLayout.parseInstance(o).toPrintable());

        Customer c1 = new Customer();//16 bytes
        System.out.println(ClassLayout.parseInstance(c1).toPrintable());
    }
}

//åªæœ‰ä¸€ä¸ªå¯¹è±¡å¤´çš„å®ä¾‹å¯¹è±¡ï¼Œ16å­—èŠ‚ï¼ˆå¿½ç•¥å‹ç¼©æŒ‡é’ˆçš„å½±å“ï¼‰+4å­—èŠ‚+1å­—èŠ‚=21å­—èŠ‚ -->å¯¹å…¶å¡«å……ï¼Œ24å­—èŠ‚
class Customer {
    //1 ç¬¬ä¸€ç§æƒ…å†µï¼Œåªæœ‰å¯¹è±¡å¤´ï¼Œæ²¡æœ‰å…¶å®ƒä»»ä½•å®ä¾‹æ•°æ®

    //2 ç¬¬äºŒç§æƒ…å†µï¼Œint + booleanï¼Œé»˜è®¤æ»¡è¶³å¯¹å…¶å¡«å……ï¼Œ24 bytes
//    int id;
//    boolean flag = false;
//    boolean flag2 = false;
}
```

æŸ¥çœ‹é»˜è®¤è¿è¡Œå‚æ•°ï¼š

```sh
-XX:+PrintCommandLineFlags
```

é»˜è®¤æƒ…å†µä¸‹è™šæ‹Ÿæœºå·²ç»å¼€å¯å‹ç¼©æŒ‡é’ˆé…ç½®ï¼š

```sh
-XX:+UseCompressedClassPointers
```

å¦‚æœå…³é—­å‹ç¼©æŒ‡é’ˆï¼Œé‚£ä¹ˆæŒ‡å‘ç±»å…ƒä¿¡æ¯çš„æŒ‡é’ˆå°±ä¼šè¢«å‹ç¼©ä¸º 4byteï¼Œä»¥æ­¤æ¥èŠ‚çº¦å†…å­˜å¼€é”€ã€‚



### 2.  Monitor åŸç†

Monitorè¢«ç¿»è¯‘ä¸ºç›‘è§†å™¨æˆ–è€…è¯´ç®¡ç¨‹

æ¯ä¸ªjavaå¯¹è±¡éƒ½å¯ä»¥å…³è”ä¸€ä¸ªMonitorï¼Œå¦‚æœä½¿ç”¨`synchronized`ç»™å¯¹è±¡ä¸Šé”ï¼ˆé‡é‡çº§ï¼‰ï¼Œè¯¥å¯¹è±¡å¤´çš„Mark Wordä¸­å°±è¢«è®¾ç½®ä¸ºæŒ‡å‘Monitorå¯¹è±¡çš„æŒ‡é’ˆ

Monitorç»“æ„å¦‚ä¸‹

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162215914.png)

- åˆšå¼€å§‹æ—¶Monitorä¸­çš„Ownerä¸ºnull
- å½“Thread-2 æ‰§è¡Œsynchronized(obj){}ä»£ç æ—¶å°±ä¼šå°†Monitorçš„æ‰€æœ‰è€…Owner è®¾ç½®ä¸º Thread-2ï¼Œä¸Šé”æˆåŠŸï¼ŒMonitorä¸­åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªOwner
- å½“Thread-2 å æ®é”æ—¶ï¼Œå¦‚æœçº¿ç¨‹Thread-3ï¼ŒThread-4ä¹Ÿæ¥æ‰§è¡Œsynchronized(obj){}ä»£ç ï¼Œå°±ä¼šè¿›å…¥EntryListä¸­å˜æˆBLOCKEDçŠ¶æ€
- Thread-2 æ‰§è¡Œå®ŒåŒæ­¥ä»£ç å—çš„å†…å®¹ï¼Œç„¶åå”¤é†’ EntryList ä¸­ç­‰å¾…çš„çº¿ç¨‹æ¥ç«äº‰é”ï¼Œç«äº‰æ—¶æ˜¯éå…¬å¹³çš„
- å›¾ä¸­ WaitSet ä¸­çš„ Thread-0ï¼ŒThread-1 æ˜¯ä¹‹å‰è·å¾—è¿‡é”ï¼Œä½†æ¡ä»¶ä¸æ»¡è¶³è¿›å…¥ WAITING çŠ¶æ€çš„çº¿ç¨‹ï¼Œåé¢è®²wait-notify æ—¶ä¼šåˆ†æ

> æ³¨æ„ï¼š
>
> - synchronized å¿…é¡»æ˜¯è¿›å…¥åŒä¸€ä¸ªå¯¹è±¡çš„ monitor æ‰æœ‰ä¸Šè¿°çš„æ•ˆæœ
> - ä¸åŠ  synchronized çš„å¯¹è±¡ä¸ä¼šå…³è”ç›‘è§†å™¨ï¼Œä¸éµä»ä»¥ä¸Šè§„åˆ™





### 3.  synchronizedåŸç†

```java
static final Object lock=new Object();
static int counter = 0;
public static void main(String[] args) {
    synchronized (lock) {
        counter++;
    }
}
```

```shell
# å­—èŠ‚ç æŒ‡ä»¤åˆ†æ
0 getstatic #2 <com/concurrent/test/Test17.lock>
# å–å¾—lockçš„å¼•ç”¨ï¼ˆsynchronizedå¼€å§‹äº†ï¼‰
3 dup    
# å¤åˆ¶æ“ä½œæ•°æ ˆæ ˆé¡¶çš„å€¼æ”¾å…¥æ ˆé¡¶ï¼Œå³å¤åˆ¶äº†ä¸€ä»½lockçš„å¼•ç”¨
4 astore_1
# æ“ä½œæ•°æ ˆæ ˆé¡¶çš„å€¼å¼¹å‡ºï¼Œå³å°†lockçš„å¼•ç”¨å­˜åˆ°å±€éƒ¨å˜é‡è¡¨ä¸­
5 monitorenter
# å°†lockå¯¹è±¡çš„Mark Wordç½®ä¸ºæŒ‡å‘MonitoræŒ‡é’ˆ
6 getstatic #3 <com/concurrent/test/Test17.counter>
9 iconst_1
10 iadd
11 putstatic #3 <com/concurrent/test/Test17.counter>
14 aload_1
# ä»å±€éƒ¨å˜é‡è¡¨ä¸­å–å¾—lockçš„å¼•ç”¨ï¼Œæ”¾å…¥æ“ä½œæ•°æ ˆæ ˆé¡¶
15 monitorexit
# å°†lockå¯¹è±¡çš„Mark Wordé‡ç½®ï¼Œå”¤é†’EntryList
16 goto 24 (+8)
# ä¸‹é¢æ˜¯å¼‚å¸¸å¤„ç†æŒ‡ä»¤ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœå‡ºç°å¼‚å¸¸ï¼Œä¹Ÿèƒ½è‡ªåŠ¨åœ°é‡Šæ”¾é”
19 astore_2
20 aload_1
21 monitorexit
22 aload_2
23 athrow
24 return
```

> æ³¨æ„ï¼šæ–¹æ³•çº§åˆ«çš„ synchronized ä¸ä¼šåœ¨å­—èŠ‚ç æŒ‡ä»¤ä¸­æœ‰æ‰€ä½“ç°



**å°æ•…äº‹**

æ•…äº‹è§’è‰²

- è€ç‹ - JVM
- å°å— - çº¿ç¨‹
- å°å¥³ - çº¿ç¨‹
- æˆ¿é—´ - å¯¹è±¡
- æˆ¿é—´é—¨ä¸Š - é˜²ç›—é” - Monitor
- æˆ¿é—´é—¨ä¸Š - å°å—ä¹¦åŒ… - è½»é‡çº§é”
- æˆ¿é—´é—¨ä¸Š - åˆ»ä¸Šå°å—å¤§å - åå‘é”
- æ‰¹é‡é‡åˆ»å - ä¸€ä¸ªç±»çš„åå‘é”æ’¤é”€åˆ°è¾¾ 20 é˜ˆå€¼
- ä¸èƒ½åˆ»åå­— - æ‰¹é‡æ’¤é”€è¯¥ç±»å¯¹è±¡çš„åå‘é”ï¼Œè®¾ç½®è¯¥ç±»ä¸å¯åå‘

å°å—è¦ä½¿ç”¨æˆ¿é—´ä¿è¯è®¡ç®—ä¸è¢«å…¶å®ƒäººå¹²æ‰°ï¼ˆåŸå­æ€§ï¼‰ï¼Œæœ€åˆï¼Œä»–ç”¨çš„æ˜¯é˜²ç›—é”ï¼Œå½“ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶ï¼Œé”ä½é—¨ã€‚è¿™æ ·ï¼Œ å³ä½¿ä»–ç¦»å¼€äº†ï¼Œåˆ«äººä¹Ÿè¿›ä¸äº†é—¨ï¼Œä»–çš„å·¥ä½œå°±æ˜¯å®‰å…¨çš„ã€‚

ä½†æ˜¯ï¼Œå¾ˆå¤šæƒ…å†µä¸‹æ²¡äººè·Ÿä»–æ¥ç«äº‰æˆ¿é—´çš„ä½¿ç”¨æƒã€‚å°å¥³æ˜¯è¦ç”¨æˆ¿é—´ï¼Œä½†ä½¿ç”¨çš„æ—¶é—´ä¸Šæ˜¯é”™å¼€çš„ï¼Œå°å—ç™½å¤©ç”¨ï¼Œå°å¥³ æ™šä¸Šç”¨ã€‚æ¯æ¬¡ä¸Šé”å¤ªéº»çƒ¦äº†ï¼Œæœ‰æ²¡æœ‰æ›´ç®€å•çš„åŠæ³•å‘¢ï¼Ÿ

å°å—å’Œå°å¥³å•†é‡äº†ä¸€ä¸‹ï¼Œçº¦å®šä¸é”é—¨äº†ï¼Œè€Œæ˜¯è°ç”¨æˆ¿é—´ï¼Œè°æŠŠè‡ªå·±çš„ä¹¦åŒ…æŒ‚åœ¨é—¨å£ï¼Œä½†ä»–ä»¬çš„ä¹¦åŒ…æ ·å¼éƒ½ä¸€æ ·ï¼Œå›  æ­¤æ¯æ¬¡è¿›é—¨å‰å¾—ç¿»ç¿»ä¹¦åŒ…ï¼Œçœ‹è¯¾æœ¬æ˜¯è°çš„ï¼Œå¦‚æœæ˜¯è‡ªå·±çš„ï¼Œé‚£ä¹ˆå°±å¯ä»¥è¿›é—¨ï¼Œè¿™æ ·çœçš„ä¸Šé”è§£é”äº†ã€‚ä¸‡ä¸€ä¹¦åŒ…ä¸æ˜¯ è‡ªå·±çš„ï¼Œé‚£ä¹ˆå°±åœ¨é—¨å¤–ç­‰ï¼Œå¹¶é€šçŸ¥å¯¹æ–¹ä¸‹æ¬¡ç”¨é”é—¨çš„æ–¹å¼ã€‚

åæ¥ï¼Œå°å¥³å›è€å®¶äº†ï¼Œå¾ˆé•¿ä¸€æ®µæ—¶é—´éƒ½ä¸ä¼šç”¨è¿™ä¸ªæˆ¿é—´ã€‚å°å—æ¯æ¬¡è¿˜æ˜¯æŒ‚ä¹¦åŒ…ï¼Œç¿»ä¹¦åŒ…ï¼Œè™½ç„¶æ¯”é”é—¨çœäº‹äº†ï¼Œä½†ä» ç„¶è§‰å¾—éº»çƒ¦ã€‚

äºæ˜¯ï¼Œå°å—å¹²è„†åœ¨é—¨ä¸Šåˆ»ä¸Šäº†è‡ªå·±çš„åå­—ï¼šã€å°å—ä¸“å±æˆ¿é—´ï¼Œå…¶å®ƒäººå‹¿ç”¨ã€‘ï¼Œä¸‹æ¬¡æ¥ç”¨æˆ¿é—´æ—¶ï¼Œåªè¦åå­—è¿˜åœ¨ï¼Œé‚£ ä¹ˆè¯´æ˜æ²¡äººæ‰“æ‰°ï¼Œè¿˜æ˜¯å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨æˆ¿é—´ã€‚å¦‚æœè¿™æœŸé—´æœ‰å…¶å®ƒäººè¦ç”¨è¿™ä¸ªæˆ¿é—´ï¼Œé‚£ä¹ˆç”±ä½¿ç”¨è€…å°†å°å—åˆ»çš„åå­—æ“¦ æ‰ï¼Œå‡çº§ä¸ºæŒ‚ä¹¦åŒ…çš„æ–¹å¼ã€‚

åŒå­¦ä»¬éƒ½æ”¾å‡å›è€å®¶äº†ï¼Œå°å—å°±è†¨èƒ€äº†ï¼Œåœ¨ 20 ä¸ªæˆ¿é—´åˆ»ä¸Šäº†è‡ªå·±çš„åå­—ï¼Œæƒ³è¿›å“ªä¸ªè¿›å“ªä¸ªã€‚åæ¥ä»–è‡ªå·±æ”¾å‡å›è€ å®¶äº†ï¼Œè¿™æ—¶å°å¥³å›æ¥äº†ï¼ˆå¥¹ä¹Ÿè¦ç”¨è¿™äº›æˆ¿é—´ï¼‰ï¼Œç»“æœå°±æ˜¯å¾—ä¸€ä¸ªä¸ªåœ°æ“¦æ‰å°å—åˆ»çš„åå­—ï¼Œå‡çº§ä¸ºæŒ‚ä¹¦åŒ…çš„æ–¹å¼ã€‚è€ ç‹è§‰å¾—è¿™æˆæœ¬æœ‰ç‚¹é«˜ï¼Œæå‡ºäº†ä¸€ç§æ‰¹é‡é‡åˆ»åçš„æ–¹æ³•ï¼Œä»–è®©å°å¥³ä¸ç”¨æŒ‚ä¹¦åŒ…äº†ï¼Œå¯ä»¥ç›´æ¥åœ¨é—¨ä¸Šåˆ»ä¸Šè‡ªå·±çš„åå­—

åæ¥ï¼Œåˆ»åçš„ç°è±¡è¶Šæ¥è¶Šé¢‘ç¹ï¼Œè€ç‹å—ä¸äº†äº†ï¼šç®—äº†ï¼Œè¿™äº›æˆ¿é—´éƒ½ä¸èƒ½åˆ»åäº†ï¼Œåªèƒ½æŒ‚ä¹¦åŒ…





###  4. synchronizedè¿›é˜¶

#### 1. è½»é‡çº§é”

è½»é‡çº§é”çš„ä½¿ç”¨åœºæ™¯æ˜¯ï¼šå¦‚æœä¸€ä¸ªå¯¹è±¡è™½ç„¶æœ‰å¤šä¸ªçº¿ç¨‹è¦å¯¹å®ƒè¿›è¡ŒåŠ é”ï¼Œä½†æ˜¯åŠ é”çš„æ—¶é—´æ˜¯é”™å¼€çš„ï¼ˆä¹Ÿå°±æ˜¯æ²¡æœ‰äººå¯ä»¥ç«äº‰çš„ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨è½»é‡çº§é”æ¥è¿›è¡Œä¼˜åŒ–ã€‚

è½»é‡çº§é”å¯¹ä½¿ç”¨è€…æ˜¯é€æ˜çš„ï¼Œå³è¯­æ³•ä»ç„¶æ˜¯`synchronized`

å‡è®¾æœ‰ä¸¤ä¸ªæ–¹æ³•åŒæ­¥å—ï¼Œåˆ©ç”¨åŒä¸€ä¸ªå¯¹è±¡åŠ é”

 ```java
 static final Object obj = new Object();
 public static void method1() {
     synchronized( obj ) {
         // åŒæ­¥å— A
         method2();
     }
 }
 public static void method2() {
     synchronized( obj ) {
         // åŒæ­¥å— B
     }
 }
 ```



- æ¯æ¬¡æŒ‡å‘åˆ° synchronized ä»£ç å—æ—¶ï¼Œéƒ½ä¼šåˆ›å»ºé”è®°å½•ï¼ˆLock Recordï¼‰å¯¹è±¡ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šåŒ…æ‹¬ä¸€ä¸ªé”è®°å½•çš„ç»“æ„ï¼Œé”è®°å½•å†…éƒ¨å¯ä»¥å‚¨å­˜å¯¹è±¡çš„ Mark Word å’Œå¯¹è±¡å¼•ç”¨ reference

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162215632.png)

- è®©é”è®°å½•ä¸­çš„ Object reference æŒ‡å‘å¯¹è±¡ï¼Œå¹¶ä¸”å°è¯•ç”¨ cas(compare and sweep) æ›¿æ¢ Object å¯¹è±¡çš„ Mark Word ï¼Œå°† Mark Word çš„å€¼å­˜å…¥é”è®°å½•ä¸­

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162216614.png)

- å¦‚æœcasæ›¿æ¢æˆåŠŸï¼Œé‚£ä¹ˆå¯¹è±¡çš„å¯¹è±¡å¤´å‚¨å­˜çš„å°±æ˜¯ `é”è®°å½•çš„åœ°å€å’ŒçŠ¶æ€ 01`ï¼Œå¦‚ä¸‹æ‰€ç¤º

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162216794.png)

- å¦‚æœcaså¤±è´¥ï¼Œæœ‰ä¸¤ç§æƒ…å†µ
  - å¦‚æœæ˜¯å…¶å®ƒçº¿ç¨‹å·²ç»æŒæœ‰äº†è¯¥Objectçš„è½»é‡çº§é”ï¼Œé‚£ä¹ˆè¡¨ç¤ºæœ‰ç«äº‰ï¼Œå°†è¿›å…¥é”è†¨èƒ€é˜¶æ®µ
  - å¦‚æœæ˜¯è‡ªå·±çš„çº¿ç¨‹å·²ç»æ‰§è¡Œäº†synchronizedè¿›è¡ŒåŠ é”ï¼Œé‚£ä¹ˆé‚£ä¹ˆå†æ·»åŠ ä¸€æ¡ Lock Record ä½œä¸ºé‡å…¥çš„è®¡æ•°

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162216187.png)

- å½“çº¿ç¨‹é€€å‡ºsynchronizedä»£ç å—çš„æ—¶å€™ï¼Œ**å¦‚æœè·å–çš„æ˜¯å–å€¼ä¸º null çš„é”è®°å½• **ï¼Œè¡¨ç¤ºæœ‰é‡å…¥ï¼Œè¿™æ—¶é‡ç½®é”è®°å½•ï¼Œè¡¨ç¤ºé‡å…¥è®¡æ•°å‡ä¸€

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162216165.png)

- å½“çº¿ç¨‹é€€å‡ºsynchronizedä»£ç å—çš„æ—¶å€™ï¼Œå¦‚æœè·å–çš„é”è®°å½•å–å€¼ä¸ä¸º nullï¼Œé‚£ä¹ˆä½¿ç”¨caså°†Mark Wordçš„å€¼æ¢å¤ç»™å¯¹è±¡
  - æˆåŠŸåˆ™è§£é”æˆåŠŸ
  - å¤±è´¥ï¼Œåˆ™è¯´æ˜è½»é‡çº§é”è¿›è¡Œäº†é”è†¨èƒ€æˆ–å·²ç»å‡çº§ä¸ºé‡é‡çº§é”ï¼Œè¿›å…¥é‡é‡çº§é”è§£é”æµç¨‹



#### 2.  é”è†¨èƒ€

å¦‚æœåœ¨å°è¯•åŠ è½»é‡çº§é”çš„è¿‡ç¨‹ä¸­ï¼Œcas æ“ä½œæ— æ³•æˆåŠŸï¼Œè¿™æ—¶æœ‰ä¸€ç§æƒ…å†µå°±æ˜¯å…¶å®ƒçº¿ç¨‹å·²ç»ä¸ºè¿™ä¸ªå¯¹è±¡åŠ ä¸Šäº†è½»é‡çº§é”ï¼Œè¿™æ˜¯å°±è¦è¿›è¡Œé”è†¨èƒ€ï¼Œå°†è½»é‡çº§é”å˜æˆé‡é‡çº§é”ã€‚

- å½“ Thread-1 è¿›è¡Œè½»é‡çº§åŠ é”æ—¶ï¼ŒThread-0 å·²ç»å¯¹è¯¥å¯¹è±¡åŠ äº†è½»é‡çº§é”

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162216892.png)

- è¿™æ—¶ Thread-1 åŠ è½»é‡çº§é”å¤±è´¥ï¼Œè¿›å…¥é”è†¨èƒ€æµç¨‹
  - å³ä¸ºå¯¹è±¡ç”³è¯·Monitoré”ï¼Œè®©ObjectæŒ‡å‘é‡é‡çº§é”åœ°å€
  - ç„¶åè‡ªå·±è¿›å…¥Monitor çš„EntryList å˜æˆBLOCKEDçŠ¶æ€

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162216341.png)

- å½“Thread-0 é€€å‡ºsynchronizedåŒæ­¥å—æ—¶ï¼Œä½¿ç”¨caså°†Mark Wordçš„å€¼æ¢å¤ç»™å¯¹è±¡å¤´ï¼Œå¤±è´¥ï¼Œé‚£ä¹ˆä¼šè¿›å…¥é‡é‡çº§é”çš„è§£é”è¿‡ç¨‹ï¼Œå³æŒ‰ç…§Monitorçš„åœ°å€æ‰¾åˆ°Monitorå¯¹è±¡ï¼Œå°†Ownerè®¾ç½®ä¸ºnullï¼Œå”¤é†’EntryList ä¸­çš„Thread-1çº¿ç¨‹



#### 3.  è‡ªæ—‹ä¼˜åŒ–

é‡é‡çº§é”ç«äº‰çš„æ—¶å€™ï¼Œè¿˜å¯ä»¥ä½¿ç”¨è‡ªæ—‹æ¥ä¼˜åŒ–ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è‡ªæ—‹æˆåŠŸï¼ˆå³è¿™æ—¶æŒé”çº¿ç¨‹å·²ç»é€€å‡ºäº†åŒæ­¥å—ï¼Œé‡Šæ”¾äº†é”ï¼‰ï¼Œè¿™æ—¶å½“å‰çº¿ç¨‹å°±å¯ä»¥é¿å…é˜»å¡ã€‚

1. è‡ªæ—‹é‡è¯•æˆåŠŸçš„æƒ…å†µ

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162216868.png)



2. è‡ªæ—‹é‡è¯•å¤±è´¥çš„æƒ…å†µï¼Œè‡ªæ—‹äº†ä¸€å®šæ¬¡æ•°è¿˜æ˜¯æ²¡æœ‰ç­‰åˆ°æŒé”çš„çº¿ç¨‹é‡Šæ”¾é”

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162216919.png)

- åœ¨ Java 6 ä¹‹åè‡ªæ—‹é”æ˜¯è‡ªé€‚åº”çš„ï¼Œæ¯”å¦‚å¯¹è±¡åˆšåˆšçš„ä¸€æ¬¡è‡ªæ—‹æ“ä½œæˆåŠŸè¿‡ï¼Œé‚£ä¹ˆè®¤ä¸ºè¿™æ¬¡è‡ªæ—‹æˆåŠŸçš„å¯èƒ½æ€§ä¼šé«˜ï¼Œå°±å¤šè‡ªæ—‹å‡ æ¬¡ï¼›åä¹‹ï¼Œå°±å°‘è‡ªæ—‹ç”šè‡³ä¸è‡ªæ—‹ï¼Œæ€»ä¹‹ï¼Œæ¯”è¾ƒæ™ºèƒ½ã€‚
- è‡ªæ—‹ä¼šå ç”¨ CPU æ—¶é—´ï¼Œå•æ ¸ CPU è‡ªæ—‹å°±æ˜¯æµªè´¹ï¼Œå¤šæ ¸ CPU è‡ªæ—‹æ‰èƒ½å‘æŒ¥ä¼˜åŠ¿ã€‚
- Java 7 ä¹‹åä¸èƒ½æ§åˆ¶æ˜¯å¦å¼€å¯è‡ªæ—‹åŠŸèƒ½



#### 4. åå‘é”

è½»é‡çº§é”åœ¨æ²¡æœ‰ç«äº‰æ—¶ï¼ˆå°±åªæœ‰è‡ªå·±çº¿ç¨‹ï¼‰ï¼Œæ¯æ¬¡é‡å…¥ä»ç„¶éœ€è¦æ‰§è¡Œ CAS æ“ä½œã€‚

Java 6 ä¸­å¼•å…¥äº†åå‘é”æ¥åšè¿›ä¸€æ­¥ä¼˜åŒ–ï¼šåªæœ‰ç¬¬ä¸€æ¬¡ä½¿ç”¨ CAS å°†çº¿ç¨‹ ID è®¾ç½®åˆ°å¯¹è±¡çš„ Mark Word å¤´ï¼Œä¹‹åå‘ç°è¿™ä¸ªçº¿ç¨‹ ID æ˜¯è‡ªå·±çš„ å°±è¡¨ç¤ºæ²¡æœ‰ç«äº‰ï¼Œä¸ç”¨é‡æ–° CASã€‚ä»¥ååªè¦ä¸å‘ç”Ÿç«äº‰ï¼Œè¿™ä¸ªçº¿ç¨‹å°±å½’è¯¥çº¿ç¨‹æ‰€æœ‰

```java
static final Object obj = new Object();
public static void method1() {
    synchronized( obj ) {
        // åŒæ­¥å— A
        method2();
    }
}
public static void method2() {
    synchronized( obj ) {
        // åŒæ­¥å— B
    }
}
```

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162216770.png)



**1ã€åå‘çŠ¶æ€**

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162217193.png)

ä¸€ä¸ªå¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹ï¼š

- å¦‚æœå¼€å¯äº†åå‘é”ï¼ˆé»˜è®¤æ˜¯å¼€å¯çš„ï¼‰ï¼Œé‚£ä¹ˆå¯¹è±¡åˆšåˆ›å»ºä¹‹åï¼ŒMark Word æœ€åä¸‰ä½çš„å€¼101ï¼Œå¹¶ä¸”è¿™æ˜¯å®ƒçš„Threadï¼Œepochï¼Œageéƒ½æ˜¯ 0
- åå‘é”é»˜è®¤æ˜¯å»¶è¿Ÿçš„ï¼Œä¸ä¼šåœ¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™ç«‹åˆ»ç”Ÿæ•ˆï¼Œå¦‚æœæƒ³é¿å…å»¶è¿Ÿï¼Œå¯ä»¥æ·»åŠ è™šæ‹Ÿæœºå‚æ•°æ¥ç¦ç”¨å»¶è¿Ÿï¼š-`XX:BiasedLockingStartupDelay=0`æ¥ç¦ç”¨å»¶è¿Ÿ

- å¦‚æœæ²¡æœ‰å¼€å¯åå‘é”ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ›å»ºåæœ€åä¸‰ä½çš„å€¼ä¸º001ï¼Œè¿™æ—¶å€™å®ƒçš„hashcodeï¼Œageéƒ½ä¸º0ï¼Œhashcodeæ˜¯ç¬¬ä¸€æ¬¡ç”¨åˆ°`hashcode`æ—¶æ‰èµ‹å€¼

1. åŠ ä¸Šè™šæ‹Ÿæœºå‚æ•° `-XX:BiasedLockingStartupDelay=0` è¿›è¡Œæµ‹è¯•

```JAVA
public static void main(String[] args) throws InterruptedException {
    Dog d = list.get(i);
    log.debug(i + "\t" + ClassLayout.parseInstance(d).toPrintable());
    synchronized (d) {
        log.debug(i + "\t" + ClassLayout.parseInstance(d).toPrintable());
    }
    log.debug(i + "\t" + ClassLayout.parseInstance(d).toPrintable());
}
```

> ä¸‰æ¬¡è¾“å‡ºçš„çŠ¶æ€ç éƒ½ä¸º101



2. æµ‹è¯•ç¦ç”¨

å¦‚æœæ²¡æœ‰å¼€å¯åå‘é”ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ›å»ºåæœ€åä¸‰ä½çš„å€¼ä¸º001ï¼Œè¿™æ—¶å€™å®ƒçš„ hashcodeï¼Œageéƒ½ä¸º0ï¼Œhashcodeæ˜¯ç¬¬ä¸€æ¬¡ç”¨åˆ°`hashcode`æ—¶æ‰èµ‹å€¼çš„ã€‚åœ¨ä¸Šé¢æµ‹è¯•ä»£ç è¿è¡Œæ—¶åœ¨æ·»åŠ  VM å‚æ•° `-XX:-UseBiasedLocking` ç¦ç”¨åå‘é”ï¼ˆç¦ç”¨åå‘é”åˆ™ä¼˜å…ˆä½¿ç”¨è½»é‡çº§é”ï¼‰ï¼Œé€€å‡º`synchronized`çŠ¶æ€å˜å›001

> æœ€å¼€å§‹çŠ¶æ€ä¸º01ï¼Œç„¶ååŠ è½»é‡çº§é”å˜æˆ00ï¼Œæœ€åæ¢å¤æˆ01



**2ã€æ’¤é”€**

1. è°ƒç”¨å¯¹è±¡çš„hashcodeæ–¹æ³•

å½“è°ƒç”¨å¯¹è±¡çš„ hashcode æ–¹æ³•çš„æ—¶å€™å°±ä¼šæ’¤é”€è¿™ä¸ªå¯¹è±¡çš„åå‘é”ï¼Œå› ä¸ºä½¿ç”¨åå‘é”æ—¶æ²¡æœ‰ä½ç½®å­˜`hashcode`çš„å€¼äº†

```java
public static void main(String[] args) throws InterruptedException {
    Test1 t = new Test1();
    t.hashCode(); // ä¼šç¦ç”¨è¿™ä¸ªå¯¹è±¡çš„åå‘é”
    test.parseObjectHeader(getObjectHeader(t));

    synchronized (t){
        test.parseObjectHeader(getObjectHeader(t));
    }
    test.parseObjectHeader(getObjectHeader(t));
}
```



2. å…¶å®ƒçº¿ç¨‹ä½¿ç”¨å¯¹è±¡

å½“æœ‰å…¶ä»–çº¿ç¨‹ä½¿ç”¨åå‘é”å¯¹è±¡æ—¶ï¼Œä¼šå°†**åå‘é”**å‡çº§ä¸º**è½»é‡çº§é”**

```java
// -XX:-UseCompressedOops -XX:-UseCompressedClassPointers -XX:BiasedLockingStartupDelay=0 -XX:+PrintFlagsFinal
//-XX:-UseBiasedLocking tid=0x000000001f173000  -XX:BiasedLockingStartupDelay=0 -XX:+TraceBiasedLocking
private static void test2() throws InterruptedException {

    Dog d = new Dog();
    Thread t1 = new Thread(() -> {
        synchronized (d) {
            log.debug(ClassLayout.parseInstance(d).toPrintable());
        }
        synchronized (TestBiased.class) {
            TestBiased.class.notify();
        }
    }, "t1");
    t1.start();


    Thread t2 = new Thread(() -> {
        synchronized (TestBiased.class) {
            try {
                TestBiased.class.wait();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
        log.debug(ClassLayout.parseInstance(d).toPrintable());
        synchronized (d) {
            log.debug(ClassLayout.parseInstance(d).toPrintable());
        }
        log.debug(ClassLayout.parseInstance(d).toPrintable());
    }, "t2");
    t2.start();
}
```



3. è°ƒç”¨ wait/notify

ä¼šä½¿å¯¹è±¡çš„é”å˜æˆé‡é‡çº§é”ï¼Œå› ä¸ºwait/notifyæ–¹æ³•ä¹‹åé‡é‡çº§é”æ‰æ”¯æŒ



**3ã€æ‰¹é‡é‡åå‘**

å¦‚æœå¯¹è±¡è™½ç„¶è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®ï¼Œä½†æ²¡æœ‰ç«äº‰ï¼Œè¿™æ˜¯åå‘äº†çº¿ç¨‹ T1 çš„å¯¹è±¡ä»æœ‰æœºä¼šé‡æ–°åå‘ T2ï¼Œé‡åå‘ä¼šé‡ç½®å¯¹è±¡çš„ ThreadID

å½“æ’¤é”€åå‘é”é˜ˆå€¼è¶…è¿‡20æ¬¡åï¼Œjvm ä¼šè¿™æ ·è§‰å¾—ï¼Œæˆ‘æ˜¯ä¸æ˜¯åå‘é”™äº†å‘¢ï¼Œäºæ˜¯ä¼šåœ¨ç»™è¿™äº›å¯¹è±¡åŠ é”æ—¶é‡æ–°åå‘è‡³åŠ é”çº¿ç¨‹

```java
private static void test3() throws InterruptedException {

    Vector<Dog> list = new Vector<>();
    Thread t1 = new Thread(() -> {
        for (int i = 0; i < 30; i++) {
            Dog d = new Dog();
            list.add(d);
            synchronized (d) {
                log.debug(i + "\t" + ClassLayout.parseInstance(d).toPrintable());
            }
        }
        synchronized (list) {
            list.notify();
        }
    }, "t1");
    t1.start();

    Thread t2 = new Thread(() -> {
        synchronized (list) {
            try {
                list.wait();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
        log.debug("===============> ");
        for (int i = 0; i < 30; i++) {
            Dog d = list.get(i);
            log.debug(i + "\t" + ClassLayout.parseInstance(d).toPrintable());
            synchronized (d) {
                log.debug(i + "\t" + ClassLayout.parseInstance(d).toPrintable());
            }
            log.debug(i + "\t" + ClassLayout.parseInstance(d).toPrintable());
        }
    }, "t2");
    t2.start();
}
```



#### 5. é”æ¶ˆé™¤

```java
@Fork(1)
@BenchmarkMode(Mode.AverageTime)
@Warmup(iterations=3)
@Measurement(iterations=5)
@OutputTimeUnit(TimeUnit.NANOSECONDS)
public class MyBenchmark {
    static int x = 0;
    @Benchmark
    public void a() throws Exception {
        x++;
    }
    @Benchmark
    // JIT  å³æ—¶ç¼–è¯‘å™¨
    public void b() throws Exception {
        Object o = new Object();
        synchronized (o) {
            x++;
        }
    }
}
```





## 5. wait / notify

å°æ•…äº‹ - ä¸ºä»€ä¹ˆéœ€è¦ wait

- ç”±äºæ¡ä»¶ä¸æ»¡è¶³ï¼Œå°å—ä¸èƒ½ç»§ç»­è¿›è¡Œè®¡ç®—

- ä½†å°å—å¦‚æœä¸€ç›´å ç”¨ç€é”ï¼Œå…¶å®ƒäººå°±å¾—ä¸€ç›´é˜»å¡ï¼Œæ•ˆç‡å¤ªä½

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162217924.png)

- äºæ˜¯è€ç‹å•å¼€äº†ä¸€é—´ä¼‘æ¯å®¤ï¼ˆè°ƒç”¨ wait æ–¹æ³•ï¼‰ï¼Œè®©å°å—åˆ°ä¼‘æ¯å®¤ï¼ˆWaitSetï¼‰ç­‰ç€å»äº†ï¼Œä½†è¿™æ—¶é”é‡Šæ”¾å¼€ï¼Œ å…¶å®ƒäººå¯ä»¥ç”±è€ç‹éšæœºå®‰æ’è¿›å±‹
- ç›´åˆ°å°Må°†çƒŸé€æ¥ï¼Œå¤§å«ä¸€å£° [ ä½ çš„çƒŸåˆ°äº† ] ï¼ˆè°ƒç”¨ notify æ–¹æ³•ï¼‰

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162217669.png)

- å°å—äºæ˜¯å¯ä»¥ç¦»å¼€ä¼‘æ¯å®¤ï¼Œé‡æ–°è¿›å…¥ç«äº‰é”çš„é˜Ÿåˆ—

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162217572.png)





### 1. API ä»‹ç»

- `obj.wait()` è®©è¿›å…¥ object ç›‘è§†å™¨çš„çº¿ç¨‹åˆ° waitSet ç­‰å¾…
- `obj.notify()` åœ¨ object ä¸Šæ­£åœ¨ waitSet ç­‰å¾…çš„çº¿ç¨‹ä¸­æŒ‘ä¸€ä¸ªå”¤é†’
- `obj.notifyAll()`  è®© object ä¸Šæ­£åœ¨ waitSet ç­‰å¾…çš„çº¿ç¨‹å…¨éƒ¨å”¤é†’

å®ƒä»¬éƒ½æ˜¯çº¿ç¨‹ä¹‹é—´è¿›è¡Œåä½œçš„æ‰‹æ®µï¼Œéƒ½å±äº Object å¯¹è±¡çš„æ–¹æ³•ã€‚å¿…é¡»è·å¾—æ­¤å¯¹è±¡çš„é”ï¼Œæ‰èƒ½è°ƒç”¨è¿™å‡ ä¸ªæ–¹æ³•

```java
@Slf4j(topic = "c.TestWaitNotify")
public class TestWaitNotify {
    final static Object obj = new Object();

    public static void main(String[] args) {

        new Thread(() -> {
            synchronized (obj) {
                log.debug("æ‰§è¡Œ....");
                try {
                    obj.wait(); // è®©çº¿ç¨‹åœ¨objä¸Šä¸€ç›´ç­‰å¾…ä¸‹å»
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                log.debug("å…¶å®ƒä»£ç ....");
            }
        },"t1").start();

        new Thread(() -> {
            synchronized (obj) {
                log.debug("æ‰§è¡Œ....");
                try {
                    obj.wait(); // è®©çº¿ç¨‹åœ¨objä¸Šä¸€ç›´ç­‰å¾…ä¸‹å»
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                log.debug("å…¶å®ƒä»£ç ....");
            }
        },"t2").start();

        // ä¸»çº¿ç¨‹ä¸¤ç§’åæ‰§è¡Œ
        sleep(0.5);
        log.debug("å”¤é†’ obj ä¸Šå…¶å®ƒçº¿ç¨‹");
        synchronized (obj) {
            obj.notify(); // å”¤é†’objä¸Šä¸€ä¸ªçº¿ç¨‹
//            obj.notifyAll(); // å”¤é†’objä¸Šæ‰€æœ‰ç­‰å¾…çº¿ç¨‹
        }
    }
}
```

```shell
# ç»“æœ
19:58:16.638 c.TestWaitNotify [t1] - æ‰§è¡Œ....
19:58:16.644 c.TestWaitNotify [t2] - æ‰§è¡Œ....
19:58:17.146 c.TestWaitNotify [main] - å”¤é†’ obj ä¸Šå…¶å®ƒçº¿ç¨‹
19:58:17.146 c.TestWaitNotify [t1] - å…¶å®ƒä»£ç ....
```

`wait()` æ–¹æ³•ä¼šé‡Šæ”¾å¯¹è±¡çš„é”ï¼Œè¿›å…¥ WaitSet ç­‰å¾…åŒºï¼Œä»è€Œè®©å…¶ä»–çº¿ç¨‹å°±æœºä¼šè·å–å¯¹è±¡çš„é”ã€‚æ— é™åˆ¶ç­‰å¾…ï¼Œç›´åˆ° notify ä¸ºæ­¢

`wait(long n)` æœ‰æ—¶é™çš„ç­‰å¾…, åˆ° n æ¯«ç§’åç»“æŸç­‰å¾…ï¼Œæˆ–æ˜¯è¢« notify



### 2. wait notify çš„æ­£ç¡®å§¿åŠ¿

`sleep(long n)` å’Œ `wait(long n)` çš„åŒºåˆ«

- sleep æ˜¯ Thread æ–¹æ³•ï¼Œè€Œ wait æ˜¯ Object çš„æ–¹æ³•
- sleep ä¸éœ€è¦å¼ºåˆ¶å’Œ synchronized é…åˆä½¿ç”¨ï¼Œä½† wait éœ€è¦ å’Œ synchronized ä¸€èµ·ç”¨
- sleep åœ¨ç¡çœ çš„åŒæ—¶ï¼Œä¸ä¼šé‡Šæ”¾å¯¹è±¡é”çš„ï¼Œä½† wait åœ¨ç­‰å¾…çš„æ—¶å€™ä¼šé‡Šæ”¾å¯¹è±¡é”
- å®ƒä»¬ çŠ¶æ€ TIMED_WAITING

```java
@Slf4j(topic = "c.Test19")
public class Test19 {
    static final Object lock = new Object();
    public static void main(String[] args) {
        new Thread(() -> {
            synchronized (lock) {
                log.debug("è·å¾—é”");
                try {
//                    Thread.sleep(20000);
                    lock.wait(20000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }, "t1").start();

        Sleeper.sleep(1);
        synchronized (lock) {
            log.debug("è·å¾—é”");
        }
    }
}
```



**1. Step1**

```java
@Slf4j(topic = "c.TestCorrectPosture")
public class TestCorrectPostureStep1 {
    static final Object room = new Object();
    static boolean hasCigarette = false; // æœ‰æ²¡æœ‰çƒŸ
    static boolean hasTakeout = false;

    public static void main(String[] args) {
        new Thread(() -> {
            synchronized (room) {
                log.debug("æœ‰çƒŸæ²¡ï¼Ÿ[{}]", hasCigarette);
                if (!hasCigarette) {
                    log.debug("æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼");
                    sleep(2);
                }
                log.debug("æœ‰çƒŸæ²¡ï¼Ÿ[{}]", hasCigarette);
                if (hasCigarette) {
                    log.debug("å¯ä»¥å¼€å§‹å¹²æ´»äº†");
                }
            }
        }, "å°å—").start();

        for (int i = 0; i < 5; i++) {
            new Thread(() -> {
                synchronized (room) {
                    log.debug("å¯ä»¥å¼€å§‹å¹²æ´»äº†");
                }
            }, "å…¶å®ƒäºº").start();
        }

        sleep(1);
        new Thread(() -> {
            // è¿™é‡Œèƒ½ä¸èƒ½åŠ  synchronized (room)ï¼Ÿ
            hasCigarette = true;
            log.debug("çƒŸåˆ°äº†å™¢ï¼");
        }, "é€çƒŸçš„").start();
    }
}
```

- å…¶å®ƒå¹²æ´»çš„çº¿ç¨‹ï¼Œéƒ½è¦ä¸€ç›´é˜»å¡ï¼Œæ•ˆç‡å¤ªä½
- å°å—çº¿ç¨‹å¿…é¡»ç¡è¶³ 2s åæ‰èƒ½é†’æ¥ï¼Œå°±ç®—çƒŸæå‰é€åˆ°ï¼Œä¹Ÿæ— æ³•ç«‹åˆ»é†’æ¥
- åŠ äº† synchronized (room) åï¼Œå°±å¥½æ¯”å°å—åœ¨é‡Œé¢åé”äº†é—¨ç¡è§‰ï¼ŒçƒŸæ ¹æœ¬æ²¡æ³•é€è¿›é—¨ï¼Œmain æ²¡åŠ  synchronized å°±å¥½åƒ main çº¿ç¨‹æ˜¯ç¿»çª—æˆ·è¿›æ¥çš„
- è§£å†³æ–¹æ³•ï¼Œä½¿ç”¨ wait - notify æœºåˆ¶



**2. Step2**

```java
@Slf4j(topic = "c.TestCorrectPosture")
public class TestCorrectPostureStep2 {
    static final Object room = new Object();
    static boolean hasCigarette = false;
    static boolean hasTakeout = false;

    public static void main(String[] args) {
        new Thread(() -> {
            synchronized (room) {
                log.debug("æœ‰çƒŸæ²¡ï¼Ÿ[{}]", hasCigarette);
                if (!hasCigarette) {
                    log.debug("æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼");
                    try {
                        room.wait(2000);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
                log.debug("æœ‰çƒŸæ²¡ï¼Ÿ[{}]", hasCigarette);
                if (hasCigarette) {
                    log.debug("å¯ä»¥å¼€å§‹å¹²æ´»äº†");
                }
            }
        }, "å°å—").start();

        for (int i = 0; i < 5; i++) {
            new Thread(() -> {
                synchronized (room) {
                    log.debug("å¯ä»¥å¼€å§‹å¹²æ´»äº†");
                }
            }, "å…¶å®ƒäºº").start();
        }

        sleep(1);
        new Thread(() -> {
            synchronized (room) {
                hasCigarette = true;
                log.debug("çƒŸåˆ°äº†å™¢ï¼");
                room.notify();
            }
        }, "é€çƒŸçš„").start();
    }
}
```

- è§£å†³äº†å…¶å®ƒå¹²æ´»çš„çº¿ç¨‹é˜»å¡çš„é—®é¢˜
- ä½†å¦‚æœæœ‰å…¶å®ƒçº¿ç¨‹ä¹Ÿåœ¨ç­‰å¾…æ¡ä»¶å‘¢ï¼Ÿ



**3. Step3**

```java
@Slf4j(topic = "c.TestCorrectPosture")
public class TestCorrectPostureStep3 {
    static final Object room = new Object();
    static boolean hasCigarette = false;
    static boolean hasTakeout = false;

    // è™šå‡å”¤é†’
    public static void main(String[] args) {
        new Thread(() -> {
            synchronized (room) {
                log.debug("æœ‰çƒŸæ²¡ï¼Ÿ[{}]", hasCigarette);
                if (!hasCigarette) {
                    log.debug("æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼");
                    try {
                        room.wait();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
                log.debug("æœ‰çƒŸæ²¡ï¼Ÿ[{}]", hasCigarette);
                if (hasCigarette) {
                    log.debug("å¯ä»¥å¼€å§‹å¹²æ´»äº†");
                } else {
                    log.debug("æ²¡å¹²æˆæ´»...");
                }
            }
        }, "å°å—").start();

        new Thread(() -> {
            synchronized (room) {
                Thread thread = Thread.currentThread();
                log.debug("å¤–å–é€åˆ°æ²¡ï¼Ÿ[{}]", hasTakeout);
                if (!hasTakeout) {
                    log.debug("æ²¡å¤–å–ï¼Œå…ˆæ­‡ä¼šï¼");
                    try {
                        room.wait();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
                log.debug("å¤–å–é€åˆ°æ²¡ï¼Ÿ[{}]", hasTakeout);
                if (hasTakeout) {
                    log.debug("å¯ä»¥å¼€å§‹å¹²æ´»äº†");
                } else {
                    log.debug("æ²¡å¹²æˆæ´»...");
                }
            }
        }, "å°å¥³").start();

        sleep(1);
        new Thread(() -> {
            synchronized (room) {
                hasTakeout = true;
                log.debug("å¤–å–åˆ°äº†å™¢ï¼");
                room.notifyAll();
            }
        }, "é€å¤–å–çš„").start();
    }
}
```

- notify åªèƒ½éšæœºå”¤é†’ä¸€ä¸ª WaitSet ä¸­çš„çº¿ç¨‹ï¼Œè¿™æ—¶å¦‚æœæœ‰å…¶å®ƒçº¿ç¨‹ä¹Ÿåœ¨ç­‰å¾…ï¼Œé‚£ä¹ˆå°±å¯èƒ½å”¤é†’ä¸äº†æ­£ç¡®çš„çº¿ ç¨‹ï¼Œç§°ä¹‹ä¸ºã€è™šå‡å”¤é†’ã€‘
- è§£å†³æ–¹æ³•ï¼Œæ”¹ä¸º notifyAll



**4. Step4**

```java
@Slf4j(topic = "c.TestCorrectPosture")
public class TestCorrectPostureStep4 {
    static final Object room = new Object();
    static boolean hasCigarette = false;
    static boolean hasTakeout = false;

    public static void main(String[] args) {
        new Thread(() -> {
            synchronized (room) {
                log.debug("æœ‰çƒŸæ²¡ï¼Ÿ[{}]", hasCigarette);
                while (!hasCigarette) {
                    log.debug("æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼");
                    try {
                        room.wait();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
                log.debug("æœ‰çƒŸæ²¡ï¼Ÿ[{}]", hasCigarette);
                if (hasCigarette) {
                    log.debug("å¯ä»¥å¼€å§‹å¹²æ´»äº†");
                } else {
                    log.debug("æ²¡å¹²æˆæ´»...");
                }
            }
        }, "å°å—").start();

        new Thread(() -> {
            synchronized (room) {
                Thread thread = Thread.currentThread();
                log.debug("å¤–å–é€åˆ°æ²¡ï¼Ÿ[{}]", hasTakeout);
                if (!hasTakeout) {
                    log.debug("æ²¡å¤–å–ï¼Œå…ˆæ­‡ä¼šï¼");
                    try {
                        room.wait();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
                log.debug("å¤–å–é€åˆ°æ²¡ï¼Ÿ[{}]", hasTakeout);
                if (hasTakeout) {
                    log.debug("å¯ä»¥å¼€å§‹å¹²æ´»äº†");
                } else {
                    log.debug("æ²¡å¹²æˆæ´»...");
                }
            }
        }, "å°å¥³").start();

        sleep(1);
        new Thread(() -> {
            synchronized (room) {
                hasTakeout = true;
                log.debug("å¤–å–åˆ°äº†å™¢ï¼");
                room.notifyAll();
            }
        }, "é€å¤–å–çš„").start();
    }
}
```

- ç”¨ notifyAll ä»…è§£å†³æŸä¸ªçº¿ç¨‹çš„å”¤é†’é—®é¢˜ï¼Œä½†ä½¿ç”¨ if + wait åˆ¤æ–­ä»…æœ‰ä¸€æ¬¡æœºä¼šï¼Œä¸€æ—¦æ¡ä»¶ä¸æˆç«‹ï¼Œå°±æ²¡æœ‰é‡æ–° åˆ¤æ–­çš„æœºä¼šäº†
- è§£å†³æ–¹æ³•ï¼Œç”¨ while + waitï¼Œå½“æ¡ä»¶ä¸æˆç«‹ï¼Œå†æ¬¡ wait



**5. Step5**

```java
synchronized(lock) {
    while(æ¡ä»¶ä¸æˆç«‹) {
        lock.wait();
    }
    // å¹²æ´»
}
// å¦ä¸€ä¸ªçº¿ç¨‹
synchronized(lock) {
    lock.notifyAll();
}
```



### 3. åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ ğŸ

#### 1. å®šä¹‰

å³ Guarded Suspensionï¼Œç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œç»“æœ

- æœ‰ä¸€ä¸ªç»“æœéœ€è¦ä»ä¸€ä¸ªçº¿ç¨‹ä¼ é€’åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œè®©ä»–ä»¬å…³è”åŒä¸€ä¸ª GuardedObject
- å¦‚æœæœ‰ç»“æœä¸æ–­ä»ä¸€ä¸ªçº¿ç¨‹åˆ°å¦ä¸€ä¸ªçº¿ç¨‹é‚£ä¹ˆå¯ä»¥ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆè§ç”Ÿäº§è€…/æ¶ˆè´¹è€…ï¼‰
- JDK ä¸­ï¼Œjoin çš„å®ç°ã€Future çš„å®ç°ï¼Œé‡‡ç”¨çš„å°±æ˜¯æ­¤æ¨¡å¼
- å› ä¸ºè¦ç­‰å¾…å¦ä¸€æ–¹çš„ç»“æœï¼Œå› æ­¤å½’ç±»åˆ°åŒæ­¥æ¨¡å¼

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162217983.png)



#### 2. å®ç°

```java
class GuardedObject {
    private Object response;
    private final Object lock = new Object();
    public Object get() {
        synchronized (lock) {
            // æ¡ä»¶ä¸æ»¡è¶³åˆ™ç­‰å¾…
            while (response == null) {
                try {
                    lock.wait();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
            return response;
        }
    }
    public void complete(Object response) {
        synchronized (lock) {
            // æ¡ä»¶æ»¡è¶³ï¼Œé€šçŸ¥ç­‰å¾…çº¿ç¨‹
            this.response = response;
            lock.notifyAll();
        }
    }
}
```

ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œç»“æœ

```java
public static void main(String[] args) {
    GuardedObject guardedObject = new GuardedObject();
    new Thread(() -> {
        try {
            // å­çº¿ç¨‹æ‰§è¡Œä¸‹è½½
            List<String> response = download();
            log.debug("download complete...");
            guardedObject.complete(response);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }).start();
    log.debug("waiting...");
    // ä¸»çº¿ç¨‹é˜»å¡ç­‰å¾…
    Object response = guardedObject.get();
    log.debug("get response: [{}] lines", ((List<String>) response).size());
}
```

```shell
# ç»“æœ
08:42:18.568 [main] c.TestGuardedObject - waiting...
08:42:23.312 [Thread-0] c.TestGuardedObject - download complete...
08:42:23.312 [main] c.TestGuardedObject - get response: [3] lines
```



#### 3. å¸¦è¶…æ—¶ç‰ˆ GuardedObject

å¦‚æœè¦æ§åˆ¶è¶…æ—¶æ—¶é—´å‘¢

```java
class GuardedObjectV2 {
    private Object response;
    private final Object lock = new Object();
    public Object get(long millis) {
        synchronized (lock) {
            // 1) è®°å½•æœ€åˆæ—¶é—´
            long begin = System.currentTimeMillis();
            // 2) å·²ç»ç»å†çš„æ—¶é—´
            long timePassed = 0;
            while (response == null) {
                // 4) å‡è®¾ millis æ˜¯ 1000ï¼Œç»“æœåœ¨ 400 æ—¶å”¤é†’äº†ï¼Œé‚£ä¹ˆè¿˜æœ‰ 600 è¦ç­‰
                long waitTime = millis - timePassed;
                log.debug("waitTime: {}", waitTime);
                if (waitTime <= 0) {
                    log.debug("break...");
                    break;
                }
                try {
                    lock.wait(waitTime);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                // 3) å¦‚æœæå‰è¢«å”¤é†’ï¼Œè¿™æ—¶å·²ç»ç»å†çš„æ—¶é—´å‡è®¾ä¸º 400
                timePassed = System.currentTimeMillis() - begin;
                log.debug("timePassed: {}, object is null {}", 
                          timePassed, response == null);
            }
            return response;
        }
    }
    public void complete(Object response) {
        synchronized (lock) {
            // æ¡ä»¶æ»¡è¶³ï¼Œé€šçŸ¥ç­‰å¾…çº¿ç¨‹
            this.response = response;
            log.debug("notify...");
            lock.notifyAll();
        }
    }
}
```

æµ‹è¯•ï¼Œæ²¡æœ‰è¶…æ—¶

```java
public static void main(String[] args) {
    GuardedObjectV2 v2 = new GuardedObjectV2();
    new Thread(() -> {
        sleep(1);
        v2.complete(null);
        sleep(1);
        v2.complete(Arrays.asList("a", "b", "c"));
    }).start();
    Object response = v2.get(2500);
    if (response != null) {
        log.debug("get response: [{}] lines", ((List<String>) response).size());
    } else {
        log.debug("can't get response");
    }
}
```

æµ‹è¯•ï¼Œæ²¡è¶…æ—¶

```java
// ç­‰å¾…æ—¶é—´ä¸è¶³
List<String> lines = v2.get(1500);
```



#### 4. åŸç†ä¹‹ join

`join(long millis)` æºç 

 ```java
 public final synchronized void join(long millis)
     throws InterruptedException {
     long base = System.currentTimeMillis();
     long now = 0;
 
     if (millis < 0) {
         throw new IllegalArgumentException("timeout value is negative");
     }
 
     if (millis == 0) {
         while (isAlive()) {
             wait(0);
         }
     } else {
         // joinä¸€ä¸ªæŒ‡å®šçš„æ—¶é—´
         while (isAlive()) {
             long delay = millis - now;
             if (delay <= 0) {
                 break;
             }
             wait(delay);
             now = System.currentTimeMillis() - base;
         }
     }
 }
 ```



#### 5. å¤šä»»åŠ¡ç‰ˆ GuardedObject

å›¾ä¸­ Futures å°±å¥½æ¯”å±…æ°‘æ¥¼ä¸€å±‚çš„ä¿¡ç®±ï¼ˆæ¯ä¸ªä¿¡ç®±æœ‰æˆ¿é—´ç¼–å·ï¼‰ï¼Œå·¦ä¾§çš„ t0ï¼Œt2ï¼Œt4 å°±å¥½æ¯”ç­‰å¾…é‚®ä»¶çš„å±…æ°‘ï¼Œå³ ä¾§çš„ t1ï¼Œt3ï¼Œt5 å°±å¥½æ¯”é‚®é€’å‘˜

å¦‚æœéœ€è¦åœ¨å¤šä¸ªç±»ä¹‹é—´ä½¿ç”¨ GuardedObject å¯¹è±¡ï¼Œä½œä¸ºå‚æ•°ä¼ é€’ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œå› æ­¤è®¾è®¡ä¸€ä¸ªç”¨æ¥è§£è€¦çš„ä¸­é—´ç±»ï¼Œ è¿™æ ·ä¸ä»…èƒ½å¤Ÿè§£è€¦ã€ç»“æœç­‰å¾…è€…ã€‘å’Œã€ç»“æœç”Ÿäº§è€…ã€‘ï¼Œè¿˜èƒ½å¤ŸåŒæ—¶æ”¯æŒå¤šä¸ªä»»åŠ¡çš„ç®¡ç†

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162218253.png)

æ–°å¢ id ç”¨æ¥æ ‡è¯† GuardedObject

 ```java
 class GuardedObject {
     // æ ‡è¯† Guarded Object
     private int id;
     public GuardedObject(int id) {
         this.id = id;
     }
     public int getId() {
         return id;
     }
     // ç»“æœ
     private Object response;
     // è·å–ç»“æœ
     // timeout è¡¨ç¤ºè¦ç­‰å¾…å¤šä¹… 2000
     public Object get(long timeout) {
         synchronized (this) {
             // å¼€å§‹æ—¶é—´ 15:00:00
             long begin = System.currentTimeMillis();
             // ç»å†çš„æ—¶é—´
             long passedTime = 0;
             while (response == null) {
                 // è¿™ä¸€è½®å¾ªç¯åº”è¯¥ç­‰å¾…çš„æ—¶é—´
                 long waitTime = timeout - passedTime;
                 // ç»å†çš„æ—¶é—´è¶…è¿‡äº†æœ€å¤§ç­‰å¾…æ—¶é—´æ—¶ï¼Œé€€å‡ºå¾ªç¯
                 if (timeout - passedTime <= 0) {
                     break;
                 }
                 try {
                     this.wait(waitTime); // è™šå‡å”¤é†’ 15:00:01
                 } catch (InterruptedException e) {
                     e.printStackTrace();
                 }
                 // æ±‚å¾—ç»å†æ—¶é—´
                 passedTime = System.currentTimeMillis() - begin; // 15:00:02 1s
             }
             return response;
         }
     }
     // äº§ç”Ÿç»“æœ
     public void complete(Object response) {
         synchronized (this) {
             // ç»™ç»“æœæˆå‘˜å˜é‡èµ‹å€¼
             this.response = response;
             this.notifyAll();
         }
     }
 }
 ```

ä¸­é—´è§£è€¦ç±»

```java
class Mailboxes {
    private static Map<Integer, GuardedObject> boxes = new Hashtable<>();
    private static int id = 1;
    // äº§ç”Ÿå”¯ä¸€ id
    private static synchronized int generateId() {
        return id++;
    }
    public static GuardedObject getGuardedObject(int id) {
        return boxes.remove(id);
    }
    public static GuardedObject createGuardedObject() {
        GuardedObject go = new GuardedObject(generateId());
        boxes.put(go.getId(), go);
        return go;
    }
    public static Set<Integer> getIds() {
        return boxes.keySet();
    }
}

```

ä¸šåŠ¡ç›¸å…³ç±»

```java
class People extends Thread{
    @Override
    public void run() {
        // æ”¶ä¿¡
        GuardedObject guardedObject = Mailboxes.createGuardedObject();
        log.debug("å¼€å§‹æ”¶ä¿¡ id:{}", guardedObject.getId());
        Object mail = guardedObject.get(5000);
        log.debug("æ”¶åˆ°ä¿¡ id:{}, å†…å®¹:{}", guardedObject.getId(), mail);
    }
}
```

```java
class Postman extends Thread {
    private int id;
    private String mail;
    public Postman(int id, String mail) {
        this.id = id;
        this.mail = mail;
    }
    @Override
    public void run() {
        GuardedObject guardedObject = Mailboxes.getGuardedObject(id);
        log.debug("é€ä¿¡ id:{}, å†…å®¹:{}", id, mail);
        guardedObject.complete(mail);
    }
}

```

æµ‹è¯•

```java
public static void main(String[] args) throws InterruptedException {
    for (int i = 0; i < 3; i++) {
        new People().start();
    }
    Sleeper.sleep(1);
    for (Integer id : Mailboxes.getIds()) {
        new Postman(id, "å†…å®¹" + id).start();
    }
}
```

```shell
# æŸæ¬¡è¿è¡Œç»“æœ
21:12:22.159 c.People [Thread-0] - å¼€å§‹æ”¶ä¿¡ id:3
21:12:22.159 c.People [Thread-1] - å¼€å§‹æ”¶ä¿¡ id:1
21:12:22.159 c.People [Thread-2] - å¼€å§‹æ”¶ä¿¡ id:2
21:12:23.163 c.Postman [Thread-4] - é€ä¿¡ id:2, å†…å®¹:å†…å®¹2
21:12:23.163 c.Postman [Thread-3] - é€ä¿¡ id:3, å†…å®¹:å†…å®¹3
21:12:23.164 c.People [Thread-2] - æ”¶åˆ°ä¿¡ id:2, å†…å®¹:å†…å®¹2
21:12:23.164 c.People [Thread-0] - æ”¶åˆ°ä¿¡ id:3, å†…å®¹:å†…å®¹3
21:12:23.164 c.Postman [Thread-5] - é€ä¿¡ id:1, å†…å®¹:å†…å®¹1
21:12:23.164 c.People [Thread-1] - æ”¶åˆ°ä¿¡ id:1, å†…å®¹:å†…å®¹1
```





### 4. å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…/æ¶ˆè´¹è€… ğŸ

**1ã€å®šä¹‰**

- ä¸å‰é¢çš„ä¿æŠ¤æ€§æš‚åœä¸­çš„ GuardObject ä¸åŒï¼Œä¸éœ€è¦äº§ç”Ÿç»“æœå’Œæ¶ˆè´¹ç»“æœçš„çº¿ç¨‹ä¸€ä¸€å¯¹åº”
- æ¶ˆè´¹é˜Ÿåˆ—å¯ä»¥ç”¨æ¥å¹³è¡¡ç”Ÿäº§å’Œæ¶ˆè´¹çš„çº¿ç¨‹èµ„æº
- ç”Ÿäº§è€…ä»…è´Ÿè´£äº§ç”Ÿç»“æœæ•°æ®ï¼Œä¸å…³å¿ƒæ•°æ®è¯¥å¦‚ä½•å¤„ç†ï¼Œè€Œæ¶ˆè´¹è€…ä¸“å¿ƒå¤„ç†ç»“æœæ•°æ®
- æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æœ‰å®¹é‡é™åˆ¶çš„ï¼Œæ»¡æ—¶ä¸ä¼šå†åŠ å…¥æ•°æ®ï¼Œç©ºæ—¶ä¸ä¼šå†æ¶ˆè€—æ•°æ®
- JDK ä¸­å„ç§é˜»å¡é˜Ÿåˆ—ï¼Œé‡‡ç”¨çš„å°±æ˜¯è¿™ç§æ¨¡å¼

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162218447.png)



**2ã€å®ç°**

```java
/ æ¶ˆæ¯é˜Ÿåˆ—ç±», java çº¿ç¨‹ä¹‹é—´é€šä¿¡
@Slf4j(topic = "c.MessageQueue")
class MessageQueue {
    // æ¶ˆæ¯çš„é˜Ÿåˆ—é›†åˆ
    private LinkedList<Message> list = new LinkedList<>();
    // é˜Ÿåˆ—å®¹é‡
    private int capcity;

    public MessageQueue(int capcity) {
        this.capcity = capcity;
    }

    // è·å–æ¶ˆæ¯
    public Message take() {
        // æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º
        synchronized (list) {
            while(list.isEmpty()) {
                try {
                    log.debug("é˜Ÿåˆ—ä¸ºç©º, æ¶ˆè´¹è€…çº¿ç¨‹ç­‰å¾…");
                    list.wait();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
            // ä»é˜Ÿåˆ—å¤´éƒ¨è·å–æ¶ˆæ¯å¹¶è¿”å›
            Message message = list.removeFirst();
            log.debug("æ¶ˆè´¹æ¶ˆæ¯ {}", message);
            list.notifyAll();
            return message;
        }
    }

    // å­˜å…¥æ¶ˆæ¯
    public void put(Message message) {
        synchronized (list) {
            // æ£€æŸ¥å¯¹è±¡æ˜¯å¦å·²æ»¡
            while(list.size() == capcity) {
                try {
                    log.debug("é˜Ÿåˆ—å·²æ»¡, ç”Ÿäº§è€…çº¿ç¨‹ç­‰å¾…");
                    list.wait();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
            // å°†æ¶ˆæ¯åŠ å…¥é˜Ÿåˆ—å°¾éƒ¨
            list.addLast(message);
            log.debug("ç”Ÿäº§æ¶ˆæ¯ {}", message);
            list.notifyAll();
        }
    }
}

final class Message {
    private int id;
    private Object value;

    public Message(int id, Object value) {
        this.id = id;
        this.value = value;
    }

    public int getId() {
        return id;
    }

    public Object getValue() {
        return value;
    }

    @Override
    public String toString() {
        return "Message{" +
                "id=" + id +
                ", value=" + value +
                '}';
    }
}
```

æµ‹è¯•

```java
@Slf4j(topic = "c.Test21")
public class Test21 {
    public static void main(String[] args) {
        MessageQueue queue = new MessageQueue(2);
        for (int i = 0; i < 3; i++) {
            int id = i;
            new Thread(() -> {
                queue.put(new Message(id , "å€¼"+id));
            }, "ç”Ÿäº§è€…" + i).start();
        }

        new Thread(() -> {
            while(true) {
                sleep(1);
                Message message = queue.take();
            }
        }, "æ¶ˆè´¹è€…").start();
    }
}
```





## 6. Park & Unpark

### 1. åŸºæœ¬ä½¿ç”¨

å®ƒä»¬æ˜¯ LockSupport ç±»ä¸­çš„æ–¹æ³•

```java
// æš‚åœå½“å‰çº¿ç¨‹
LockSupport.park(); 
// æ¢å¤æŸä¸ªçº¿ç¨‹çš„è¿è¡Œ
LockSupport.unpark(æš‚åœçº¿ç¨‹å¯¹è±¡)
```

1ã€å…ˆ park å† unpark

```java
public static void main(String[] args) {
    Thread t1 = new Thread(() -> {
        log.debug("start...");
        sleep(1);
        log.debug("park...");
        LockSupport.park();
        log.debug("resume...");
    },"t1");
    t1.start();
    sleep(2);
    log.debug("unpark...");
    LockSupport.unpark(t1);
}
```

2ã€å…ˆ unpark å† park

 ```java
 public static void main(String[] args) {
     Thread t1 = new Thread(() -> {
         log.debug("start...");
         sleep(2);
         log.debug("park...");
         LockSupport.park();
         log.debug("resume...");
     }, "t1");
     t1.start();
     sleep(1);
     log.debug("unpark...");
     LockSupport.unpark(t1);
 }
 ```

> ä¸¤ç§æƒ…å†µ t1 éƒ½å¯ä»¥æ­£å¸¸æ‰§è¡Œç»“æŸ

**ç‰¹ç‚¹**

ä¸ Object çš„ wait & notify ç›¸æ¯”

- waitï¼Œnotify å’Œ notifyAll å¿…é¡»é…åˆ Object Monitor ä¸€èµ·ä½¿ç”¨ï¼Œè€Œ parkï¼Œunpark ä¸å¿…
- park & unpark æ˜¯ä»¥çº¿ç¨‹ä¸ºå•ä½æ¥ã€é˜»å¡ã€‘å’Œã€å”¤é†’ã€‘çº¿ç¨‹ï¼Œè€Œ notify åªèƒ½éšæœºå”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ï¼ŒnotifyAll  æ˜¯å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ï¼Œå°±ä¸é‚£ä¹ˆã€ç²¾ç¡®ã€‘
- park & unpark å¯ä»¥å…ˆ unparkï¼Œè€Œ wait & notify ä¸èƒ½å…ˆ notify



### 2. park/unpark åŸç†

æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸€ä¸ª Parker å¯¹è±¡ï¼Œç”±ä¸‰éƒ¨åˆ†ç»„æˆ `_counter` ï¼Œ `_cond` å’Œ `_mutex` æ‰“ä¸ªæ¯”å–»

- çº¿ç¨‹å°±åƒä¸€ä¸ªæ—…äººï¼ŒParker å°±åƒä»–éšèº«æºå¸¦çš„èƒŒåŒ…ï¼Œæ¡ä»¶å˜é‡å°±å¥½æ¯”èƒŒåŒ…ä¸­çš„å¸ç¯·ã€‚_counter å°±å¥½æ¯”èƒŒåŒ…ä¸­ çš„å¤‡ç”¨å¹²ç²®ï¼ˆ0 ä¸ºè€—å°½ï¼Œ1 ä¸ºå……è¶³ï¼‰

- è°ƒç”¨ park å°±æ˜¯è¦çœ‹éœ€ä¸éœ€è¦åœä¸‹æ¥æ­‡æ¯
  - å¦‚æœå¤‡ç”¨å¹²ç²®è€—å°½ï¼Œé‚£ä¹ˆé’»è¿›å¸ç¯·æ­‡æ¯
  - å¦‚æœå¤‡ç”¨å¹²ç²®å……è¶³ï¼Œé‚£ä¹ˆä¸éœ€åœç•™ï¼Œç»§ç»­å‰è¿›

- è°ƒç”¨ unparkï¼Œå°±å¥½æ¯”ä»¤å¹²ç²®å……è¶³
  - å¦‚æœè¿™æ—¶çº¿ç¨‹è¿˜åœ¨å¸ç¯·ï¼Œå°±å”¤é†’è®©ä»–ç»§ç»­å‰è¿›
  - å¦‚æœè¿™æ—¶çº¿ç¨‹è¿˜åœ¨è¿è¡Œï¼Œé‚£ä¹ˆä¸‹æ¬¡ä»–è°ƒç”¨ park æ—¶ï¼Œä»…æ˜¯æ¶ˆè€—æ‰å¤‡ç”¨å¹²ç²®ï¼Œä¸éœ€åœç•™ç»§ç»­å‰è¿›
    - å› ä¸ºèƒŒåŒ…ç©ºé—´æœ‰é™ï¼Œå¤šæ¬¡è°ƒç”¨ unpark ä»…ä¼šè¡¥å……ä¸€ä»½å¤‡ç”¨å¹²ç²®

è°ƒç”¨ `Unsafe.park()`

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162218474.png)

1. å½“å‰çº¿ç¨‹è°ƒç”¨ Unsafe.park() æ–¹æ³• 
2. æ£€æŸ¥ _counter ï¼Œæœ¬æƒ…å†µä¸º 0ï¼Œè¿™æ—¶ï¼Œè·å¾— _mutex äº’æ–¥é”
3. çº¿ç¨‹è¿›å…¥ _cond æ¡ä»¶å˜é‡é˜»å¡
4. è®¾ç½® _counter = 0

è°ƒç”¨ `Unsafe.unpark(Thread-0)`

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162218347.png)

1. è°ƒç”¨ Unsafe.unpark(Thread_0) æ–¹æ³•ï¼Œè®¾ç½® _counter ä¸º 1

2. å”¤é†’ _cond æ¡ä»¶å˜é‡ä¸­çš„ Thread_0
3. Thread_0 æ¢å¤è¿è¡Œ
4. è®¾ç½® _counter ä¸º 0

è°ƒç”¨ `Unsafe.unpark(Thread-0)`ï¼Œå†è°ƒç”¨ `Unsafe.park()`

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162218297.png)

1. è°ƒç”¨ Unsafe.unpark(Thread_0) æ–¹æ³•ï¼Œè®¾ç½® _counter ä¸º 1

2. å½“å‰çº¿ç¨‹è°ƒç”¨ Unsafe.park() æ–¹æ³•

3. æ£€æŸ¥ _counter ï¼Œæœ¬æƒ…å†µä¸º 1ï¼Œè¿™æ—¶çº¿ç¨‹æ— éœ€é˜»å¡ï¼Œç»§ç»­è¿è¡Œ

4. è®¾ç½® _counter ä¸º 0





## 7. é‡æ–°ç†è§£çº¿ç¨‹çŠ¶æ€è½¬æ¢

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162219826.png)

å‡è®¾æœ‰çº¿ç¨‹ `Thread t`

**æƒ…å†µ 1** `NEW --> RUNNABLE`

- å½“è°ƒç”¨ `t.start()` æ–¹æ³•æ—¶ï¼Œç”± `NEW --> RUNNABL`



**æƒ…å†µ 2** `RUNNABLE <--> WAITING`

**t çº¿ç¨‹**ç”¨ `synchronized(obj)` è·å–äº†å¯¹è±¡é”

- è°ƒç”¨ `obj.wait()` æ–¹æ³•æ—¶ï¼Œ**t çº¿ç¨‹**ä» `RUNNABLE --> WAITING`

- è°ƒç”¨ `obj.notify()` ï¼Œ `obj.notifyAll()` ï¼Œ `t.interrupt()` æ—¶
  - ç«äº‰é”æˆåŠŸï¼Œ**t çº¿ç¨‹**ä» `WAITING --> RUNNABLE`
  - ç«äº‰é”å¤±è´¥ï¼Œ**t çº¿ç¨‹**ä» `WAITING --> BLOCKED`

```java
@Slf4j(topic = "c.TestWaitNotify")
public class TestWaitNotify {
    final static Object obj = new Object();

    public static void main(String[] args) {
        new Thread(() -> {
            synchronized (obj) {
                log.debug("æ‰§è¡Œ....");
                try {
                    obj.wait(); // è®©çº¿ç¨‹åœ¨objä¸Šä¸€ç›´ç­‰å¾…ä¸‹å»
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                log.debug("å…¶å®ƒä»£ç ....");
            }
        },"t1").start();

        sleep(0.5);
        new Thread(() -> {
            synchronized (obj) {
                log.debug("æ‰§è¡Œ....");
                try {
                    obj.wait(); // è®©çº¿ç¨‹åœ¨objä¸Šä¸€ç›´ç­‰å¾…ä¸‹å»
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                log.debug("å…¶å®ƒä»£ç ....");
            }
        },"t2").start();

        // ä¸»çº¿ç¨‹ä¸¤ç§’åæ‰§è¡Œ
        sleep(0.5);
        log.debug("å”¤é†’ obj ä¸Šå…¶å®ƒçº¿ç¨‹");
        synchronized (obj) {
//            obj.notify(); // å”¤é†’objä¸Šä¸€ä¸ªçº¿ç¨‹
            obj.notifyAll(); // å”¤é†’objä¸Šæ‰€æœ‰ç­‰å¾…çº¿ç¨‹
        }
    }
}
```



**æƒ…å†µ 3** `RUNNABLE <--> WAITING`

- å½“å‰çº¿ç¨‹è°ƒç”¨ `t.join()` æ–¹æ³•æ—¶ï¼Œå½“å‰çº¿ç¨‹ä» `RUNNABLE --> WAITING`
  - æ³¨æ„æ˜¯**å½“å‰çº¿ç¨‹**åœ¨**t çº¿ç¨‹å¯¹è±¡çš„ç›‘è§†å™¨**ä¸Šç­‰å¾…

- **t çº¿ç¨‹**è¿è¡Œç»“æŸï¼Œæˆ–è°ƒç”¨äº†**å½“å‰çº¿ç¨‹**çš„ `interrupt()` æ—¶ï¼Œå½“å‰çº¿ç¨‹ä» `WAITING --> RUNNABLE`



**æƒ…å†µ 4** `RUNNABLE <--> WAITING`

- å½“å‰çº¿ç¨‹è°ƒç”¨ `LockSupport.park()` æ–¹æ³•ä¼šè®©å½“å‰çº¿ç¨‹ä» `RUNNABLE --> WAITING`

- è°ƒç”¨ `LockSupport.unpark(ç›®æ ‡çº¿ç¨‹)` æˆ–è°ƒç”¨äº†çº¿ç¨‹ çš„ `interrupt()` ï¼Œä¼šè®©ç›®æ ‡çº¿ç¨‹ä» `WAITING -->  RUNNABLE`



**æƒ…å†µ 5** `RUNNABLE <--> TIMED_WAITING`

**t çº¿ç¨‹**ç”¨ `synchronized(obj)` è·å–äº†å¯¹è±¡é”å

- è°ƒç”¨ `obj.wait(long n)` æ–¹æ³•æ—¶ï¼Œ**t çº¿ç¨‹**ä» `RUNNABLE --> TIMED_WAITING`
- **t çº¿ç¨‹**ç­‰å¾…æ—¶é—´è¶…è¿‡äº† n æ¯«ç§’ï¼Œæˆ–è°ƒç”¨ `obj.notify()` ï¼Œ `obj.notifyAll()` ï¼Œ `t.interrupt()` æ—¶
  - ç«äº‰é”æˆåŠŸï¼Œ**t çº¿ç¨‹**ä» `TIMED_WAITING --> RUNNABLE`
  - ç«äº‰é”å¤±è´¥ï¼Œ**t çº¿ç¨‹**ä» `TIMED_WAITING --> BLOCKED`



**æƒ…å†µ 6** `RUNNABLE <--> TIMED_WAITING`

- **å½“å‰çº¿ç¨‹**è°ƒç”¨ `t.join(long n)` æ–¹æ³•æ—¶ï¼Œ**å½“å‰çº¿ç¨‹**ä» `RUNNABLE --> TIMED_WAITING`
  - æ³¨æ„æ˜¯**å½“å‰çº¿ç¨‹**åœ¨**t çº¿ç¨‹å¯¹è±¡çš„ç›‘è§†å™¨**ä¸Šç­‰å¾…

- **å½“å‰çº¿ç¨‹**ç­‰å¾…æ—¶é—´è¶…è¿‡äº† n æ¯«ç§’ï¼Œæˆ–**t çº¿ç¨‹**è¿è¡Œç»“æŸï¼Œæˆ–è°ƒç”¨äº†**å½“å‰çº¿ç¨‹**çš„ `interrupt()` æ—¶ï¼Œå½“å‰çº¿ç¨‹ä» `TIMED_WAITING --> RUNNABLE`



**æƒ…å†µ 7** `RUNNABLE <--> TIMED_WAITING`

- **å½“å‰çº¿ç¨‹**è°ƒç”¨ `Thread.sleep(long n)` ï¼Œ**å½“å‰çº¿ç¨‹**ä» `RUNNABLE --> TIMED_WAITING`
- **å½“å‰çº¿ç¨‹**ç­‰å¾…æ—¶é—´è¶…è¿‡äº† n æ¯«ç§’ï¼Œ**å½“å‰çº¿ç¨‹**ä» `TIMED_WAITING --> RUNNABLE`



**æƒ…å†µ 8** `RUNNABLE <--> TIMED_WAITING`

- **å½“å‰çº¿ç¨‹**è°ƒç”¨ `LockSupport.parkNanos(long nanos)` æˆ– `LockSupport.parkUntil(long millis)` æ—¶ï¼Œå½“å‰çº¿ ç¨‹ä» `RUNNABLE --> TIMED_WAITING`
- è°ƒç”¨ `LockSupport.unpark(ç›®æ ‡çº¿ç¨‹)` æˆ–è°ƒç”¨äº†çº¿ç¨‹ çš„ `interrupt()` ï¼Œæˆ–æ˜¯ç­‰å¾…è¶…æ—¶ï¼Œä¼šè®©**ç›®æ ‡çº¿ç¨‹**ä» `TIMED_WAITING--> RUNNABLE`



**æƒ…å†µ 9** `RUNNABLE <--> BLOCKED`

- **t çº¿ç¨‹**ç”¨ `synchronized(obj)` è·å–äº†å¯¹è±¡é”æ—¶å¦‚æœç«äº‰å¤±è´¥ï¼Œä» `RUNNABLE --> BLOCKED`
- æŒ obj é”çº¿ç¨‹çš„åŒæ­¥ä»£ç å—æ‰§è¡Œå®Œæ¯•ï¼Œä¼šå”¤é†’è¯¥å¯¹è±¡ä¸Šæ‰€æœ‰ `BLOCKED` çš„çº¿ç¨‹é‡æ–°ç«äº‰ï¼Œå¦‚æœå…¶ä¸­ **t çº¿ç¨‹**ç«äº‰ æˆåŠŸï¼Œä» `BLOCKED --> RUNNABLE` ï¼Œå…¶å®ƒå¤±è´¥çš„çº¿ç¨‹ä»ç„¶ `BLOCKED`



**æƒ…å†µ 10** `RUNNABLE <--> TERMINATED`

å½“å‰çº¿ç¨‹æ‰€æœ‰ä»£ç è¿è¡Œå®Œæ¯•ï¼Œè¿›å…¥ `TERMINATED`





## 8. å¤šé”

**å¤šæŠŠä¸ç›¸å¹²çš„é”**

ä¸€é—´å¤§å±‹å­æœ‰ä¸¤ä¸ªåŠŸèƒ½ï¼šç¡è§‰ã€å­¦ä¹ ï¼Œäº’ä¸ç›¸å¹²ã€‚

ç°åœ¨å°å—è¦å­¦ä¹ ï¼Œå°å¥³è¦ç¡è§‰ï¼Œä½†å¦‚æœåªç”¨ä¸€é—´å±‹å­ï¼ˆä¸€ä¸ªå¯¹è±¡é”ï¼‰çš„è¯ï¼Œé‚£ä¹ˆå¹¶å‘åº¦å¾ˆä½

è§£å†³æ–¹æ³•æ˜¯å‡†å¤‡å¤šä¸ªæˆ¿é—´ï¼ˆå¤šä¸ªå¯¹è±¡é”ï¼‰

ä¾‹å¦‚

```java
class BigRoom {
    public void sleep() {
        synchronized (this) {
            log.debug("sleeping 2 å°æ—¶");
            Sleeper.sleep(2);
        }
    }
    public void study() {
        synchronized (this) {
            log.debug("study 1 å°æ—¶");
            Sleeper.sleep(1);
        }
    }
}
```

æ‰§è¡Œ

```java
BigRoom bigRoom = new BigRoom();
new Thread(() -> {
    bigRoom.compute();
},"å°å—").start();
new Thread(() -> {
    bigRoom.sleep();
},"å°å¥³").start();
```



**æ”¹è¿›**

```java
class BigRoom {
    private final Object studyRoom = new Object();
    private final Object bedRoom = new Object();
    public void sleep() {
        synchronized (bedRoom) {
            log.debug("sleeping 2 å°æ—¶");
            Sleeper.sleep(2);
        }
    }
    public void study() {
        synchronized (studyRoom) {
            log.debug("study 1 å°æ—¶");
            Sleeper.sleep(1);
        }
    }
}

```

**å°†é”çš„ç²’åº¦ç»†åˆ†**

- å¥½å¤„ï¼Œæ˜¯å¯ä»¥å¢å¼ºå¹¶å‘åº¦
- åå¤„ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è·å¾—å¤šæŠŠé”ï¼Œå°±å®¹æ˜“å‘ç”Ÿæ­»é”





## 9. æ´»è·ƒæ€§

### 1. æ­»é”

#### 1. æ­»é”

æœ‰è¿™æ ·çš„æƒ…å†µï¼šä¸€ä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è·å–å¤šæŠŠé”ï¼Œè¿™æ—¶å°±å®¹æ˜“å‘ç”Ÿæ­»é”

`t1 çº¿ç¨‹` è·å¾— `Aå¯¹è±¡` é”ï¼Œæ¥ä¸‹æ¥æƒ³è·å– `Bå¯¹è±¡` çš„é”

`t2 çº¿ç¨‹` è·å¾— `Bå¯¹è±¡` é”ï¼Œæ¥ä¸‹æ¥æƒ³è·å– `Aå¯¹è±¡` çš„é”ï¼Œä¾‹ï¼š

```java
private static void test1() {
    Object A = new Object();
    Object B = new Object();
    Thread t1 = new Thread(() -> {
        synchronized (A) {
            log.debug("lock A");
            sleep(1);
            synchronized (B) {
                log.debug("lock B");
                log.debug("æ“ä½œ...");
            }
        }
    }, "t1");

    Thread t2 = new Thread(() -> {
        synchronized (B) {
            log.debug("lock B");
            sleep(0.5);
            synchronized (A) {
                log.debug("lock A");
                log.debug("æ“ä½œ...");
            }
        }
    }, "t2");
    t1.start();
    t2.start();
}
```



#### 2. å®šä½æ­»é”

- æ£€æµ‹æ­»é”å¯ä»¥ä½¿ç”¨ jconsoleå·¥å…·ï¼Œæˆ–è€…ä½¿ç”¨ jps å®šä½è¿›ç¨‹ idï¼Œå†ç”¨ jstack å®šä½æ­»é”ï¼š

```bash
C:\Users\Administrator>jps
11232 Jps
1200
12132 Launcher
21336 TestDeadLock
```

```bash
C:\Users\Administrator>jstack 21336
...
Found one Java-level deadlock:
=============================
"t2":
  waiting to lock monitor 0x000002905f66f368 (object 0x00000000d737e9b8, a java.lang.Object),
  which is held by "t1"
"t1":
  waiting to lock monitor 0x000002905e4cc928 (object 0x00000000d737e9c8, a java.lang.Object),
  which is held by "t2"

Java stack information for the threads listed above:
===================================================
"t2":
        at cn.itcast.n4.deadlock.TestDeadLock.lambda$test1$1(TestDeadLock.java:32)
        - waiting to lock <0x00000000d737e9b8> (a java.lang.Object)
        - locked <0x00000000d737e9c8> (a java.lang.Object)
        at cn.itcast.n4.deadlock.TestDeadLock$$Lambda$2/1908923184.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:748)
"t1":
        at cn.itcast.n4.deadlock.TestDeadLock.lambda$test1$0(TestDeadLock.java:21)
        - waiting to lock <0x00000000d737e9c8> (a java.lang.Object)
        - locked <0x00000000d737e9b8> (a java.lang.Object)
        at cn.itcast.n4.deadlock.TestDeadLock$$Lambda$1/1207140081.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:748)

Found 1 deadlock.
```

- é¿å…æ­»é”è¦æ³¨æ„åŠ é”é¡ºåº
- å¦å¤–å¦‚æœç”±äºæŸä¸ªçº¿ç¨‹è¿›å…¥äº†æ­»å¾ªç¯ï¼Œå¯¼è‡´å…¶å®ƒçº¿ç¨‹ä¸€ç›´ç­‰å¾…ï¼Œå¯¹äºè¿™ç§æƒ…å†µ linux ä¸‹å¯ä»¥é€šè¿‡ top å…ˆå®šä½åˆ° CPU å ç”¨é«˜çš„ Java è¿›ç¨‹ï¼Œå†åˆ©ç”¨ `top -Hp è¿›ç¨‹id` æ¥å®šä½æ˜¯å“ªä¸ªçº¿ç¨‹ï¼Œæœ€åå†ç”¨ jstack æ’æŸ¥





### 2. å“²å­¦å®¶å°±é¤é—®é¢˜

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162219109.png)

æœ‰äº”ä½å“²å­¦å®¶ï¼Œå›´ååœ¨åœ†æ¡Œæ—ã€‚

- ä»–ä»¬åªåšä¸¤ä»¶äº‹ï¼Œæ€è€ƒå’Œåƒé¥­ï¼Œæ€è€ƒä¸€ä¼šåƒå£é¥­ï¼Œåƒå®Œé¥­åæ¥ç€æ€è€ƒã€‚
- åƒé¥­æ—¶è¦ç”¨ä¸¤æ ¹ç­·å­åƒï¼Œæ¡Œä¸Šå…±æœ‰ 5 æ ¹ç­·å­ï¼Œæ¯ä½å“²å­¦å®¶å·¦å³æ‰‹è¾¹å„æœ‰ä¸€æ ¹ç­·å­ã€‚
- å¦‚æœç­·å­è¢«èº«è¾¹çš„äººæ‹¿ç€ï¼Œè‡ªå·±å°±å¾—ç­‰å¾…

```java
@Slf4j(topic = "c.Philosopher")
class Philosopher extends Thread {
    Chopstick left;
    Chopstick right;

    public Philosopher(String name, Chopstick left, Chopstick right) {
        super(name);
        this.left = left;
        this.right = right;
    }

    @Override
    public void run() {
        while (true) {
            //ã€€å°è¯•è·å¾—å·¦æ‰‹ç­·å­
            synchronized (left) {
                // å°è¯•è·å¾—å³æ‰‹ç­·å­
                synchronized (right) {
                    eat();
                }
            }
        }
    }
    
    private void eat() {
        log.debug("eating...");
        Sleeper.sleep(0.5);
    }
}

class Chopstick {
    String name;

    public Chopstick(String name) {
        this.name = name;
    }

    @Override
    public String toString() {
        return "ç­·å­{" + name + '}';
    }
}
```

æµ‹è¯•

```java
public static void main(String[] args) {
    Chopstick c1 = new Chopstick("1");
    Chopstick c2 = new Chopstick("2");
    Chopstick c3 = new Chopstick("3");
    Chopstick c4 = new Chopstick("4");
    Chopstick c5 = new Chopstick("5");
    new Philosopher("è‹æ ¼æ‹‰åº•", c1, c2).start();
    new Philosopher("æŸæ‹‰å›¾", c2, c3).start();
    new Philosopher("äºšé‡Œå£«å¤šå¾·", c3, c4).start();
    new Philosopher("èµ«æ‹‰å…‹åˆ©ç‰¹", c4, c5).start();
    new Philosopher("é˜¿åŸºç±³å¾·", c1, c5).start();
}
```

æ‰§è¡Œä¸€ä¼šç¨‹åºä¸å†æ‰“å°ä¿¡æ¯

ä½¿ç”¨ jconsole æ£€æµ‹æ­»é”ï¼Œå‘ç°

```bash
-------------------------------------------------------------------------
åç§°: é˜¿åŸºç±³å¾·
çŠ¶æ€: cn.itcast.Chopstick@1540e19d (ç­·å­1) ä¸Šçš„BLOCKED, æ‹¥æœ‰è€…: è‹æ ¼æ‹‰åº•
æ€»é˜»æ­¢æ•°: 2, æ€»ç­‰å¾…æ•°: 1
å †æ ˆè·Ÿè¸ª:
cn.itcast.Philosopher.run(TestDinner.java:48)
 - å·²é”å®š cn.itcast.Chopstick@6d6f6e28 (ç­·å­5)
-------------------------------------------------------------------------
åç§°: è‹æ ¼æ‹‰åº•
çŠ¶æ€: cn.itcast.Chopstick@677327b6 (ç­·å­2) ä¸Šçš„BLOCKED, æ‹¥æœ‰è€…: æŸæ‹‰å›¾
æ€»é˜»æ­¢æ•°: 2, æ€»ç­‰å¾…æ•°: 1
å †æ ˆè·Ÿè¸ª:
cn.itcast.Philosopher.run(TestDinner.java:48)
 - å·²é”å®š cn.itcast.Chopstick@1540e19d (ç­·å­1)
-------------------------------------------------------------------------
åç§°: æŸæ‹‰å›¾
çŠ¶æ€: cn.itcast.Chopstick@14ae5a5 (ç­·å­3) ä¸Šçš„BLOCKED, æ‹¥æœ‰è€…: äºšé‡Œå£«å¤šå¾·
æ€»é˜»æ­¢æ•°: 2, æ€»ç­‰å¾…æ•°: 0
å †æ ˆè·Ÿè¸ª:
cn.itcast.Philosopher.run(TestDinner.java:48)
 - å·²é”å®š cn.itcast.Chopstick@677327b6 (ç­·å­2)
-------------------------------------------------------------------------
åç§°: äºšé‡Œå£«å¤šå¾·
çŠ¶æ€: cn.itcast.Chopstick@7f31245a (ç­·å­4) ä¸Šçš„BLOCKED, æ‹¥æœ‰è€…: èµ«æ‹‰å…‹åˆ©ç‰¹
æ€»é˜»æ­¢æ•°: 1, æ€»ç­‰å¾…æ•°: 1
å †æ ˆè·Ÿè¸ª:
cn.itcast.Philosopher.run(TestDinner.java:48)
 - å·²é”å®š cn.itcast.Chopstick@14ae5a5 (ç­·å­3)
-------------------------------------------------------------------------
åç§°: èµ«æ‹‰å…‹åˆ©ç‰¹
çŠ¶æ€: cn.itcast.Chopstick@6d6f6e28 (ç­·å­5) ä¸Šçš„BLOCKED, æ‹¥æœ‰è€…: é˜¿åŸºç±³å¾·
æ€»é˜»æ­¢æ•°: 2, æ€»ç­‰å¾…æ•°: 0
å †æ ˆè·Ÿè¸ª:
cn.itcast.Philosopher.run(TestDinner.java:48)
 - å·²é”å®š cn.itcast.Chopstick@7f31245a (ç­·å­4)
```

è¿™ç§çº¿ç¨‹æ²¡æœ‰æŒ‰é¢„æœŸç»“æŸï¼Œæ‰§è¡Œä¸ä¸‹å»çš„æƒ…å†µï¼Œå½’ç±»ä¸ºã€æ´»è·ƒæ€§ã€‘é—®é¢˜ï¼Œé™¤äº†æ­»é”ä»¥å¤–ï¼Œè¿˜æœ‰æ´»é”å’Œé¥¥é¥¿è€…ä¸¤ç§æƒ… å†µ

è¯¥é—®é¢˜è§£å†³è§ **ReentrantLock**





### 3. æ´»é”

æ´»é”å‡ºç°åœ¨ä¸¤ä¸ªçº¿ç¨‹äº’ç›¸æ”¹å˜å¯¹æ–¹çš„ç»“æŸæ¡ä»¶ï¼Œæœ€åè°ä¹Ÿæ— æ³•ç»“æŸï¼Œä¾‹å¦‚

```java
public class TestLiveLock {
    static volatile int count = 10;
    static final Object lock = new Object();
    public static void main(String[] args) {
        new Thread(() -> {
            // æœŸæœ›å‡åˆ° 0 é€€å‡ºå¾ªç¯
            while (count > 0) {
                sleep(0.2);
                count--;
                log.debug("count: {}", count);
            }
        }, "t1").start();
        new Thread(() -> {
            // æœŸæœ›è¶…è¿‡ 20 é€€å‡ºå¾ªç¯
            while (count < 20) {
                sleep(0.2);
                count++;
                log.debug("count: {}", count);
            }
        }, "t2").start();
    }
}
```





### 4. é¥¥é¥¿

å¾ˆå¤šæ•™ç¨‹ä¸­æŠŠé¥¥é¥¿å®šä¹‰ä¸ºï¼Œä¸€ä¸ªçº¿ç¨‹ç”±äºä¼˜å…ˆçº§å¤ªä½ï¼Œå§‹ç»ˆå¾—ä¸åˆ° CPU è°ƒåº¦æ‰§è¡Œï¼Œä¹Ÿä¸èƒ½å¤Ÿç»“æŸï¼Œé¥¥é¥¿çš„æƒ…å†µä¸ æ˜“æ¼”ç¤ºï¼Œè®²è¯»å†™é”æ—¶ä¼šæ¶‰åŠé¥¥é¥¿é—®é¢˜

ä¸‹é¢æˆ‘è®²ä¸€ä¸‹æˆ‘é‡åˆ°çš„ä¸€ä¸ªçº¿ç¨‹é¥¥é¥¿çš„ä¾‹å­ï¼Œå…ˆæ¥çœ‹çœ‹ä½¿ç”¨é¡ºåºåŠ é”çš„æ–¹å¼è§£å†³ä¹‹å‰çš„æ­»é”é—®é¢˜

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162219659.png)

é¡ºåºåŠ é”çš„è§£å†³æ–¹æ¡ˆ

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162220899.png)





## 10. ReentrantLock

ç›¸å¯¹äº synchronized å®ƒå…·å¤‡å¦‚ä¸‹ç‰¹ç‚¹

- å¯ä¸­æ–­
- å¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´
- å¯ä»¥è®¾ç½®ä¸ºå…¬å¹³é”
- æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡

ä¸ synchronized ä¸€æ ·ï¼Œéƒ½æ”¯æŒå¯é‡å…¥

åŸºæœ¬è¯­æ³•

````java
// è·å–é”
reentrantLock.lock();
try {
    // ä¸´ç•ŒåŒº
} finally {
    // é‡Šæ”¾é”
    reentrantLock.unlock();
}
````



### 1. å¯é‡å…¥

å¯é‡å…¥æ˜¯æŒ‡åŒä¸€ä¸ªçº¿ç¨‹å¦‚æœé¦–æ¬¡è·å¾—äº†è¿™æŠŠé”ï¼Œé‚£ä¹ˆå› ä¸ºå®ƒæ˜¯è¿™æŠŠé”çš„æ‹¥æœ‰è€…ï¼Œå› æ­¤æœ‰æƒåˆ©å†æ¬¡è·å–è¿™æŠŠé”

å¦‚æœæ˜¯ä¸å¯é‡å…¥é”ï¼Œé‚£ä¹ˆç¬¬äºŒæ¬¡è·å¾—é”æ—¶ï¼Œè‡ªå·±ä¹Ÿä¼šè¢«é”æŒ¡ä½

```java
static ReentrantLock lock = new ReentrantLock();
public static void main(String[] args) {
    method1();
}
public static void method1() {
    lock.lock();
    try {
        log.debug("execute method1");
        method2();
    } finally {
        lock.unlock();
    }
}
public static void method2() {
    lock.lock();
    try {
        log.debug("execute method2");
        method3();
    } finally {
        lock.unlock();
    }
}
public static void method3() {
    lock.lock();
    try {
        log.debug("execute method3");
    } finally {
        lock.unlock();
    }
}

```





### 2. å¯æ‰“æ–­

```java
public static void main(String[] args) {
    ReentrantLock lock = new ReentrantLock();
    Thread t1 = new Thread(() -> {
        log.debug("å¯åŠ¨...");
        try {
            // å¦‚æœæ²¡æœ‰ç«äº‰ï¼Œé‚£ä¹ˆæ­¤æ–¹æ³•å°±ä¼šè·å– lock å¯¹è±¡é”
            // å¦‚æœæœ‰ç«äº‰å°±è¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼Œå¯ä»¥è¢«å…¶ä»–çº¿ç¨‹ç”¨ interrupt æ–¹å¼æ‰“æ–­
            lock.lockInterruptibly();
        } catch (InterruptedException e) {
            e.printStackTrace();
            log.debug("ç­‰é”çš„è¿‡ç¨‹ä¸­è¢«æ‰“æ–­");
            return;
        }
        try {
            log.debug("è·å¾—äº†é”");
        } finally {
            lock.unlock();
        }
    }, "t1");
    lock.lock();
    log.debug("è·å¾—äº†é”");
    t1.start();
    try {
        sleep(1);
        t1.interrupt();
        log.debug("æ‰§è¡Œæ‰“æ–­");
    } finally {
        lock.unlock();
    }
}
```

> æ³¨æ„ :  å¦‚æœæ˜¯ä¸å¯ä¸­æ–­æ¨¡å¼ï¼Œé‚£ä¹ˆå³ä½¿ä½¿ç”¨äº† interrupt ä¹Ÿä¸ä¼šè®©ç­‰å¾…ä¸­æ–­





### 3. é”è¶…æ—¶

#### 1. ç«‹åˆ»å¤±è´¥

```java
public static void main(String[] args) {
    ReentrantLock lock = new ReentrantLock();
    Thread t1 = new Thread(() -> {
        log.debug("å¯åŠ¨...");
        // å°è¯•è·å¾—é”
        if (!lock.tryLock()) {
            log.debug("è·å–ç«‹åˆ»å¤±è´¥ï¼Œè¿”å›");
            return;
        }
        try {
            log.debug("è·å¾—äº†é”");
        } finally {
            lock.unlock();
        }
    }, "t1");
    lock.lock();
    log.debug("è·å¾—äº†é”");
    t1.start();
    try {
        sleep(2);
    } finally {
        lock.unlock();
    }
}
```



#### 2. è¶…æ—¶å¤±è´¥

```java
public static void main(String[] args) {
    ReentrantLock lock = new ReentrantLock();
    Thread t1 = new Thread(() -> {
        log.debug("å¯åŠ¨...");
        try {
            if (!lock.tryLock(1, TimeUnit.SECONDS)) {
                log.debug("è·å–ç­‰å¾… 1s åå¤±è´¥ï¼Œè¿”å›");
                return;
            }
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        try {
            log.debug("è·å¾—äº†é”");
        } finally {
            lock.unlock();
        }
    }, "t1");
    lock.lock();
    log.debug("è·å¾—äº†é”");
    t1.start();
    try {
        sleep(2);
    } finally {
        lock.unlock();
    }
}
```



#### 3. ä½¿ç”¨ tryLock è§£å†³å“²å­¦å®¶å°±é¤é—®é¢˜

```java
@Slf4j(topic = "c.Philosopher")
class Philosopher extends Thread {
    Chopstick left;
    Chopstick right;

    public Philosopher(String name, Chopstick left, Chopstick right) {
        super(name);
        this.left = left;
        this.right = right;
    }

    @Override
    public void run() {
        while (true) {
            //ã€€å°è¯•è·å¾—å·¦æ‰‹ç­·å­
            if(left.tryLock()) {
                try {
                    // å°è¯•è·å¾—å³æ‰‹ç­·å­
                    if(right.tryLock()) {
                        try {
                            eat();
                        } finally {
                            right.unlock();
                        }
                    }
                } finally {
                    left.unlock(); // é‡Šæ”¾è‡ªå·±æ‰‹é‡Œçš„ç­·å­
                }
            }
        }
    }
    
    private void eat() {
        log.debug("eating...");
        Sleeper.sleep(0.5);
    }
}

class Chopstick extends ReentrantLock {
    String name;

    public Chopstick(String name) {
        this.name = name;
    }

    @Override
    public String toString() {
        return "ç­·å­{" + name + '}';
    }
}
```

æµ‹è¯•

```java
public static void main(String[] args) {
    Chopstick c1 = new Chopstick("1");
    Chopstick c2 = new Chopstick("2");
    Chopstick c3 = new Chopstick("3");
    Chopstick c4 = new Chopstick("4");
    Chopstick c5 = new Chopstick("5");
    new Philosopher("è‹æ ¼æ‹‰åº•", c1, c2).start();
    new Philosopher("æŸæ‹‰å›¾", c2, c3).start();
    new Philosopher("äºšé‡Œå£«å¤šå¾·", c3, c4).start();
    new Philosopher("èµ«æ‹‰å…‹åˆ©ç‰¹", c4, c5).start();
    new Philosopher("é˜¿åŸºç±³å¾·", c5, c1).start();
}
```





### 4. å…¬å¹³é”

ReentrantLock é»˜è®¤æ˜¯ä¸å…¬å¹³çš„

ReentrantLock æ„é€ æºç 

```java
/**
 * Creates an instance of {@code ReentrantLock}.
 * This is equivalent to using {@code ReentrantLock(false)}.
 */
public ReentrantLock() {
    sync = new NonfairSync();
}
```

```java
ReentrantLock lock = new ReentrantLock(false);
lock.lock();
for (int i = 0; i < 500; i++) {
    new Thread(() -> {
        lock.lock();
        try {
            System.out.println(Thread.currentThread().getName() + " running...");
        } finally {
            lock.unlock();
        }
    }, "t" + i).start();
}
// 1s ä¹‹åå»äº‰æŠ¢é”
Thread.sleep(1000);
new Thread(() -> {
    System.out.println(Thread.currentThread().getName() + " start...");
    lock.lock();
    try {
        System.out.println(Thread.currentThread().getName() + " running...");
    } finally {
        lock.unlock();
    }
}, "å¼ºè¡Œæ’å…¥").start();
lock.unlock();
```

å¼ºè¡Œæ’å…¥ï¼Œæœ‰æœºä¼šåœ¨ä¸­é—´è¾“å‡º

> æ³¨æ„ï¼šè¯¥å®éªŒä¸ä¸€å®šæ€»èƒ½å¤ç°

```bash
t39 running... 
t40 running... 
t41 running... 
t42 running... 
t43 running... 
å¼ºè¡Œæ’å…¥ start... 
å¼ºè¡Œæ’å…¥ running... 
t44 running... 
t45 running... 
t46 running... 
t47 running... 
t49 running... 
```



æ”¹ä¸ºå…¬å¹³é”å

```java
ReentrantLock lock = new ReentrantLock(true);
```

å¼ºè¡Œæ’å…¥ï¼Œæ€»æ˜¯åœ¨æœ€åè¾“å‡º

```bash
t465 running... 
t464 running... 
t477 running... 
t442 running... 
t468 running... 
t493 running... 
t482 running... 
t485 running... 
t481 running... 
å¼ºè¡Œæ’å…¥ running... 
```

å…¬å¹³é”ä¸€èˆ¬æ²¡æœ‰å¿…è¦ï¼Œä¼šé™ä½å¹¶å‘åº¦ï¼Œåé¢åˆ†æåŸç†æ—¶ä¼šè®²è§£





### 5. æ¡ä»¶å˜é‡

synchronized ä¸­ä¹Ÿæœ‰æ¡ä»¶å˜é‡ï¼Œå°±æ˜¯æˆ‘ä»¬è®²åŸç†æ—¶é‚£ä¸ª waitSet ä¼‘æ¯å®¤ï¼Œå½“æ¡ä»¶ä¸æ»¡è¶³æ—¶è¿›å…¥ waitSet ç­‰å¾…

ReentrantLock çš„æ¡ä»¶å˜é‡æ¯” synchronized å¼ºå¤§ä¹‹å¤„åœ¨äºï¼Œå®ƒæ˜¯æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡çš„ï¼Œè¿™å°±å¥½æ¯”

- synchronized æ˜¯é‚£äº›ä¸æ»¡è¶³æ¡ä»¶çš„çº¿ç¨‹éƒ½åœ¨ä¸€é—´ä¼‘æ¯å®¤ç­‰æ¶ˆæ¯
- è€Œ ReentrantLock æ”¯æŒå¤šé—´ä¼‘æ¯å®¤ï¼Œæœ‰ä¸“é—¨ç­‰çƒŸçš„ä¼‘æ¯å®¤ã€ä¸“é—¨ç­‰æ—©é¤çš„ä¼‘æ¯å®¤ã€å”¤é†’æ—¶ä¹Ÿæ˜¯æŒ‰ä¼‘æ¯å®¤æ¥å”¤ é†’

**ä½¿ç”¨è¦ç‚¹ï¼š**

- await å‰éœ€è¦è·å¾—é”
- await æ‰§è¡Œåï¼Œä¼šé‡Šæ”¾é”ï¼Œè¿›å…¥ conditionObject ç­‰å¾…
- await çš„çº¿ç¨‹è¢«å”¤é†’ï¼ˆæˆ–æ‰“æ–­ã€æˆ–è¶…æ—¶ï¼‰å–é‡æ–°ç«äº‰ lock é”
- ç«äº‰ lock é”æˆåŠŸåï¼Œä» await åç»§ç»­æ‰§è¡Œ

```java
public class Test24 {
    static final Object room = new Object();
    static boolean hasCigarette = false;
    static boolean hasTakeout = false;
    static ReentrantLock ROOM = new ReentrantLock();
    // ç­‰å¾…çƒŸçš„ä¼‘æ¯å®¤
    static Condition waitCigaretteSet = ROOM.newCondition();
    // ç­‰å¤–å–çš„ä¼‘æ¯å®¤
    static Condition waitTakeoutSet = ROOM.newCondition();

    public static void main(String[] args) {

        new Thread(() -> {
            ROOM.lock();
            try {
                log.debug("æœ‰çƒŸæ²¡ï¼Ÿ[{}]", hasCigarette);
                while (!hasCigarette) {
                    log.debug("æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼");
                    try {
                        waitCigaretteSet.await();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
                log.debug("å¯ä»¥å¼€å§‹å¹²æ´»äº†");
            } finally {
                ROOM.unlock();
            }
        }, "å°å—").start();

        new Thread(() -> {
            ROOM.lock();
            try {
                log.debug("å¤–å–é€åˆ°æ²¡ï¼Ÿ[{}]", hasTakeout);
                while (!hasTakeout) {
                    log.debug("æ²¡å¤–å–ï¼Œå…ˆæ­‡ä¼šï¼");
                    try {
                        waitTakeoutSet.await();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
                log.debug("å¯ä»¥å¼€å§‹å¹²æ´»äº†");
            } finally {
                ROOM.unlock();
            }
        }, "å°å¥³").start();

        sleep(1);
        new Thread(() -> {
            ROOM.lock();
            try {
                hasTakeout = true;
                waitTakeoutSet.signal();
            } finally {
                ROOM.unlock();
            }
        }, "é€å¤–å–çš„").start();

        sleep(1);

        new Thread(() -> {
            ROOM.lock();
            try {
                hasCigarette = true;
                waitCigaretteSet.signal();
            } finally {
                ROOM.unlock();
            }
        }, "é€çƒŸçš„").start();
    }
}
```





## 11. åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶ ğŸ

### 1. å›ºå®šè¿è¡Œé¡ºåº

æ¯”å¦‚ï¼Œå¿…é¡»å…ˆ 2 å 1 æ‰“å°

#### 1. wait notify ç‰ˆ

```java
// ç”¨æ¥åŒæ­¥çš„å¯¹è±¡
static Object obj = new Object();
// t2 è¿è¡Œæ ‡è®°ï¼Œ ä»£è¡¨ t2 æ˜¯å¦æ‰§è¡Œè¿‡
static boolean t2runed = false;
public static void main(String[] args) {
    Thread t1 = new Thread(() -> {
        synchronized (obj) {
            // å¦‚æœ t2 æ²¡æœ‰æ‰§è¡Œè¿‡
            while (!t2runed) { 
                try {
                    // t1 å…ˆç­‰ä¸€ä¼š
                    obj.wait(); 
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }
        System.out.println(1);
    });
    Thread t2 = new Thread(() -> {
        System.out.println(2);
        synchronized (obj) {
            // ä¿®æ”¹è¿è¡Œæ ‡è®°
            t2runed = true;
            // é€šçŸ¥ obj ä¸Šç­‰å¾…çš„çº¿ç¨‹ï¼ˆå¯èƒ½æœ‰å¤šä¸ªï¼Œå› æ­¤éœ€è¦ç”¨ notifyAllï¼‰
            obj.notifyAll();
        }
    });
    t1.start();
    t2.start();
}
```



#### 2. Park Unpark ç‰ˆ

å¯ä»¥çœ‹åˆ°ï¼Œå®ç°ä¸Šå¾ˆéº»çƒ¦ï¼š

- é¦–å…ˆï¼Œéœ€è¦ä¿è¯å…ˆ wait å† notifyï¼Œå¦åˆ™ wait çº¿ç¨‹æ°¸è¿œå¾—ä¸åˆ°å”¤é†’ã€‚å› æ­¤ä½¿ç”¨äº†ã€è¿è¡Œæ ‡è®°ã€æ¥åˆ¤æ–­è¯¥ä¸è¯¥ wait
- ç¬¬äºŒï¼Œå¦‚æœæœ‰äº›å¹²æ‰°çº¿ç¨‹é”™è¯¯åœ° notify äº† wait çº¿ç¨‹ï¼Œæ¡ä»¶ä¸æ»¡è¶³æ—¶è¿˜è¦é‡æ–°ç­‰å¾…ï¼Œä½¿ç”¨äº† while å¾ªç¯æ¥è§£å†³ æ­¤é—®é¢˜
- æœ€åï¼Œå”¤é†’å¯¹è±¡ä¸Šçš„ wait çº¿ç¨‹éœ€è¦ä½¿ç”¨ notifyAllï¼Œå› ä¸ºã€åŒæ­¥å¯¹è±¡ã€ä¸Šçš„ç­‰å¾…çº¿ç¨‹å¯èƒ½ä¸æ­¢ä¸€ä¸ª

å¯ä»¥ä½¿ç”¨ `LockSupport` ç±»çš„ park å’Œ unpark æ¥ç®€åŒ–ä¸Šé¢çš„é¢˜ç›®ï¼š

```java
Thread t1 = new Thread(() -> {
    try { Thread.sleep(1000); } catch (InterruptedException e) { }
    // å½“æ²¡æœ‰ã€è®¸å¯ã€æ—¶ï¼Œå½“å‰çº¿ç¨‹æš‚åœè¿è¡Œï¼›æœ‰ã€è®¸å¯ã€æ—¶ï¼Œç”¨æ‰è¿™ä¸ªã€è®¸å¯ã€ï¼Œå½“å‰çº¿ç¨‹æ¢å¤è¿è¡Œ
    LockSupport.park();
    System.out.println("1");
});
Thread t2 = new Thread(() -> {
    System.out.println("2");
    // ç»™çº¿ç¨‹ t1 å‘æ”¾ã€è®¸å¯ã€ï¼ˆå¤šæ¬¡è¿ç»­è°ƒç”¨ unpark åªä¼šå‘æ”¾ä¸€ä¸ªã€è®¸å¯ã€ï¼‰
    LockSupport.unpark(t1);
});
t1.start();
t2.start();

```

park å’Œ unpark æ–¹æ³•æ¯”è¾ƒçµæ´»ï¼Œä»–ä¿©è°å…ˆè°ƒç”¨ï¼Œè°åè°ƒç”¨æ— æ‰€è°“ã€‚å¹¶ä¸”æ˜¯ä»¥çº¿ç¨‹ä¸ºå•ä½è¿›è¡Œã€æš‚åœã€å’Œã€æ¢å¤ã€ï¼Œ ä¸éœ€è¦ã€åŒæ­¥å¯¹è±¡ã€å’Œã€è¿è¡Œæ ‡è®°ã€





### 2. äº¤æ›¿è¾“å‡º

çº¿ç¨‹ 1 è¾“å‡º a 5 æ¬¡ï¼Œçº¿ç¨‹ 2 è¾“å‡º b 5 æ¬¡ï¼Œçº¿ç¨‹ 3 è¾“å‡º c 5 æ¬¡ã€‚ç°åœ¨è¦æ±‚è¾“å‡º abcabcabcabcabc æ€ä¹ˆå®ç°

#### 1. wait notify ç‰ˆ

```java
@Slf4j(topic = "c.Test27")
public class Test27 {
    public static void main(String[] args) {
        WaitNotify wn = new WaitNotify(1, 5);
        new Thread(() -> {
            wn.print("a", 1, 2);
        }).start();
        new Thread(() -> {
            wn.print("b", 2, 3);
        }).start();
        new Thread(() -> {
            wn.print("c", 3, 1);
        }).start();
    }
}

/*
è¾“å‡ºå†…å®¹       ç­‰å¾…æ ‡è®°     ä¸‹ä¸€ä¸ªæ ‡è®°
   a           1             2
   b           2             3
   c           3             1
 */
class WaitNotify {
    
    // ç­‰å¾…æ ‡è®°
    private int flag; // 2
    // å¾ªç¯æ¬¡æ•°
    private int loopNumber;

    public WaitNotify(int flag, int loopNumber) {
        this.flag = flag;
        this.loopNumber = loopNumber;
    }

    // æ‰“å°               a           1             2
    public void print(String str, int waitFlag, int nextFlag) {
        for (int i = 0; i < loopNumber; i++) {
            synchronized (this) {
                while(flag != waitFlag) {
                    try {
                        this.wait();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
                System.out.print(str);
                flag = nextFlag;
                this.notifyAll();
            }
        }
    }
}
```



#### 2. Lock æ¡ä»¶å˜é‡ç‰ˆ

```java
public class Test30 {
    public static void main(String[] args) throws InterruptedException {
        AwaitSignal awaitSignal = new AwaitSignal(5);
        Condition a = awaitSignal.newCondition();
        Condition b = awaitSignal.newCondition();
        Condition c = awaitSignal.newCondition();
        new Thread(() -> {
            awaitSignal.print("a", a, b);
        }).start();
        new Thread(() -> {
            awaitSignal.print("b", b, c);
        }).start();
        new Thread(() -> {
            awaitSignal.print("c", c, a);
        }).start();

        Thread.sleep(1000);
        awaitSignal.lock();
        try {
            System.out.println("å¼€å§‹...");
            a.signal();
        } finally {
            awaitSignal.unlock();
        }
    }
}

class AwaitSignal extends ReentrantLock{
    private int loopNumber;

    public AwaitSignal(int loopNumber) {
        this.loopNumber = loopNumber;
    }

    /**
     * @author dahuang
     * @date 2021/11/16 18:53
     * @param str     æ‰“å°å†…å®¹
     * @param current è¿›å…¥å“ªä¸€é—´ä¼‘æ¯å®¤
     * @param next    ä¸‹ä¸€é—´ä¼‘æ¯å®¤
     */
    public void print(String str, Condition current, Condition next) {
        for (int i = 0; i < loopNumber; i++) {
            lock();
            try {
                current.await();
                System.out.print(str);
                next.signal();
            } catch (InterruptedException e) {
                e.printStackTrace();
            } finally {
                unlock();
            }
        }
    }
}
```



#### 3. Park Unpark ç‰ˆ

```java
public class Test31 {

    static Thread t1;
    static Thread t2;
    static Thread t3;
    public static void main(String[] args) {
        ParkUnpark pu = new ParkUnpark(5);
        t1 = new Thread(() -> {
            pu.print("a", t2);
        });
        t2 = new Thread(() -> {
            pu.print("b", t3);
        });
        t3 = new Thread(() -> {
            pu.print("c", t1);
        });
        t1.start();
        t2.start();
        t3.start();
        LockSupport.unpark(t1);
    }
}

class ParkUnpark {

    private int loopNumber;

    public ParkUnpark(int loopNumber) {
        this.loopNumber = loopNumber;
    }

    public void print(String str, Thread next) {
        for (int i = 0; i < loopNumber; i++) {
            LockSupport.park();
            System.out.print(str);
            LockSupport.unpark(next);
        }
    }
}
```





## 12. å°ç»“

**æœ¬ç« æˆ‘ä»¬éœ€è¦é‡ç‚¹æŒæ¡çš„æ˜¯**

- åˆ†æå¤šçº¿ç¨‹è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œå“ªäº›ä»£ç ç‰‡æ®µå±äºä¸´ç•ŒåŒº
- ä½¿ç”¨ synchronized äº’æ–¥è§£å†³ä¸´ç•ŒåŒºçš„çº¿ç¨‹å®‰å…¨é—®é¢˜
  - æŒæ¡ synchronized é”å¯¹è±¡è¯­æ³•
  - æŒæ¡ synchronzied åŠ è½½æˆå‘˜æ–¹æ³•å’Œé™æ€æ–¹æ³•è¯­æ³•
  - æŒæ¡ wait/notify åŒæ­¥æ–¹æ³•

- ä½¿ç”¨ lock äº’æ–¥è§£å†³ä¸´ç•ŒåŒºçš„çº¿ç¨‹å®‰å…¨é—®é¢˜
  - æŒæ¡ lock çš„ä½¿ç”¨ç»†èŠ‚ï¼šå¯æ‰“æ–­ã€é”è¶…æ—¶ã€å…¬å¹³é”ã€æ¡ä»¶å˜é‡

- å­¦ä¼šåˆ†æå˜é‡çš„çº¿ç¨‹å®‰å…¨æ€§ã€æŒæ¡å¸¸è§çº¿ç¨‹å®‰å…¨ç±»çš„ä½¿ç”¨
- äº†è§£çº¿ç¨‹æ´»è·ƒæ€§é—®é¢˜ï¼šæ­»é”ã€æ´»é”ã€é¥¥é¥¿

**åº”ç”¨æ–¹é¢**

- äº’æ–¥ï¼šä½¿ç”¨ synchronized æˆ– Lock è¾¾åˆ°å…±äº«èµ„æºäº’æ–¥æ•ˆæœ
- åŒæ­¥ï¼šä½¿ç”¨ wait/notify æˆ– Lock çš„æ¡ä»¶å˜é‡æ¥è¾¾åˆ°çº¿ç¨‹é—´é€šä¿¡æ•ˆæœ

**åŸç†æ–¹é¢**

- monitorã€synchronized ã€wait/notify åŸç†
- synchronized è¿›é˜¶åŸç†
- park & unpark åŸç†

**æ¨¡å¼æ–¹é¢**

- åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ
- å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…æ¶ˆè´¹è€…
- åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶








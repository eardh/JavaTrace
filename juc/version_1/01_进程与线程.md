# è¿›ç¨‹ä¸çº¿ç¨‹

## 1.  è¿›ç¨‹ä¸çº¿ç¨‹

### 1. æ¦‚å¿µ

#### 1. è¿›ç¨‹

- ç¨‹åºç”±æŒ‡ä»¤å’Œæ•°æ®ç»„æˆï¼Œä½†æ˜¯è¿™äº›æŒ‡ä»¤è¦è¿è¡Œï¼Œæ•°æ®è¦è¯»å†™ï¼Œå°±å¿…é¡»å°†æŒ‡ä»¤åŠ è½½åˆ°cpuï¼Œæ•°æ®åŠ è½½è‡³å†…å­˜ã€‚åœ¨æŒ‡ä»¤è¿è¡Œè¿‡ç¨‹ä¸­è¿˜éœ€è¦ç”¨åˆ°ç£ç›˜ï¼Œç½‘ç»œç­‰è®¾å¤‡ï¼Œè¿›ç¨‹å°±æ˜¯ç”¨æ¥åŠ è½½æŒ‡ä»¤ç®¡ç†å†…å­˜ç®¡ç†IOçš„
- å½“ä¸€ä¸ªæŒ‡ä»¤è¢«è¿è¡Œï¼Œä»ç£ç›˜åŠ è½½è¿™ä¸ªç¨‹åºçš„ä»£ç åˆ°å†…å­˜ï¼Œè¿™æ—¶å€™å°±å¼€å¯äº†ä¸€ä¸ªè¿›ç¨‹
- è¿›ç¨‹å°±å¯ä»¥è§†ä¸ºç¨‹åºçš„ä¸€ä¸ªå®ä¾‹ï¼Œå¤§éƒ¨åˆ†ç¨‹åºéƒ½å¯ä»¥è¿è¡Œå¤šä¸ªå®ä¾‹è¿›ç¨‹ï¼ˆä¾‹å¦‚è®°äº‹æœ¬ï¼Œæµè§ˆå™¨ç­‰ï¼‰ï¼Œéƒ¨åˆ†åªå¯ä»¥è¿è¡Œä¸€ä¸ªå®ä¾‹è¿›ç¨‹ï¼ˆä¾‹å¦‚360å®‰å…¨å«å£«ï¼‰



#### 2. çº¿ç¨‹

- ä¸€ä¸ªè¿›ç¨‹ä¹‹å†…å¯ä»¥åˆ†ä¸ºä¸€åˆ°å¤šä¸ªçº¿ç¨‹ã€‚
- ä¸€ä¸ªçº¿ç¨‹å°±æ˜¯ä¸€ä¸ªæŒ‡ä»¤æµï¼Œå°†æŒ‡ä»¤æµä¸­çš„ä¸€æ¡æ¡æŒ‡ä»¤ä»¥ä¸€å®šçš„é¡ºåºäº¤ç»™ CPU æ‰§è¡Œ
- Java ä¸­ï¼Œçº¿ç¨‹ä½œä¸ºæœ€å°è°ƒåº¦å•ä½ï¼Œè¿›ç¨‹ä½œä¸ºèµ„æºåˆ†é…çš„æœ€å°å•ä½ã€‚ åœ¨ windows ä¸­è¿›ç¨‹æ˜¯ä¸æ´»åŠ¨çš„ï¼Œåªæ˜¯ä½œ ä¸ºçº¿ç¨‹çš„å®¹å™¨ï¼ˆè¿™é‡Œæ„Ÿè§‰è¦å­¦äº†è®¡ç®—æœºç»„æˆåŸç†ä¹‹åä¼šæ›´æœ‰æ„Ÿè§‰å§ï¼ï¼‰



#### 3. å¯¹æ¯”

- è¿›ç¨‹åŸºæœ¬ä¸Šç›¸äº’ç‹¬ç«‹çš„ï¼Œè€Œçº¿ç¨‹å­˜åœ¨äºè¿›ç¨‹å†…ï¼Œæ˜¯è¿›ç¨‹çš„ä¸€ä¸ªå­é›†
- è¿›ç¨‹æ‹¥æœ‰å…±äº«çš„èµ„æºï¼Œå¦‚å†…å­˜ç©ºé—´ç­‰ï¼Œä¾›å…¶å†…éƒ¨çš„çº¿ç¨‹å…±äº«
- è¿›ç¨‹é—´é€šä¿¡è¾ƒä¸ºå¤æ‚
  - åŒä¸€å°è®¡ç®—æœºçš„è¿›ç¨‹é€šä¿¡ç§°ä¸º IPCï¼ˆInter-process communicationï¼‰
  - ä¸åŒè®¡ç®—æœºä¹‹é—´çš„è¿›ç¨‹é€šä¿¡ï¼Œéœ€è¦é€šè¿‡ç½‘ç»œï¼Œå¹¶éµå®ˆå…±åŒçš„åè®®ï¼Œä¾‹å¦‚ HTTP
- çº¿ç¨‹é€šä¿¡ç›¸å¯¹ç®€å•ï¼Œå› ä¸ºå®ƒä»¬å…±äº«è¿›ç¨‹å†…çš„å†…å­˜ï¼Œä¸€ä¸ªä¾‹å­æ˜¯å¤šä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®åŒä¸€ä¸ªå…±äº«å˜é‡
- çº¿ç¨‹æ›´è½»é‡ï¼Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬ä¸€èˆ¬ä¸Šè¦æ¯”è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ä½





### 2. å¹¶å‘ä¸å¹¶è¡Œ

#### 1. å¹¶å‘

å•æ ¸ cpu ä¸‹ï¼Œçº¿ç¨‹å®é™…è¿˜æ˜¯ **ä¸²è¡Œæ‰§è¡Œ** çš„ã€‚æ“ä½œç³»ç»Ÿä¸­æœ‰ä¸€ä¸ªç»„ä»¶å«åšä»»åŠ¡è°ƒåº¦å™¨ï¼Œå°† cpu çš„æ—¶é—´ç‰‡ï¼ˆwindows ä¸‹æ—¶é—´ç‰‡æœ€å°çº¦ä¸º 15 æ¯«ç§’ï¼‰åˆ†ç»™ä¸åŒçš„ç¨‹åºä½¿ç”¨ï¼Œåªæ˜¯ç”±äº cpu åœ¨çº¿ç¨‹é—´ï¼ˆæ—¶é—´ç‰‡å¾ˆçŸ­ï¼‰çš„åˆ‡æ¢éå¸¸å¿«ï¼Œäººç±»æ„Ÿ è§‰æ˜¯åŒæ—¶è¿è¡Œçš„ ã€‚

æ€»ç»“ä¸ºä¸€å¥è¯å°±æ˜¯ï¼š å¾®è§‚ä¸²è¡Œï¼Œå®è§‚å¹¶è¡Œ ï¼Œ ä¸€èˆ¬ä¼šå°†è¿™ç§ çº¿ç¨‹è½®æµä½¿ç”¨ CPU çš„åšæ³•ç§°ä¸ºå¹¶å‘ï¼Œ **concurrent**

| CPU  | æ—¶é—´ç‰‡ 1 | æ—¶é—´ç‰‡ 2 | æ—¶é—´ç‰‡ 3 | æ—¶é—´ç‰‡ 4 |
| ---- | -------- | -------- | -------- | -------- |
| core | çº¿ç¨‹ 1   | çº¿ç¨‹ 2   | çº¿ç¨‹ 3   | çº¿ç¨‹ 4   |

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162206989.png)



#### 2. å¹¶è¡Œ

å¤šæ ¸ cpuä¸‹ï¼Œæ¯ä¸ª æ ¸ï¼ˆcoreï¼‰ éƒ½å¯ä»¥è°ƒåº¦è¿è¡Œçº¿ç¨‹ï¼Œè¿™æ—¶å€™çº¿ç¨‹å¯ä»¥æ˜¯å¹¶è¡Œçš„ã€‚

| CPU    | æ—¶é—´ç‰‡ 1 | æ—¶é—´ç‰‡ 2 | æ—¶é—´ç‰‡ 3 | æ—¶é—´ç‰‡ 4 |
| ------ | -------- | -------- | -------- | -------- |
| core 1 | çº¿ç¨‹ 1   | çº¿ç¨‹ 1   | çº¿ç¨‹ 3   | çº¿ç¨‹ 3   |
| core 2 | çº¿ç¨‹ 2   | çº¿ç¨‹ 4   | çº¿ç¨‹ 2   | çº¿ç¨‹ 4   |

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162206581.png)



#### 3. åŒºåˆ«

å¼•ç”¨ Rob Pike çš„ä¸€æ®µæè¿°ï¼š

- å¹¶å‘ï¼ˆconcurrentï¼‰æ˜¯åŒä¸€æ—¶é—´åº”å¯¹ï¼ˆdealing withï¼‰å¤šä»¶äº‹æƒ…çš„èƒ½åŠ›
- å¹¶è¡Œï¼ˆparallelï¼‰æ˜¯åŒä¸€æ—¶é—´åŠ¨æ‰‹åšï¼ˆdoingï¼‰å¤šä»¶äº‹æƒ…çš„èƒ½åŠ›

ä¾‹å­ï¼š

- å®¶åº­ä¸»å¦‡åšé¥­ã€æ‰“æ‰«å«ç”Ÿã€ç»™å­©å­å–‚å¥¶ï¼Œå¥¹ä¸€ä¸ªäººè½®æµäº¤æ›¿åšè¿™å¤šä»¶äº‹ï¼Œè¿™æ—¶å°±æ˜¯å¹¶å‘
- é›‡äº†3ä¸ªä¿å§†ï¼Œä¸€ä¸ªä¸“åšé¥­ã€ä¸€ä¸ªä¸“æ‰“æ‰«å«ç”Ÿã€ä¸€ä¸ªä¸“å–‚å¥¶ï¼Œäº’ä¸å¹²æ‰°ï¼Œè¿™æ—¶æ˜¯å¹¶è¡Œ
- å®¶åº­ä¸»å¦‡é›‡äº†ä¸ªä¿å§†ï¼Œå¥¹ä»¬ä¸€èµ·è¿™äº›äº‹ï¼Œè¿™æ—¶æ—¢æœ‰å¹¶å‘ï¼Œä¹Ÿæœ‰å¹¶è¡Œï¼ˆè¿™æ—¶ä¼šäº§ç”Ÿç«äº‰ï¼Œä¾‹å¦‚é”…åªæœ‰ä¸€å£ï¼Œä¸€ ä¸ªäººç”¨é”…æ—¶ï¼Œå¦ä¸€ä¸ªäººå°±å¾—ç­‰å¾…ï¼‰





### 3. åº”ç”¨

#### 1. åº”ç”¨ä¹‹å¼‚æ­¥è°ƒç”¨

ä»¥è°ƒç”¨æ–¹çš„è§’åº¦è®²ï¼Œå¦‚æœ

- éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œæ‰èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯**åŒæ­¥**
- ä¸éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œå°±èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯**å¼‚æ­¥**

æ³¨æ„ï¼šåŒæ­¥åœ¨å¤šçº¿ç¨‹ä¸­è¿˜æœ‰å¦å¤–ä¸€å±‚æ„æ€ï¼Œæ˜¯è®©å¤šä¸ªçº¿ç¨‹æ­¥è°ƒä¸€è‡´



**1ã€è®¾è®¡**

å¤šçº¿ç¨‹å¯ä»¥è®©æ–¹æ³•æ‰§è¡Œå˜ä¸ºå¼‚æ­¥çš„ï¼ˆå³ä¸è¦å·´å·´å¹²ç­‰ç€ï¼‰æ¯”å¦‚è¯´è¯»å–ç£ç›˜æ–‡ä»¶æ—¶ï¼Œå‡è®¾è¯»å–æ“ä½œèŠ±è´¹äº† 5 ç§’é’Ÿï¼Œå¦‚ æœæ²¡æœ‰çº¿ç¨‹è°ƒåº¦æœºåˆ¶ï¼Œè¿™ 5 ç§’ cpu ä»€ä¹ˆéƒ½åšä¸äº†ï¼Œå…¶å®ƒä»£ç éƒ½å¾—æš‚åœ...

**ä»£ç ï¼š**

```java
// FileReader.java
@Slf4j(topic = "c.FileReader")
public class FileReader {
    public static void read(String filename) {
        int idx = filename.lastIndexOf(File.separator);
        String shortName = filename.substring(idx + 1);
        try (FileInputStream in = new FileInputStream(filename)) {
            long start = System.currentTimeMillis();
            log.debug("read [{}] start ...", shortName);
            byte[] buf = new byte[1024];
            int n = -1;
            do {
                n = in.read(buf);
            } while (n != -1);
            long end = System.currentTimeMillis();
            log.debug("read [{}] end ... cost: {} ms", shortName, end - start);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

```java
// åŒæ­¥è°ƒç”¨
@Slf4j(topic = "c.Sync")
public class Sync {
    public static void main(String[] args) {
        FileReader.read(Constants.MP4_FULL_PATH);
        log.debug("do other things ...");
    }
}
```

```java
// å¼‚æ­¥è°ƒç”¨
@Slf4j(topic = "c.Async")
public class Async {
    public static void main(String[] args) {
        new Thread(() -> FileReader.read(Constants.MP4_FULL_PATH)).start();
        log.debug("do other things ...");
    }
}
```



**2ã€ç»“è®º**

- æ¯”å¦‚åœ¨é¡¹ç›®ä¸­ï¼Œè§†é¢‘æ–‡ä»¶éœ€è¦è½¬æ¢æ ¼å¼ç­‰æ“ä½œæ¯”è¾ƒè´¹æ—¶ï¼Œè¿™æ—¶å¼€ä¸€ä¸ªæ–°çº¿ç¨‹å¤„ç†è§†é¢‘è½¬æ¢ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ 
- tomcat çš„å¼‚æ­¥ servlet ä¹Ÿæ˜¯ç±»ä¼¼çš„ç›®çš„ï¼Œè®©ç”¨æˆ·çº¿ç¨‹å¤„ç†è€—æ—¶è¾ƒé•¿çš„æ“ä½œï¼Œé¿å…é˜»å¡ tomcat çš„å·¥ä½œçº¿ç¨‹ 
- ui ç¨‹åºä¸­ï¼Œå¼€çº¿ç¨‹è¿›è¡Œå…¶ä»–æ“ä½œï¼Œé¿å…é˜»å¡ ui çº¿ç¨‹



#### 2. åº”ç”¨ä¹‹æé«˜æ•ˆç‡ ğŸ

å……åˆ†åˆ©ç”¨å¤šæ ¸ cpu çš„ä¼˜åŠ¿ï¼Œæé«˜è¿è¡Œæ•ˆç‡ã€‚æƒ³è±¡ä¸‹é¢çš„åœºæ™¯ï¼Œæ‰§è¡Œ 3 ä¸ªè®¡ç®—ï¼Œæœ€åå°†è®¡ç®—ç»“æœæ±‡æ€»ã€‚

 ```bash
 è®¡ç®— 1 èŠ±è´¹ 10 ms
 è®¡ç®— 2 èŠ±è´¹ 11 ms
 è®¡ç®— 3 èŠ±è´¹ 9 ms
 æ±‡æ€»éœ€è¦ 1 ms
 ```

- å¦‚æœæ˜¯ä¸²è¡Œæ‰§è¡Œï¼Œé‚£ä¹ˆæ€»å…±èŠ±è´¹çš„æ—¶é—´æ˜¯ `10 + 11 + 9 + 1 = 31ms`
- ä½†å¦‚æœæ˜¯å››æ ¸ cpuï¼Œå„ä¸ªæ ¸å¿ƒåˆ†åˆ«ä½¿ç”¨çº¿ç¨‹ 1 æ‰§è¡Œè®¡ç®— 1ï¼Œçº¿ç¨‹ 2 æ‰§è¡Œè®¡ç®— 2ï¼Œçº¿ç¨‹ 3 æ‰§è¡Œè®¡ç®— 3ï¼Œé‚£ä¹ˆ 3 ä¸ª çº¿ç¨‹æ˜¯å¹¶è¡Œçš„ï¼ŒèŠ±è´¹æ—¶é—´åªå–å†³äºæœ€é•¿çš„é‚£ä¸ªçº¿ç¨‹è¿è¡Œçš„æ—¶é—´ï¼Œå³ `11ms `æœ€ååŠ ä¸Šæ±‡æ€»æ—¶é—´åªä¼šèŠ±è´¹ `12ms`

> æ³¨æ„ï¼šéœ€è¦åœ¨å¤šæ ¸ cpu æ‰èƒ½æé«˜æ•ˆç‡ï¼Œå•æ ¸ä»ç„¶æ—¶æ˜¯è½®æµæ‰§è¡Œ

**1ã€è®¾è®¡**ï¼ˆ**ä½¿ç”¨å¤šçº¿ç¨‹å……åˆ†åˆ©ç”¨ CPU**ï¼‰

1. **ç¯å¢ƒæ­å»º**
   - åŸºå‡†æµ‹è¯•å·¥å…·é€‰æ‹©ï¼Œä½¿ç”¨äº†æ¯”è¾ƒé è°±çš„ JMHï¼Œå®ƒä¼šæ‰§è¡Œç¨‹åºé¢„çƒ­ï¼Œæ‰§è¡Œå¤šæ¬¡æµ‹è¯•å¹¶å¹³å‡
   - cpu æ ¸æ•°é™åˆ¶ï¼Œæœ‰ä¸¤ç§æ€è·¯
   
     1. ä½¿ç”¨è™šæ‹Ÿæœºï¼Œåˆ†é…åˆé€‚çš„æ ¸
   
     2. ä½¿ç”¨ msconfigï¼Œåˆ†é…åˆé€‚çš„æ ¸ï¼Œéœ€è¦é‡å¯æ¯”è¾ƒéº»çƒ¦
   - å¹¶è¡Œè®¡ç®—æ–¹å¼çš„é€‰æ‹©
     1. æœ€åˆæƒ³ç›´æ¥ä½¿ç”¨ parallel streamï¼Œåæ¥å‘ç°å®ƒæœ‰è‡ªå·±çš„é—®é¢˜
     2. æ”¹ä¸ºäº†è‡ªå·±æ‰‹åŠ¨æ§åˆ¶ threadï¼Œå®ç°ç®€å•çš„å¹¶è¡Œè®¡ç®—
   - æµ‹è¯•ä»£ç å¦‚ä¸‹

```shell
mvn archetype:generate -DinteractiveMode=false -DarchetypeGroupId=org.openjdk.jmh -
DarchetypeArtifactId=jmh-java-benchmark-archetype -DgroupId=org.sample -DartifactId=test -
Dversion=1.0
```

```java
import org.openjdk.jmh.annotations.*;
import java.util.Arrays;
import java.util.concurrent.FutureTask;

@Fork(1)
@BenchmarkMode(Mode.AverageTime)
@Warmup(iterations=3)
@Measurement(iterations=5)
public class MyBenchmark {
    static int[] ARRAY = new int[1000_000_00];
    static {
        Arrays.fill(ARRAY, 1);
    }
    
    @Benchmark
    public int c() throws Exception {
        int[] array = ARRAY;
        FutureTask<Integer> t1 = new FutureTask<>(()->{
            int sum = 0;
            for(int i = 0; i < 250_000_00;i++) {
                sum += array[0+i];
            }
            return sum;
        });
        FutureTask<Integer> t2 = new FutureTask<>(()->{
            int sum = 0;
            for(int i = 0; i < 250_000_00;i++) {
                sum += array[250_000_00+i];
            }
            return sum;
        });
        FutureTask<Integer> t3 = new FutureTask<>(()->{
            int sum = 0;
            for(int i = 0; i < 250_000_00;i++) {
                sum += array[500_000_00+i];
            }
            return sum;
        });
        FutureTask<Integer> t4 = new FutureTask<>(()->{
            int sum = 0;
            for(int i = 0; i < 250_000_00;i++) {
                sum += array[750_000_00+i];
            }
            return sum;
        });
        new Thread(t1).start();
        new Thread(t2).start();
        new Thread(t3).start();
        new Thread(t4).start();
        return t1.get() + t2.get() + t3.get()+ t4.get();
    }
    
    @Benchmark
    public int d() throws Exception {
        int[] array = ARRAY;
        FutureTask<Integer> t1 = new FutureTask<>(()->{
            int sum = 0;
            for(int i = 0; i < 1000_000_00;i++) {
                sum += array[0+i];
            }
            return sum;
        });
        new Thread(t1).start();
        return t1.get();
    }
}
```



2. **åŒæ ¸ CPUï¼ˆ4ä¸ªé€»è¾‘CPUï¼‰**

```shell
C:\Users\lenovo\eclipse-workspace\test>java -jar target/benchmarks.jar
# VM invoker: C:\Program Files\Java\jdk-11\bin\java.exe
# VM options: <none>
# Warmup: 3 iterations, 1 s each
# Measurement: 5 iterations, 1 s each
# Threads: 1 thread, will synchronize iterations
# Benchmark mode: Average time, time/op
# Benchmark: org.sample.MyBenchmark.c
# Run progress: 0.00% complete, ETA 00:00:16
# Fork: 1 of 1
# Warmup Iteration 1: 0.022 s/op
# Warmup Iteration 2: 0.019 s/op
# Warmup Iteration 3: 0.020 s/op
Iteration 1: 0.020 s/op
Iteration 2: 0.020 s/op
Iteration 3: 0.020 s/op
Iteration 4: 0.020 s/op
Iteration 5: 0.020 s/op
Result: 0.020 Â±(99.9%) 0.001 s/op [Average]
 Statistics: (min, avg, max) = (0.020, 0.020, 0.020), stdev = 0.000
 Confidence interval (99.9%): [0.019, 0.021]
# VM invoker: C:\Program Files\Java\jdk-11\bin\java.exe
# VM options: <none>
# Warmup: 3 iterations, 1 s each
# Measurement: 5 iterations, 1 s each
# Threads: 1 thread, will synchronize iterations
# Benchmark mode: Average time, time/op
# Benchmark: org.sample.MyBenchmark.d
# Run progress: 50.00% complete, ETA 00:00:10
# Fork: 1 of 1
# Warmup Iteration 1: 0.042 s/op
# Warmup Iteration 2: 0.042 s/op
# Warmup Iteration 3: 0.041 s/op
Iteration 1: 0.043 s/op
Iteration 2: 0.042 s/op
Iteration 3: 0.042 s/op
Iteration 4: 0.044 s/op
Iteration 5: 0.042 s/op
Result: 0.043 Â±(99.9%) 0.003 s/op [Average]
 Statistics: (min, avg, max) = (0.042, 0.043, 0.044), stdev = 0.001
 Confidence interval (99.9%): [0.040, 0.045]
# Run complete. Total time: 00:00:20
Benchmark Mode Samples Score Score error Units
o.s.MyBenchmark.c avgt 5 0.020 0.001 s/op
o.s.MyBenchmark.d avgt 5 0.043 0.003 s/op
```

å¯ä»¥çœ‹åˆ°å¤šæ ¸ä¸‹ï¼Œæ•ˆç‡æå‡è¿˜æ˜¯å¾ˆæ˜æ˜¾çš„ï¼Œå¿«äº†ä¸€å€å·¦å³



3. **å•æ ¸ CPU**

```shell
C:\Users\lenovo\eclipse-workspace\test>java -jar target/benchmarks.jar
# VM invoker: C:\Program Files\Java\jdk-11\bin\java.exe
# VM options: <none>
# Warmup: 3 iterations, 1 s each
# Measurement: 5 iterations, 1 s each
# Threads: 1 thread, will synchronize iterations
# Benchmark mode: Average time, time/op
# Benchmark: org.sample.MyBenchmark.c
# Run progress: 0.00% complete, ETA 00:00:16
# Fork: 1 of 1
# Warmup Iteration 1: 0.064 s/op
# Warmup Iteration 2: 0.052 s/op
# Warmup Iteration 3: 1.127 s/op
Iteration 1: 0.053 s/op
Iteration 2: 0.052 s/op
Iteration 3: 0.053 s/op
Iteration 4: 0.057 s/op
Iteration 5: 0.088 s/op
Result: 0.061 Â±(99.9%) 0.060 s/op [Average]
 Statistics: (min, avg, max) = (0.052, 0.061, 0.088), stdev = 0.016
 Confidence interval (99.9%): [0.001, 0.121]
# VM invoker: C:\Program Files\Java\jdk-11\bin\java.exe
# VM options: <none>
# Warmup: 3 iterations, 1 s each
# Measurement: 5 iterations, 1 s each
# Threads: 1 thread, will synchronize iterations
# Benchmark mode: Average time, time/op
# Benchmark: org.sample.MyBenchmark.d
# Run progress: 50.00% complete, ETA 00:00:11
# Fork: 1 of 1
# Warmup Iteration 1: 0.054 s/op
# Warmup Iteration 2: 0.053 s/op
# Warmup Iteration 3: 0.051 s/op
Iteration 1: 0.096 s/op
Iteration 2: 0.054 s/op
Iteration 3: 0.065 s/op
Iteration 4: 0.050 s/op
Iteration 5: 0.055 s/op
Result: 0.064 Â±(99.9%) 0.071 s/op [Average]
 Statistics: (min, avg, max) = (0.050, 0.064, 0.096), stdev = 0.018
 Confidence interval (99.9%): [-0.007, 0.135]
# Run complete. Total time: 00:00:22
Benchmark Mode Samples Score Score error Units
o.s.MyBenchmark.c avgt 5 0.061 0.060 s/op
o.s.MyBenchmark.d avgt 5 0.064 0.071 s/op
```

æ€§èƒ½å‡ ä¹æ˜¯ä¸€æ ·çš„



**2ã€ç»“è®º**

1. å•æ ¸ cpu ä¸‹ï¼Œå¤šçº¿ç¨‹ä¸èƒ½å®é™…æé«˜ç¨‹åºè¿è¡Œæ•ˆç‡ï¼Œåªæ˜¯ä¸ºäº†èƒ½å¤Ÿåœ¨ä¸åŒçš„ä»»åŠ¡ä¹‹é—´åˆ‡æ¢ï¼Œä¸åŒçº¿ç¨‹è½®æµä½¿ç”¨ cpu ï¼Œä¸è‡³äºä¸€ä¸ªçº¿ç¨‹æ€»å ç”¨ cpuï¼Œåˆ«çš„çº¿ç¨‹æ²¡æ³•å¹²æ´» 
2. å¤šæ ¸ cpu å¯ä»¥å¹¶è¡Œè·‘å¤šä¸ªçº¿ç¨‹ï¼Œä½†èƒ½å¦æé«˜ç¨‹åºè¿è¡Œæ•ˆç‡è¿˜æ˜¯è¦åˆ†æƒ…å†µçš„ æœ‰äº›ä»»åŠ¡ï¼Œç»è¿‡ç²¾å¿ƒè®¾è®¡ï¼Œå°†ä»»åŠ¡æ‹†åˆ†ï¼Œå¹¶è¡Œæ‰§è¡Œï¼Œå½“ç„¶å¯ä»¥æé«˜ç¨‹åºçš„è¿è¡Œæ•ˆç‡ã€‚ä½†ä¸æ˜¯æ‰€æœ‰è®¡ç®—ä»» åŠ¡éƒ½èƒ½æ‹†åˆ†ï¼ˆå‚è€ƒåæ–‡çš„ã€é˜¿å§†è¾¾å°”å®šå¾‹ã€‘ï¼‰ ä¹Ÿä¸æ˜¯æ‰€æœ‰ä»»åŠ¡éƒ½éœ€è¦æ‹†åˆ†ï¼Œä»»åŠ¡çš„ç›®çš„å¦‚æœä¸åŒï¼Œè°ˆæ‹†åˆ†å’Œæ•ˆç‡æ²¡å•¥æ„ä¹‰ 
3. IO æ“ä½œä¸å ç”¨ cpuï¼Œåªæ˜¯æˆ‘ä»¬ä¸€èˆ¬æ‹·è´æ–‡ä»¶ä½¿ç”¨çš„æ˜¯ã€é˜»å¡ IOã€‘ï¼Œè¿™æ—¶ç›¸å½“äºçº¿ç¨‹è™½ç„¶ä¸ç”¨ cpuï¼Œä½†éœ€è¦ä¸€ ç›´ç­‰å¾… IO ç»“æŸï¼Œæ²¡èƒ½å……åˆ†åˆ©ç”¨çº¿ç¨‹ã€‚æ‰€ä»¥æ‰æœ‰åé¢çš„ã€éé˜»å¡ IOã€‘å’Œã€å¼‚æ­¥ IOã€‘ä¼˜åŒ–





## 2. java çº¿ç¨‹

### 1. åˆ›å»ºå’Œè¿è¡Œçº¿ç¨‹

#### 1. æ–¹æ³•ä¸€

**ç›´æ¥ä½¿ç”¨ Thread**

```java
// åˆ›å»ºçº¿ç¨‹å¯¹è±¡
Thread t = new Thread() {
 public void run() {
 // è¦æ‰§è¡Œçš„ä»»åŠ¡
 }
};
// å¯åŠ¨çº¿ç¨‹
t.start();
```

ä¾‹å¦‚ï¼š

```java
public static void test1() {
    Thread t = new Thread(){
        @Override
        public void run() {
            log.debug("running");
        }
    };
    t.setName("t1");
    t.start();
}
```

```shell
#ç»“æœ
14:43:18.389 c.Test1 [t1] - running
```





#### 2. æ–¹æ³•äºŒ

**ä½¿ç”¨ Runnable é…åˆ Thread**

æŠŠã€çº¿ç¨‹ã€‘å’Œã€ä»»åŠ¡ã€‘ï¼ˆè¦æ‰§è¡Œçš„ä»£ç ï¼‰åˆ†å¼€

- Thread ä»£è¡¨çº¿ç¨‹
- Runnable å¯è¿è¡Œçš„ä»»åŠ¡ï¼ˆçº¿ç¨‹è¦æ‰§è¡Œçš„ä»£ç ï¼‰

```java
Runnable runnable = new Runnable() {
 public void run(){
 // è¦æ‰§è¡Œçš„ä»»åŠ¡
 }
};
// åˆ›å»ºçº¿ç¨‹å¯¹è±¡
Thread t = new Thread(runnable);
// å¯åŠ¨çº¿ç¨‹
t.start(); 
```

ä¾‹å¦‚ï¼š

```java
public static void test2() {
    // åˆ›å»ºä»»åŠ¡å¯¹è±¡
    Runnable task = new Runnable() {
        @Override
        public void run() {
            log.debug("hello");
        }
    };
    // å‚æ•°1 æ˜¯ä»»åŠ¡å¯¹è±¡; å‚æ•°2 æ˜¯çº¿ç¨‹åå­—ï¼Œæ¨è
    Thread t = new Thread(task, "t2");
    t.start();
}
```

```shell
#ç»“æœ
19:19:00 [t2] c.ThreadStarter - hello
```



Java 8 ä»¥åå¯ä»¥ä½¿ç”¨ lambda ç²¾ç®€ä»£ç 

```java
public static void test2() {
    // åˆ›å»ºä»»åŠ¡å¯¹è±¡
    Runnable task2 = () -> log.debug("hello");
    // å‚æ•°1 æ˜¯ä»»åŠ¡å¯¹è±¡; å‚æ•°2 æ˜¯çº¿ç¨‹åå­—ï¼Œæ¨è
    Thread t2 = new Thread(task2, "t2");
    t2.start();
}
```



==**åŸç†ä¹‹ Thread ä¸ Runnable çš„å…³ç³»**==

åˆ†æ Thread çš„æºç ï¼Œç†æ¸…å®ƒä¸ Runnable çš„å…³ç³»

å°ç»“ï¼š

- æ–¹æ³•1 æ˜¯æŠŠçº¿ç¨‹å’Œä»»åŠ¡åˆå¹¶åœ¨äº†ä¸€èµ·ï¼Œæ–¹æ³•2 æ˜¯æŠŠçº¿ç¨‹å’Œä»»åŠ¡åˆ†å¼€äº† 
- ç”¨ Runnable æ›´å®¹æ˜“ä¸çº¿ç¨‹æ± ç­‰é«˜çº§ API é…åˆ 
- ç”¨ Runnable è®©ä»»åŠ¡ç±»è„±ç¦»äº† Thread ç»§æ‰¿ä½“ç³»ï¼Œæ›´çµæ´»





#### 3. æ–¹æ³•ä¸‰

**FutureTask é…åˆ Thread**

FutureTask èƒ½å¤Ÿæ¥æ”¶ Callable ç±»å‹çš„å‚æ•°ï¼Œç”¨æ¥å¤„ç†æœ‰è¿”å›ç»“æœçš„æƒ…å†µ

```java
public static void main(String[] args) throws ExecutionException, InterruptedException {
    // å®ç°å¤šçº¿ç¨‹çš„ç¬¬ä¸‰ç§æ–¹æ³•å¯ä»¥è¿”å›æ•°æ®
    FutureTask futureTask = new FutureTask<>(new Callable<Integer>() {
        @Override
        public Integer call() throws Exception {
            log.debug("å¤šçº¿ç¨‹ä»»åŠ¡");
            Thread.sleep(100);
            return 100;
        }
    });
    // ä¸»çº¿ç¨‹é˜»å¡ï¼ŒåŒæ­¥ç­‰å¾… task æ‰§è¡Œå®Œæ¯•çš„ç»“æœ
    new Thread(futureTask,"t").start();
    log.debug("ä¸»çº¿ç¨‹");
    log.debug("{}",futureTask.get());
}
```

```shell
#ç»“æœ
19:22:27 [t] c.ThreadStarter - hello
19:22:27 [main] c.ThreadStarter - ç»“æœæ˜¯:100
```





### 2. æŸ¥çœ‹çº¿ç¨‹

#### 1. ç†è§£

- äº¤æ›¿æ‰§è¡Œ
- è°å…ˆè°åï¼Œä¸ç”±æˆ‘ä»¬æ§åˆ¶



#### 2. æŸ¥çœ‹è¿›ç¨‹çº¿ç¨‹çš„æ–¹æ³•

**windows**

- ä»»åŠ¡ç®¡ç†å™¨å¯ä»¥æŸ¥çœ‹è¿›ç¨‹å’Œçº¿ç¨‹æ•°ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥æ€æ­»è¿›ç¨‹
- `tasklist` æŸ¥çœ‹è¿›ç¨‹
- `taskkill` æ€æ­»è¿›ç¨‹



**linux**

- `ps -fe` æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹
- `ps -fT -p`  æŸ¥çœ‹æŸä¸ªè¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹
- `kill` æ€æ­»è¿›ç¨‹
- `top` æŒ‰å¤§å†™ H åˆ‡æ¢æ˜¯å¦æ˜¾ç¤ºçº¿ç¨‹
- `top -H -p`  æŸ¥çœ‹æŸä¸ªè¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹



**Java**

- `jps` å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰ Java è¿›ç¨‹
- `jstack`  æŸ¥çœ‹æŸä¸ª Java è¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹çŠ¶æ€
- `jconsole` æ¥æŸ¥çœ‹æŸä¸ª Java è¿›ç¨‹ä¸­çº¿ç¨‹çš„è¿è¡Œæƒ…å†µï¼ˆå›¾å½¢ç•Œé¢ï¼‰



**jconsole è¿œç¨‹ç›‘æ§é…ç½®**

- éœ€è¦ä»¥å¦‚ä¸‹æ–¹å¼è¿è¡Œä½ çš„ java ç±»

```shell
java -Djava.rmi.server.hostname=`ipåœ°å€` -Dcom.sun.management.jmxremote -
Dcom.sun.management.jmxremote.port=`è¿æ¥ç«¯å£` -Dcom.sun.management.jmxremote.ssl=æ˜¯å¦å®‰å…¨è¿æ¥ -
Dcom.sun.management.jmxremote.authenticate=æ˜¯å¦è®¤è¯ javaç±»
```

- ä¿®æ”¹ /etc/hosts æ–‡ä»¶å°† 127.0.0.1 æ˜ å°„è‡³ä¸»æœºå

å¦‚æœè¦è®¤è¯è®¿é—®ï¼Œè¿˜éœ€è¦åšå¦‚ä¸‹æ­¥éª¤

- å¤åˆ¶ jmxremote.password æ–‡ä»¶
- ä¿®æ”¹ jmxremote.password å’Œ jmxremote.access æ–‡ä»¶çš„æƒé™ä¸º 600 å³æ–‡ä»¶æ‰€æœ‰è€…å¯è¯»å†™
- è¿æ¥æ—¶å¡«å…¥ controlRoleï¼ˆç”¨æˆ·åï¼‰ï¼ŒR&Dï¼ˆå¯†ç ï¼‰



### 3. çº¿ç¨‹è¿è¡ŒåŸç†

#### 1. æ ˆä¸æ ˆå¸§

Java Virtual Machine Stacks ï¼ˆJava è™šæ‹Ÿæœºæ ˆï¼‰

æˆ‘ä»¬éƒ½çŸ¥é“ JVM ä¸­ç”±å †ã€æ ˆã€æ–¹æ³•åŒºæ‰€ç»„æˆï¼Œå…¶ä¸­æ ˆå†…å­˜æ˜¯ç»™è°ç”¨çš„å‘¢ï¼Ÿå…¶å®å°±æ˜¯çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¯åŠ¨åï¼Œè™šæ‹Ÿ æœºå°±ä¼šä¸ºå…¶åˆ†é…ä¸€å—æ ˆå†…å­˜ã€‚

- æ¯ä¸ªæ ˆç”±å¤šä¸ªæ ˆå¸§ï¼ˆFrameï¼‰ç»„æˆï¼Œå¯¹åº”ç€æ¯æ¬¡æ–¹æ³•è°ƒç”¨æ—¶æ‰€å ç”¨çš„å†…å­˜
- æ¯ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªæ´»åŠ¨æ ˆå¸§ï¼Œå¯¹åº”ç€å½“å‰æ­£åœ¨æ‰§è¡Œçš„é‚£ä¸ªæ–¹æ³•

![](https://gitlab.com/eardh/picture/-/raw/main/jvm_img/202110242155704.jpg)



#### 2. çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢

**çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šThread Context Switch**

å› ä¸ºä»¥ä¸‹ä¸€äº›åŸå› å¯¼è‡´ cpu ä¸å†æ‰§è¡Œå½“å‰çš„çº¿ç¨‹ï¼Œè½¬è€Œæ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹çš„ä»£ç 

- çº¿ç¨‹çš„ cpu æ—¶é—´ç‰‡ç”¨å®Œ(æ¯ä¸ªçº¿ç¨‹è½®æµæ‰§è¡Œï¼Œçœ‹å‰é¢å¹¶è¡Œçš„æ¦‚å¿µ)
- åƒåœ¾å›æ”¶
- æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹éœ€è¦è¿è¡Œ
- çº¿ç¨‹è‡ªå·±è°ƒç”¨äº† `sleep`ã€`yield`ã€`wait`ã€`join`ã€`park`ã€`synchronized`ã€`lock` ç­‰æ–¹æ³•

å½“ Context Switch å‘ç”Ÿæ—¶ï¼Œéœ€è¦ç”±æ“ä½œç³»ç»Ÿä¿å­˜å½“å‰çº¿ç¨‹çš„çŠ¶æ€ï¼Œå¹¶æ¢å¤å¦ä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€ï¼ŒJava ä¸­å¯¹åº”çš„æ¦‚å¿µ å°±æ˜¯ç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counter Registerï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯è®°ä½ä¸‹ä¸€æ¡ jvm æŒ‡ä»¤çš„æ‰§è¡Œåœ°å€ï¼Œæ˜¯çº¿ç¨‹ç§æœ‰çš„

- çŠ¶æ€åŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆä¸­æ¯ä¸ªæ ˆå¸§çš„ä¿¡æ¯ï¼Œå¦‚å±€éƒ¨å˜é‡ã€æ“ä½œæ•°æ ˆã€è¿”å›åœ°å€ç­‰

- Context Switch é¢‘ç¹å‘ç”Ÿä¼šå½±å“æ€§èƒ½



### 4. Thread æ–¹æ³•

| æ–¹æ³•å           | static | åŠŸèƒ½è¯´æ˜                                                     | æ³¨æ„                                                         |
| ---------------- | ------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| start()          |        | å¯åŠ¨ä¸€ä¸ªæ–°çº¿ ç¨‹ï¼Œåœ¨æ–°çš„çº¿ç¨‹ è¿è¡Œ run æ–¹æ³• ä¸­çš„ä»£ç            | start æ–¹æ³•åªæ˜¯è®©çº¿ç¨‹è¿›å…¥å°±ç»ªï¼Œé‡Œé¢ä»£ç ä¸ä¸€å®šç«‹åˆ» è¿è¡Œï¼ˆCPU çš„æ—¶é—´ç‰‡è¿˜æ²¡åˆ†ç»™å®ƒï¼‰ã€‚æ¯ä¸ªçº¿ç¨‹å¯¹è±¡çš„ startæ–¹æ³•åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œå¦‚æœè°ƒç”¨äº†å¤šæ¬¡ä¼šå‡ºç° IllegalThreadStateException |
| run()            |        | æ–°çº¿ç¨‹å¯åŠ¨åä¼š è°ƒç”¨çš„æ–¹æ³•                                    | å¦‚æœåœ¨æ„é€  Thread å¯¹è±¡æ—¶ä¼ é€’äº† Runnable å‚æ•°ï¼Œåˆ™ çº¿ç¨‹å¯åŠ¨åä¼šè°ƒç”¨ Runnable ä¸­çš„ run æ–¹æ³•ï¼Œå¦åˆ™é»˜ è®¤ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚ä½†å¯ä»¥åˆ›å»º Thread çš„å­ç±»å¯¹è±¡ï¼Œ æ¥è¦†ç›–é»˜è®¤è¡Œä¸º |
| join()           |        | ç­‰å¾…çº¿ç¨‹è¿è¡Œç»“ æŸ                                            |                                                              |
| join(long n)     |        | ç­‰å¾…çº¿ç¨‹è¿è¡Œç»“ æŸ,æœ€å¤šç­‰å¾… n  æ¯«ç§’                           |                                                              |
| getId()          |        | è·å–çº¿ç¨‹é•¿æ•´å‹ çš„ id                                         | id å”¯ä¸€                                                      |
| getName()        |        | è·å–çº¿ç¨‹å                                                   |                                                              |
| getPriority()    |        | è·å–çº¿ç¨‹ä¼˜å…ˆçº§                                               |                                                              |
| setPriority(int) |        | ä¿®æ”¹çº¿ç¨‹ä¼˜å…ˆçº§                                               | javaä¸­è§„å®šçº¿ç¨‹ä¼˜å…ˆçº§æ˜¯1~10 çš„æ•´æ•°ï¼Œè¾ƒå¤§çš„ä¼˜å…ˆçº§ èƒ½æé«˜è¯¥çº¿ç¨‹è¢« CPU è°ƒåº¦çš„æœºç‡ |
| getState()       |        | è·å–çº¿ç¨‹çŠ¶æ€                                                 | Java ä¸­çº¿ç¨‹çŠ¶æ€æ˜¯ç”¨ 6 ä¸ª enum è¡¨ç¤ºï¼Œåˆ†åˆ«ä¸ºï¼š NEW, RUNNABLE, BLOCKED, WAITING,  TIMED_WAITING, TERMINATED |
| isInterrupted()  |        | åˆ¤æ–­æ˜¯å¦è¢«æ‰“ æ–­                                              | ä¸ä¼šæ¸…é™¤ `æ‰“æ–­æ ‡è®°`                                          |
| isAlive()        |        | çº¿ç¨‹æ˜¯å¦å­˜æ´» ï¼ˆè¿˜æ²¡æœ‰è¿è¡Œå®Œ æ¯•ï¼‰                             |                                                              |
| interrupt()      |        | æ‰“æ–­çº¿ç¨‹                                                     | å¦‚æœè¢«æ‰“æ–­çº¿ç¨‹æ­£åœ¨ sleepï¼Œwaitï¼Œjoin ä¼šå¯¼è‡´è¢«æ‰“æ–­ çš„çº¿ç¨‹æŠ›å‡º `InterruptedException`ï¼Œå¹¶æ¸…é™¤ `æ‰“æ–­æ ‡è®°` ï¼›å¦‚æœæ‰“æ–­çš„æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Œåˆ™ä¼šè®¾ç½® `æ‰“æ–­æ ‡è®°` ï¼›park çš„çº¿ç¨‹è¢«æ‰“æ–­ï¼Œä¹Ÿä¼šè®¾ç½® `æ‰“æ–­æ ‡è®°` |
| interrupted()    | static | åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯ å¦è¢«æ‰“æ–­                                      | ä¼šæ¸…é™¤ `æ‰“æ–­æ ‡è®°`                                            |
| currentThread()  | static | è·å–å½“å‰æ­£åœ¨æ‰§ è¡Œçš„çº¿ç¨‹                                      |                                                              |
| sleep(long n)    | static | è®©å½“å‰æ‰§è¡Œçš„çº¿ ç¨‹ä¼‘çœ næ¯«ç§’ï¼Œ ä¼‘çœ æ—¶è®©å‡º cpu  çš„æ—¶é—´ç‰‡ç»™å…¶å®ƒ çº¿ç¨‹ |                                                              |
| yield()          | static | æç¤ºçº¿ç¨‹è°ƒåº¦å™¨ è®©å‡ºå½“å‰çº¿ç¨‹å¯¹ CPUçš„ä½¿ç”¨                      | ä¸»è¦æ˜¯ä¸ºäº†æµ‹è¯•å’Œè°ƒè¯•                                         |



#### 1. start ä¸ run

**1ã€è°ƒç”¨ run**

```java
public static void main(String[] args) {
    Thread t1 = new Thread("t1") {
        @Override
        public void run() {
            log.debug(Thread.currentThread().getName());
            FileReader.read(Constants.MP4_FULL_PATH);
        }
    };
    t1.run();
    log.debug("do other things ...");
}
```

```shell
#ç»“æœ
19:39:14 [main] c.TestStart - main
19:39:14 [main] c.FileReader - read [1.mp4] start ...
19:39:18 [main] c.FileReader - read [1.mp4] end ... cost: 4227 ms
19:39:18 [main] c.TestStart - do other things ...
```

ç¨‹åºä»åœ¨ main çº¿ç¨‹è¿è¡Œï¼Œ `FileReader.read()` æ–¹æ³•è°ƒç”¨è¿˜æ˜¯åŒæ­¥çš„



**2ã€è°ƒç”¨ start**

å°†ä¸Šè¿°ä»£ç çš„ `t1.run()` æ”¹ä¸º `t1.start()`

```shell
#ç»“æœ
19:41:30 [main] c.TestStart - do other things ...
19:41:30 [t1] c.TestStart - t1
19:41:30 [t1] c.FileReader - read [1.mp4] start ...
19:41:35 [t1] c.FileReader - read [1.mp4] end ... cost: 4542 ms
```

ç¨‹åºåœ¨ t1 çº¿ç¨‹è¿è¡Œï¼Œ `FileReader.read()` æ–¹æ³•è°ƒç”¨æ˜¯å¼‚æ­¥çš„



**3ã€ç»“è®ºï¼š**

- ç›´æ¥è°ƒç”¨ run æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œäº† runï¼Œæ²¡æœ‰å¯åŠ¨æ–°çš„çº¿ç¨‹
- ä½¿ç”¨ start æ˜¯å¯åŠ¨æ–°çš„çº¿ç¨‹ï¼Œé€šè¿‡æ–°çš„çº¿ç¨‹é—´æ¥æ‰§è¡Œ run ä¸­çš„ä»£ç 



#### 2. sleep ä¸ yield

**1ã€sleep**

1. è°ƒç”¨ sleep ä¼šè®©å½“å‰çº¿ç¨‹ä» Running è¿›å…¥ Timed Waiting çŠ¶æ€ï¼ˆé˜»å¡ï¼‰

```java
public static void main(String[] args) {
    Thread t1 = new Thread("t1") {
        @Override
        public void run() {
            try {
                Thread.sleep(2000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    };

    t1.start();
    log.debug("t1 state: {}", t1.getState());

    try {
        Thread.sleep(500);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
    log.debug("t1 state: {}", t1.getState());
}
```



2. å…¶å®ƒçº¿ç¨‹å¯ä»¥ä½¿ç”¨ interrupt æ–¹æ³•æ‰“æ–­æ­£åœ¨ç¡çœ çš„çº¿ç¨‹ï¼Œé‚£ä¹ˆè¢«æ‰“æ–­çš„çº¿ç¨‹è¿™æ—¶å°±ä¼šæŠ›å‡º `InterruptedException`å¼‚å¸¸ã€æ³¨æ„ï¼šè¿™é‡Œæ‰“æ–­çš„æ˜¯æ­£åœ¨ä¼‘çœ çš„çº¿ç¨‹ï¼Œè€Œä¸æ˜¯å…¶å®ƒçŠ¶æ€çš„çº¿ç¨‹ã€‘

```java
public static void main(String[] args) throws InterruptedException {
    Thread t1 = new Thread("t1") {
        @Override
        public void run() {
            log.debug("enter sleep...");
            try {
                Thread.sleep(2000);
            } catch (InterruptedException e) {
                log.debug("wake up...");
                e.printStackTrace();
            }
        }
    };
    t1.start();

    Thread.sleep(1000);
    log.debug("interrupt...");
    t1.interrupt();
}
```



3. ç¡çœ ç»“æŸåçš„çº¿ç¨‹æœªå¿…ä¼šç«‹åˆ»å¾—åˆ°æ‰§è¡Œ(éœ€è¦åˆ†é…åˆ°cpuæ—¶é—´ç‰‡)




4. å»ºè®®ç”¨ TimeUnit çš„ `sleep()` ä»£æ›¿ Thread çš„ `sleep()`æ¥è·å¾—æ›´å¥½çš„å¯è¯»æ€§

```java
public static void main(String[] args) throws InterruptedException {
    log.debug("enter");
    TimeUnit.SECONDS.sleep(1);
    log.debug("end");
//        Thread.sleep(1000);
}
```





**2ã€yield**

1. è°ƒç”¨ yield ä¼šè®©å½“å‰çº¿ç¨‹ä» Running è¿›å…¥ Runnable å°±ç»ªçŠ¶æ€ï¼Œç„¶åè°ƒåº¦æ‰§è¡Œå…¶å®ƒçº¿ç¨‹
2. å…·ä½“çš„å®ç°ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„ä»»åŠ¡è°ƒåº¦å™¨(å°±æ˜¯å¯èƒ½æ²¡æœ‰å…¶å®ƒçš„çº¿ç¨‹æ­£åœ¨æ‰§è¡Œï¼Œè™½ç„¶è°ƒç”¨äº†yieldæ–¹æ³•ï¼Œä½†æ˜¯ä¹Ÿæ²¡æœ‰ç”¨)



**3ã€é™åˆ¶å¯¹ CPU çš„ä½¿ç”¨**

åœ¨æ²¡æœ‰åˆ©ç”¨ cpu æ¥è®¡ç®—æ—¶ï¼Œä¸è¦è®© while(true) ç©ºè½¬æµªè´¹ cpuï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨ yield æˆ– sleep æ¥è®©å‡º cpu çš„ä½¿ç”¨æƒ ç»™å…¶ä»–ç¨‹åº

```java
while(true) {
    try {
        Thread.sleep(50);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
}

```

- å¯ä»¥ç”¨ wait æˆ– æ¡ä»¶å˜é‡è¾¾åˆ°ç±»ä¼¼çš„æ•ˆæœ
- ä¸åŒçš„æ˜¯ï¼Œåä¸¤ç§éƒ½éœ€è¦åŠ é”ï¼Œå¹¶ä¸”éœ€è¦ç›¸åº”çš„å”¤é†’æ“ä½œï¼Œä¸€èˆ¬é€‚ç”¨äºè¦è¿›è¡ŒåŒæ­¥çš„åœºæ™¯
- sleep é€‚ç”¨äºæ— éœ€é”åŒæ­¥çš„åœºæ™¯



#### 3. çº¿ç¨‹ä¼˜å…ˆçº§

- çº¿ç¨‹ä¼˜å…ˆçº§ä¼šæç¤ºï¼ˆhintï¼‰è°ƒåº¦å™¨ä¼˜å…ˆè°ƒåº¦è¯¥çº¿ç¨‹ï¼Œä½†å®ƒä»…ä»…æ˜¯ä¸€ä¸ªæç¤ºï¼Œè°ƒåº¦å™¨å¯ä»¥å¿½ç•¥å®ƒ
- å¦‚æœ cpu æ¯”è¾ƒå¿™ï¼Œé‚£ä¹ˆä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹ä¼šè·å¾—æ›´å¤šçš„æ—¶é—´ç‰‡ï¼Œä½† cpu é—²æ—¶ï¼Œä¼˜å…ˆçº§å‡ ä¹æ²¡ä½œç”¨

```java
public static void main(String[] args) {
    Runnable task1 = () -> {
        int count = 0;
        for (;;) {
            System.out.println("---->1 " + count++);
        }
    };
    Runnable task2 = () -> {
        int count = 0;
        for (;;) {
//                Thread.yield();
            System.out.println("              ---->2 " + count++);
        }
    };
    Thread t1 = new Thread(task1, "t1");
    Thread t2 = new Thread(task2, "t2");
    t1.setPriority(Thread.MIN_PRIORITY);
    t2.setPriority(Thread.MAX_PRIORITY);
    t1.start();
    t2.start();
}
```



#### 4. join æ–¹æ³•è¯¦è§£

##### 1. ä¸ºä»€ä¹ˆéœ€è¦ join

```java
private static void test1() throws InterruptedException {
    log.debug("å¼€å§‹");
    Thread t1 = new Thread(() -> {
        log.debug("å¼€å§‹");
        sleep(1);
        log.debug("ç»“æŸ");
        r = 10;
    },"t1");
    t1.start();
    t1.join();
    log.debug("ç»“æœä¸º:{}", r);
    log.debug("ç»“æŸ");
}
```



**åˆ†æ**

- å› ä¸ºä¸»çº¿ç¨‹å’Œçº¿ç¨‹ t1 æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œt1 çº¿ç¨‹éœ€è¦ 1 ç§’ä¹‹åæ‰èƒ½ç®—å‡º `r=10`
- è€Œä¸»çº¿ç¨‹ä¸€å¼€å§‹å°±è¦æ‰“å° r çš„ç»“æœï¼Œæ‰€ä»¥åªèƒ½æ‰“å°å‡º `r=0`

**è§£å†³æ–¹æ³•**

- ç”¨ sleep è¡Œä¸è¡Œï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ
- ç”¨ joinï¼ŒåŠ åœ¨ `t1.start()` ä¹‹åå³å¯



##### 2. æ¡ˆä¾‹

ä»¥è°ƒç”¨æ–¹è§’åº¦æ¥è®²ï¼Œå¦‚æœ

- éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œæ‰èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯åŒæ­¥
- ä¸éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œå°±èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯å¼‚æ­¥

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162208479.png)



1. **ç­‰å¾…å¤šä¸ªç»“æœ**

```java
private static void test2() throws InterruptedException {
    Thread t1 = new Thread(() -> {
        sleep(1);
        r1 = 10;
    });
    Thread t2 = new Thread(() -> {
        sleep(2);
        r2 = 20;
    });
    t1.start();
    t2.start();
    long start = System.currentTimeMillis();
    log.debug("join begin");
    t2.join();
    log.debug("t2 join end");
    t1.join();
    log.debug("t1 join end");
    long end = System.currentTimeMillis();
    log.debug("r1: {} r2: {} cost: {}", r1, r2, end - start);
}
```

åˆ†æå¦‚ä¸‹

- ç¬¬ä¸€ä¸ª joinï¼šç­‰å¾… t1 æ—¶, t2 å¹¶æ²¡æœ‰åœæ­¢, è€Œåœ¨è¿è¡Œ
- ç¬¬äºŒä¸ª joinï¼š1s å, æ‰§è¡Œåˆ°æ­¤, t2 ä¹Ÿè¿è¡Œäº† 1s, å› æ­¤ä¹Ÿåªéœ€å†ç­‰å¾… 1s

å¦‚æœé¢ å€’ä¸¤ä¸ª join å‘¢ï¼Ÿ æœ€ç»ˆéƒ½æ˜¯è¾“å‡º

```shell
20:45:43.239 [main] c.TestJoin - r1: 10 r2: 20 cost: 2005
```

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162208609.png)



2. **æœ‰æ—¶æ•ˆçš„ join**

```java
public static void test3() throws InterruptedException {
    Thread t1 = new Thread(() -> {
        sleep(2);
        r1 = 10;
    });

    long start = System.currentTimeMillis();
    t1.start();

    // çº¿ç¨‹æ‰§è¡Œç»“æŸä¼šå¯¼è‡´ join ç»“æŸ
    log.debug("join begin");
    t1.join(3000);
    long end = System.currentTimeMillis();
    log.debug("r1: {} r2: {} cost: {}", r1, r2, end - start);
}
```

```shell
#ç»“æœ
16:27:34.636 c.TestJoin [main] - r1: 10 r2: 0 cost: 2026
```

æ—¶é—´è¶³å¤Ÿå’Œä¸å¤Ÿæœ‰åŒºåˆ«





#### 5.  interrupt æ–¹æ³•è¯¦è§£

##### 1. æ‰“æ–­ sleepï¼Œwaitï¼Œjoin çš„çº¿ç¨‹

è¿™å‡ ä¸ªæ–¹æ³•éƒ½ä¼šè®©çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œæ‰“æ–­ sleep çš„çº¿ç¨‹, ä¼šæ¸…ç©ºæ‰“æ–­çŠ¶æ€ï¼Œä»¥ sleep ä¸ºä¾‹

```java
public static void main(String[] args) throws InterruptedException {
    Thread t1 = new Thread(() -> {
        log.debug("sleep...");
        try {
            Thread.sleep(5000); // wait, join
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    },"t1");

    t1.start();
    Thread.sleep(1000);
    log.debug("interrupt");
    t1.interrupt();
    log.debug("æ‰“æ–­æ ‡è®°:{}", t1.isInterrupted());
}
```



##### 2. æ‰“æ–­æ­£å¸¸è¿è¡Œçš„çº¿ç¨‹

æ‰“æ–­æ­£å¸¸è¿è¡Œçš„çº¿ç¨‹, ä¸ä¼šæ¸…ç©ºæ‰“æ–­çŠ¶æ€

```java
public static void main(String[] args) throws InterruptedException {
    Thread t1 = new Thread(() -> {
        while(true) {
            boolean interrupted = Thread.currentThread().isInterrupted();
            if(interrupted) {
                log.debug("è¢«æ‰“æ–­äº†, é€€å‡ºå¾ªç¯");
                break;
            }
        }
    }, "t1");
    t1.start();

    Thread.sleep(1000);
    log.debug("interrupt");
    t1.interrupt();
}
```



##### 3. ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼ ğŸ

çº¿ç¨‹çš„`isInterrupted()`æ–¹æ³•å¯ä»¥å–å¾—çº¿ç¨‹çš„æ‰“æ–­æ ‡è®°ï¼Œå¦‚æœçº¿ç¨‹åœ¨ç¡çœ `sleep`æœŸé—´è¢«æ‰“æ–­ï¼Œæ‰“æ–­æ ‡è®°æ˜¯ä¸ä¼šå˜çš„ï¼Œä¸ºfalseï¼Œä½†æ˜¯`sleep`æœŸé—´è¢«æ‰“æ–­ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæˆ‘ä»¬æ®æ­¤æ‰‹åŠ¨è®¾ç½®æ‰“æ–­æ ‡è®°ä¸º`true`ï¼›å¦‚æœæ˜¯åœ¨ç¨‹åºæ­£å¸¸è¿è¡ŒæœŸé—´è¢«æ‰“æ–­çš„ï¼Œé‚£ä¹ˆæ‰“æ–­æ ‡è®°å°±è¢«è‡ªåŠ¨è®¾ç½®ä¸º`true`ã€‚å¤„ç†å¥½è¿™ä¸¤ç§æƒ…å†µé‚£æˆ‘ä»¬å°±å¯ä»¥æ”¾å¿ƒåœ°æ¥æ–™ç†åäº‹å•¦ï¼

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162209823.png)



```java
@Slf4j(topic = "c.TestTwoPhaseTermination")
public class TestTwoPhaseTermination {
    public static void main(String[] args) throws InterruptedException {
        TPTVolatile t = new TPTVolatile();
        t.start();

        Thread.sleep(3500);
        log.debug("stop");
        t.stop();
    }
}

// interrupt å¯ä»¥æ‰“æ–­æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ï¼Œæ— è®ºè¿™ä¸ªçº¿ç¨‹æ˜¯åœ¨ sleepï¼Œwaitï¼Œè¿˜æ˜¯æ­£å¸¸è¿è¡Œ
@Slf4j(topic = "c.TPTInterrupt")
class TPTInterrupt {
    private Thread thread;

    public void start(){
        thread = new Thread(() -> {
            while(true) {
                Thread current = Thread.currentThread();
                if(current.isInterrupted()) {
                    log.debug("æ–™ç†åäº‹");
                    break;
                }
                try {
                    Thread.sleep(1000);
                    log.debug("å°†ç»“æœä¿å­˜");
                } catch (InterruptedException e) {
                    current.interrupt();
                }

            }
        },"ç›‘æ§çº¿ç¨‹");
        thread.start();
    }

    public void stop() {
        thread.interrupt();
    }
}

// åœæ­¢æ ‡è®°ç”¨ volatile æ˜¯ä¸ºäº†ä¿è¯è¯¥å˜é‡åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§
// æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå³ä¸»çº¿ç¨‹æŠŠå®ƒä¿®æ”¹ä¸º true å¯¹ t1 çº¿ç¨‹å¯è§
@Slf4j(topic = "c.TPTVolatile")
class TPTVolatile {
    private Thread thread;
    private volatile boolean stop = false;

    public void start(){
        thread = new Thread(() -> {
            while(true) {
                Thread current = Thread.currentThread();
                if(stop) {
                    log.debug("æ–™ç†åäº‹");
                    break;
                }
                try {
                    Thread.sleep(1000);
                    log.debug("å°†ç»“æœä¿å­˜");
                } catch (InterruptedException e) {
                }
            }
        },"ç›‘æ§çº¿ç¨‹");
        thread.start();
    }

    public void stop() {
        stop = true;
        thread.interrupt();
    }
}
```



##### 4. æ‰“æ–­ park çº¿ç¨‹

æ‰“æ–­ park çº¿ç¨‹, ä¸ä¼šæ¸…ç©ºæ‰“æ–­çŠ¶æ€

```java
private static void test3() throws InterruptedException {
    Thread t1 = new Thread(() -> {
        log.debug("park...");
        LockSupport.park(); // é˜»å¡ç­‰å¾…è¯¥çº¿ç¨‹è¢«æ‰“æ–­
        log.debug("unpark...");
        log.debug("æ‰“æ–­çŠ¶æ€ï¼š{}", Thread.currentThread().isInterrupted());
    }, "t1");
    t1.start();

    sleep(1);
    t1.interrupt();
}
```



å¦‚æœæ‰“æ–­æ ‡è®°å·²ç»æ˜¯ true, åˆ™ park ä¼šå¤±æ•ˆ

```java
private static void test4() {
    Thread t1 = new Thread(() -> {
        for (int i = 0; i < 5; i++) {
            log.debug("park...");
            LockSupport.park(); // é˜»å¡ç­‰å¾…è¯¥çº¿ç¨‹è¢«æ‰“æ–­
            log.debug("æ‰“æ–­çŠ¶æ€ï¼š{}", Thread.interrupted());
        }
    });
    t1.start();

    sleep(1);
    t1.interrupt();
}
```

> æç¤º :  å¯ä»¥ä½¿ç”¨ `Thread.interrupted()` æ¸…é™¤æ‰“æ–­çŠ¶æ€





### 5. ä¸»çº¿ç¨‹å’Œå®ˆæŠ¤çº¿ç¨‹

é»˜è®¤æƒ…å†µä¸‹ï¼ŒJava è¿›ç¨‹éœ€è¦ç­‰å¾…æ‰€æœ‰çº¿ç¨‹éƒ½è¿è¡Œç»“æŸï¼Œæ‰ä¼šç»“æŸã€‚

æœ‰ä¸€ç§ç‰¹æ®Šçš„çº¿ç¨‹å«åšå®ˆæŠ¤çº¿ç¨‹ï¼Œåªè¦å…¶å®ƒéå®ˆ æŠ¤çº¿ç¨‹è¿è¡Œç»“æŸäº†ï¼Œå³ä½¿å®ˆæŠ¤çº¿ç¨‹çš„ä»£ç æ²¡æœ‰æ‰§è¡Œå®Œï¼Œä¹Ÿä¼šå¼ºåˆ¶ç»“æŸã€‚

```java
public static void main(String[] args) throws InterruptedException {
    Thread t1 = new Thread(() -> {
        while (true) {
            if (Thread.currentThread().isInterrupted()) {
                break;
            }
        }
        log.debug("ç»“æŸ");
    }, "t1");
    t1.setDaemon(true);
    t1.start();

    Thread.sleep(1000);
    log.debug("ç»“æŸ");
}
```

>**æ³¨æ„ï¼š**
>
>- åƒåœ¾å›æ”¶å™¨çº¿ç¨‹å°±æ˜¯ä¸€ç§å®ˆæŠ¤çº¿ç¨‹
>- Tomcat ä¸­çš„ Acceptor å’Œ Poller çº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œæ‰€ä»¥ Tomcat æ¥æ”¶åˆ° shutdown å‘½ä»¤åï¼Œä¸ä¼šç­‰ å¾…å®ƒä»¬å¤„ç†å®Œå½“å‰è¯·æ±‚





### 6. çº¿ç¨‹äº”ç§çŠ¶æ€

è¿™æ˜¯ä» æ“ä½œç³»ç»Ÿ å±‚é¢æ¥æè¿°çš„



![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162210887.png)

- ã€åˆå§‹çŠ¶æ€ã€‘ä»…æ˜¯åœ¨è¯­è¨€å±‚é¢åˆ›å»ºäº†çº¿ç¨‹å¯¹è±¡ï¼Œè¿˜æœªä¸æ“ä½œç³»ç»Ÿçº¿ç¨‹å…³è”
- ã€å¯è¿è¡ŒçŠ¶æ€ã€‘ï¼ˆå°±ç»ªçŠ¶æ€ï¼‰æŒ‡è¯¥çº¿ç¨‹å·²ç»è¢«åˆ›å»ºï¼ˆä¸æ“ä½œç³»ç»Ÿçº¿ç¨‹å…³è”ï¼‰ï¼Œå¯ä»¥ç”± CPU è°ƒåº¦æ‰§è¡Œ
- ã€è¿è¡ŒçŠ¶æ€ã€‘æŒ‡è·å–äº† CPU æ—¶é—´ç‰‡è¿è¡Œä¸­çš„çŠ¶æ€
  - å½“ CPU æ—¶é—´ç‰‡ç”¨å®Œï¼Œä¼šä»ã€è¿è¡ŒçŠ¶æ€ã€‘è½¬æ¢è‡³ã€å¯è¿è¡ŒçŠ¶æ€ã€‘ï¼Œä¼šå¯¼è‡´çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢
- ã€é˜»å¡çŠ¶æ€ã€‘
  - å¦‚æœè°ƒç”¨äº†é˜»å¡ APIï¼Œå¦‚ BIO è¯»å†™æ–‡ä»¶ï¼Œè¿™æ—¶è¯¥çº¿ç¨‹å®é™…ä¸ä¼šç”¨åˆ° CPUï¼Œä¼šå¯¼è‡´çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿›å…¥ ã€é˜»å¡çŠ¶æ€ã€‘
  - ç­‰ BIO æ“ä½œå®Œæ¯•ï¼Œä¼šç”±æ“ä½œç³»ç»Ÿå”¤é†’é˜»å¡çš„çº¿ç¨‹ï¼Œè½¬æ¢è‡³ã€å¯è¿è¡ŒçŠ¶æ€ã€‘
  - ä¸ã€å¯è¿è¡ŒçŠ¶æ€ã€‘çš„åŒºåˆ«æ˜¯ï¼Œå¯¹ã€é˜»å¡çŠ¶æ€ã€‘çš„çº¿ç¨‹æ¥è¯´åªè¦å®ƒä»¬ä¸€ç›´ä¸å”¤é†’ï¼Œè°ƒåº¦å™¨å°±ä¸€ç›´ä¸ä¼šè€ƒè™‘ è°ƒåº¦å®ƒä»¬
- ã€ç»ˆæ­¢çŠ¶æ€ã€‘è¡¨ç¤ºçº¿ç¨‹å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œç”Ÿå‘½å‘¨æœŸå·²ç»ç»“æŸï¼Œä¸ä¼šå†è½¬æ¢ä¸ºå…¶å®ƒçŠ¶æ€





### 7. çº¿ç¨‹å…­ç§çŠ¶æ€ ğŸ

#### 1.  Thread.State æšä¸¾

è¿™æ˜¯ä» Java API å±‚é¢æ¥æè¿°çš„

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162210858.png)

- `NEW` çº¿ç¨‹åˆšè¢«åˆ›å»ºï¼Œä½†æ˜¯è¿˜æ²¡æœ‰è°ƒç”¨ start() æ–¹æ³• RUNNABLE å½“è°ƒç”¨äº† start() æ–¹æ³•ä¹‹åï¼Œæ³¨æ„ï¼ŒJava API å±‚é¢çš„
- `RUNNABLE` çŠ¶æ€æ¶µç›–äº† æ“ä½œç³»ç»Ÿ å±‚é¢çš„ ã€å¯è¿è¡ŒçŠ¶æ€ã€‘ã€ã€è¿è¡ŒçŠ¶æ€ã€‘å’Œã€é˜»å¡çŠ¶æ€ã€‘ï¼ˆç”±äº BIO å¯¼è‡´çš„çº¿ç¨‹é˜»å¡ï¼Œåœ¨ Java é‡Œæ— æ³•åŒºåˆ†ï¼Œä»ç„¶è®¤ä¸º æ˜¯å¯è¿è¡Œï¼‰
- `BLOCKED` ï¼Œ `WAITING` ï¼Œ `TIMED_WAITING` éƒ½æ˜¯ Java API å±‚é¢å¯¹ã€é˜»å¡çŠ¶æ€ã€‘çš„ç»†åˆ†ï¼Œåé¢ä¼šåœ¨çŠ¶æ€è½¬æ¢ä¸€èŠ‚è¯¦è¿°
- `TERMINATED` å½“çº¿ç¨‹ä»£ç è¿è¡Œç»“æŸ

```java
public static void main(String[] args) throws IOException {
    Thread t1 = new Thread("t1") {
        @Override
        public void run() {
            log.debug("running...");
        }
    };

    Thread t2 = new Thread("t2") {
        @Override
        public void run() {
            while(true) { // runnable

            }
        }
    };
    t2.start();

    Thread t3 = new Thread("t3") {
        @Override
        public void run() {
            log.debug("running...");
        }
    };
    t3.start();

    Thread t4 = new Thread("t4") {
        @Override
        public void run() {
            synchronized (TestState.class) {
                try {
                    Thread.sleep(1000000); // timed_waiting
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }
    };
    t4.start();

    Thread t5 = new Thread("t5") {
        @Override
        public void run() {
            try {
                t2.join(); // waiting
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    };
    t5.start();

    Thread t6 = new Thread("t6") {
        @Override
        public void run() {
            synchronized (TestState.class) { // blocked
                try {
                    Thread.sleep(1000000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }
    };
    t6.start();

    try {
        Thread.sleep(500);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
    log.debug("t1 state {}", t1.getState());
    log.debug("t2 state {}", t2.getState());
    log.debug("t3 state {}", t3.getState());
    log.debug("t4 state {}", t4.getState());
    log.debug("t5 state {}", t5.getState());
    log.debug("t6 state {}", t6.getState());
    System.in.read();
}
```

```shell
#ç»“æœ
14:16:01.785 c.TestState [t3] - running...
14:16:02.297 c.TestState [main] - t1 state NEW
14:16:02.301 c.TestState [main] - t2 state RUNNABLE
14:16:02.301 c.TestState [main] - t3 state TERMINATED
14:16:02.301 c.TestState [main] - t4 state TIMED_WAITING
14:16:02.301 c.TestState [main] - t5 state WAITING
14:16:02.301 c.TestState [main] - t6 state BLOCKED
```





#### 2. çƒ§æ°´æ³¡èŒ¶ ğŸš€

é˜…è¯»åç½—åºšã€Šç»Ÿç­¹æ–¹æ³•ã€‹ï¼Œç»™å‡ºçƒ§æ°´æ³¡èŒ¶çš„å¤šçº¿ç¨‹è§£å†³æ–¹æ¡ˆï¼Œæç¤º

- å‚è€ƒå›¾äºŒï¼Œç”¨ä¸¤ä¸ªçº¿ç¨‹ï¼ˆä¸¤ä¸ªäººåä½œï¼‰æ¨¡æ‹Ÿçƒ§æ°´æ³¡èŒ¶è¿‡ç¨‹
  - æ–‡ä¸­åŠæ³•ä¹™ã€ä¸™éƒ½ç›¸å½“äºä»»åŠ¡ä¸²è¡Œ
  - è€Œå›¾ä¸€ç›¸å½“äºå¯åŠ¨äº† 4 ä¸ªçº¿ç¨‹ï¼Œæœ‰ç‚¹æµªè´¹

- ç”¨ sleep(n) æ¨¡æ‹Ÿæ´—èŒ¶å£¶ã€æ´—æ°´å£¶ç­‰è€—è´¹çš„æ—¶é—´

é™„ï¼šåç½—åºšã€Šç»Ÿç­¹æ–¹æ³•ã€‹

> ç»Ÿç­¹æ–¹æ³•ï¼Œæ˜¯ä¸€ç§å®‰æ’å·¥ä½œè¿›ç¨‹çš„æ•°å­¦æ–¹æ³•ã€‚å®ƒçš„å®ç”¨èŒƒå›´æå¹¿æ³›ï¼Œåœ¨ä¼ä¸šç®¡ç†å’ŒåŸºæœ¬å»ºè®¾ä¸­ï¼Œä»¥åŠå…³ç³»å¤ æ‚çš„ç§‘ç ”é¡¹ç›®çš„ç»„ç»‡ä¸ç®¡ç†ä¸­ï¼Œéƒ½å¯ä»¥åº”ç”¨ã€‚
>
> æ€æ ·åº”ç”¨å‘¢ï¼Ÿä¸»è¦æ˜¯æŠŠå·¥åºå®‰æ’å¥½ã€‚
>
> æ¯”å¦‚ï¼Œæƒ³æ³¡å£¶èŒ¶å–ã€‚å½“æ—¶çš„æƒ…å†µæ˜¯ï¼šå¼€æ°´æ²¡æœ‰ï¼›æ°´å£¶è¦æ´—ï¼ŒèŒ¶å£¶ã€èŒ¶æ¯è¦æ´—ï¼›ç«å·²ç”Ÿäº†ï¼ŒèŒ¶å¶ä¹Ÿæœ‰äº†ã€‚æ€ä¹ˆ åŠï¼Ÿ
>
> - åŠæ³•ç”²ï¼šæ´—å¥½æ°´å£¶ï¼ŒçŒä¸Šå‡‰æ°´ï¼Œæ”¾åœ¨ç«ä¸Šï¼›åœ¨ç­‰å¾…æ°´å¼€çš„æ—¶é—´é‡Œï¼Œæ´—èŒ¶å£¶ã€æ´—èŒ¶æ¯ã€æ‹¿èŒ¶å¶ï¼›ç­‰æ°´å¼€ äº†ï¼Œæ³¡èŒ¶å–ã€‚
> - åŠæ³•ä¹™ï¼šå…ˆåšå¥½ä¸€äº›å‡†å¤‡å·¥ä½œï¼Œæ´—æ°´å£¶ï¼Œæ´—èŒ¶å£¶èŒ¶æ¯ï¼Œæ‹¿èŒ¶å¶ï¼›ä¸€åˆ‡å°±ç»ªï¼ŒçŒæ°´çƒ§æ°´ï¼›åå¾…æ°´å¼€äº†ï¼Œæ³¡ èŒ¶å–ã€‚
> - åŠæ³•ä¸™ï¼šæ´—å‡€æ°´å£¶ï¼ŒçŒä¸Šå‡‰æ°´ï¼Œæ”¾åœ¨ç«ä¸Šï¼Œåå¾…æ°´å¼€ï¼›æ°´å¼€äº†ä¹‹åï¼Œæ€¥æ€¥å¿™å¿™æ‰¾èŒ¶å¶ï¼Œæ´—èŒ¶å£¶èŒ¶æ¯ï¼Œæ³¡ èŒ¶å–ã€‚
>
> å“ªä¸€ç§åŠæ³•çœæ—¶é—´ï¼Ÿæˆ‘ä»¬èƒ½ä¸€çœ¼çœ‹å‡ºï¼Œç¬¬ä¸€ç§åŠæ³•å¥½ï¼Œåä¸¤ç§åŠæ³•éƒ½çªäº†å·¥ã€‚
>
> è¿™æ˜¯å°äº‹ï¼Œä½†è¿™æ˜¯å¼•å­ï¼Œå¯ä»¥å¼•å‡ºç”Ÿäº§ç®¡ç†ç­‰æ–¹é¢æœ‰ç”¨çš„æ–¹æ³•æ¥ã€‚
>
> æ°´å£¶ä¸æ´—ï¼Œä¸èƒ½çƒ§å¼€æ°´ï¼Œå› è€Œæ´—æ°´å£¶æ˜¯çƒ§å¼€æ°´çš„å‰æã€‚æ²¡å¼€æ°´ã€æ²¡èŒ¶å¶ã€ä¸æ´—èŒ¶å£¶èŒ¶æ¯ï¼Œå°±ä¸èƒ½æ³¡èŒ¶ï¼Œå› è€Œ è¿™äº›åˆæ˜¯æ³¡èŒ¶çš„å‰æã€‚å®ƒä»¬çš„ç›¸äº’å…³ç³»ï¼Œå¯ä»¥ç”¨ä¸‹è¾¹çš„ç®­å¤´å›¾æ¥è¡¨ç¤ºï¼š
>
> ![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162210786.png)
>
> ä»è¿™ä¸ªå›¾ä¸Šå¯ä»¥ä¸€çœ¼çœ‹å‡ºï¼ŒåŠæ³•ç”²æ€»å…±è¦16åˆ†é’Ÿï¼ˆè€ŒåŠæ³•ä¹™ã€ä¸™éœ€è¦20åˆ†é’Ÿï¼‰ã€‚å¦‚æœè¦ç¼©çŸ­å·¥æ—¶ã€æé«˜å·¥ä½œ æ•ˆç‡ï¼Œåº”å½“ä¸»è¦æŠ“çƒ§å¼€æ°´è¿™ä¸ªç¯èŠ‚ï¼Œè€Œä¸æ˜¯æŠ“æ‹¿èŒ¶å¶ç­‰ç¯èŠ‚ã€‚åŒæ—¶ï¼Œæ´—èŒ¶å£¶èŒ¶æ¯ã€æ‹¿èŒ¶å¶æ€»å…±ä¸è¿‡4åˆ†é’Ÿï¼Œå¤§ å¯åˆ©ç”¨â€œç­‰æ°´å¼€â€çš„æ—¶é—´æ¥åšã€‚ 
>
> æ˜¯çš„ï¼Œè¿™å¥½åƒæ˜¯åºŸè¯ï¼Œå‘ä¹‹æ— ç”šé«˜è®ºã€‚æœ‰å¦‚èµ°è·¯è¦ç”¨ä¸¤æ¡è…¿èµ°ï¼Œåƒé¥­è¦ä¸€å£ä¸€å£åƒï¼Œè¿™äº›é“ç†è°éƒ½æ‡‚å¾—ã€‚ä½† ç¨æœ‰å˜åŒ–ï¼Œä¸´äº‹è€Œè¿·çš„æƒ…å†µï¼Œå¸¸å¸¸æ˜¯å­˜åœ¨çš„ã€‚åœ¨è¿‘ä»£å·¥ä¸šçš„é”™ç»¼å¤æ‚çš„å·¥è‰ºè¿‡ç¨‹ä¸­ï¼Œå¾€å¾€å°±ä¸æ˜¯åƒæ³¡èŒ¶å–è¿™ ä¹ˆç®€å•äº†ã€‚ä»»åŠ¡å¤šäº†ï¼Œå‡ ç™¾å‡ åƒï¼Œç”šè‡³æœ‰å¥½å‡ ä¸‡ä¸ªä»»åŠ¡ã€‚å…³ç³»å¤šäº†ï¼Œé”™ç»¼å¤æ‚ï¼Œåƒå¤´ä¸‡ç»ªï¼Œå¾€å¾€å‡ºç°â€œä¸‡äº‹ä¿± å¤‡ï¼Œåªæ¬ ä¸œé£â€çš„æƒ…å†µã€‚ç”±äºä¸€ä¸¤ä¸ªé›¶ä»¶æ²¡å®Œæˆï¼Œè€½è¯¯äº†ä¸€å°å¤æ‚æœºå™¨çš„å‡ºå‚æ—¶é—´ã€‚æˆ–å¾€å¾€å› ä¸ºæŠ“çš„ä¸æ˜¯å…³ é”®ï¼Œè¿å¤œä¸‰ç­ï¼Œæ€¥æ€¥å¿™å¿™ï¼Œå®Œæˆè¿™ä¸€ç¯èŠ‚ä¹‹åï¼Œè¿˜å¾—ç­‰å¾…æ—çš„ç¯èŠ‚æ‰èƒ½è£…é…ã€‚ 
>
> æ´—èŒ¶å£¶ï¼Œæ´—èŒ¶æ¯ï¼Œæ‹¿èŒ¶å¶ï¼Œæˆ–å…ˆæˆ–åï¼Œå…³ç³»ä¸å¤§ï¼Œè€Œä¸”åŒæ˜¯ä¸€ä¸ªäººçš„æ´»å„¿ï¼Œå› è€Œå¯ä»¥åˆå¹¶æˆä¸ºï¼š
>
> ![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111162210920.png)
>
> çœ‹æ¥è¿™æ˜¯â€œå°é¢˜å¤§åšâ€ï¼Œä½†åœ¨å·¥ä½œç¯èŠ‚å¤ªå¤šçš„æ—¶å€™ï¼Œè¿™æ ·åšå°±éå¸¸å¿…è¦äº†ã€‚
>
>  è¿™é‡Œè®²çš„ä¸»è¦æ˜¯æ—¶é—´æ–¹é¢çš„äº‹ï¼Œä½†åœ¨å…·ä½“ç”Ÿäº§å®è·µä¸­ï¼Œè¿˜æœ‰å…¶ä»–æ–¹é¢çš„è®¸å¤šäº‹ã€‚è¿™ç§æ–¹æ³•è™½ç„¶ä¸ä¸€å®šèƒ½ç›´æ¥ è§£å†³æ‰€æœ‰é—®é¢˜ï¼Œä½†æ˜¯ï¼Œæˆ‘ä»¬åˆ©ç”¨è¿™ç§æ–¹æ³•æ¥è€ƒè™‘é—®é¢˜ï¼Œä¹Ÿæ˜¯ä¸æ— è£¨ç›Šçš„ã€‚



##### 1. è§£æ³•ï¼šjoin

```java
public static void main(String[] args) {
    Thread t1 = new Thread(() -> {
        log.debug("æ´—æ°´å£¶");
        sleep(1);
        log.debug("çƒ§å¼€æ°´");
        sleep(5);
    },"è€ç‹");

    Thread t2 = new Thread(() -> {
        log.debug("æ´—èŒ¶å£¶");
        sleep(1);
        log.debug("æ´—èŒ¶æ¯");
        sleep(2);
        log.debug("æ‹¿èŒ¶å¶");
        sleep(1);
        try {
            t1.join();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.debug("æ³¡èŒ¶");
    },"å°ç‹");

    t1.start();
    t2.start();
}
```

è§£æ³•1 çš„ç¼ºé™·ï¼š

- ä¸Šé¢æ¨¡æ‹Ÿçš„æ˜¯å°ç‹ç­‰è€ç‹çš„æ°´çƒ§å¼€äº†ï¼Œå°ç‹æ³¡èŒ¶ï¼Œå¦‚æœåè¿‡æ¥è¦å®ç°è€ç‹ç­‰å°ç‹çš„èŒ¶å¶æ‹¿æ¥äº†ï¼Œè€ç‹æ³¡èŒ¶ å‘¢ï¼Ÿä»£ç æœ€å¥½èƒ½é€‚åº”ä¸¤ç§æƒ…å†µ
- ä¸Šé¢çš„ä¸¤ä¸ªçº¿ç¨‹å…¶å®æ˜¯å„æ‰§è¡Œå„çš„ï¼Œå¦‚æœè¦æ¨¡æ‹Ÿè€ç‹æŠŠæ°´å£¶äº¤ç»™å°ç‹æ³¡èŒ¶ï¼Œæˆ–æ¨¡æ‹Ÿå°ç‹æŠŠèŒ¶å¶äº¤ç»™è€ç‹æ³¡èŒ¶ å‘¢ï¼Ÿ



##### 2. è§£æ³•2ï¼šwait/notify





### 8. å°ç»“

æœ¬ç« çš„é‡ç‚¹åœ¨äºæŒæ¡

- çº¿ç¨‹åˆ›å»º

- çº¿ç¨‹é‡è¦ apiï¼Œå¦‚ startï¼Œrunï¼Œsleepï¼Œjoinï¼Œinterrupt ç­‰

- çº¿ç¨‹çŠ¶æ€

- åº”ç”¨æ–¹é¢

  - å¼‚æ­¥è°ƒç”¨ï¼šä¸»çº¿ç¨‹æ‰§è¡ŒæœŸé—´ï¼Œå…¶å®ƒçº¿ç¨‹å¼‚æ­¥æ‰§è¡Œè€—æ—¶æ“ä½œ
  - æé«˜æ•ˆç‡ï¼šå¹¶è¡Œè®¡ç®—ï¼Œç¼©çŸ­è¿ç®—æ—¶é—´
  - åŒæ­¥ç­‰å¾…ï¼šjoin
  - ç»Ÿç­¹è§„åˆ’ï¼šåˆç†ä½¿ç”¨çº¿ç¨‹ï¼Œå¾—åˆ°æœ€ä¼˜æ•ˆæœ

- åŸç†æ–¹é¢
  - çº¿ç¨‹è¿è¡Œæµç¨‹ï¼šæ ˆã€æ ˆå¸§ã€ä¸Šä¸‹æ–‡åˆ‡æ¢ã€ç¨‹åºè®¡æ•°å™¨
  - Thread ä¸¤ç§åˆ›å»ºæ–¹å¼ çš„æºç 

- æ¨¡å¼æ–¹é¢
  - ç»ˆæ­¢æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢


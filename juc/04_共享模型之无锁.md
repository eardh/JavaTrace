# å…±äº«æ¨¡å‹ä¹‹æ— é”

- CAS ä¸ volatile
- åŸå­æ•´æ•°
- åŸå­å¼•ç”¨
- åŸå­ç´¯åŠ å™¨
- ThreadLocal
- Unsafe



## 1. é—®é¢˜æå‡º

æœ‰å¦‚ä¸‹éœ€æ±‚ï¼Œä¿è¯ `account.withdraw` å–æ¬¾æ–¹æ³•çš„çº¿ç¨‹å®‰å…¨

```java
interface Account {
    // è·å–ä½™é¢
    Integer getBalance();

    // å–æ¬¾
    void withdraw(Integer amount);

    /**
     * æ–¹æ³•å†…ä¼šå¯åŠ¨ 1000 ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åš -10 å…ƒ çš„æ“ä½œ
     * å¦‚æœåˆå§‹ä½™é¢ä¸º 10000 é‚£ä¹ˆæ­£ç¡®çš„ç»“æœåº”å½“æ˜¯ 0
     */
    static void demo(Account account) {
        List<Thread> ts = new ArrayList<>();
        for (int i = 0; i < 1000; i++) {
            ts.add(new Thread(() -> {
                account.withdraw(10);
            }));
        }
        long start = System.nanoTime();
        ts.forEach(Thread::start);
        ts.forEach(t -> {
            try {
                t.join();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        });
        long end = System.nanoTime();
        System.out.println(account.getBalance()
                + " cost: " + (end-start)/1000_000 + " ms");
    }
}
```

åŸæœ‰å®ç°å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„

```java
class AccountUnsafe implements Account {
    private Integer balance;
    public AccountUnsafe(Integer balance) {
        this.balance = balance;
    }
    @Override
    public Integer getBalance() {
        return balance;
    }
    @Override
    public void withdraw(Integer amount) {
        balance -= amount;
    }
}
```

æµ‹è¯•

```java
public static void main(String[] args) {
    Account.demo(new AccountUnsafe(10000));
}
```

```shell
# ç»“æœ
330 cost: 306 ms 
```



### 1. å®‰å…¨åˆ†æ

`withdraw` æ–¹æ³•

```java
public void withdraw(Integer amount) {
    balance -= amount;
}
```

å¯¹åº”çš„å­—èŠ‚ç 

```java
ALOAD 0                                                        // <- this
ALOAD 0
GETFIELD cn/itcast/AccountUnsafe.balance : Ljava/lang/Integer; // <- this.balance
INVOKEVIRTUAL java/lang/Integer.intValue ()I                   // æ‹†ç®±
ALOAD 1                                                        // <- amount
INVOKEVIRTUAL java/lang/Integer.intValue ()I                   // æ‹†ç®±
ISUB                                                           // å‡æ³•
INVOKESTATIC java/lang/Integer.valueOf (I)Ljava/lang/Integer;  // ç»“æœè£…ç®±
PUTFIELD cn/itcast/AccountUnsafe.balance : Ljava/lang/Integer; // -> this.balance
```

å¤šçº¿ç¨‹æ‰§è¡Œæµç¨‹

```java
ALOAD 0 								 // thread-0 <- this 
ALOAD 0 
GETFIELD cn/itcast/AccountUnsafe.balance // thread-0 <- this.balance 
INVOKEVIRTUAL java/lang/Integer.intValue // thread-0 æ‹†ç®±
ALOAD 1 // thread-0 <- amount 
INVOKEVIRTUAL java/lang/Integer.intValue // thread-0 æ‹†ç®±
ISUB // thread-0 å‡æ³•
INVOKESTATIC java/lang/Integer.valueOf   // thread-0 ç»“æœè£…ç®±
PUTFIELD cn/itcast/AccountUnsafe.balance // thread-0 -> this.balance 
 
ALOAD 0 							     // thread-1 <- this 
ALOAD 0 
GETFIELD cn/itcast/AccountUnsafe.balance // thread-1 <- this.balance 
INVOKEVIRTUAL java/lang/Integer.intValue // thread-1 æ‹†ç®±
ALOAD 1 // thread-1 <- amount 
INVOKEVIRTUAL java/lang/Integer.intValue // thread-1 æ‹†ç®±
ISUB // thread-1 å‡æ³•
INVOKESTATIC java/lang/Integer.valueOf   // thread-1 ç»“æœè£…ç®±
PUTFIELD cn/itcast/AccountUnsafe.balance // thread-1 -> this.balance 
```

- å•æ ¸çš„æŒ‡ä»¤äº¤é”™
- å¤šæ ¸çš„æŒ‡ä»¤äº¤é”™



### 2. è§£å†³æ€è·¯-é”

é¦–å…ˆæƒ³åˆ°çš„æ˜¯ç»™ Account å¯¹è±¡åŠ é”

```java
class AccountUnsafe implements Account {
    private Integer balance;
    public AccountUnsafe(Integer balance) {
        this.balance = balance;
    }
    @Override
    public synchronized Integer getBalance() {
        return balance;
    }
    @Override
    public synchronized void withdraw(Integer amount) {
        balance -= amount;
    }
}

```

```shell
# ç»“æœ
0 cost: 399 ms 
```





### 3. è§£å†³æ€è·¯-æ— é”

```java
class AccountSafe implements Account {
    private AtomicInteger balance;
    public AccountSafe(Integer balance) {
        this.balance = new AtomicInteger(balance);
    }
    @Override
    public Integer getBalance() {
        return balance.get();
    }
    @Override
    public void withdraw(Integer amount) {
        while (true) {
            int prev = balance.get();
            int next = prev - amount;
            if (balance.compareAndSet(prev, next)) {
                break;
            }
        }
        // å¯ä»¥ç®€åŒ–ä¸ºä¸‹é¢çš„æ–¹æ³•
        // balance.addAndGet(-1 * amount);
    }
}
```

æ‰§è¡Œæµ‹è¯•ä»£ç 

```java
public static void main(String[] args) {
    Account.demo(new AccountSafe(10000));
}
```

```shell
# ç»“æœ
0 cost: 302 ms 
```





## 2. CAS ä¸ volatile

å‰é¢çœ‹åˆ°çš„ `AtomicInteger` çš„è§£å†³æ–¹æ³•ï¼Œå†…éƒ¨å¹¶æ²¡æœ‰ç”¨é”æ¥ä¿æŠ¤å…±äº«å˜é‡çš„çº¿ç¨‹å®‰å…¨ã€‚é‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ

```java
public void withdraw(Integer amount) {
    while(true) {
        // éœ€è¦ä¸æ–­å°è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢
        while (true) {
            // æ¯”å¦‚æ‹¿åˆ°äº†æ—§å€¼ 1000
            int prev = balance.get();
            // åœ¨è¿™ä¸ªåŸºç¡€ä¸Š 1000-10 = 990
            int next = prev - amount;
            /*
 			compareAndSet æ­£æ˜¯åšè¿™ä¸ªæ£€æŸ¥ï¼Œåœ¨ set å‰ï¼Œå…ˆæ¯”è¾ƒ prev ä¸å½“å‰å€¼
			- ä¸ä¸€è‡´äº†ï¼Œnext ä½œåºŸï¼Œè¿”å› false è¡¨ç¤ºå¤±è´¥
 				æ¯”å¦‚ï¼Œåˆ«çš„çº¿ç¨‹å·²ç»åšäº†å‡æ³•ï¼Œå½“å‰å€¼å·²ç»è¢«å‡æˆäº† 990
 				é‚£ä¹ˆæœ¬çº¿ç¨‹çš„è¿™æ¬¡ 990 å°±ä½œåºŸäº†ï¼Œè¿›å…¥ while ä¸‹æ¬¡å¾ªç¯é‡è¯•
 			- ä¸€è‡´ï¼Œä»¥ next è®¾ç½®ä¸ºæ–°å€¼ï¼Œè¿”å› true è¡¨ç¤ºæˆåŠŸ
 			*/
            if (balance.compareAndSet(prev, next)) {
                break;
            }
        }
    }
}
```

å…¶ä¸­çš„å…³é”®æ˜¯ compareAndSetï¼Œå®ƒçš„ç®€ç§°å°±æ˜¯ CAS ï¼ˆä¹Ÿæœ‰ Compare And Swap çš„è¯´æ³•ï¼‰ï¼Œå®ƒå¿…é¡»æ˜¯åŸå­æ“ä½œã€‚

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111171302908.png)

> **æ³¨æ„**
>
> å…¶å® CAS çš„åº•å±‚æ˜¯ `lock cmpxchg` æŒ‡ä»¤ï¼ˆX86 æ¶æ„ï¼‰ï¼Œåœ¨å•æ ¸ CPU å’Œå¤šæ ¸ CPU ä¸‹éƒ½èƒ½å¤Ÿä¿è¯ã€æ¯”è¾ƒ-äº¤ æ¢ã€‘çš„åŸå­æ€§ã€‚
>
> - åœ¨å¤šæ ¸çŠ¶æ€ä¸‹ï¼ŒæŸä¸ªæ ¸æ‰§è¡Œåˆ°å¸¦ lock çš„æŒ‡ä»¤æ—¶ï¼ŒCPU ä¼šè®©æ€»çº¿é”ä½ï¼Œå½“è¿™ä¸ªæ ¸æŠŠæ­¤æŒ‡ä»¤æ‰§è¡Œå®Œæ¯•ï¼Œå†å¼€å¯æ€»çº¿ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ä¸ä¼šè¢«çº¿ç¨‹çš„è°ƒåº¦æœºåˆ¶æ‰€æ‰“æ–­ï¼Œä¿è¯äº†å¤šä¸ªçº¿ç¨‹å¯¹å†…å­˜æ“ä½œçš„å‡†ç¡®æ€§ï¼Œæ˜¯åŸå­çš„ã€‚



### 1. æ…¢åŠ¨ä½œåˆ†æ

```java
@Slf4j
public class SlowMotion {
    public static void main(String[] args) {
        AtomicInteger balance = new AtomicInteger(10000);
        int mainPrev = balance.get();
        log.debug("try get {}", mainPrev);
        new Thread(() -> {
            sleep(1000);
            int prev = balance.get();
            balance.compareAndSet(prev, 9000);
            log.debug(balance.toString());
        }, "t1").start();
        
        sleep(2000);
        log.debug("try set 8000...");
        boolean isSuccess = balance.compareAndSet(mainPrev, 8000);
        log.debug("is success ? {}", isSuccess);
        if(!isSuccess){
            mainPrev = balance.get();
            log.debug("try set 8000...");
            isSuccess = balance.compareAndSet(mainPrev, 8000);
            log.debug("is success ? {}", isSuccess);
        }
    }
    
    private static void sleep(int millis) {
        try {
            Thread.sleep(millis);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
```

```shell
# ç»“æœ
2019-10-13 11:28:37.134 [main] try get 10000 
2019-10-13 11:28:38.154 [t1] 9000 
2019-10-13 11:28:39.154 [main] try set 8000... 
2019-10-13 11:28:39.154 [main] is success ? false 
2019-10-13 11:28:39.154 [main] try set 8000... 
2019-10-13 11:28:39.154 [main] is success ? true 
```





### 2. volatile

è·å–å…±äº«å˜é‡æ—¶ï¼Œä¸ºäº†ä¿è¯è¯¥å˜é‡çš„å¯è§æ€§ï¼Œéœ€è¦ä½¿ç”¨ volatile ä¿®é¥°ã€‚

å®ƒå¯ä»¥ç”¨æ¥ä¿®é¥°æˆå‘˜å˜é‡å’Œé™æ€æˆå‘˜å˜é‡ï¼Œä»–å¯ä»¥é¿å…çº¿ç¨‹ä»è‡ªå·±çš„å·¥ä½œç¼“å­˜ä¸­æŸ¥æ‰¾å˜é‡çš„å€¼ï¼Œå¿…é¡»åˆ°ä¸»å­˜ä¸­è·å– å®ƒçš„å€¼ï¼Œçº¿ç¨‹æ“ä½œ volatile å˜é‡éƒ½æ˜¯ç›´æ¥æ“ä½œä¸»å­˜ã€‚å³ä¸€ä¸ªçº¿ç¨‹å¯¹ volatile å˜é‡çš„ä¿®æ”¹ï¼Œå¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§ã€‚

> **æ³¨æ„**
>
> volatile ä»…ä»…ä¿è¯äº†å…±äº«å˜é‡çš„å¯è§æ€§ï¼Œè®©å…¶å®ƒçº¿ç¨‹èƒ½å¤Ÿçœ‹åˆ°æœ€æ–°å€¼ï¼Œä½†ä¸èƒ½è§£å†³æŒ‡ä»¤äº¤é”™é—®é¢˜ï¼ˆä¸èƒ½ä¿è¯åŸ å­æ€§ï¼‰

CAS å¿…é¡»å€ŸåŠ© volatile æ‰èƒ½è¯»å–åˆ°å…±äº«å˜é‡çš„æœ€æ–°å€¼æ¥å®ç°ã€æ¯”è¾ƒå¹¶äº¤æ¢ã€‘çš„æ•ˆæœ





### 3. æ— é”æ•ˆç‡é«˜

- æ— é”æƒ…å†µä¸‹ï¼Œå³ä½¿é‡è¯•å¤±è´¥ï¼Œçº¿ç¨‹å§‹ç»ˆåœ¨é«˜é€Ÿè¿è¡Œï¼Œæ²¡æœ‰åœæ­‡ï¼Œè€Œ `synchronized` ä¼šè®©çº¿ç¨‹åœ¨æ²¡æœ‰è·å¾—é”çš„æ—¶ å€™ï¼Œå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿›å…¥é˜»å¡ã€‚æ‰“ä¸ªæ¯”å–»
- çº¿ç¨‹å°±å¥½åƒé«˜é€Ÿè·‘é“ä¸Šçš„èµ›è½¦ï¼Œé«˜é€Ÿè¿è¡Œæ—¶ï¼Œé€Ÿåº¦è¶…å¿«ï¼Œä¸€æ—¦å‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå°±å¥½æ¯”èµ›è½¦è¦å‡é€Ÿã€ç†„ç«ï¼Œ ç­‰è¢«å”¤é†’åˆå¾—é‡æ–°æ‰“ç«ã€å¯åŠ¨ã€åŠ é€Ÿ... æ¢å¤åˆ°é«˜é€Ÿè¿è¡Œï¼Œä»£ä»·æ¯”è¾ƒå¤§

- çº¿ç¨‹å°±å¥½åƒé«˜é€Ÿè·‘é“ä¸Šçš„èµ›è½¦ï¼Œé«˜é€Ÿè¿è¡Œæ—¶ï¼Œé€Ÿåº¦è¶…å¿«ï¼Œä¸€æ—¦å‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå°±å¥½æ¯”èµ›è½¦è¦å‡é€Ÿã€ç†„ç«ï¼Œ ç­‰è¢«å”¤é†’åˆå¾—é‡æ–°æ‰“ç«ã€å¯åŠ¨ã€åŠ é€Ÿ... æ¢å¤åˆ°é«˜é€Ÿè¿è¡Œï¼Œä»£ä»·æ¯”è¾ƒå¤§

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111171302354.png)



### 4. CAS çš„ç‰¹ç‚¹

ç»“åˆ CAS å’Œ volatile å¯ä»¥å®ç°æ— é”å¹¶å‘ï¼Œé€‚ç”¨äºçº¿ç¨‹æ•°å°‘ã€å¤šæ ¸ CPU çš„åœºæ™¯ä¸‹ã€‚

- CAS æ˜¯åŸºäº**ä¹è§‚é”**çš„æ€æƒ³ï¼šæœ€ä¹è§‚çš„ä¼°è®¡ï¼Œä¸æ€•åˆ«çš„çº¿ç¨‹æ¥ä¿®æ”¹å…±äº«å˜é‡ï¼Œå°±ç®—æ”¹äº†ä¹Ÿæ²¡å…³ç³»ï¼Œæˆ‘åƒäºç‚¹å† é‡è¯•å‘—ã€‚
- `synchronized` æ˜¯åŸºäº**æ‚²è§‚é”**çš„æ€æƒ³ï¼šæœ€æ‚²è§‚çš„ä¼°è®¡ï¼Œå¾—é˜²ç€å…¶å®ƒçº¿ç¨‹æ¥ä¿®æ”¹å…±äº«å˜é‡ï¼Œæˆ‘ä¸Šäº†é”ä½ ä»¬éƒ½åˆ«æƒ³ æ”¹ï¼Œæˆ‘æ”¹å®Œäº†è§£å¼€é”ï¼Œä½ ä»¬æ‰æœ‰æœºä¼šã€‚
- CAS ä½“ç°çš„æ˜¯æ— é”å¹¶å‘ã€æ— é˜»å¡å¹¶å‘ï¼Œè¯·ä»”ç»†ä½“ä¼šè¿™ä¸¤å¥è¯çš„æ„æ€
  - å› ä¸ºæ²¡æœ‰ä½¿ç”¨ synchronizedï¼Œæ‰€ä»¥çº¿ç¨‹ä¸ä¼šé™·å…¥é˜»å¡ï¼Œè¿™æ˜¯æ•ˆç‡æå‡çš„å› ç´ ä¹‹ä¸€
  - ä½†å¦‚æœç«äº‰æ¿€çƒˆï¼Œå¯ä»¥æƒ³åˆ°é‡è¯•å¿…ç„¶é¢‘ç¹å‘ç”Ÿï¼Œåè€Œæ•ˆç‡ä¼šå—å½±å“





## 3. åŸå­æ•´æ•°

J.U.C å¹¶å‘åŒ…æä¾›äº†ï¼š

- AtomicBoolean
- AtomicInteger
- AtomicLong

ä»¥ AtomicInteger ä¸ºä¾‹

```java
AtomicInteger i = new AtomicInteger(0);

// è·å–å¹¶è‡ªå¢ï¼ˆi = 0, ç»“æœ i = 1, è¿”å› 0ï¼‰ï¼Œç±»ä¼¼äº i++
System.out.println(i.getAndIncrement());

// è‡ªå¢å¹¶è·å–ï¼ˆi = 1, ç»“æœ i = 2, è¿”å› 2ï¼‰ï¼Œç±»ä¼¼äº ++i
System.out.println(i.incrementAndGet());

// è‡ªå‡å¹¶è·å–ï¼ˆi = 2, ç»“æœ i = 1, è¿”å› 1ï¼‰ï¼Œç±»ä¼¼äº --i
System.out.println(i.decrementAndGet());

// è·å–å¹¶è‡ªå‡ï¼ˆi = 1, ç»“æœ i = 0, è¿”å› 1ï¼‰ï¼Œç±»ä¼¼äº i--
System.out.println(i.getAndDecrement());

// è·å–å¹¶åŠ å€¼ï¼ˆi = 0, ç»“æœ i = 5, è¿”å› 0ï¼‰
System.out.println(i.getAndAdd(5));

// åŠ å€¼å¹¶è·å–ï¼ˆi = 5, ç»“æœ i = 0, è¿”å› 0ï¼‰
System.out.println(i.addAndGet(-5));

// è·å–å¹¶æ›´æ–°ï¼ˆi = 0, p ä¸º i çš„å½“å‰å€¼, ç»“æœ i = -2, è¿”å› 0ï¼‰
// å…¶ä¸­å‡½æ•°ä¸­çš„æ“ä½œèƒ½ä¿è¯åŸå­ï¼Œä½†å‡½æ•°éœ€è¦æ— å‰¯ä½œç”¨
System.out.println(i.getAndUpdate(p -> p - 2));

// æ›´æ–°å¹¶è·å–ï¼ˆi = -2, p ä¸º i çš„å½“å‰å€¼, ç»“æœ i = 0, è¿”å› 0ï¼‰
// å…¶ä¸­å‡½æ•°ä¸­çš„æ“ä½œèƒ½ä¿è¯åŸå­ï¼Œä½†å‡½æ•°éœ€è¦æ— å‰¯ä½œç”¨
System.out.println(i.updateAndGet(p -> p + 2));

// è·å–å¹¶è®¡ç®—ï¼ˆi = 0, p ä¸º i çš„å½“å‰å€¼, x ä¸ºå‚æ•°1, ç»“æœ i = 10, è¿”å› 0ï¼‰
// å…¶ä¸­å‡½æ•°ä¸­çš„æ“ä½œèƒ½ä¿è¯åŸå­ï¼Œä½†å‡½æ•°éœ€è¦æ— å‰¯ä½œç”¨
// getAndUpdate å¦‚æœåœ¨ lambda ä¸­å¼•ç”¨äº†å¤–éƒ¨çš„å±€éƒ¨å˜é‡ï¼Œè¦ä¿è¯è¯¥å±€éƒ¨å˜é‡æ˜¯ final çš„
// getAndAccumulate å¯ä»¥é€šè¿‡ å‚æ•°1 æ¥å¼•ç”¨å¤–éƒ¨çš„å±€éƒ¨å˜é‡ï¼Œä½†å› ä¸ºå…¶ä¸åœ¨ lambda ä¸­å› æ­¤ä¸å¿…æ˜¯ final
System.out.println(i.getAndAccumulate(10, (p, x) -> p + x));

// è®¡ç®—å¹¶è·å–ï¼ˆi = 10, p ä¸º i çš„å½“å‰å€¼, x ä¸ºå‚æ•°1, ç»“æœ i = 0, è¿”å› 0ï¼‰
// å…¶ä¸­å‡½æ•°ä¸­çš„æ“ä½œèƒ½ä¿è¯åŸå­ï¼Œä½†å‡½æ•°éœ€è¦æ— å‰¯ä½œç”¨
System.out.println(i.accumulateAndGet(-10, (p, x) -> p + x))
```





## 4. åŸå­å¼•ç”¨

ä¸ºä»€ä¹ˆéœ€è¦åŸå­å¼•ç”¨ç±»å‹ï¼Ÿ

- AtomicReference
- AtomicMarkableReference
- AtomicStampedReference

æœ‰å¦‚ä¸‹æ–¹æ³•

```java
public interface DecimalAccount {
    // è·å–ä½™é¢
    BigDecimal getBalance();
    // å–æ¬¾
    void withdraw(BigDecimal amount);
    /**
 	 * æ–¹æ³•å†…ä¼šå¯åŠ¨ 1000 ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åš -10 å…ƒ çš„æ“ä½œ
 	 * å¦‚æœåˆå§‹ä½™é¢ä¸º 10000 é‚£ä¹ˆæ­£ç¡®çš„ç»“æœåº”å½“æ˜¯ 0
 	 */
    static void demo(DecimalAccount account) {
        List<Thread> ts = new ArrayList<>();
        for (int i = 0; i < 1000; i++) {
            ts.add(new Thread(() -> {
                account.withdraw(BigDecimal.TEN);
            }));
        }
        ts.forEach(Thread::start);
        ts.forEach(t -> {
            try {
                t.join();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        });
        System.out.println(account.getBalance());
    }
}
```

è¯•ç€æä¾›ä¸åŒçš„ DecimalAccount å®ç°ï¼Œå®ç°å®‰å…¨çš„å–æ¬¾æ“ä½œ



### 1. éå®‰å…¨

```java
class DecimalAccountUnsafe implements DecimalAccount {
    BigDecimal balance;
    
    public DecimalAccountUnsafe(BigDecimal balance) {
        this.balance = balance;
    }
    
    @Override
    public BigDecimal getBalance() {
        return balance;
    }
    
    @Override
    public void withdraw(BigDecimal amount) {
        BigDecimal balance = this.getBalance();
        this.balance = balance.subtract(amount);
    }
}
```



### 2. å®‰å…¨-é”

```java
class DecimalAccountSafeLock implements DecimalAccount {
    private final Object lock = new Object();
    BigDecimal balance;
    
    public DecimalAccountSafeLock(BigDecimal balance) {
        this.balance = balance;
    }
    
    @Override
    public BigDecimal getBalance() {
        return balance;
    }
    
    @Override
    public void withdraw(BigDecimal amount) {
        synchronized (lock) {
            BigDecimal balance = this.getBalance();
            this.balance = balance.subtract(amount);
        }
    }
}
```



### 3. å®‰å…¨-CAS

```java
class DecimalAccountSafeCas implements DecimalAccount {
    AtomicReference<BigDecimal> ref;
    
    public DecimalAccountSafeCas(BigDecimal balance) {
        ref = new AtomicReference<>(balance);
    }
    
    @Override
    public BigDecimal getBalance() {
        return ref.get();
    }
    
    @Override
    public void withdraw(BigDecimal amount) {
        while (true) {
            BigDecimal prev = ref.get();
            BigDecimal next = prev.subtract(amount);
            if (ref.compareAndSet(prev, next)) {
                break;
            }
        }
    }
}
```

> ç”¨æ³•ä¸ AtomicInteger ç±»ä¼¼



### 4. ABA ğŸš€

#### 1. ABA é—®é¢˜

```java
static AtomicReference<String> ref = new AtomicReference<>("A");

public static void main(String[] args) throws InterruptedException {
    log.debug("main start...");
    // è·å–å€¼ A
    // è¿™ä¸ªå…±äº«å˜é‡è¢«å®ƒçº¿ç¨‹ä¿®æ”¹è¿‡ï¼Ÿ
    String prev = ref.get();
    other();
    sleep(1);
    // å°è¯•æ”¹ä¸º C
    log.debug("change A->C {}", ref.compareAndSet(prev, "C"));
}

private static void other() {
    new Thread(() -> {
        log.debug("change A->B {}", ref.compareAndSet(ref.get(), "B"));
    }, "t1").start();
    sleep(0.5);
    new Thread(() -> {
        log.debug("change B->A {}", ref.compareAndSet(ref.get(), "A"));
    }, "t2").start();
}
```

```shell
# ç»“æœ
11:29:52.325 c.Test36 [main] - main start... 
11:29:52.379 c.Test36 [t1] - change A->B true 
11:29:52.879 c.Test36 [t2] - change B->A true 
11:29:53.880 c.Test36 [main] - change A->C true 
```

ä¸»çº¿ç¨‹ä»…èƒ½åˆ¤æ–­å‡ºå…±äº«å˜é‡çš„å€¼ä¸æœ€åˆå€¼ A æ˜¯å¦ç›¸åŒï¼Œä¸èƒ½æ„ŸçŸ¥åˆ°è¿™ç§ä» A æ”¹ä¸º B åˆ æ”¹å› A çš„æƒ…å†µï¼Œå¦‚æœä¸»çº¿ç¨‹ å¸Œæœ›ï¼š

åªè¦æœ‰å…¶å®ƒçº¿ç¨‹ã€åŠ¨è¿‡äº†ã€‘å…±äº«å˜é‡ï¼Œé‚£ä¹ˆè‡ªå·±çš„ cas å°±ç®—å¤±è´¥ï¼Œè¿™æ—¶ï¼Œä»…æ¯”è¾ƒå€¼æ˜¯ä¸å¤Ÿçš„ï¼Œéœ€è¦å†åŠ ä¸€ä¸ªç‰ˆæœ¬å·



#### 2. AtomicStampedReference

```java
@Slf4j(topic = "c.Test36")
public class Test36 {

    static AtomicStampedReference<String> ref = new AtomicStampedReference<>("A", 0);

    public static void main(String[] args) throws InterruptedException {
        log.debug("main start...");
        // è·å–å€¼ A
        String prev = ref.getReference();
        // è·å–ç‰ˆæœ¬å·
        int stamp = ref.getStamp();
        log.debug("ç‰ˆæœ¬ {}", stamp);
        // å¦‚æœä¸­é—´æœ‰å…¶å®ƒçº¿ç¨‹å¹²æ‰°ï¼Œå‘ç”Ÿäº† ABA ç°è±¡
        other();
        sleep(1);
        // å°è¯•æ”¹ä¸º C
        log.debug("change A->C {}", ref.compareAndSet(prev, "C", stamp, stamp + 1));
    }

    private static void other() {
        new Thread(() -> {
            log.debug("change A->B {}", ref.compareAndSet(ref.getReference(), "B", ref.getStamp(), ref.getStamp() + 1));
            log.debug("æ›´æ–°ç‰ˆæœ¬ä¸º {}", ref.getStamp());
        }, "t1").start();
        sleep(0.5);
        new Thread(() -> {
            log.debug("change B->A {}", ref.compareAndSet(ref.getReference(), "A", ref.getStamp(), ref.getStamp() + 1));
            log.debug("æ›´æ–°ç‰ˆæœ¬ä¸º {}", ref.getStamp());
        }, "t2").start();
    }
}
```

```shell
# ç»“æœ
10:45:22.059 c.Test36 [main] - main start...
10:45:22.071 c.Test36 [main] - ç‰ˆæœ¬ 0
10:45:22.195 c.Test36 [t1] - change A->B true
10:45:22.195 c.Test36 [t1] - æ›´æ–°ç‰ˆæœ¬ä¸º 1
10:45:22.728 c.Test36 [t2] - change B->A true
10:45:22.728 c.Test36 [t2] - æ›´æ–°ç‰ˆæœ¬ä¸º 2
10:45:23.725 c.Test36 [main] - change A->C false
```

`AtomicStampedReference` å¯ä»¥ç»™åŸå­å¼•ç”¨åŠ ä¸Šç‰ˆæœ¬å·ï¼Œè¿½è¸ªåŸå­å¼•ç”¨æ•´ä¸ªçš„å˜åŒ–è¿‡ç¨‹ï¼Œå¦‚ï¼š `A -> B -> A -> C` ï¼Œé€šè¿‡ `AtomicStampedReference`ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå¼•ç”¨å˜é‡ä¸­é€”è¢«æ›´æ”¹äº†å‡ æ¬¡ã€‚



#### 3. AtomicMarkableReference

ä½†æ˜¯æœ‰æ—¶å€™ï¼Œå¹¶ä¸å…³å¿ƒå¼•ç”¨å˜é‡æ›´æ”¹äº†å‡ æ¬¡ï¼Œåªæ˜¯å•çº¯çš„å…³å¿ƒ**æ˜¯å¦æ›´æ”¹è¿‡**ï¼Œæ‰€ä»¥å°±æœ‰äº† `AtomicMarkableReference`

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111171303067.png)

```java
@Slf4j(topic = "c.Test38")
public class Test38 {
    public static void main(String[] args) throws InterruptedException {
        GarbageBag bag = new GarbageBag("è£…æ»¡äº†åƒåœ¾");
        // å‚æ•°2 mark å¯ä»¥çœ‹ä½œä¸€ä¸ªæ ‡è®°ï¼Œè¡¨ç¤ºåƒåœ¾è¢‹æ»¡äº†
        AtomicMarkableReference<GarbageBag> ref = new AtomicMarkableReference<>(bag, true);

        log.debug("start...");
        GarbageBag prev = ref.getReference();
        log.debug(prev.toString());

        new Thread(() -> {
            log.debug("start...");
            bag.setDesc("ç©ºåƒåœ¾è¢‹");
            ref.compareAndSet(bag, bag, true, false);
            log.debug(bag.toString());
        },"ä¿æ´é˜¿å§¨").start();

        sleep(1);
        log.debug("æƒ³æ¢ä¸€åªæ–°åƒåœ¾è¢‹ï¼Ÿ");
        boolean success = ref.compareAndSet(prev, new GarbageBag("ç©ºåƒåœ¾è¢‹"), true, false);
        log.debug("æ¢äº†ä¹ˆï¼Ÿ" + success);
        log.debug(ref.getReference().toString());
    }
}

class GarbageBag {
    String desc;

    public GarbageBag(String desc) {
        this.desc = desc;
    }

    public void setDesc(String desc) {
        this.desc = desc;
    }

    @Override
    public String toString() {
        return super.toString() + " " + desc;
    }
}
```





## 5. åŸå­æ•°ç»„

- AtomicIntegerArray
- AtomicLongArray
- AtomicReferenceArray

```java
/**
 * å‚æ•°1ï¼Œæä¾›æ•°ç»„ã€å¯ä»¥æ˜¯çº¿ç¨‹ä¸å®‰å…¨æ•°ç»„æˆ–çº¿ç¨‹å®‰å…¨æ•°ç»„
 * å‚æ•°2ï¼Œè·å–æ•°ç»„é•¿åº¦çš„æ–¹æ³•
 * å‚æ•°3ï¼Œè‡ªå¢æ–¹æ³•ï¼Œå›ä¼  array, index
 * å‚æ•°4ï¼Œæ‰“å°æ•°ç»„çš„æ–¹æ³•
 */
// supplier æä¾›è€… æ— ä¸­ç”Ÿæœ‰  ()->ç»“æœ
// function å‡½æ•°   ä¸€ä¸ªå‚æ•°ä¸€ä¸ªç»“æœ   (å‚æ•°)->ç»“æœ  ,  BiFunction (å‚æ•°1,å‚æ•°2)->ç»“æœ
// consumer æ¶ˆè´¹è€… ä¸€ä¸ªå‚æ•°æ²¡ç»“æœ  (å‚æ•°)->void,      BiConsumer (å‚æ•°1,å‚æ•°2)->void
private static <T> void demo(
    Supplier<T> arraySupplier,
    Function<T, Integer> lengthFun,
    BiConsumer<T, Integer> putConsumer,
    Consumer<T> printConsumer ) {
    List<Thread> ts = new ArrayList<>();
    T array = arraySupplier.get();
    int length = lengthFun.apply(array);
    for (int i = 0; i < length; i++) {
        // æ¯ä¸ªçº¿ç¨‹å¯¹æ•°ç»„ä½œ 10000 æ¬¡æ“ä½œ
        ts.add(new Thread(() -> {
            for (int j = 0; j < 10000; j++) {
                putConsumer.accept(array, j%length);
            }
        }));
    }

    ts.forEach(t -> t.start()); // å¯åŠ¨æ‰€æœ‰çº¿ç¨‹
    ts.forEach(t -> {
        try {
            t.join();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    });     // ç­‰æ‰€æœ‰çº¿ç¨‹ç»“æŸ
    printConsumer.accept(array);
}
```



### 1. ä¸å®‰å…¨æ•°ç»„

```java
public static void main(String[] args) {
    demo(
        ()->new int[10],
        array -> array.length,
        (array, index) -> array[index]++,
        array -> System.out.println(Arrays.toString(array))
    );
}
```

```shell
# ç»“æœ
[9965, 9977, 9974, 9970, 9965, 9978, 9977, 9977, 9977, 9975]
```





### 2. å®‰å…¨æ•°ç»„

```java
public static void main(String[] args) {
    demo(
        ()-> new AtomicIntegerArray(10),
        (array) -> array.length(),
        (array, index) -> array.getAndIncrement(index),
        array -> System.out.println(array)
    );
}
```

```shell
# ç»“æœ
[10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000]
```





## 6. å­—æ®µæ›´æ–°å™¨

- AtomicReferenceFieldUpdater
- AtomicIntegerFieldUpdater
- AtomicLongFieldUpdater

åˆ©ç”¨å­—æ®µæ›´æ–°å™¨ï¼Œå¯ä»¥é’ˆå¯¹å¯¹è±¡çš„æŸä¸ªåŸŸï¼ˆFieldï¼‰è¿›è¡ŒåŸå­æ“ä½œï¼Œåªèƒ½é…åˆ `volatile` ä¿®é¥°çš„å­—æ®µä½¿ç”¨ï¼Œå¦åˆ™ä¼šå‡ºç°å¼‚å¸¸

```java
Exception in thread "main" java.lang.IllegalArgumentException: Must be volatile type
```

```java
public class Test40 {

    public static void main(String[] args) {
        Student stu = new Student();

        AtomicReferenceFieldUpdater updater =
                AtomicReferenceFieldUpdater.newUpdater(Student.class, String.class, "name");

        System.out.println(updater.compareAndSet(stu, null, "å¼ ä¸‰"));
        System.out.println(stu);
    }
}

class Student {
    volatile String name;

    @Override
    public String toString() {
        return "Student{" +
                "name='" + name + '\'' +
                '}';
    }
}
```





## 7. åŸå­ç´¯åŠ å™¨

### 1. ç´¯åŠ å™¨æ€§èƒ½æ¯”è¾ƒ

```java
/**
 * () -> ç»“æœ        æä¾›ç´¯åŠ å™¨å¯¹è±¡
 * (å‚æ•°) -> void    æ‰§è¡Œç´¯åŠ æ“ä½œ
 */
private static <T> void demo(Supplier<T> adderSupplier, Consumer<T> action) {
    T adder = adderSupplier.get();
    List<Thread> ts = new ArrayList<>();
    // 4 ä¸ªçº¿ç¨‹ï¼Œæ¯äººç´¯åŠ  50 ä¸‡
    for (int i = 0; i < 4; i++) {
        ts.add(new Thread(() -> {
            for (int j = 0; j < 500000; j++) {
                action.accept(adder);
            }
        }));
    }
    long start = System.nanoTime();
    ts.forEach(t -> t.start());
    ts.forEach(t -> {
        try {
            t.join();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    });

    long end = System.nanoTime();
    System.out.println(adder + " cost:" + (end - start) / 1000_000);
}
```

æ¯”è¾ƒ AtomicLong ä¸ LongAdder

```java
public static void main(String[] args) {
    for (int i = 0; i < 5; i++) {
        demo(
            () -> new LongAdder(),
            adder -> adder.increment()
        );
    }

    for (int i = 0; i < 5; i++) {
        demo(
            () -> new AtomicLong(0),
            (adder) -> adder.getAndIncrement()
        );
    }
}
```

```shell
# ç»“æœ
2000000 cost:38
2000000 cost:29
2000000 cost:17
2000000 cost:15
2000000 cost:16

2000000 cost:37
2000000 cost:34
2000000 cost:25
2000000 cost:29
2000000 cost:33
```

æ€§èƒ½æå‡çš„åŸå› å¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨æœ‰ç«äº‰æ—¶ï¼Œè®¾ç½®å¤šä¸ªç´¯åŠ å•å…ƒï¼ŒTherad-0 ç´¯åŠ  Cell[0]ï¼Œè€Œ Thread-1 ç´¯åŠ  Cell[1]... æœ€åå°†ç»“æœæ±‡æ€»ã€‚è¿™æ ·å®ƒä»¬åœ¨ç´¯åŠ æ—¶æ“ä½œçš„ä¸åŒçš„ Cell å˜é‡ï¼Œå› æ­¤å‡å°‘äº† CAS é‡è¯•å¤±è´¥ï¼Œä»è€Œæé«˜æ€§ èƒ½ã€‚





### 2. LongAdderæºç 

LongAdder æ˜¯å¹¶å‘å¤§å¸ˆ @author Doug Lea ï¼ˆå¤§å“¥æï¼‰çš„ä½œå“ï¼Œè®¾è®¡çš„éå¸¸ç²¾å·§

![](https://gitlab.com/eardh/picture/-/raw/main/common_img/202207161212306.png)

LongAdder ç±»æœ‰å‡ ä¸ªå…³é”®åŸŸ

```java
/** Number of CPUS, to place bound on table size        CPUæ•°é‡ï¼Œå³cellsæ•°ç»„çš„æœ€å¤§é•¿åº¦ */
static final int NCPU = Runtime.getRuntime().availableProcessors();

/**
 * Table of cells. When non-null, size is a power of 2.
cellsæ•°ç»„ï¼Œä¸º2çš„å¹‚ï¼Œ2,4,8,16.....ï¼Œæ–¹ä¾¿ä»¥åä½è¿ç®—
 */
transient volatile Cell[] cells;

/**åŸºç¡€valueå€¼ï¼Œå½“å¹¶å‘è¾ƒä½æ—¶ï¼Œåªç´¯åŠ è¯¥å€¼ä¸»è¦ç”¨äºæ²¡æœ‰ç«äº‰çš„æƒ…å†µï¼Œé€šè¿‡CASæ›´æ–°ã€‚
 * Base value, used mainly when there is no contention, but also as
 * a fallback during table initialization races. Updated via CAS.
 */
transient volatile long base;

/**åˆ›å»ºæˆ–è€…æ‰©å®¹Cellsæ•°ç»„æ—¶ä½¿ç”¨çš„è‡ªæ—‹é”å˜é‡è°ƒæ•´å•å…ƒæ ¼å¤§å°ï¼ˆæ‰©å®¹ï¼‰ï¼Œåˆ›å»ºå•å…ƒæ ¼æ—¶ä½¿ç”¨çš„é”ã€‚
 * Spinlock (locked via CAS) used when resizing and/or creating Cells. 
 */
transient volatile int cellsBusy;
```

**cas é”**

```java
public class LockCas {
    // 0 æ²¡åŠ é”
    // 1 åŠ é”
    private AtomicInteger state = new AtomicInteger(0);

    public void lock() {
        while (true) {
            if (state.compareAndSet(0, 1)) {
                break;
            }
        }
    }

    public void unlock() {
        log.debug("unlock...");
        state.set(0);
    }

    public static void main(String[] args) {
        LockCas lock = new LockCas();
        new Thread(() -> {
            log.debug("begin...");
            lock.lock();
            try {
                log.debug("lock...");
                sleep(1);
            } finally {
                lock.unlock();
            }
        }).start();

        new Thread(() -> {
            log.debug("begin...");
            lock.lock();
            try {
                log.debug("lock...");
            } finally {
                lock.unlock();
            }
        }).start();
    }
}
```

```shell
# ç»“æœ
11:56:42.532 c.Test42 [Thread-0] - begin...
11:56:42.529 c.Test42 [Thread-1] - begin...
11:56:42.536 c.Test42 [Thread-0] - lock...
11:56:43.540 c.Test42 [Thread-0] - unlock...
11:56:43.540 c.Test42 [Thread-1] - lock...
11:56:43.540 c.Test42 [Thread-1] - unlock...
```





### 3. ä¼ªå…±äº«åŸç†

 Cell å³ä¸ºç´¯åŠ å•å…ƒ

```java
// é˜²æ­¢ç¼“å­˜è¡Œä¼ªå…±äº«
@sun.misc.Contended
    static final class Cell {
        volatile long value;
        Cell(long x) { value = x; }

        // æœ€é‡è¦çš„æ–¹æ³•, ç”¨æ¥ cas æ–¹å¼è¿›è¡Œç´¯åŠ , prev è¡¨ç¤ºæ—§å€¼, next è¡¨ç¤ºæ–°å€¼
        final boolean cas(long prev, long next) {
            return UNSAFE.compareAndSwapLong(this, valueOffset, prev, next);
        }
        // çœç•¥ä¸é‡è¦ä»£ç 
    }
```



#### 1. å†…å­˜ä¸ç¼“å­˜

ç¼“å­˜ä¸å†…å­˜çš„é€Ÿåº¦æ¯”è¾ƒ

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111171303349.png)

| ä» cpu åˆ° | å¤§çº¦éœ€è¦çš„æ—¶é’Ÿå‘¨æœŸ               |
| --------- | -------------------------------- |
| å¯„å­˜å™¨    | 1 cycle (4GHz çš„ CPU çº¦ä¸º0.25ns) |
| L1        | 3~4 cycle                        |
| L2        | 10~20 cycle                      |
| L3        | 40~45 cycle                      |
| å†…å­˜      | 120~240 cycle                    |

å› ä¸º CPU ä¸ å†…å­˜çš„é€Ÿåº¦å·®å¼‚å¾ˆå¤§ï¼Œéœ€è¦é é¢„è¯»æ•°æ®è‡³ç¼“å­˜æ¥æå‡æ•ˆç‡ã€‚

è€Œç¼“å­˜ä»¥ç¼“å­˜è¡Œä¸ºå•ä½ï¼Œæ¯ä¸ªç¼“å­˜è¡Œå¯¹åº”ç€ä¸€å—å†…å­˜ï¼Œä¸€èˆ¬æ˜¯ 64 byteï¼ˆ8 ä¸ª longï¼‰

ç¼“å­˜çš„åŠ å…¥ä¼šé€ æˆæ•°æ®å‰¯æœ¬çš„äº§ç”Ÿï¼Œå³åŒä¸€ä»½æ•°æ®ä¼šç¼“å­˜åœ¨ä¸åŒæ ¸å¿ƒçš„ç¼“å­˜è¡Œä¸­

CPU è¦ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œå¦‚æœæŸä¸ª CPU æ ¸å¿ƒæ›´æ”¹äº†æ•°æ®ï¼Œå…¶å®ƒ CPU æ ¸å¿ƒå¯¹åº”çš„æ•´ä¸ªç¼“å­˜è¡Œå¿…é¡»å¤±æ•ˆ

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111171304137.png)

å› ä¸º Cell æ˜¯æ•°ç»„å½¢å¼ï¼Œåœ¨å†…å­˜ä¸­æ˜¯è¿ç»­å­˜å‚¨çš„ï¼Œä¸€ä¸ª Cell ä¸º 24 å­—èŠ‚ï¼ˆ16 å­—èŠ‚çš„å¯¹è±¡å¤´å’Œ 8 å­—èŠ‚çš„ valueï¼‰ï¼Œå›  æ­¤ç¼“å­˜è¡Œå¯ä»¥å­˜ä¸‹ 2 ä¸ªçš„ Cell å¯¹è±¡ã€‚è¿™æ ·é—®é¢˜æ¥äº†ï¼š

- Core-0 è¦ä¿®æ”¹ Cell[0]
- Core-1 è¦ä¿®æ”¹ Cell[1]

æ— è®ºè°ä¿®æ”¹æˆåŠŸï¼Œéƒ½ä¼šå¯¼è‡´å¯¹æ–¹ Core çš„ç¼“å­˜è¡Œå¤±æ•ˆï¼Œæ¯”å¦‚ Core-0 ä¸­ `Cell[0]=6000, Cell[1]=8000` è¦ç´¯åŠ  `Cell[0]=6001, Cell[1]=8000` ï¼Œè¿™æ—¶ä¼šè®© Core-1 çš„ç¼“å­˜è¡Œå¤±æ•ˆ

@sun.misc.Contended ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒçš„åŸç†æ˜¯åœ¨ä½¿ç”¨æ­¤æ³¨è§£çš„å¯¹è±¡æˆ–å­—æ®µçš„å‰åå„å¢åŠ  128 å­—èŠ‚å¤§å°çš„ paddingï¼Œä»è€Œè®© CPU å°†å¯¹è±¡é¢„è¯»è‡³ç¼“å­˜æ—¶å ç”¨ä¸åŒçš„ç¼“å­˜è¡Œï¼Œè¿™æ ·ï¼Œä¸ä¼šé€ æˆå¯¹æ–¹ç¼“å­˜è¡Œçš„å¤±æ•ˆ

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111171304949.png)



#### 2. Striped64

- `base`ï¼šç±»ä¼¼äºAtomicLongä¸­å…¨å±€çš„valueå€¼ã€‚åœ¨æ²¡æœ‰ç«äº‰æƒ…å†µä¸‹æ•°æ®ç›´æ¥ç´¯åŠ åˆ°baseä¸Šï¼Œæˆ–è€…cellsæ‰©å®¹æ—¶ï¼Œä¹Ÿéœ€è¦å°†æ•°æ®å†™å…¥åˆ°baseä¸Š
- `collide`ï¼šè¡¨ç¤ºæ‰©å®¹æ„å‘ï¼Œfalseä¸€å®šä¸ä¼šæ‰©å®¹ï¼Œtrueå¯èƒ½ä¼šæ‰©å®¹ã€‚
- `cellsBusy`ï¼šåˆå§‹åŒ–cellsæˆ–è€…æ‰©å®¹cellséœ€è¦è·å–é”ï¼Œ0ï¼šè¡¨ç¤ºæ— é”çŠ¶æ€ï¼›1ï¼šè¡¨ç¤ºå…¶ä»–çº¿ç¨‹å·²ç»æŒæœ‰äº†é”
- `casCellsBusy()`ï¼šé€šè¿‡CASæ“ä½œä¿®æ”¹cellsBusyçš„å€¼ï¼ŒCASæˆåŠŸä»£è¡¨è·å–é”ï¼Œè¿”å›true
- `NCPU`ï¼šå½“å‰è®¡ç®—æœºCPUæ•°é‡ï¼ŒCelIæ•°ç»„æ‰©å®¹æ—¶ä¼šä½¿ç”¨åˆ°
- `getProbe()`ï¼šè·å–å½“å‰çº¿ç¨‹çš„hashå€¼
- `advanceProbe()`ï¼šé‡ç½®å½“å‰çº¿ç¨‹çš„hashå€¼



#### 2. add

```java
// x ä¸ºç´¯åŠ å€¼
public void add(long x) {
    // as ä¸ºç´¯åŠ å•å…ƒæ•°ç»„
    // b ä¸ºåŸºç¡€å€¼
    Cell[] as; long b, v; int m; Cell a;
    // è¿›å…¥ if çš„ä¸¤ä¸ªæ¡ä»¶
    // 1. as æœ‰å€¼, è¡¨ç¤ºå·²ç»å‘ç”Ÿè¿‡ç«äº‰, è¿›å…¥ if
    // 2. cas ç»™ base ç´¯åŠ æ—¶å¤±è´¥äº†, è¡¨ç¤º base å‘ç”Ÿäº†ç«äº‰, è¿›å…¥ if
    if ((as = cells) != null || !casBase(b = base, b + x)) {
        // uncontended è¡¨ç¤º cell æ²¡æœ‰ç«äº‰
        boolean uncontended = true;
        if (
            // as è¿˜æ²¡æœ‰åˆ›å»º
            as == null || (m = as.length - 1) < 0 ||
            // å½“å‰çº¿ç¨‹å¯¹åº”çš„ cell è¿˜æ²¡æœ‰
            (a = as[getProbe() & m]) == null ||
            // cas ç»™å½“å‰çº¿ç¨‹çš„ cell ç´¯åŠ å¤±è´¥ uncontended=false ( a ä¸ºå½“å‰çº¿ç¨‹çš„ cell )
            !(uncontended = a.cas(v = a.value, v + x))
        ) {
            // è¿›å…¥ cell æ•°ç»„åˆ›å»ºã€cell æ‰©å®¹çš„æµç¨‹
            longAccumulate(x, null, uncontended);
        }
    }
}
```

**add æµç¨‹å›¾**

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111171304650.png)





#### 3. longAccumulate 

```java
final void longAccumulate(long x, LongBinaryOperator fn,
                          boolean wasUncontended) {
    int h;
    // å½“å‰çº¿ç¨‹è¿˜æ²¡æœ‰å¯¹åº”çš„ cell, éœ€è¦éšæœºç”Ÿæˆä¸€ä¸ª h å€¼ç”¨æ¥å°†å½“å‰çº¿ç¨‹ç»‘å®šåˆ° cell
    if ((h = getProbe()) == 0) {
        // åˆå§‹åŒ– probe
        ThreadLocalRandom.current();
        // h å¯¹åº”æ–°çš„ probe å€¼, ç”¨æ¥å¯¹åº” cell
        h = getProbe();
        wasUncontended = true;
    }
    // collide ä¸º true è¡¨ç¤ºéœ€è¦æ‰©å®¹
    boolean collide = false; 
    for (;;) {
        Cell[] as; Cell a; int n; long v;
        // å·²ç»æœ‰äº† cells
        if ((as = cells) != null && (n = as.length) > 0) {
            // è¿˜æ²¡æœ‰ cell
            if ((a = as[(n - 1) & h]) == null) {
                // ä¸º cellsBusy åŠ é”, åˆ›å»º cell, cell çš„åˆå§‹ç´¯åŠ å€¼ä¸º x
                // æˆåŠŸåˆ™ break, å¦åˆ™ç»§ç»­ continue å¾ªç¯
            }
            // æœ‰ç«äº‰, æ”¹å˜çº¿ç¨‹å¯¹åº”çš„ cell æ¥é‡è¯• cas
            else if (!wasUncontended)
                wasUncontended = true;
            // cas å°è¯•ç´¯åŠ , fn é…åˆ LongAccumulator ä¸ä¸º null, é…åˆ LongAdder ä¸º null
            else if (a.cas(v = a.value, ((fn == null) ? v + x : fn.applyAsLong(v, x))))
                break;
            // å¦‚æœ cells é•¿åº¦å·²ç»è¶…è¿‡äº†æœ€å¤§é•¿åº¦, æˆ–è€…å·²ç»æ‰©å®¹, æ”¹å˜çº¿ç¨‹å¯¹åº”çš„ cell æ¥é‡è¯• cas
            else if (n >= NCPU || cells != as)
                collide = false;
            // ç¡®ä¿ collide ä¸º false è¿›å…¥æ­¤åˆ†æ”¯, å°±ä¸ä¼šè¿›å…¥ä¸‹é¢çš„ else if è¿›è¡Œæ‰©å®¹äº†
            else if (!collide)
                collide = true;
            // åŠ é”
            else if (cellsBusy == 0 && casCellsBusy()) {
                // åŠ é”æˆåŠŸ, æ‰©å®¹
                continue;
            }
            // æ”¹å˜çº¿ç¨‹å¯¹åº”çš„ cell
            h = advanceProbe(h);
        }
        // è¿˜æ²¡æœ‰ cells, å°è¯•ç»™ cellsBusy åŠ é”
        else if (cellsBusy == 0 && cells == as && casCellsBusy()) {
            // åŠ é”æˆåŠŸ, åˆå§‹åŒ– cells, æœ€å¼€å§‹é•¿åº¦ä¸º 2, å¹¶å¡«å……ä¸€ä¸ª cell
            // æˆåŠŸåˆ™ break;
        }
        // ä¸Šä¸¤ç§æƒ…å†µå¤±è´¥, å°è¯•ç»™ base ç´¯åŠ 
        else if (casBase(v = base, ((fn == null) ? v + x : fn.applyAsLong(v, x))))
            break;
    }
}
```

**longAccumulate æµç¨‹å›¾**

![](https://gitlab.com/eardh/picture/-/raw/main/common_img/202207161307255.png)

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111171304971.png)

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111171304084.png)

æ¯ä¸ªçº¿ç¨‹åˆšè¿›å…¥ longAccumulate æ—¶ï¼Œä¼šå°è¯•å¯¹åº”ä¸€ä¸ª cell å¯¹è±¡ï¼ˆæ‰¾åˆ°ä¸€ä¸ªå‘ä½ï¼‰

![](https://gitlab.com/eardh/picture/-/raw/main/Jconcurrent_img/202111171304923.png)



#### 4. sum

è·å–æœ€ç»ˆç»“æœé€šè¿‡ sum æ–¹æ³•

```java
public long sum() {
    Cell[] as = cells; Cell a;
    long sum = base;
    if (as != null) {
        for (int i = 0; i < as.length; ++i) {
            if ((a = as[i]) != null)
                sum += a.value;
        }
    }
    return sum;
}
```





## 8. ThreadLocal

### 1. ç®€ä»‹

ThreadLocalæä¾›çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚è¿™äº›å˜é‡ä¸æ­£å¸¸çš„å˜é‡ä¸åŒï¼Œå› ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹åœ¨è®¿é—®ThreadLocalå®ä¾‹çš„æ—¶å€™ï¼ˆé€šè¿‡å…¶getæˆ–setæ–¹æ³•ï¼‰éƒ½æœ‰è‡ªå·±çš„ã€ç‹¬ç«‹åˆå§‹åŒ–çš„å˜é‡å‰¯æœ¬ã€‚ThreadLocalå®ä¾‹é€šå¸¸æ˜¯ç±»ä¸­çš„ç§æœ‰é™æ€å­—æ®µï¼Œä½¿ç”¨å®ƒçš„ç›®çš„æ˜¯å¸Œæœ›å°†çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œç”¨æˆ·IDæˆ–äº‹åŠ¡IDï¼‰ä¸çº¿ç¨‹å…³è”èµ·æ¥ã€‚

å®ç°æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±ä¸“å±çš„æœ¬åœ°å˜é‡å‰¯æœ¬(è‡ªå·±ç”¨è‡ªå·±çš„å˜é‡ä¸éº»çƒ¦åˆ«äººï¼Œä¸å’Œå…¶ä»–äººå…±äº«ï¼Œäººäººæœ‰ä»½ï¼Œäººå„ä¸€ä»½)ï¼Œä¸»è¦è§£å†³äº†è®©æ¯ä¸ªçº¿ç¨‹ç»‘å®šè‡ªå·±çš„å€¼ï¼Œé€šè¿‡ä½¿ç”¨get()å’Œset()æ–¹æ³•ï¼Œè·å–é»˜è®¤å€¼æˆ–å°†å…¶å€¼æ›´æ”¹ä¸ºå½“å‰çº¿ç¨‹æ‰€å­˜çš„å‰¯æœ¬çš„å€¼ä»è€Œé¿å…äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚



#### 1. API

| å˜é‡å’Œç±»å‹                  | æ–¹æ³•                                        | æè¿°                                       |
| --------------------------- | ------------------------------------------- | ------------------------------------------ |
| T                           | get()                                       | è¿”å›å½“å‰çº¿ç¨‹çš„æ­¤çº¿ç¨‹å±€éƒ¨å˜é‡å‰¯æœ¬ä¸­çš„å€¼     |
| protected T                 | initialvalue()                              | è¿”å›æ­¤çº¿ç¨‹å±€éƒ¨å˜é‡çš„å½“å‰çº¿ç¨‹çš„åˆå§‹å€¼       |
| void                        | remove()                                    | åˆ é™¤æ­¤çº¿ç¨‹å±€éƒ¨å˜é‡çš„å½“å‰çº¿ç¨‹å€¼             |
| void                        | set(T value)                                | å°†æ­¤çº¿ç¨‹å±€éƒ¨å˜é‡çš„å½“å‰çº¿ç¨‹å‰¯æœ¬è®¾ç½®ä¸ºæŒ‡å®šå€¼ |
| static \<S> ThreadLocal\<S> | withInitial(Supplier<? extends S> supplier) | åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å±€éƒ¨å˜é‡                       |



#### 2. åº”ç”¨æ¡ˆä¾‹

```java
/èµ„æºç±»
class House {
    int saleCount = 0;

    public synchronized void saleHouse() {
        ++saleCount;
    }

    /*ThreadLocal<Integer> saleVolume = new ThreadLocal<Integer>(){
        @Override
        protected Integer initialValue()
        {
            return 0;
        }
    };*/
    ThreadLocal<Integer> saleVolume = ThreadLocal.withInitial(() -> 0);

    public void saleVolumeByThreadLocal() {
        saleVolume.set(1 + saleVolume.get());
    }
}

/**
 * @auther zzyy
 * @create 2021-12-31 15:46
 * <p>
 * éœ€æ±‚1ï¼š 5ä¸ªé”€å”®å–æˆ¿å­ï¼Œé›†å›¢é«˜å±‚åªå…³å¿ƒé”€å”®æ€»é‡çš„å‡†ç¡®ç»Ÿè®¡æ•°ã€‚
 * <p>
 * éœ€æ±‚2ï¼š 5ä¸ªé”€å”®å–å®Œéšæœºæ•°æˆ¿å­ï¼Œå„è‡ªç‹¬ç«‹é”€å”®é¢åº¦ï¼Œè‡ªå·±ä¸šç»©æŒ‰ææˆèµ°ï¼Œåˆ†ç¶åƒé¥­ï¼Œå„ä¸ªé”€å”®è‡ªå·±åŠ¨æ‰‹ï¼Œä¸°è¡£è¶³é£Ÿ
 */
public class ThreadLocalDemo {
    public static void main(String[] args) throws InterruptedException {

        House house = new House();

        for (int i = 1; i <= 5; i++) {
            new Thread(() -> {
                int size = new Random().nextInt(5) + 1;
                try {
                    for (int j = 1; j <= size; j++) {
                        house.saleHouse();
                        house.saleVolumeByThreadLocal();
                    }
                    System.out.println(Thread.currentThread().getName() + "\t" + "å·é”€å”®å–å‡ºï¼š" + house.saleVolume.get());
                } finally {
                    house.saleVolume.remove();
                }
            }, String.valueOf(i)).start();
        }

        //æš‚åœæ¯«ç§’
        try {
            TimeUnit.MILLISECONDS.sleep(300);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

        System.out.println(Thread.currentThread().getName() + "\t" + "å…±è®¡å–å‡ºå¤šå°‘å¥—ï¼š " + house.saleCount);
    }
}
```

> **ã€å¼ºåˆ¶ã€‘**å¿…é¡»å›æ”¶è‡ªå®šä¹‰çš„ThreadLocalå˜é‡ï¼Œå°¤å…¶åœ¨çº¿ç¨‹æ± åœºæ™¯ä¸‹ï¼Œçº¿ç¨‹ç»å¸¸ä¼šè¢«å¤ç”¨ï¼Œå¦‚æœä¸æ¸…ç†è‡ªå®šä¹‰çš„ThreadLocalå˜é‡ï¼Œå¯èƒ½ä¼šå½±å“åç»­ä¸šåŠ¡é€»è¾‘å’Œé€ æˆå†…å­˜æ³„éœ²ç­‰é—®é¢˜ã€‚å°½é‡åœ¨ä»£ç†ä¸­ä½¿ç”¨try-finallyå—è¿›è¡Œå›æ”¶ã€‚



### 2. æºç åˆ†æ

**Threadï¼ŒThreadLocalï¼ŒThreadLocalMap å…³ç³»**

![](https://gitlab.com/eardh/picture/-/raw/main/common_img/202207161553674.png)

threadLocalMapå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªä»¥threadLocalå®ä¾‹ä¸ºkeyï¼Œä»»æ„å¯¹è±¡ä¸ºvalueçš„Entryå¯¹è±¡ã€‚ å½“æˆ‘ä»¬ä¸ºthreadLocalå˜é‡èµ‹å€¼ï¼Œå®é™…ä¸Šå°±æ˜¯ä»¥å½“å‰threadLocalå®ä¾‹ä¸ºkeyï¼Œå€¼ä¸ºvalueçš„Entryå¾€è¿™ä¸ªthreadLocalMapä¸­å­˜æ”¾ã€‚

è¿‘ä¼¼çš„å¯ä»¥ç†è§£ä¸ºï¼š

ThreadLocalMapä»å­—é¢ä¸Šå°±å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ªä¿å­˜ThreadLocalå¯¹è±¡çš„map(å…¶å®æ˜¯ä»¥ThreadLocalä¸ºKey)ï¼Œä¸è¿‡æ˜¯ç»è¿‡äº†ä¸¤å±‚åŒ…è£…çš„ThreadLocalå¯¹è±¡ï¼š

![](https://gitlab.com/eardh/picture/-/raw/main/common_img/202207161553675.png)

JVMå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªçº¿ç¨‹ç‰ˆçš„`Map<Thread,T>`(é€šè¿‡ThreadLocalå¯¹è±¡çš„setæ–¹æ³•ï¼Œç»“æœæŠŠThreadLocalå¯¹è±¡è‡ªå·±å½“åškeyï¼Œæ”¾è¿›äº†ThreadLoalMapä¸­)ï¼Œæ¯ä¸ªçº¿ç¨‹è¦ç”¨åˆ°è¿™ä¸ªTçš„æ—¶å€™ï¼Œç”¨å½“å‰çš„çº¿ç¨‹å»Mapé‡Œé¢è·å–ï¼Œé€šè¿‡è¿™æ ·è®©æ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰äº†è‡ªå·±ç‹¬ç«‹çš„å˜é‡ï¼Œäººæ‰‹ä¸€ä»½ï¼Œç«äº‰æ¡ä»¶è¢«å½»åº•æ¶ˆé™¤ï¼Œåœ¨å¹¶å‘æ¨¡å¼ä¸‹æ˜¯ç»å¯¹å®‰å…¨çš„å˜é‡ã€‚

![](https://gitlab.com/eardh/picture/-/raw/main/common_img/202207161553676.png)

ThreadLocalæ˜¯ä¸€ä¸ªå£³å­ï¼ŒçœŸæ­£çš„å­˜å‚¨ç»“æ„æ˜¯TheadLocalé‡Œæœ‰ThreadLocalMapè¿™ä¹ˆä¸ªå†…éƒ¨ç±»ï¼Œæ¯ä¸ªThreadå¯¹è±¡ç»´æŠ¤ç€ä¸€ä¸ªThreadLoclMapçš„å¼•ç”¨ï¼ŒThreadLocalMapæ˜¯ThreadLocalçš„å†…éƒ¨ç±»ï¼Œç”¨Entryæ¥è¿›è¡Œå­˜å‚¨ã€‚

1. è°ƒç”¨ThreadLocaliçš„set()æ–¹æ³•æ—¶ï¼Œå®é™…ä¸Šå°±æ˜¯å¾€ThreadLocalMapè®¾ç½®å€¼ï¼Œkeyæ˜¯ThreadLocalå¯¹è±¡ï¼Œå€¼Valueæ˜¯ä¼ é€’è¿›æ¥çš„å¯¹è±¡

2. è°ƒç”¨ThreadLocalçš„get()æ–¹æ³•æ—¶ï¼Œå®é™…ä¸Šå°±æ˜¯å¾€ThreadLocalMapè·å–å€¼ï¼Œkeyæ˜¯ThreadLocalå¯¹è±¡

ThreadLocalæœ¬èº«å¹¶ä¸å­˜å‚¨å€¼(ThreadLocalæ˜¯ä¸€ä¸ªå£³å­)ï¼Œå®ƒåªæ˜¯è‡ªå·±ä½œä¸ºä¸€ä¸ªkeyæ¥è®©çº¿ç¨‹ä»ThreadLocalMapè·å–valueã€‚æ­£å› ä¸ºè¿™ä¸ªåŸç†ï¼Œæ‰€ä»¥ThreadLocalèƒ½å¤Ÿå®ç°â€œæ•°æ®éš”ç¦»â€ï¼Œè·å–å½“å‰çº¿ç¨‹çš„å±€éƒ¨å˜é‡å€¼ï¼Œä¸å—å…¶ä»–çº¿ç¨‹å½±å“ã€‚





### 3.  å¼•ç”¨ç±»å‹

![](https://gitlab.com/eardh/picture/-/raw/main/common_img/202207161553677.png)

java æŠ€æœ¯å…è®¸ä½¿ç”¨ finalize() æ–¹æ³•åœ¨åƒåœ¾æ”¶é›†å™¨å°†å¯¹è±¡ä»å†…å­˜ä¸­æ¸…é™¤å‡ºå»ä¹‹å‰åšå¿…è¦çš„æ¸…ç†å·¥ä½œã€‚

```java
class MyObject {
    //è¿™ä¸ªæ–¹æ³•ä¸€èˆ¬ä¸ç”¨å¤å†™ï¼Œæˆ‘ä»¬åªæ˜¯ä¸ºäº†æ•™å­¦ç»™å¤§å®¶æ¼”ç¤ºæ¡ˆä¾‹åšè¯´æ˜
    @Override
    protected void finalize() throws Throwable {
        // finalizeçš„é€šå¸¸ç›®çš„æ˜¯åœ¨å¯¹è±¡è¢«ä¸å¯æ’¤é”€åœ°ä¸¢å¼ƒä¹‹å‰æ‰§è¡Œæ¸…ç†æ“ä½œã€‚
        System.out.println("-------invoke finalize method~!!!");
    }
}
```





#### 1. å¼ºå¼•ç”¨

å½“å†…å­˜ä¸è¶³ï¼ŒJVMå¼€å§‹åƒåœ¾å›æ”¶ï¼Œå¯¹äºå¼ºå¼•ç”¨çš„å¯¹è±¡ï¼Œå°±ç®—æ˜¯å‡ºç°äº†OOMä¹Ÿä¸ä¼šå¯¹è¯¥å¯¹è±¡è¿›è¡Œå›æ”¶ï¼Œæ­»éƒ½ä¸æ”¶ã€‚

å¼ºå¼•ç”¨æ˜¯æˆ‘ä»¬æœ€å¸¸è§çš„æ™®é€šå¯¹è±¡å¼•ç”¨ï¼Œåªè¦è¿˜æœ‰å¼ºå¼•ç”¨æŒ‡å‘ä¸€ä¸ªå¯¹è±¡ï¼Œå°±èƒ½è¡¨æ˜å¯¹è±¡è¿˜â€œæ´»ç€â€ï¼Œåƒåœ¾æ”¶é›†å™¨ä¸ä¼šç¢°è¿™ç§å¯¹è±¡ã€‚åœ¨ Java ä¸­æœ€å¸¸è§çš„å°±æ˜¯å¼ºå¼•ç”¨ï¼ŒæŠŠä¸€ä¸ªå¯¹è±¡èµ‹ç»™ä¸€ä¸ªå¼•ç”¨å˜é‡ï¼Œè¿™ä¸ªå¼•ç”¨å˜é‡å°±æ˜¯ä¸€ä¸ªå¼ºå¼•ç”¨ã€‚å½“ä¸€ä¸ªå¯¹è±¡è¢«å¼ºå¼•ç”¨å˜é‡å¼•ç”¨æ—¶ï¼Œå®ƒå¤„äºå¯è¾¾çŠ¶æ€ï¼Œå®ƒæ˜¯ä¸å¯èƒ½è¢«åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶çš„ï¼Œå³ä½¿è¯¥å¯¹è±¡ä»¥åæ°¸è¿œéƒ½ä¸ä¼šè¢«ç”¨åˆ°JVMä¹Ÿä¸ä¼šå›æ”¶ã€‚å› æ­¤å¼ºå¼•ç”¨æ˜¯é€ æˆJavaå†…å­˜æ³„æ¼çš„ä¸»è¦åŸå› ä¹‹ä¸€ã€‚

å¯¹äºä¸€ä¸ªæ™®é€šçš„å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–çš„å¼•ç”¨å…³ç³»ï¼Œåªè¦è¶…è¿‡äº†å¼•ç”¨çš„ä½œç”¨åŸŸæˆ–è€…æ˜¾å¼åœ°å°†ç›¸åº”ï¼ˆå¼ºï¼‰å¼•ç”¨èµ‹å€¼ä¸º nullï¼Œä¸€èˆ¬è®¤ä¸ºå°±æ˜¯å¯ä»¥è¢«åƒåœ¾æ”¶é›†çš„äº†(å½“ç„¶å…·ä½“å›æ”¶æ—¶æœºè¿˜æ˜¯è¦çœ‹åƒåœ¾æ”¶é›†ç­–ç•¥)ã€‚

```java
public static void strongReference() {
    MyObject myObject = new MyObject();
    System.out.println("-----gc before: "+myObject);

    myObject = null;
    System.gc();
    try { TimeUnit.SECONDS.sleep(1); } catch (InterruptedException e) { e.printStackTrace(); }

    System.out.println("-----gc after: "+myObject);
}
```



#### 2. è½¯å¼•ç”¨

è½¯å¼•ç”¨æ˜¯ä¸€ç§ç›¸å¯¹å¼ºå¼•ç”¨å¼±åŒ–äº†ä¸€äº›çš„å¼•ç”¨ï¼Œéœ€è¦ç”¨java.lang.ref.SoftReferenceç±»æ¥å®ç°ï¼Œå¯ä»¥è®©å¯¹è±¡è±å…ä¸€äº›åƒåœ¾æ”¶é›†ã€‚

å¯¹äºåªæœ‰è½¯å¼•ç”¨çš„å¯¹è±¡æ¥è¯´ï¼Œ

å½“ç³»ç»Ÿå†…å­˜å……è¶³æ—¶å®ƒ ä¸ä¼š è¢«å›æ”¶ï¼Œ

å½“ç³»ç»Ÿå†…å­˜ä¸è¶³æ—¶å®ƒ ä¼š è¢«å›æ”¶ã€‚

è½¯å¼•ç”¨é€šå¸¸ç”¨åœ¨å¯¹å†…å­˜æ•æ„Ÿçš„ç¨‹åºä¸­ï¼Œæ¯”å¦‚é«˜é€Ÿç¼“å­˜å°±æœ‰ç”¨åˆ°è½¯å¼•ç”¨ï¼Œå†…å­˜å¤Ÿç”¨çš„æ—¶å€™å°±ä¿ç•™ï¼Œä¸å¤Ÿç”¨å°±å›æ”¶ï¼

```java
private static void softReference() {
    SoftReference<MyObject> softReference = new SoftReference<>(new MyObject());
    //System.out.println("-----softReference:"+softReference.get());

    System.gc();
    try {
        TimeUnit.SECONDS.sleep(1);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
    System.out.println("-----gc afterå†…å­˜å¤Ÿç”¨: " + softReference.get());

    try {
        byte[] bytes = new byte[20 * 1024 * 1024];//20MBå¯¹è±¡
    } catch (Exception e) {
        e.printStackTrace();
    } finally {
        System.out.println("-----gc afterå†…å­˜ä¸å¤Ÿ: " + softReference.get());
    }
}
```



#### 3. å¼±å¼•ç”¨

å¼±å¼•ç”¨éœ€è¦ç”¨java.lang.ref.WeakReferenceç±»æ¥å®ç°ï¼Œå®ƒæ¯”è½¯å¼•ç”¨çš„ç”Ÿå­˜æœŸæ›´çŸ­ï¼Œå¯¹äºåªæœ‰å¼±å¼•ç”¨çš„å¯¹è±¡æ¥è¯´ï¼Œåªè¦åƒåœ¾å›æ”¶æœºåˆ¶ä¸€è¿è¡Œï¼Œä¸ç®¡JVMçš„å†…å­˜ç©ºé—´æ˜¯å¦è¶³å¤Ÿï¼Œéƒ½ä¼šå›æ”¶è¯¥å¯¹è±¡å ç”¨çš„å†…å­˜ã€‚

```java
private static void weakReference() {
    WeakReference<MyObject> weakReference = new WeakReference<>(new MyObject());
    System.out.println("-----gc before å†…å­˜å¤Ÿç”¨ï¼š " + weakReference.get());

    System.gc();
    //æš‚åœå‡ ç§’é’Ÿçº¿ç¨‹
    try {
        TimeUnit.SECONDS.sleep(1);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }

    System.out.println("-----gc after å†…å­˜å¤Ÿç”¨ï¼š " + weakReference.get());
}
```

**è½¯å¼•ç”¨å’Œå¼±å¼•ç”¨çš„é€‚ç”¨åœºæ™¯**

å‡å¦‚æœ‰ä¸€ä¸ªåº”ç”¨éœ€è¦è¯»å–å¤§é‡çš„æœ¬åœ°å›¾ç‰‡:

å¦‚æœæ¯æ¬¡è¯»å–å›¾ç‰‡éƒ½ä»ç¡¬ç›˜è¯»å–åˆ™ä¼šä¸¥é‡å½±å“æ€§èƒ½,

å¦‚æœä¸€æ¬¡æ€§å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­åˆå¯èƒ½é€ æˆå†…å­˜æº¢å‡ºã€‚

æ­¤æ—¶ä½¿ç”¨è½¯å¼•ç”¨å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

è®¾è®¡æ€è·¯æ˜¯ï¼šç”¨ä¸€ä¸ªHashMapæ¥ä¿å­˜å›¾ç‰‡çš„è·¯å¾„å’Œç›¸åº”å›¾ç‰‡å¯¹è±¡å…³è”çš„è½¯å¼•ç”¨ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œåœ¨å†…å­˜ä¸è¶³æ—¶ï¼ŒJVMä¼šè‡ªåŠ¨å›æ”¶è¿™äº›ç¼“å­˜å›¾ç‰‡å¯¹è±¡æ‰€å ç”¨çš„ç©ºé—´ï¼Œä»è€Œæœ‰æ•ˆåœ°é¿å…äº†OOMçš„é—®é¢˜ã€‚

Map<String, SoftReference<Bitmap>> imageCache = new HashMap<String, SoftReference<Bitmap>>();



#### 4. è™šå¼•ç”¨

è™šå¼•ç”¨éœ€è¦java.lang.ref.PhantomReferenceç±»æ¥å®ç°ã€‚

é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å½¢åŒè™šè®¾ï¼Œä¸å…¶ä»–å‡ ç§å¼•ç”¨éƒ½ä¸åŒï¼Œè™šå¼•ç”¨å¹¶ä¸ä¼šå†³å®šå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡ä»…æŒæœ‰è™šå¼•ç”¨ï¼Œé‚£ä¹ˆå®ƒå°±å’Œæ²¡æœ‰ä»»ä½•å¼•ç”¨ä¸€æ ·ï¼Œåœ¨ä»»ä½•æ—¶å€™éƒ½å¯èƒ½è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ï¼Œå®ƒä¸èƒ½å•ç‹¬ä½¿ç”¨ä¹Ÿä¸èƒ½é€šè¿‡å®ƒè®¿é—®å¯¹è±¡ï¼Œè™šå¼•ç”¨å¿…é¡»å’Œå¼•ç”¨é˜Ÿåˆ— (ReferenceQueue)è”åˆä½¿ç”¨ã€‚

è™šå¼•ç”¨çš„ä¸»è¦ä½œç”¨æ˜¯è·Ÿè¸ªå¯¹è±¡è¢«åƒåœ¾å›æ”¶çš„çŠ¶æ€ã€‚ ä»…ä»…æ˜¯æä¾›äº†ä¸€ç§ç¡®ä¿å¯¹è±¡è¢« finalizeä»¥åï¼ŒåšæŸäº›äº‹æƒ…çš„æœºåˆ¶ã€‚ PhantomReferenceçš„getæ–¹æ³•æ€»æ˜¯è¿”å›nullï¼Œå› æ­¤æ— æ³•è®¿é—®å¯¹åº”çš„å¼•ç”¨å¯¹è±¡ã€‚

å…¶æ„ä¹‰åœ¨äºï¼šè¯´æ˜ä¸€ä¸ªå¯¹è±¡å·²ç»è¿›å…¥finalizationé˜¶æ®µï¼Œå¯ä»¥è¢«gcå›æ”¶ï¼Œç”¨æ¥å®ç°æ¯”finalizationæœºåˆ¶æ›´çµæ´»çš„å›æ”¶æ“ä½œã€‚

æ¢å¥è¯è¯´ï¼Œè®¾ç½®è™šå¼•ç”¨å…³è”çš„å”¯ä¸€ç›®çš„ï¼Œå°±æ˜¯åœ¨è¿™ä¸ªå¯¹è±¡è¢«æ”¶é›†å™¨å›æ”¶çš„æ—¶å€™æ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥æˆ–è€…åç»­æ·»åŠ è¿›ä¸€æ­¥çš„å¤„ç†ã€‚

```java
private static void phantomReference() {
    MyObject myObject = new MyObject();
    ReferenceQueue<MyObject> referenceQueue = new ReferenceQueue<>();
    PhantomReference<MyObject> phantomReference = new PhantomReference<>(myObject, referenceQueue);
    System.out.println(phantomReference.get());

    //        myObject = null;


    List<byte[]> list = new ArrayList<>();

    new Thread(() -> {
        while (true) {
            list.add(new byte[1024 * 1024]);
            try {
                TimeUnit.MILLISECONDS.sleep(500);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            System.out.println(phantomReference.get() + "\t" + "list add ok");
        }
    }, "t1").start();

    new Thread(() -> {
        while (true) {
            Reference<? extends MyObject> reference = referenceQueue.poll();
            if (reference != null) {
                System.out.println("-----æœ‰è™šå¯¹è±¡å›æ”¶åŠ å…¥äº†é˜Ÿåˆ—");
                break;
            }
        }
    }, "t2").start();
}
```



#### 5. å°ç»“

![](https://gitlab.com/eardh/picture/-/raw/main/common_img/202207161553678.png)



### 4. å†…å­˜æ³„æ¼

ä¸å†ä¼šè¢«ä½¿ç”¨çš„å¯¹è±¡æˆ–è€…å˜é‡å ç”¨çš„å†…å­˜ä¸èƒ½è¢«å›æ”¶ï¼Œå°±æ˜¯å†…å­˜æ³„éœ²ã€‚

ThreadLocalMapä»å­—é¢ä¸Šå°±å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ªä¿å­˜ThreadLocalå¯¹è±¡çš„map(å…¶å®æ˜¯ä»¥å®ƒä¸ºKey)ï¼Œä¸è¿‡æ˜¯ç»è¿‡äº†ä¸¤å±‚åŒ…è£…çš„ThreadLocalå¯¹è±¡ï¼š

1. ç¬¬ä¸€å±‚åŒ…è£…æ˜¯ä½¿ç”¨ WeakReference<ThreadLocal<?>> å°†ThreadLocalå¯¹è±¡å˜æˆä¸€ä¸ªå¼±å¼•ç”¨çš„å¯¹è±¡
2. ç¬¬äºŒå±‚åŒ…è£…æ˜¯å®šä¹‰äº†ä¸€ä¸ªä¸“é—¨çš„ç±» Entry æ¥æ‰©å±•  WeakReference<ThreadLocal<?>>



### 5. ä¸ºä½•ç”¨å¼±å¼•ç”¨

```java
public void function01(){
    ThreadLocal tl = new ThreadLocal<Integer>();    //line1
    tl.set(2021);                                   //line2
    tl.get();                                       //line3
}
//line1æ–°å»ºäº†ä¸€ä¸ªThreadLocalå¯¹è±¡ï¼Œt1 æ˜¯å¼ºå¼•ç”¨æŒ‡å‘è¿™ä¸ªå¯¹è±¡ï¼›
//line2è°ƒç”¨set()æ–¹æ³•åæ–°å»ºä¸€ä¸ªEntryï¼Œé€šè¿‡æºç å¯çŸ¥Entryå¯¹è±¡é‡Œçš„kæ˜¯å¼±å¼•ç”¨æŒ‡å‘è¿™ä¸ªå¯¹è±¡ã€‚
```

![](https://gitlab.com/eardh/picture/-/raw/main/common_img/202207161553679.png)

1. å½“function01æ–¹æ³•æ‰§è¡Œå®Œæ¯•åï¼Œæ ˆå¸§é”€æ¯å¼ºå¼•ç”¨ tl ä¹Ÿå°±æ²¡æœ‰äº†ã€‚ä½†æ­¤æ—¶çº¿ç¨‹çš„ThreadLocalMapé‡ŒæŸä¸ªentryçš„keyå¼•ç”¨è¿˜æŒ‡å‘è¿™ä¸ªå¯¹è±¡
2. è‹¥è¿™ä¸ªkeyå¼•ç”¨æ˜¯å¼ºå¼•ç”¨ï¼Œå°±ä¼šå¯¼è‡´keyæŒ‡å‘çš„ThreadLocalå¯¹è±¡åŠvæŒ‡å‘çš„å¯¹è±¡ä¸èƒ½è¢«gcå›æ”¶ï¼Œé€ æˆå†…å­˜æ³„æ¼
3. è‹¥è¿™ä¸ªkeyå¼•ç”¨æ˜¯å¼±å¼•ç”¨å°±å¤§æ¦‚ç‡ä¼šå‡å°‘å†…å­˜æ³„æ¼çš„é—®é¢˜(è¿˜æœ‰ä¸€ä¸ªkeyä¸ºnullçš„é›·)ã€‚ä½¿ç”¨å¼±å¼•ç”¨ï¼Œå°±å¯ä»¥ä½¿ThreadLocalå¯¹è±¡åœ¨æ–¹æ³•æ‰§è¡Œå®Œæ¯•åé¡ºåˆ©è¢«å›æ”¶ä¸”Entryçš„keyå¼•ç”¨æŒ‡å‘ä¸ºnullã€‚



#### 1. ä»…ç”¨å®ƒå°±å®‰å…¨ï¼Ÿ

1. å½“æˆ‘ä»¬ä¸ºthreadLocalå˜é‡èµ‹å€¼ï¼Œå®é™…ä¸Šå°±æ˜¯å½“å‰çš„Entry(threadLocalå®ä¾‹ä¸ºkeyï¼Œå€¼ä¸ºvalue)å¾€è¿™ä¸ªthreadLocalMapä¸­å­˜æ”¾ã€‚Entryä¸­çš„keyæ˜¯å¼±å¼•ç”¨ï¼Œå½“threadLocalå¤–éƒ¨å¼ºå¼•ç”¨è¢«ç½®ä¸ºnull(tl=null),é‚£ä¹ˆç³»ç»Ÿ GC çš„æ—¶å€™ï¼Œæ ¹æ®å¯è¾¾æ€§åˆ†æï¼Œè¿™ä¸ªthreadLocalå®ä¾‹å°±æ²¡æœ‰ä»»ä½•ä¸€æ¡é“¾è·¯èƒ½å¤Ÿå¼•ç”¨åˆ°å®ƒï¼Œè¿™ä¸ªThreadLocalåŠ¿å¿…ä¼šè¢«å›æ”¶ï¼Œè¿™æ ·ä¸€æ¥ï¼ŒThreadLocalMapä¸­å°±ä¼šå‡ºç°keyä¸ºnullçš„Entryï¼Œå°±æ²¡æœ‰åŠæ³•è®¿é—®è¿™äº›keyä¸ºnullçš„Entryçš„valueï¼Œå¦‚æœå½“å‰çº¿ç¨‹å†è¿Ÿè¿Ÿä¸ç»“æŸçš„è¯ï¼Œè¿™äº›keyä¸ºnullçš„Entryçš„valueå°±ä¼šä¸€ç›´å­˜åœ¨ä¸€æ¡å¼ºå¼•ç”¨é“¾ï¼šThread Ref -> Thread -> ThreaLocalMap -> Entry -> valueæ°¸è¿œæ— æ³•å›æ”¶ï¼Œé€ æˆå†…å­˜æ³„æ¼ã€‚
2. å½“ç„¶ï¼Œå¦‚æœå½“å‰threadè¿è¡Œç»“æŸï¼ŒthreadLocalï¼ŒthreadLocalMap,Entryæ²¡æœ‰å¼•ç”¨é“¾å¯è¾¾ï¼Œåœ¨åƒåœ¾å›æ”¶çš„æ—¶å€™éƒ½ä¼šè¢«ç³»ç»Ÿè¿›è¡Œå›æ”¶ã€‚
3. ä½†åœ¨å®é™…ä½¿ç”¨ä¸­æˆ‘ä»¬æœ‰æ—¶å€™ä¼šç”¨çº¿ç¨‹æ± å»ç»´æŠ¤æˆ‘ä»¬çš„çº¿ç¨‹ï¼Œæ¯”å¦‚åœ¨Executors.newFixedThreadPool()æ—¶åˆ›å»ºçº¿ç¨‹çš„æ—¶å€™ï¼Œä¸ºäº†å¤ç”¨çº¿ç¨‹æ˜¯ä¸ä¼šç»“æŸçš„ï¼Œæ‰€ä»¥threadLocalå†…å­˜æ³„æ¼å°±å€¼å¾—æˆ‘ä»¬å°å¿ƒ



#### 2. key ä¸ºnullçš„Entry

ThreadLocalMapä½¿ç”¨ThreadLocalçš„å¼±å¼•ç”¨ä½œä¸ºkeyï¼Œå¦‚æœä¸€ä¸ªThreadLocalæ²¡æœ‰å¤–éƒ¨å¼ºå¼•ç”¨å¼•ç”¨ä»–ï¼Œé‚£ä¹ˆç³»ç»Ÿgcçš„æ—¶å€™ï¼Œè¿™ä¸ªThreadLocalåŠ¿å¿…ä¼šè¢«å›æ”¶ï¼Œè¿™æ ·ä¸€æ¥ï¼ŒThreadLocalMapä¸­å°±ä¼šå‡ºç°keyä¸ºnullçš„Entryï¼Œå°±æ²¡æœ‰åŠæ³•è®¿é—®è¿™äº›keyä¸ºnullçš„Entryçš„valueï¼Œå¦‚æœå½“å‰çº¿ç¨‹å†è¿Ÿè¿Ÿä¸ç»“æŸçš„è¯(æ¯”å¦‚æ­£å¥½ç”¨åœ¨çº¿ç¨‹æ± )ï¼Œè¿™äº›keyä¸ºnullçš„Entryçš„valueå°±ä¼šä¸€ç›´å­˜åœ¨ä¸€æ¡å¼ºå¼•ç”¨é“¾ã€‚

è™½ç„¶å¼±å¼•ç”¨ï¼Œä¿è¯äº†keyæŒ‡å‘çš„ThreadLocalå¯¹è±¡èƒ½è¢«åŠæ—¶å›æ”¶ï¼Œä½†æ˜¯væŒ‡å‘çš„valueå¯¹è±¡æ˜¯éœ€è¦ThreadLocalMapè°ƒç”¨getã€setæ—¶å‘ç°keyä¸ºnullæ—¶æ‰ä¼šå»å›æ”¶æ•´ä¸ªentryã€valueï¼Œå› æ­¤å¼±å¼•ç”¨ä¸èƒ½100%ä¿è¯å†…å­˜ä¸æ³„éœ²ã€‚æˆ‘ä»¬è¦åœ¨ä¸ä½¿ç”¨æŸä¸ªThreadLocalå¯¹è±¡åï¼Œæ‰‹åŠ¨è°ƒç”¨remoevæ–¹æ³•æ¥åˆ é™¤å®ƒï¼Œå°¤å…¶æ˜¯åœ¨çº¿ç¨‹æ± ä¸­ï¼Œä¸ä»…ä»…æ˜¯å†…å­˜æ³„éœ²çš„é—®é¢˜ï¼Œå› ä¸ºçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ˜¯é‡å¤ä½¿ç”¨çš„ï¼Œæ„å‘³ç€è¿™ä¸ªçº¿ç¨‹çš„ThreadLocalMapå¯¹è±¡ä¹Ÿæ˜¯é‡å¤ä½¿ç”¨çš„ï¼Œå¦‚æœæˆ‘ä»¬ä¸æ‰‹åŠ¨è°ƒç”¨removeæ–¹æ³•ï¼Œé‚£ä¹ˆåé¢çš„çº¿ç¨‹å°±æœ‰å¯èƒ½è·å–åˆ°ä¸Šä¸ªçº¿ç¨‹é—ç•™ä¸‹æ¥çš„valueå€¼ï¼Œé€ æˆbugã€‚



#### 3. æ¸…é™¤è„ Entry æºç 

ä»ThreadLocalçš„setï¼Œgetï¼Œremoveæ–¹æ³•æºç çœ‹å‡ºï¼Œåœ¨threadLocalçš„ç”Ÿå‘½å‘¨æœŸé‡Œï¼Œé’ˆå¯¹threadLocalå­˜åœ¨çš„å†…å­˜æ³„æ¼çš„é—®é¢˜ï¼Œ éƒ½ä¼šé€šè¿‡expungeStaleEntryï¼ŒcleanSomeSlots,replaceStaleEntryè¿™ä¸‰ä¸ªæ–¹æ³•æ¸…ç†æ‰keyä¸ºnullçš„è„entryã€‚



### 6. æ€»ç»“

- ThreadLocal å¹¶ä¸è§£å†³çº¿ç¨‹é—´å…±äº«æ•°æ®çš„é—®é¢˜
- ThreadLocal é€‚ç”¨äºå˜é‡åœ¨çº¿ç¨‹é—´éš”ç¦»ä¸”åœ¨æ–¹æ³•é—´å…±äº«çš„åœºæ™¯
- ThreadLocal é€šè¿‡éšå¼çš„åœ¨ä¸åŒçº¿ç¨‹å†…åˆ›å»ºç‹¬ç«‹å®ä¾‹å‰¯æœ¬é¿å…äº†å®ä¾‹çº¿ç¨‹å®‰å…¨çš„é—®é¢˜
- æ¯ä¸ªçº¿ç¨‹æŒæœ‰ä¸€ä¸ªåªå±äºè‡ªå·±çš„ä¸“å±Mapå¹¶ç»´æŠ¤äº†ThreadLocalå¯¹è±¡ä¸å…·ä½“å®ä¾‹çš„æ˜ å°„ï¼Œè¯¥Mapç”±äºåªè¢«æŒæœ‰å®ƒçš„çº¿ç¨‹è®¿é—®ï¼Œæ•…ä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨ä»¥åŠé”çš„é—®é¢˜
- ThreadLocalMapçš„Entryå¯¹ThreadLocalçš„å¼•ç”¨ä¸ºå¼±å¼•ç”¨ï¼Œé¿å…äº†ThreadLocalå¯¹è±¡æ— æ³•è¢«å›æ”¶çš„é—®é¢˜
- éƒ½ä¼šé€šè¿‡expungeStaleEntryï¼ŒcleanSomeSlots,replaceStaleEntryè¿™ä¸‰ä¸ªæ–¹æ³•å›æ”¶é”®ä¸º null çš„ Entry å¯¹è±¡çš„å€¼ï¼ˆå³ä¸ºå…·ä½“å®ä¾‹ï¼‰ä»¥åŠ Entry å¯¹è±¡æœ¬èº«ä»è€Œé˜²æ­¢å†…å­˜æ³„æ¼ï¼Œå±äºå®‰å…¨åŠ å›ºçš„æ–¹æ³•
- ç¾¤é›„é€é¹¿èµ·çº·äº‰ï¼Œäººå„ä¸€ä»½å¤©ä¸‹å®‰



## 9. Unsafe

### 1. æ¦‚è¿°

Unsafe å¯¹è±¡æä¾›äº†éå¸¸åº•å±‚çš„ï¼Œæ“ä½œå†…å­˜ã€çº¿ç¨‹çš„æ–¹æ³•ï¼ŒUnsafe å¯¹è±¡ä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œåªèƒ½é€šè¿‡åå°„è·å¾—

```java
public class UnsafeAccessor {
    static Unsafe unsafe;
    
    static {
        try { 
            Field theUnsafe = Unsafe.class.getDeclaredField("theUnsafe");
            theUnsafe.setAccessible(true);
            unsafe = (Unsafe) theUnsafe.get(null);
        } catch (NoSuchFieldException | IllegalAccessException e) {
            throw new Error(e);
        }
    }
    
    static Unsafe getUnsafe() {
        return unsafe;
    }
```





### 2. Unsafe CAS æ“ä½œ

```java
public class TestUnsafe {

    public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException {
        Field theUnsafe = Unsafe.class.getDeclaredField("theUnsafe");
        theUnsafe.setAccessible(true);
        Unsafe unsafe = (Unsafe) theUnsafe.get(null);

        System.out.println(unsafe);

        // 1. è·å–åŸŸçš„åç§»åœ°å€
        long idOffset = unsafe.objectFieldOffset(Teacher.class.getDeclaredField("id"));
        long nameOffset = unsafe.objectFieldOffset(Teacher.class.getDeclaredField("name"));

        Teacher t = new Teacher();
        // 2. æ‰§è¡Œ cas æ“ä½œ
        unsafe.compareAndSwapInt(t, idOffset, 0, 1);
        unsafe.compareAndSwapObject(t, nameOffset, null, "å¼ ä¸‰");

        // 3. éªŒè¯
        System.out.println(t);
    }
}

@Data
class Teacher {
    volatile int id;
    volatile String name;
}
```

```shell
# ç»“æœ
sun.misc.Unsafe@5acf9800
Teacher(id=1, name=å¼ ä¸‰)
```





### 3. è‡ªå®šä¹‰åŸå­ç±»

ä½¿ç”¨è‡ªå®šä¹‰çš„ AtomicData å®ç°ä¹‹å‰çº¿ç¨‹å®‰å…¨çš„åŸå­æ•´æ•° Account å®ç°

```java
class AtomicData implements Account {
    private volatile int value;
    private static final long valueOffset;
    private static final Unsafe UNSAFE;
    static {
        UNSAFE = UnsafeAccessor.getUnsafe();
        try {
            valueOffset = UNSAFE.objectFieldOffset(AtomicData.class.getDeclaredField("value"));
        } catch (NoSuchFieldException e) {
            e.printStackTrace();
            throw new RuntimeException(e);
        }
    }

    public int getValue() {
        return value;
    }

    public void decrement(int amount) {
        while(true) {
            int prev = this.value;
            int next = prev - amount;
            if (UNSAFE.compareAndSwapInt(this, valueOffset, prev, next)) {
                break;
            }
        }
    }

    public AtomicData(int value) {
        this.value = value;
    }

    @Override
    public Integer getBalance() {
        return getValue();
    }

    @Override
    public void withdraw(Integer amount) {
        decrement(amount);
    }
}

interface Account {
    // è·å–ä½™é¢
    Integer getBalance();

    // å–æ¬¾
    void withdraw(Integer amount);

    /**
     * æ–¹æ³•å†…ä¼šå¯åŠ¨ 1000 ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åš -10 å…ƒ çš„æ“ä½œ
     * å¦‚æœåˆå§‹ä½™é¢ä¸º 10000 é‚£ä¹ˆæ­£ç¡®çš„ç»“æœåº”å½“æ˜¯ 0
     */
    static void demo(Account account) {
        List<Thread> ts = new ArrayList<>();
        for (int i = 0; i < 1000; i++) {
            ts.add(new Thread(() -> {
                account.withdraw(10);
            }));
        }
        long start = System.nanoTime();
        ts.forEach(Thread::start);
        ts.forEach(t -> {
            try {
                t.join();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        });
        long end = System.nanoTime();
        System.out.println(account.getBalance()
                + " cost: " + (end-start)/1000_000 + " ms");
    }
}
```

æµ‹è¯•

```java
public static void main(String[] args) {
    Account.demo(new AtomicData(10000));
}
```

```shell
# ç»“æœ
0 cost: 166 ms
```





## 10. å°ç»“

- CAS ä¸ volatile
- API
  - åŸå­æ•´æ•°
  - åŸå­å¼•ç”¨
  - åŸå­æ•°ç»„
  - å­—æ®µæ›´æ–°å™¨
  - åŸå­ç´¯åŠ å™¨

- ThreadLocal
  
- Unsafe
- åŸç†æ–¹é¢
  - LongAdder æºç 
  - ä¼ªå…±äº«


# å†è°ˆç±»çš„åŠ è½½å™¨ ğŸ›´

## 1. æ¦‚è¿°

ç±»åŠ è½½å™¨æ˜¯ JVM æ‰§è¡Œç±»åŠ è½½æœºåˆ¶çš„å‰æã€‚

**ClassLoader çš„ä½œç”¨ï¼š**

ClassLoader æ˜¯ Java çš„æ ¸å¿ƒç»„ä»¶ï¼Œæ‰€æœ‰çš„Classéƒ½æ˜¯ç”± ClassLoader è¿›è¡ŒåŠ è½½çš„ï¼ŒClassLoader è´Ÿè´£é€šè¿‡å„ç§æ–¹å¼å°† Class ä¿¡æ¯çš„äºŒè¿›åˆ¶æ•°æ®æµè¯»å…¥ JVM å†…éƒ¨ï¼Œè½¬æ¢ä¸ºä¸€ä¸ªä¸ç›®æ ‡ç±»å¯¹åº”çš„ java.lang.Class å¯¹è±¡å®ä¾‹ã€‚ç„¶åäº¤ç»™ Java è™šæ‹Ÿæœºè¿›è¡Œé“¾æ¥ã€åˆå§‹åŒ–ç­‰æ“ä½œã€‚å› æ­¤ï¼Œ**ClassLoader åœ¨æ•´ä¸ªè£…è½½é˜¶æ®µï¼Œåªèƒ½å½±å“åˆ°ç±»çš„åŠ è½½**ï¼Œè€Œæ— æ³•é€šè¿‡ClassLoader å»æ”¹å˜ç±»çš„é“¾æ¥å’Œåˆå§‹åŒ–è¡Œä¸ºã€‚è‡³äºå®ƒæ˜¯å¦å¯ä»¥è¿è¡Œï¼Œåˆ™ç”± Execution Engine å†³å®šã€‚

![](https://gitlab.com/eardh/picture/-/raw/main/jvm_img/202111021740830.png)



ç±»åŠ è½½å™¨æœ€æ—©å‡ºç°åœ¨ Java1.0 ç‰ˆæœ¬ä¸­ï¼Œé‚£ä¸ªæ—¶å€™åªæ˜¯å•çº¯åœ°ä¸ºäº†æ»¡è¶³ Java Applet åº”ç”¨è€Œè¢«ç ”å‘å‡ºæ¥ã€‚ä½†å¦‚ä»Šç±»åŠ è½½å™¨å´åœ¨0SGiã€å­—èŠ‚ç åŠ è§£å¯†é¢†åŸŸå¤§æ”¾å¼‚å½©ã€‚è¿™ä¸»è¦å½’åŠŸäº Java è™šæ‹Ÿæœºçš„è®¾è®¡è€…ä»¬å½“åˆåœ¨è®¾è®¡ç±»åŠ è½½å™¨çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰è€ƒè™‘å°†å®ƒç»‘å®šåœ¨ JVM å†…éƒ¨ï¼Œè¿™æ ·åšçš„å¥½å¤„å°±æ˜¯èƒ½å¤Ÿæ›´åŠ çµæ´»å’ŒåŠ¨æ€åœ°æ‰§è¡Œç±»åŠ è½½æ“ä½œã€‚




###  1. å¤§å‚é¢è¯•é¢˜

**èš‚èšé‡‘æœï¼š**

æ·±å…¥åˆ†æ classLoaderï¼ŒåŒäº²å§”æ´¾æœºåˆ¶

ç±»åŠ è½½å™¨çš„åŒäº²å§”æ´¾æ¨¡å‹æ˜¯ä»€ä¹ˆ?

ä¸€é¢ï¼šåŒäº²å§”æ´¾æœºåˆ¶åŠä½¿ç”¨åŸå› 



**ç™¾åº¦ï¼š**

éƒ½æœ‰å“ªäº›ç±»åŠ è½½å™¨,è¿™äº›ç±»åŠ è½½å™¨éƒ½åŠ è½½å“ªäº›æ–‡ä»¶?

æ‰‹å†™ä¸€ä¸ªç±»åŠ è½½å™¨Demo

class çš„ forName(" java.lang.String") å’Œ Class çš„ getClassLoader() çš„ loadClass("java.lang.String") æœ‰ä»€ä¹ˆåŒºåˆ«?



**è…¾è®¯ï¼š**

ä»€ä¹ˆæ˜¯åŒäº²å§”æ´¾æ¨¡å‹?

ç±»åŠ è½½å™¨æœ‰å“ªäº›?



**å°ç±³ï¼š**

åŒäº²å§”æ´¾æ¨¡å‹ä»‹ç»



**æ»´æ»´ï¼š**

ç®€å•è¯´è¯´ä½ äº†è§£çš„ç±»åŠ è½½å™¨

ä¸€é¢ï¼šè®²ä¸€ä¸‹åŒäº²å§”æ´¾æ¥¼å‹ï¼Œä»¥åŠå…¶ä¼˜ç‚¹



**å­—èŠ‚è·³åŠ¨ï¼š**

ä»€ä¹ˆæ˜¯ç±»åŠ è§„å™¨ï¼Œç±»åŠ è½½å™¨æœ‰å“ªäº›?



**äº¬ä¸œï¼š**

ç±»åŠ è½½å™¨çš„æˆäº²å§”æ´¾æ¥¼å‹æ˜¯ä»€ä¹ˆ?

åŒäº²å§”æ´¾æœºåˆ¶å¯ä»¥æ‰“è¢«å—?ä¸ºä»€ä¹ˆ



### 2. ç±»åŠ è½½çš„åˆ†ç±»

**ç±»çš„åŠ è½½åˆ†ç±»ï¼šæ˜¾å¼åŠ è½½ vs éšå¼åŠ è½½**

classæ–‡ä»¶çš„ æ˜¾å¼åŠ è½½ ä¸ éšå¼åŠ è½½ çš„æ–¹å¼æ˜¯æŒ‡ JVM åŠ è½½ class æ–‡ä»¶åˆ°å†…å­˜çš„æ–¹å¼ã€‚

- ==æ˜¾å¼åŠ è½½== æŒ‡çš„æ˜¯åœ¨ä»£ç ä¸­é€šè¿‡è°ƒç”¨ ClassLoader åŠ è½½ class å¯¹è±¡ï¼Œå¦‚ç›´æ¥ä½¿ç”¨ `Class.forName()` æˆ–`this.getClass().getClassLoader().loadClass()` åŠ è½½classå¯¹è±¡ã€‚
- ==éšå¼åŠ è½½== åˆ™æ˜¯ä¸ç›´æ¥åœ¨ä»£ç ä¸­è°ƒç”¨ ClassLoader çš„æ–¹æ³•åŠ è½½ class å¯¹è±¡ï¼Œè€Œæ˜¯é€šè¿‡è™šæ‹Ÿæœºè‡ªåŠ¨åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¦‚åœ¨åŠ è½½æŸä¸ªç±»çš„ class æ–‡ä»¶æ—¶ï¼Œè¯¥ç±»çš„classæ–‡ä»¶ä¸­å¼•ç”¨äº†å¦å¤–ä¸€ä¸ªç±»çš„å¯¹è±¡ï¼Œæ­¤æ—¶é¢å¤–å¼•ç”¨çš„ç±»å°†é€šè¿‡ JVMè‡ªåŠ¨åŠ è½½åˆ°å†…å­˜ä¸­ã€‚



åœ¨æ—¥å¸¸å¼€å‘ä¸­ä»¥ä¸Šä¸¤ç§æ–¹å¼ä¸€èˆ¬ä¼šæ··åˆä½¿ç”¨ã€‚

```java
public class UserTest {
    public static void main(String[] args) {
        User user = new User(); // éšå¼åŠ è½½
        try {
            Class clazz = Class.forName("com.atguigu.java.User"); // æ˜¾å¼åŠ è½½
            ClassLoader.getSystemClassLoader().loadClass("com.atguigu.java.User"); // æ˜¾å¼åŠ è½½
        } catch (ClassNotFoundException e) {
            e.printStackTrace();
        }
    }
}
```



### 3. ç±»åŠ è½½çš„å¿…è¦æ€§

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ Java å¼€å‘äººå‘˜å¹¶ä¸éœ€è¦åœ¨ç¨‹åºä¸­æ˜¾å¼åœ°ä½¿ç”¨ç±»åŠ è½½å™¨ï¼Œä½†æ˜¯äº†è§£ç±»åŠ è½½å™¨çš„åŠ è½½æœºåˆ¶å´æ˜¾å¾—è‡³å…³é‡è¦ã€‚ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è¯´ï¼š

- é¿å…åœ¨å¼€å‘ä¸­é‡åˆ° `java.lang.ClassNotFoundException` å¼‚å¸¸æˆ– `java.lang.NoClassDefFoundError` å¼‚å¸¸æ—¶ï¼Œæ‰‹è¶³æ— æªã€‚åªæœ‰äº†è§£ç±»åŠ è½½å™¨çš„åŠ è½½æœºåˆ¶æ‰èƒ½å¤Ÿåœ¨å‡ºç°å¼‚å¸¸çš„æ—¶å€™å¿«é€Ÿåœ°æ ¹æ®é”™è¯¯å¼‚å¸¸æ—¥å¿—å®šä½é—®é¢˜å’Œè§£å†³é—®é¢˜ã€‚
- éœ€è¦æ”¯æŒç±»çš„åŠ¨æ€åŠ è½½æˆ–éœ€è¦å¯¹ç¼–è¯‘åçš„å­—èŠ‚ç æ–‡ä»¶è¿›è¡ŒåŠ è§£å¯†æ“ä½œæ—¶ï¼Œå°±éœ€è¦ä¸ç±»åŠ è½½å™¨æ‰“äº¤é“äº†ã€‚
- å¼€å‘äººå‘˜å¯ä»¥åœ¨ç¨‹åºä¸­ç¼–å†™è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ¥é‡æ–°å®šä¹‰ç±»çš„åŠ è½½è§„åˆ™ï¼Œä»¥ä¾¿å®ç°ä¸€äº›è‡ªå®šä¹‰çš„å¤„ç†é€»è¾‘ã€‚



### 4. å‘½åç©ºé—´ ğŸ

**1. ä½•ä¸ºç±»çš„å”¯ä¸€æ€§ï¼Ÿ**

å¯¹äºä»»æ„ä¸€ä¸ªç±»ï¼Œ**éƒ½éœ€è¦ç”±åŠ è½½å®ƒçš„ç±»åŠ è½½å™¨å’Œè¿™ä¸ªç±»æœ¬èº«ä¸€åŒç¡®è®¤å…¶åœ¨Javaè™šæ‹Ÿæœºä¸­çš„å”¯ä¸€æ€§**ã€‚æ¯ä¸€ä¸ªç±»åŠ è½½å™¨ï¼Œéƒ½æ‹¥æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç±»åç§°ç©ºé—´ï¼š**æ¯”è¾ƒä¸¤ä¸ªç±»æ˜¯å¦ç›¸ç­‰ï¼Œåªæœ‰åœ¨è¿™ä¸¤ä¸ªç±»æ˜¯ç”±åŒä¸€ä¸ªç±»åŠ è½½å™¨åŠ è½½çš„å‰æä¸‹æ‰æœ‰æ„ä¹‰**ã€‚å¦åˆ™ï¼Œå³ä½¿è¿™ä¸¤ä¸ªç±»æºè‡ªåŒä¸€ä¸ª Class æ–‡ä»¶ï¼Œè¢«åŒä¸€ä¸ªè™šæ‹ŸæœºåŠ è½½ï¼Œåªè¦åŠ è½½ä»–ä»¬çš„ç±»åŠ è½½å™¨ä¸åŒï¼Œé‚£è¿™ä¸¤ä¸ªç±»å°±å¿…å®šä¸ç›¸ç­‰ã€‚



**2. å‘½åç©ºé—´**

- æ¯ä¸ªç±»åŠ è½½å™¨éƒ½æœ‰è‡ªå·±çš„å‘½åç©ºé—´ï¼Œå‘½åç©ºé—´ç”±è¯¥åŠ è½½å™¨åŠæ‰€æœ‰çš„çˆ¶åŠ è½½å™¨æ‰€åŠ è½½çš„ç±»ç»„æˆ
- åœ¨åŒä¸€å‘½åç©ºé—´ä¸­ï¼Œä¸ä¼šå‡ºç°ç±»çš„å®Œæ•´åå­—ï¼ˆåŒ…æ‹¬ç±»çš„åŒ…åï¼‰ç›¸åŒçš„ä¸¤ä¸ªç±»
- åœ¨ä¸åŒçš„å‘½åç©ºé—´ä¸­ï¼Œæœ‰å¯èƒ½ä¼šå‡ºç°ç±»çš„å®Œæ•´åå­—ï¼ˆåŒ…æ‹¬ç±»çš„åŒ…åï¼‰ç›¸åŒçš„ä¸¤ä¸ªç±»

åœ¨å¤§å‹åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¾€å¾€å€ŸåŠ©è¿™ä¸€ç‰¹æ€§ï¼Œæ¥è¿è¡ŒåŒä¸€ä¸ªç±»çš„ä¸åŒç‰ˆæœ¬ã€‚(è­¬å¦‚ web æœåŠ¡å™¨ Tomcatï¼Œå¯ä»¥åœ¨Tomcatä¸­å®šä¹‰å¤šä¸ªä¸åŒç‰ˆæœ¬çš„ç±»åŠ è½½å™¨ï¼Œç„¶ååŒä¸€ä¸ª Web æœåŠ¡å™¨è¿è¡Œä¸åŒçš„åº”ç”¨ç¨‹åºï¼Œå®ç°åº”ç”¨çš„éš”ç¦»)

```java
public class UserClassLoader extends ClassLoader {
    private String rootDir;

    public UserClassLoader(String rootDir) {
        this.rootDir = rootDir;
    }

    /**
     * ç¼–å†™findClassæ–¹æ³•çš„é€»è¾‘
     */
    @Override
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        // è·å–ç±»çš„classæ–‡ä»¶å­—èŠ‚æ•°ç»„
        byte[] classData = getClassData(name);
        if (classData == null) {
            throw new ClassNotFoundException();
        } else {
            // ç›´æ¥ç”Ÿæˆclasså¯¹è±¡
            return defineClass(name, classData, 0, classData.length);
        }
    }

    /**
     * ç¼–å†™è·å–classæ–‡ä»¶å¹¶è½¬æ¢ä¸ºå­—èŠ‚ç æµçš„é€»è¾‘
     */
    private byte[] getClassData(String className) {
        // è¯»å–ç±»æ–‡ä»¶çš„å­—èŠ‚
        String path = classNameToPath(className);
        try {
            InputStream ins = new FileInputStream(path);
            ByteArrayOutputStream baos = new ByteArrayOutputStream();
            byte[] buffer = new byte[1024];
            int len = 0;
            // è¯»å–ç±»æ–‡ä»¶çš„å­—èŠ‚ç 
            while ((len = ins.read(buffer)) != -1) {
                baos.write(buffer, 0, len);
            }
            return baos.toByteArray();
        } catch (IOException e) {
            e.printStackTrace();
        }
        return null;
    }

    /**
     * ç±»æ–‡ä»¶çš„å®Œå…¨è·¯å¾„
     */
    private String classNameToPath(String className) {
        return rootDir + "\\" + className.replace('.', '\\') + ".class";
    }

    public static void main(String[] args) {
        String rootDir = "C:\\Users\\Administrator\\IDEAworkSpace\\test\\study\\src\\";

        try {
            // åˆ›å»ºè‡ªå®šä¹‰çš„ç±»çš„ åŠ è½½å™¨1
            UserClassLoader loader1 = new UserClassLoader(rootDir);
            Class clazz1 = loader1.findClass("jvm.User");

            // åˆ›å»ºè‡ªå®šä¹‰çš„ç±»çš„ åŠ è½½å™¨2
            UserClassLoader loader2 = new UserClassLoader(rootDir);
            Class clazz2 = loader2.findClass("jvm.User");

            System.out.println(clazz1 == clazz2); // clazz1 ä¸ clazz2 å¯¹åº”äº†ä¸åŒçš„ç±»æ¨¡æ¿ç»“æ„ã€‚
            System.out.println(clazz1.getClassLoader());
            System.out.println(clazz2.getClassLoader());

            // ç³»ç»Ÿç±»åŠ è½½å™¨
            Class clazz3 = ClassLoader.getSystemClassLoader().loadClass("jvm.User");
            System.out.println(clazz3.getClassLoader());

            System.out.println(clazz1.getClassLoader().getParent());
        } catch (ClassNotFoundException e) {
            e.printStackTrace();
        }
    }
}
```

```bash
// è¿è¡Œç»“æœ ğŸ‘‡
false
jvm.UserClassLoader@2d6e8792
jvm.UserClassLoader@90f6bfd
jdk.internal.loader.ClassLoaders$AppClassLoader@2437c6dc
jdk.internal.loader.ClassLoaders$AppClassLoader@2437c6dc
```



### 5. ç±»åŠ è½½æœºåˆ¶çš„åŸºæœ¬ç‰¹å¾

é€šå¸¸ç±»åŠ è½½æœºåˆ¶æœ‰ä¸‰ä¸ªåŸºæœ¬ç‰¹å¾ï¼š

- åŒäº²å§”æ´¾æ¨¡å‹ã€‚ä½†ä¸æ˜¯æ‰€æœ‰ç±»åŠ è½½éƒ½éµå®ˆè¿™ä¸ªæ¨¡å‹ï¼Œæœ‰çš„æ—¶å€™ï¼Œå¯åŠ¨ç±»åŠ è½½å™¨æ‰€åŠ è½½çš„ç±»å‹ï¼Œæ˜¯å¯èƒ½è¦åŠ è½½ç”¨æˆ·ä»£ç çš„ï¼Œæ¯”å¦‚ JDK å†…éƒ¨çš„ ServiceProvider/ServiceLoader æœºåˆ¶ï¼Œç”¨æˆ·å¯ä»¥åœ¨æ ‡å‡†APIæ¡†æ¶ä¸Šï¼Œæä¾›è‡ªå·±çš„å®ç°ï¼ŒJDK ä¹Ÿéœ€è¦æä¾›äº›é»˜è®¤çš„å‚è€ƒå®ç°ã€‚ä¾‹å¦‚ï¼ŒJava ä¸­ INDIã€JDBCã€æ–‡ä»¶ç³»ç»Ÿã€Cipher ç­‰å¾ˆå¤šæ–¹é¢ï¼Œéƒ½æ˜¯åˆ©ç”¨çš„è¿™ç§æœºåˆ¶ï¼Œè¿™ç§æƒ…å†µå°±ä¸ä¼šç”¨åŒäº²å§”æ´¾æ¨¡å‹å»åŠ è½½ï¼Œè€Œæ˜¯åˆ©ç”¨æ‰€è°“çš„ä¸Šä¸‹æ–‡åŠ è½½å™¨ã€‚

- å¯è§æ€§ï¼Œå­ç±»åŠ è½½å™¨å¯ä»¥è®¿é—®çˆ¶åŠ è½½å™¨åŠ è½½çš„ç±»å‹ï¼Œä½†æ˜¯åè¿‡æ¥æ˜¯ä¸å…è®¸çš„ã€‚ä¸ç„¶ï¼Œå› ä¸ºç¼ºå°‘å¿…è¦çš„éš”ç¦»ï¼Œæˆ‘ä»¬å°±æ²¡æœ‰åŠæ³•åˆ©ç”¨ç±»åŠ è½½å™¨å»å®ç°å®¹å™¨çš„é€»è¾‘ã€‚
- å•ä¸€æ€§ï¼Œç”±äºçˆ¶åŠ è½½å™¨çš„ç±»å‹å¯¹äºå­åŠ è½½å™¨æ˜¯å¯è§çš„ï¼Œæ‰€ä»¥çˆ¶åŠ è½½å™¨ä¸­åŠ è½½è¿‡çš„ç±»å‹ï¼Œå°±ä¸ä¼šåœ¨å­åŠ è½½å™¨ä¸­é‡å¤åŠ è½½ã€‚ä½†æ˜¯æ³¨æ„ï¼Œç±»åŠ è½½å™¨ â€œé‚»å±…â€ é—´ï¼ŒåŒä¸€ç±»å‹ä»ç„¶å¯ä»¥è¢«åŠ è½½å¤šæ¬¡ï¼Œå› ä¸ºäº’ç›¸å¹¶ä¸å¯è§ã€‚



## 2. ç±»çš„åŠ è½½å™¨åˆ†ç±»

JVM æ”¯æŒä¸¤ç§ç±»å‹çš„ç±»åŠ è½½å™¨ï¼Œåˆ†åˆ«ä¸ºå¼•å¯¼ç±»åŠ è½½å™¨(Bootstrap ClassLoader)  å’Œ è‡ªå®šä¹‰ç±»åŠ è½½å™¨(User-Defined ClassLoader)ã€‚

ä»æ¦‚å¿µä¸Šæ¥è®²ï¼Œè‡ªå®šä¹‰ç±»åŠ è½½å™¨ä¸€èˆ¬æŒ‡çš„æ˜¯ç¨‹åºä¸­ç”±å¼€å‘äººå‘˜è‡ªå®šä¹‰çš„ä¸€ç±»ç±»åŠ è½½å™¨ï¼Œä½†æ˜¯ Java è™šæ‹Ÿæœºè§„èŒƒå´æ²¡æœ‰è¿™ä¹ˆå®šä¹‰ï¼Œè€Œæ˜¯å°†æ‰€æœ‰æ´¾ç”ŸäºæŠ½è±¡ç±» ClassLoader çš„ç±»åŠ è½½å™¨éƒ½åˆ’åˆ†ä¸ºè‡ªå®šä¹‰ç±»åŠ è½½å™¨ã€‚æ— è®ºç±»åŠ è½½å™¨çš„ç±»å‹å¦‚ä½•åˆ’åˆ†ï¼Œåœ¨ç¨‹åºä¸­æˆ‘ä»¬æœ€å¸¸è§çš„ç±»åŠ è½½å™¨ç»“æ„ä¸»è¦æ˜¯å¦‚ä¸‹æƒ…å†µï¼š

![](https://gitlab.com/eardh/picture/-/raw/main/jvm_img/202111021741466.png)

- é™¤äº†é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨å¤–ï¼Œå…¶ä½™çš„ç±»åŠ è½½å™¨éƒ½åº”å½“æœ‰è‡ªå·±çš„ â€œçˆ¶ç±»â€ åŠ è½½å™¨ã€‚
- ä¸åŒç±»åŠ è½½å™¨çœ‹ä¼¼æ˜¯ç»§æ‰¿ï¼ˆInheritanceï¼‰å…³ç³»ï¼Œå®é™…ä¸Š**æ˜¯åŒ…å«å…³ç³»**ã€‚åœ¨ä¸‹å±‚åŠ è½½å™¨ä¸­ï¼ŒåŒ…å«ç€ä¸Šå±‚åŠ è½½å™¨çš„å¼•ç”¨ï¼Œ å…³ç³»ä»£ç å¦‚ä¸‹

```java
class ClassLoader {
    ClassLoader parent; // çˆ¶ç±»åŠ è½½å™¨
    
    Public ClassLoader(ClassLoader parent) {
        this.parent = parent;
    }
}

class ParentClassLoader extends ClassLoader{
    Public ParentClassLoader(ClassLoader parent) {
        super(parent);
    }
}

class ChildClassLoader extends ClassLoader{
    Public ChildClassLoader(ClassLoader parent) {
        super(parent);
    }
}
```



### 1. å¼•å¯¼ç±»åŠ è½½å™¨(Bootstrap ClassLoader)

**å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆå¼•å¯¼ç±»åŠ è½½å™¨ï¼ŒBootstrap ClassLoader ã€ JDK11 å« BootClassLoader ã€‘ï¼‰**

- è¿™ä¸ªç±»åŠ è½½**ä½¿ç”¨C/C++è¯­è¨€å®ç°**çš„ï¼ŒåµŒå¥—åœ¨ JVM å†…éƒ¨ã€‚
- å®ƒç”¨æ¥åŠ è½½Javaçš„æ ¸å¿ƒåº“ï¼ˆ JAVA_HOME/jre/lib/rt.jar æˆ– sun.boot.class.path è·¯å¾„ä¸‹çš„å†…å®¹ ã€ jdk11 åœ¨ JAVA_HOME/jre/lib/src.zip é‡Œé¢ ã€‘ï¼‰ã€‚ç”¨äºæä¾› JVM è‡ªèº«éœ€è¦çš„ç±»ã€‚
- å¹¶ä¸ç»§æ‰¿è‡ª java.lang.ClassLoaderï¼Œæ²¡æœ‰çˆ¶åŠ è½½å™¨ã€‚
- å‡ºäºå®‰å…¨è€ƒè™‘ï¼ŒBootstrap å¯åŠ¨ç±»åŠ è½½å™¨åªåŠ è½½åŒ…åä¸º javaã€javaxã€sun ç­‰å¼€å¤´çš„ç±»
- åŠ è½½ æ‰©å±•ç±» å’Œ åº”ç”¨ç¨‹åºç±» åŠ è½½å™¨ï¼Œå¹¶æŒ‡å®šä¸ºä»–ä»¬çš„ çˆ¶ç±»åŠ è½½å™¨ã€‚

ä½¿ç”¨ ==-XX:+TraceClassLoading== å‚æ•°å¾—åˆ°ç±»åŠ è½½è®°å½•

![](https://gitlab.com/eardh/picture/-/raw/main/jvm_img/202111021741711.png)

![](https://gitlab.com/eardh/picture/-/raw/main/jvm_img/202111021741286.png)

å¯åŠ¨ç±»åŠ è½½å™¨ä½¿ç”¨ C/C++ç¼–å†™çš„ï¼ŸYesï¼

- C/C++ï¼šæŒ‡é’ˆå‡½æ•° & å‡½æ•°æŒ‡é’ˆã€C++ æ”¯æŒå¤šç»§æ‰¿ã€æ›´åŠ é«˜æ•ˆ
- Javaï¼šç”± C++ æ¼”å˜è€Œæ¥ï¼ŒC++ çš„ -- ç‰ˆï¼Œå•ç»§æ‰¿



### 2. æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension ClassLoaderï¼‰

- Javaè¯­è¨€ç¼–å†™ï¼Œç”± sun.misc.Launcher$ExtClassLoader å®ç°  ã€ JDK11 ä¸º PlatformClassLoader ã€‘ã€‚

- ç»§æ‰¿äº ClassLoader ç±»

- çˆ¶ç±»åŠ è½½å™¨ä¸ºå¯åŠ¨ç±»åŠ è½½å™¨

- ä» java.ext.dirs ç³»ç»Ÿå±æ€§æ‰€æŒ‡å®šçš„ç›®å½•ä¸­åŠ è½½ç±»åº“ï¼Œæˆ–ä»JDKçš„å®‰è£…ç›®å½•çš„ jre/lib/ext å­ç›®å½•ä¸‹åŠ è½½ç±»åº“ã€‚å¦‚æœç”¨æˆ·åˆ›å»ºçš„ JAR æ”¾åœ¨æ­¤ç›®å½•ä¸‹ï¼Œä¹Ÿä¼šè‡ªåŠ¨ç”±æ‰©å±•ç±»åŠ è½½å™¨åŠ è½½

 **JDK 8**

![](https://gitlab.com/eardh/picture/-/raw/main/jvm_img/202111021742490.png)



**JDK 11**

![](https://gitlab.com/eardh/picture/-/raw/main/jvm_img/202111021742622.png)



### 3. ç³»ç»Ÿç±»åŠ è½½å™¨(AppClassLoader)

åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼ˆç³»ç»Ÿç±»åŠ è½½å™¨ï¼ŒAppClassLoaderï¼‰

- java è¯­è¨€ç¼–å†™ï¼Œç”± sun.misc.Launcher$AppClassLoader ã€ JDK11 ä¸åŒ ã€‘å®ç°
- ç»§æ‰¿äº ClassLoader ç±»
- çˆ¶ç±»åŠ è½½å™¨ä¸ºæ‰©å±•ç±»åŠ è½½å™¨
- å®ƒè´Ÿè´£åŠ è½½ç¯å¢ƒå˜é‡ classpath æˆ–ç³»ç»Ÿå±æ€§ java.class.path æŒ‡å®šè·¯å¾„ä¸‹çš„ç±»åº“
- åº”ç”¨ç¨‹åºä¸­çš„ç±»åŠ è½½å™¨é»˜è®¤æ˜¯ç³»ç»Ÿç±»åŠ è½½å™¨ã€‚
- å®ƒæ˜¯ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„é»˜è®¤çˆ¶åŠ è½½å™¨
- é€šè¿‡ ClassLoader çš„ getSystemClassLoader() æ–¹æ³•å¯ä»¥è·å–åˆ°è¯¥ç±»åŠ è½½å™¨



### 4. ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨

- åœ¨ ]ava çš„æ—¥å¸¸åº”ç”¨ç¨‹åºå¼€å‘ä¸­ï¼Œç±»çš„åŠ è½½å‡ ä¹æ˜¯ç”±ä¸Šè¿°3ç§ç±»åŠ è½½å™¨ç›¸äº’é…åˆæ‰§è¡Œçš„ã€‚åœ¨å¿…è¦æ—¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œæ¥å®šåˆ¶ç±»çš„åŠ è½½æ–¹å¼ã€‚
- ä½“ç°Javaè¯­è¨€å¼ºå¤§ç”Ÿå‘½åŠ›å’Œå·¨å¤§é­…åŠ›çš„å…³é”®å› ç´ ä¹‹ä¸€ä¾¿æ˜¯ï¼ŒJava å¼€å‘è€…å¯ä»¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ¥å®ç°ç±»åº“çš„åŠ¨æ€åŠ è½½ï¼ŒåŠ è½½æºå¯ä»¥æ˜¯æœ¬åœ°çš„ JAR åŒ…,ä¹Ÿå¯ä»¥æ˜¯ç½‘ç»œä¸Šçš„è¿œç¨‹èµ„æºã€‚

- **é€šè¿‡ç±»åŠ è½½å™¨å¯ä»¥å®ç°éå¸¸ç»å¦™çš„æ’ä»¶æœºåˆ¶**ï¼Œè¿™æ–¹é¢çš„å®é™…åº”ç”¨æ¡ˆä¾‹ä¸¾ä¸èƒœä¸¾ã€‚ä¾‹å¦‚ï¼Œè‘—åçš„SGIç»„ä»¶æ¡†æ¶ï¼Œå†å¦‚ Eclipse çš„æ’ä»¶æœºåˆ¶ã€‚ç±»åŠ è½½å™¨ä¸ºåº”ç”¨ç¨‹åºæä¾›äº†ä¸€ç§åŠ¨æ€å¢åŠ æ–°åŠŸèƒ½çš„æœºåˆ¶ï¼Œè¿™ç§æœºåˆ¶æ— é¡»é‡æ–°æ‰“åŒ…å‘å¸ƒåº”ç”¨ç¨‹åºå°±èƒ½å®ç°ã€‚

- åŒæ—¶ï¼Œ**è‡ªå®šä¹‰åŠ è½½å™¨èƒ½å¤Ÿå®ç°åº”ç”¨éš”ç¦»**ï¼Œä¾‹å¦‚ Tomcat, Spring ç­‰ä¸­é—´ä»¶å’Œç»„ä»¶æ¡†æ¶éƒ½åœ¨å†…éƒ¨å®ç°äº†è‡ªå®šä¹‰çš„åŠ è½½å™¨ï¼Œå¹¶é€šè¿‡è‡ªå®šä¹‰åŠ è½½å™¨éš”ç¦»ä¸åŒçš„ç»„ä»¶æ¨¡å—ã€‚è¿™ç§æœºåˆ¶æ¯” C/C++ ç¨‹åºè¦å¥½å¤ªå¤šï¼Œæƒ³ä¸ä¿®æ”¹ C/C++ ç¨‹åºå°±èƒ½ä¸ºå…¶æ–°å¢åŠŸèƒ½ï¼Œå‡ ä¹æ˜¯ä¸å¯èƒ½çš„ï¼Œä»…ä»…ä¸€ä¸ªå…¼å®¹æ€§ä¾¿èƒ½é˜»æŒ¡ä½æ‰€æœ‰ç¾å¥½çš„è®¾æƒ³ã€‚

- è‡ªå®šä¹‰ç±»åŠ è½½å™¨é€šå¸¸éœ€è¦ç»§æ‰¿äº classLoaderã€‚



## 3. æµ‹è¯•ä¸åŒçš„ç±»åŠ è½½å™¨

æ¯ä¸ª Class å¯¹è±¡éƒ½ä¼šåŒ…å«ä¸€ä¸ªå®šä¹‰å®ƒçš„ ClassLoader çš„ä¸€ä¸ªå¼•ç”¨ã€‚

è·å– classLoader çš„é€”å¾„

| é€”å¾„                                                         |
| ------------------------------------------------------------ |
| è·å¾—å½“å‰ç±»çš„ ClassLoader -> clazz.getClassLoader()           |
| è·å¾—å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡çš„ ClassLoader -> Thread.currentThread().getContextClassLoader() |
| è·å¾—ç³»ç»Ÿçš„ ClassLoader -> ClassLoader.getSystemClassLoader() |

**è¯´æ˜ï¼š**

ç«™åœ¨ç¨‹åºçš„è§’åº¦çœ‹ï¼Œå¼•å¯¼ç±»åŠ è½½å™¨ä¸å¦å¤–ä¸¤ç§ç±»åŠ è½½å™¨ï¼ˆç³»ç»Ÿç±»åŠ è½½å™¨å’Œæ‰©å±•ç±»åŠ è½½å™¨ï¼‰å¹¶ä¸æ˜¯åŒä¸€ä¸ªå±‚æ¬¡æ„ä¹‰ä¸Šçš„åŠ è½½å™¨ï¼Œå¼•å¯¼ç±»åŠ è½½å™¨æ˜¯ä½¿ç”¨ C++ è¯­è¨€ç¼–å†™è€Œæˆçš„ï¼Œè€Œå¦å¤–ä¸¤ç§ç±»åŠ è½½å™¨åˆ™æ˜¯ä½¿ç”¨ Java è¯­è¨€ç¼–å†™è€Œæˆçš„ã€‚ç”±äºå¼•å¯¼ç±»åŠ è½½å™¨å‹æ ¹å„¿å°±ä¸æ˜¯ä¸€ä¸ª Java ç±»ï¼Œå› æ­¤åœ¨ Java ç¨‹åºä¸­åªèƒ½æ‰“å°å‡ºç©ºå€¼ã€‚

æ•°ç»„ç±»çš„ Class å¯¹è±¡ï¼Œä¸æ˜¯ç”±ç±»åŠ è½½å™¨å»åˆ›å»ºçš„ï¼Œè€Œæ˜¯åœ¨ Java è¿è¡ŒæœŸ JVM æ ¹æ®éœ€è¦è‡ªåŠ¨åˆ›å»ºçš„ã€‚å¯¹äºæ•°ç»„ç±»çš„ç±»åŠ è½½å™¨æ¥è¯´ï¼Œæ˜¯é€šè¿‡ Class.getClassLoader() è¿”å›çš„ï¼Œä¸æ•°ç»„å½“ä¸­å…ƒç´ ç±»å‹çš„ç±»åŠ è½½å™¨æ˜¯ä¸€æ ·çš„ï¼›å¦‚æœæ•°ç»„å½“ä¸­çš„å…ƒç´ ç±»å‹æ˜¯åŸºæœ¬æ•°æ®ç±»å‹ï¼Œæ•°ç»„ç±»æ˜¯æ²¡æœ‰ç±»åŠ è½½å™¨çš„ã€‚

**ä¾‹ï¼š**

```java
/**
 * åŸºæœ¬æ•°æ®ç±»å‹ç”±è™šæ‹Ÿæœºé¢„å…ˆå®šä¹‰ã€‚å¼•ç”¨æ•°æ®ç±»å‹åˆ™éœ€è¦è¿›è¡Œç±»çš„åŠ è½½
 */
public class ClassLoaderTest1 {
    public static void main(String[] args) {
        // è·å–ç³»ç»Ÿè¯¥ç±»åŠ è½½å™¨
        ClassLoader systemClassLoader = ClassLoader.getSystemClassLoader();
        System.out.println(systemClassLoader); // sun.misc.Launcher$AppClassLoader@18b4aac2
        // è·å–æ‰©å±•ç±»åŠ è½½å™¨
        ClassLoader extClassLoader = systemClassLoader.getParent();
        System.out.println(extClassLoader); // sun.misc.Launcher$ExtClassLoader@1540e19d
        // è¯•å›¾è·å–å¼•å¯¼ç±»åŠ è½½å™¨ï¼šå¤±è´¥
        ClassLoader bootstrapClassLoader = extClassLoader.getParent();
        System.out.println(bootstrapClassLoader); // null

        try {
            ClassLoader classLoader = Class.forName("java.lang.String").getClassLoader();
            System.out.println(classLoader);
            // è‡ªå®šä¹‰çš„ç±»é»˜è®¤ä½¿ç”¨ç³»ç»Ÿç±»åŠ è½½å™¨
            ClassLoader classLoader1 = Class.forName("jvm.ClassLoaderTest1").getClassLoader();
            System.out.println(classLoader1);

            // å…³äºæ•°ç»„ç±»å‹çš„åŠ è½½:ä½¿ç”¨çš„ç±»çš„åŠ è½½å™¨ä¸æ•°ç»„å…ƒç´ çš„ç±»çš„åŠ è½½å™¨ç›¸åŒ
            String[] arrStr = new String[10];
            System.out.println(arrStr.getClass().getClassLoader()); // null:è¡¨ç¤ºä½¿ç”¨çš„æ˜¯å¼•å¯¼ç±»åŠ è½½å™¨

            ClassLoaderTest1[] arr1 = new ClassLoaderTest1[10];
            System.out.println(arr1.getClass().getClassLoader()); // sun.misc.Launcher$AppClassLoader@18b4aac2

            int[] arr2 = new int[10];
            System.out.println(arr2.getClass().getClassLoader()); // null:ä¸éœ€è¦ç±»çš„åŠ è½½å™¨
        } catch (ClassNotFoundException e) {
            e.printStackTrace();
        }
    }
}
```



## 4. ClassLoaderæºç è§£æ

**ClassLoader ä¸ç°æœ‰ç±»åŠ è½½å™¨çš„å…³ç³»**

![](https://gitlab.com/eardh/picture/-/raw/main/jvm_img/202111021742527.png)

é™¤äº†ä»¥ä¸Šè™šæ‹Ÿæœºè‡ªå¸¦çš„åŠ è½½å™¨å¤–ï¼Œç”¨æˆ·è¿˜å¯ä»¥å®šåˆ¶è‡ªå·±çš„ç±»åŠ è½½å™¨ã€‚Java æä¾›äº†æŠ½è±¡ç±» java.lang.ClassLoaderï¼Œæ‰€æœ‰ç”¨æˆ·è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨éƒ½åº”è¯¥ç»§æ‰¿ ClassLoader ç±»ã€‚



### 1. ClassLoaderçš„ä¸»è¦æ–¹æ³•

**æŠ½è±¡ç±» classLoaderçš„ä¸»è¦æ–¹æ³•ï¼š(å†…éƒ¨æ²¡æœ‰æŠ½è±¡æ–¹æ³•)**

- **public final classLoader getParent()**  

  è¿”å›è¯¥ç±»åŠ è½½å™¨çš„è¶…ç±»åŠ è½½å™¨



- **public Class<?> loadclass(String name) throws ClassNotFoundException**    

  åŠ è½½åç§°ä¸ºnameçš„ç±»,è¿”å›ç»“æœä¸º java.lang.Class ç±»çš„å®ä¾‹ã€‚å¦‚æœæ‰¾ä¸åˆ°ç±»,åˆ™è¿”å› classNotFoundException å¼‚å¸¸ã€‚è¯¥æ–¹æ³•ä¸­çš„é€»è¾‘å°±æ˜¯åŒäº²å§”æ´¾æ¨¡å¼çš„å®ç°ã€‚

```java
/**
 * ClassLoader.loadClass(String name, boolean resolve) æºç è§£æ
 */
protected Class<?> loadClass(String name, boolean resolve)
    throws ClassNotFoundException
{
    synchronized (getClassLoadingLock(name)) {
        // First, check if the class has already been loaded
        Class<?> c = findLoadedClass(name);
        if (c == null) {
            long t0 = System.nanoTime();
            try {
                // åˆ¤æ–­å½“å‰ç±»çš„åŠ è½½å™¨æ˜¯å¦ä¸ºnull
                if (parent != null) {
                    // å¦‚æœå­˜åœ¨çˆ¶ç±»åŠ è½½å™¨ï¼Œåˆ™è°ƒç”¨çˆ¶ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½
                    c = parent.loadClass(name, false);
                } else {
                    // çˆ¶ç±»åŠ è½½å™¨æ˜¯å¼•å¯¼ç±»åŠ è½½å™¨
                    c = findBootstrapClassOrNull(name);
                }
            } catch (ClassNotFoundException e) {
                // ClassNotFoundException thrown if class not found
                // from the non-null parent class loader
            }

            // å½“å‰ç±»çš„åŠ è½½å™¨çš„çˆ¶ç±»åŠ è½½å™¨æœªåŠ è½½æ­¤ç±» or å½“å‰ç±»çš„åŠ è½½å™¨æœªåŠ è½½æ­¤ç±»
            if (c == null) {
                // If still not found, then invoke findClass in order
                // to find the class.
                long t1 = System.nanoTime();
                // è°ƒç”¨å½“å‰classLoaderçš„findClassæ–¹æ³•
                c = findClass(name);

                // this is the defining class loader; record the stats
                sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);
                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);
                sun.misc.PerfCounter.getFindClasses().increment();
            }
        }
        // æ˜¯å¦è¿›è¡Œè¿‡è§£ææ“ä½œ
        if (resolve) {
            resolveClass(c);
        }
        return c;
    }
}
```



- **protected Class<?> findclassï¼ˆString nameï¼‰ throws ClassNotFoundException**

  æŸ¥æ‰¾äºŒè¿›åˆ¶åç§°ä¸º name çš„ç±»ï¼Œè¿”å›ç»“æœä¸º java.lang.Class ç±»çš„å®ä¾‹ã€‚è¿™æ˜¯ä¸€ä¸ªå—ä¿æŠ¤çš„æ–¹æ³•ï¼ŒJVMé¼“åŠ±æˆ‘ä»¬é‡å†™æ­¤æ–¹æ³•ï¼Œéœ€è¦è‡ªå®šä¹‰åŠ è½½å™¨éµå¾ªåŒäº²å§”æ‰˜æœºåˆ¶ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨æ£€æŸ¥å®Œçˆ¶ç±»åŠ è½½å™¨ä¹‹åè¢« loadClass() æ–¹æ³•è°ƒç”¨ã€‚
  
  > åœ¨JDK1.2ä¹‹å‰ï¼Œåœ¨è‡ªå®šä¹‰ç±»åŠ è½½æ—¶ï¼Œæ€»ä¼šå»ç»§æ‰¿ ClassLoader ç±»å¹¶é‡å†™ loadClass æ–¹æ³•ï¼Œä»è€Œå®ç°è‡ªå®šä¹‰çš„ç±»åŠ è½½ç±»ã€‚ä½†æ˜¯åœ¨IDK1.2ä¹‹åå·²ä¸å†å»ºè®®ç”¨æˆ·å»è¦†ç›– loadClass() æ–¹æ³•ï¼Œè€Œæ˜¯å»ºè®®æŠŠè‡ªå®šä¹‰çš„ç±»åŠ è½½é€»è¾‘å†™åœ¨ findClass() æ–¹æ³•ä¸­ï¼Œä»å‰é¢çš„åˆ†æå¯çŸ¥ï¼Œ findClass() æ–¹æ³•æ˜¯åœ¨ loadClass() æ–¹æ³•ä¸­è¢«è°ƒç”¨çš„ï¼Œå½“ loadClass() æ–¹æ³•ä¸­çˆ¶åŠ è½½å™¨åŠ è½½å°–è´¥åï¼Œåˆ™ä¼šè°ƒç”¨è‡ªå·±çš„ findClass() æ–¹æ³•æ¥å®Œæˆç±»åŠ è½½ï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ä¹Ÿç¬¦åˆåŒäº²å§”æ‰˜æ¨¡å¼ã€‚ 
  >
  > éœ€è¦æ³¨æ„çš„æ˜¯ ClassLoader ç±»ä¸­å¹¶æ²¡æœ‰å®ç° findClass() æ–¹æ³•çš„å…·ä½“ä»£ç é€»è¾‘ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯æŠ›å‡º ClassNotFoundException å¼‚å¸¸ï¼ŒåŒæ—¶åº”è¯¥çŸ¥é“çš„æ˜¯ findClass æ–¹æ³•é€šå¸¸æ˜¯å’Œ defineClass æ–¹æ³•ä¸€èµ·ä½¿ç”¨çš„ã€‚**ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåœ¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶ï¼Œä¼šç›´æ¥è¦†ç›– ClassLoader çš„ findClass() æ–¹æ³•å¹¶ç¼–å†™åŠ è½½è§„åˆ™ï¼Œå–å¾—è¦åŠ è½½ç±»çš„å­—èŠ‚ç åè½¬æ¢æˆæµï¼Œç„¶åè°ƒç”¨ defineClass() æ–¹æ³•ç”Ÿæˆç±»çš„ Class å¯¹è±¡ã€‚**

```java
/**
 * ClassLoader.findClass(String name) æºç 
 */
protected Class<?> findClass(String name) throws ClassNotFoundException {
    throw new ClassNotFoundException(name);
}
```



- **protected final Class<?> defineClassï¼ˆString nameï¼Œ byte[] bï¼Œ int offï¼Œ int lenï¼‰**

  æ ¹æ®ç»™å®šçš„å­—èŠ‚æ•°ç»„ b è½¬æ¢ä¸º Class çš„å®ä¾‹ï¼Œoff å’Œ len å‚æ•°è¡¨ç¤ºå®é™… Class ä¿¡æ¯åœ¨ byte æ•°ç»„ä¸­çš„ä½ç½®å’Œé•¿åº¦ï¼Œå…¶ä¸­ byte æ•°ç»„ b æ˜¯ ClassLoader ä»å¤–éƒ¨è·å–çš„ã€‚è¿™æ˜¯å—ä¿æŠ¤çš„æ–¹æ³•ï¼Œåªæœ‰åœ¨è‡ªå®šä¹‰ ClassLoader å­ç±»ä¸­å¯ä»¥ä½¿ç”¨ã€‚

  > defineClass() æ–¹æ³•æ˜¯ç”¨æ¥å°† byte å­—èŠ‚æµè§£ææˆJVMèƒ½å¤Ÿè¯†åˆ«çš„ Class å¯¹è±¡ï¼ˆClassLoader ä¸­å·±å®ç°è¯¥æ–¹æ³•é€»è¾‘ï¼‰ï¼Œé€šè¿‡è¿™ä¸ªæ–¹æ³•ä¸ä»…èƒ½å¤Ÿé€šè¿‡ class æ–‡ä»¶å®ä¾‹åŒ– class å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å…¶ä»–æ–¹å¼å®ä¾‹åŒ–classå¯¹è±¡ï¼Œå¦‚é€šè¿‡ç½‘ç»œæ¥æ”¶ä¸€ä¸ªç±»çš„å­—èŠ‚ç ï¼Œç„¶åè½¬æ¢ä¸º byte å­—èŠ‚æµåˆ›å»ºå¯¹åº”çš„ Class å¯¹è±¡ã€‚        
  >
  > **defineClass() æ–¹æ³•é€šå¸¸ä¸ findClas() æ–¹æ³•ä¸€èµ·ä½¿ç”¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåœ¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶ï¼Œä¼šç›´æ¥è¦†ç›– ClassLoader çš„ findClass() æ–¹æ³•å¹¶ç¼–å†™åŠ è½½è§„åˆ™ï¼Œå–å¾—è¦åŠ è½½ç±»çš„å­—èŠ‚ç åè½¬æ¢æˆæµï¼Œç„¶åè°ƒç”¨defineClass() æ–¹æ³•ç”Ÿæˆç±»çš„ Class å¯¹è±¡**

```java
protected Class<?> findclass(String name) throws ClassNotFoundException{         
    // è·å–ç±»çš„å­—èŠ‚æ•°ç»„         
    byte[] classData = getclassData(name);         
    if (classData == null) {             
        throw new ClassNotFoundException()ï¼›         
    } else {             
        // ä½¿ç”¨defineClassç”Ÿæˆclasså¯¹è±¡             
        return defineclass(name,classData,0,classData.length);         
    }
    // ...
}
```



- **protected final void resolveclass(Class<?> c)**

  é“¾æ¥æŒ‡å®šçš„ä¸€ä¸ª Java ç±»ã€‚ä½¿ç”¨è¯¥æ–¹æ³•å¯ä»¥ä½¿ç”¨ç±»çš„ Class å¯¹è±¡åˆ›å»ºå®Œæˆçš„åŒæ—¶ä¹Ÿè¢«è§£æã€‚å‰é¢æˆ‘ä»¬è¯´é“¾æ¥é˜¶æ®µä¸»è¦æ˜¯å¯¹å­—èŠ‚ç è¿›è¡ŒéªŒè¯ï¼Œä¸ºç±»å˜é‡åˆ†é…å†…å­˜å¹¶è®¾ç½®åˆå§‹å€¼åŒæ—¶å°†å­—èŠ‚ç æ–‡ä»¶ä¸­çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ã€‚




- **protected final Class<?> findLoadedClass(String name)**

  æŸ¥æ‰¾åç§°ä¸º name çš„å·²ç»è¢«åŠ è½½è¿‡çš„ç±»ï¼Œè¿”å›ç»“æœä¸º java.lang.Class ç±»çš„å®ä¾‹ã€‚è¿™ä¸ªæ–¹æ³•æ˜¯ final æ–¹æ³•ï¼Œæ— æ³•è¢«ä¿®æ”¹ã€‚




- **private final ClassLoader parent;**

  å®ƒä¹Ÿæ˜¯ä¸€ä¸ª ClassLoader çš„å®ä¾‹ï¼Œè¿™ä¸ªå­—æ®µæ‰€è¡¨ç¤ºçš„ ClassLoader ä¹Ÿç§°ä¸ºè¿™ä¸ª ClassLoader çš„åŒäº²ã€‚åœ¨ç±»åŠ è½½çš„è¿‡ç¨‹ä¸­ï¼ŒClassLoader å¯èƒ½ä¼šå°†æŸäº›è¯·æ±‚äº¤äºˆè‡ªå·±çš„åŒäº²å¤„ç†ã€‚



### 2. SecureClassLoaderä¸URLClassLoader

æ¥ç€ SecureClassLoader æ‰©å±•äº† ClassLoaderï¼Œæ–°å¢äº†å‡ ä¸ªä¸ä½¿ç”¨ç›¸å…³çš„ä»£ç æºï¼ˆå¯¹ä»£ç æºçš„ä½ç½®åŠå…¶è¯ä¹¦çš„éªŒè¯ï¼‰å’Œæƒé™å®šä¹‰ç±»éªŒè¯ï¼ˆä¸»è¦æŒ‡å¯¹classæºç çš„è®¿é—®æƒé™ï¼‰çš„æ–¹æ³•ï¼Œä¸€èˆ¬æˆ‘ä»¬ä¸ä¼šç›´æ¥è·Ÿè¿™ä¸ªç±»æ‰“äº¤é“ï¼Œæ›´å¤šæ˜¯ä¸å®ƒçš„å­ç±» URLClassLoader æœ‰æ‰€å…³è”ã€‚

å‰é¢è¯´è¿‡ï¼ŒClassLoader æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå¾ˆå¤šæ–¹æ³•æ˜¯ç©ºçš„æ²¡æœ‰å®ç°ï¼Œæ¯”å¦‚ findClass()ã€findResource() ç­‰ã€‚è€ŒURLClassLoader è¿™ä¸ªå®ç°ç±»ä¸ºè¿™äº›æ–¹æ³•æä¾›äº†å…·ä½“çš„å®ç°ã€‚å¹¶æ–°å¢äº†URLClassPathç±»ååŠ©å–å¾— Class å­—èŠ‚ç æµç­‰åŠŸèƒ½ã€‚**åœ¨ç¼–å†™è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶ï¼Œå¦‚æœæ²¡æœ‰å¤ªè¿‡äºå¤æ‚çš„éœ€æ±‚ï¼Œå¯ä»¥ç›´æ¥ç»§æ‰¿ URLClassLoader ç±»ï¼Œ**è¿™æ ·å°±å¯ä»¥é¿å…è‡ªå·±å»ç¼–å†™ findClass() æ–¹æ³•åŠå…¶è·å–å­—èŠ‚ç æµçš„æ–¹å¼ï¼Œä½¿è‡ªå®šä¹‰ç±»åŠ è½½å™¨ç¼–å†™æ›´åŠ ç®€æ´ã€‚




### 3. ExtClassLoaderä¸AppClassLoader

äº†è§£å®Œ URLClassLoader åæ¥ç€çœ‹çœ‹å‰©ä½™çš„ä¸¤ä¸ªç±»åŠ è½½å™¨ï¼Œå³æ‹“å±•ç±»åŠ è½½å™¨ ExtClassLoader å’Œç³»ç»Ÿç±»åŠ è½½å™¨AppClassLoaderï¼Œè¿™ä¸¤ä¸ªç±»éƒ½ç»§æ‰¿è‡ª URLClassLoaderï¼Œæ˜¯ sun.misc.Launcher çš„é™æ€å†…éƒ¨ç±»ã€‚ sun.misc.Launcher ä¸»è¦è¢«ç³»ç»Ÿç”¨äºå¯åŠ¨ä¸»åº”ç”¨ç¨‹åºï¼ŒExtClassLoader å’Œ AppClassLoader éƒ½æ˜¯ç”±sun.misc.Launcher åˆ›å»ºçš„ï¼Œå…¶ä¸»è¦ç±»ç»“æ„å¦‚ä¸‹ï¼š

![](https://gitlab.com/eardh/picture/-/raw/main/jvm_img/202111021803839.png)

æˆ‘ä»¬å‘ç° ExtClassLoader å¹¶æ²¡æœ‰é‡å†™ loadClass() æ–¹æ³•ï¼Œè¿™è¶³çŸ£è¯´æ˜å…¶éµå¾ªåŒäº²å§”æ´¾æ¨¡é€€ï¼Œè€Œ AppClassLoaderé‡è½½äº† loadClass() æ–¹æ³•ï¼Œä½†æœ€ç»ˆè°ƒç”¨çš„è¿˜æ˜¯çˆ¶ç±» loadClass() æ–¹æ³•ï¼Œå› æ­¤ä¾ç„¶éµå®ˆåŒäº²å§”æ´¾æ¨¡å¼ã€‚



### 4. Class.forName()ä¸ClassLoader.loadClass()

- Class.forName() ï¼šæ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œæœ€å¸¸ç”¨çš„æ˜¯  Class.forName(String className)ï¼›æ ¹æ®ä¼ å…¥çš„ç±»çš„å…¨é™å®šåè¿”å›ä¸€ä¸ª Class å¯¹è±¡ã€‚**è¯¥æ–¹æ³•åœ¨å°† Class æ–‡ä»¶åŠ è½½åˆ°å†…å­˜çš„åŒæ—¶ï¼Œä¼šæ‰§è¡Œç±»çš„åˆå§‹åŒ–ã€‚**å¦‚ï¼š`Class.forName("com.atguigu.java.HelloWorld")`ã€‚

- ClassLoader.loadClass() ï¼šè¿™æ˜¯ä¸€ä¸ªå®ä¾‹æ–¹æ³•ï¼Œéœ€è¦ä¸€ä¸ª ClassLoader å¯¹è±¡æ¥è°ƒç”¨è¯¥æ–¹æ³•ã€‚è¯¥æ–¹æ³•å°† Class æ–‡ä»¶åŠ è½½åˆ°å†…å­˜æ—¶ï¼Œå¹¶ä¸ä¼šæ‰§è¡Œç±»çš„åˆå§‹åŒ–ï¼Œ**ç›´åˆ°è¿™ä¸ªç±»ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶æ‰è¿›è¡Œåˆå§‹åŒ–ã€‚**è¯¥æ–¹æ³•å› ä¸ºéœ€è¦å¾—åˆ°ä¸€ä¸ªClassLoader å¯¹è±¡ï¼Œæ‰€ä»¥å¯ä»¥æ ¹æ®éœ€è¦æŒ‡å®šä½¿ç”¨å“ªä¸ªç±»åŠ è½½å™¨ã€‚å¦‚ï¼š

  `ClassLoader cl = ....;`

  `cl.loadClass("com.atguigu.java.HelloWorld");`



## 5. åŒäº²å§”æ´¾æ¨¡å‹

### 1. å®šä¹‰ä¸æœ¬è´¨

ç±»åŠ è½½å™¨ç”¨æ¥æŠŠç±»åŠ è½½åˆ°Javaè™šæ‹Ÿæœºä¸­ã€‚ä»IDK1.2ç‰ˆæœ¬å¼€å§‹ï¼Œç±»çš„åŠ è½½è¿‡ç¨‹é‡‡ç”¨åŒäº²å§”æ´¾æœºåˆ¶ï¼Œè¿™ç§æœºåˆ¶èƒ½æ›´å¥½åœ°ä¿è¯Javaå¹³å°çš„å®‰å…¨ã€‚

**1. å®šä¹‰**

å¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨åœ¨æ¥åˆ°åŠ è½½ç±»çš„è¯·æ±‚æ—¶ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å°è¯•å»åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚ä»»åŠ¡å§”æ‰˜ç»™çˆ¶ç±»åŠ è½½å™¨å»å®Œæˆï¼Œä¾æ¬¡é€’å½’ï¼Œå¦‚æœçˆ¶ç±»åŠ è½½å™¨å¯ä»¥å®Œæˆç±»åŠ è½½ä»»åŠ¡ï¼Œå°±æˆåŠŸè¿”å›ã€‚åªæœ‰çˆ¶ç±»åŠ è½½å™¨æ— æ³•å®Œæˆæ­¤åŠ è½½ä»»åŠ¡æ—¶ï¼Œæ‰è‡ªå·±å»åŠ è½½ã€‚



**2. æœ¬è´¨**

è§„å®šäº†ç±»åŠ è½½çš„é¡ºåºæ˜¯ï¼šå¼•å¯¼ç±»åŠ è½½å™¨å…ˆåŠ è½½ï¼Œè‹¥åŠ è½½ä¸åˆ°ï¼Œç”±æ‰©å±•ç±»åŠ è½½å™¨åŠ è½½ï¼Œè‹¥è¿˜åŠ è½½ä¸åˆ°ï¼Œæ‰ä¼šç”±ç³»ç»Ÿç±»åŠ è½½å™¨æˆ–è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ã€‚

![](https://gitlab.com/eardh/picture/-/raw/main/jvm_img/202111021803441.png)



![](https://gitlab.com/eardh/picture/-/raw/main/jvm_img/202111021803948.png)



### 2. ä¼˜åŠ¿ä¸ç•¥åŠ¿

**1.  åŒäº²å§”æ´¾æœºåˆ¶ä¼˜åŠ¿**

- é¿å…ç±»çš„é‡å¤åŠ è½½ï¼Œç¡®ä¿ä¸€ä¸ªç±»çš„å…¨å±€å”¯ä¸€æ€§

  **Java ç±»éšç€å®ƒçš„ç±»åŠ è½½å™¨ä¸€èµ·å…·å¤‡äº†ä¸€ç§å¸¦æœ‰ä¼˜å…ˆçº§çš„å±‚æ¬¡å…³ç³»ï¼Œé€šè¿‡è¿™ç§å±‚çº§å…³å¯ä»¥é¿å…ç±»çš„é‡å¤åŠ è½½ï¼Œ**å½“çˆ¶äº²å·²ç»åŠ è½½äº†è¯¥ç±»æ—¶ï¼Œå°±æ²¡æœ‰å¿…è¦å­ ClassLoader å†åŠ è½½ä¸€æ¬¡ã€‚

- ä¿æŠ¤ç¨‹åºå®‰å…¨ï¼Œé˜²æ­¢æ ¸å¿ƒAPIè¢«éšæ„ç¯¡æ”¹



**2.  ä»£ç æ”¯æŒ**

 åŒäº²å§”æ´¾æœºåˆ¶åœ¨ java.lang.ClassLoadelr.loadClass(String, boolean) æ¥å£ä¸­ä½“ç°ã€‚è¯¥æ¥å£çš„é€»è¾‘å¦‚ä¸‹ï¼š

ï¼ˆ1ï¼‰å…ˆåœ¨å½“å‰åŠ è½½å™¨çš„ç¼“å­˜ä¸­æŸ¥æ‰¾æœ‰æ— ç›®æ ‡ç±»ï¼Œå¦‚æœæœ‰ï¼Œç›´æ¥è¿”å›ã€‚

ï¼ˆ2ï¼‰åˆ¤æ–­å½“å‰åŠ è½½å™¨çš„çˆ¶åŠ è½½å™¨æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ parent.loadClass(name, false) æ¥å£è¿›è¡ŒåŠ è½½ã€‚

ï¼ˆ3ï¼‰åä¹‹ï¼Œå¦‚æœå½“å‰åŠ è½½å™¨çš„çˆ¶ç±»åŠ è½½å™¨ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ findBootstrapClassOrNull(name) æ¥å£ï¼Œè®©å¼•å¯¼ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ã€‚

ï¼ˆ4ï¼‰å¦‚æœé€šè¿‡ä»¥ä¸Š3æ¡è·¯å¾„éƒ½æ²¡èƒ½æˆåŠŸåŠ è½½ï¼Œåˆ™è°ƒç”¨ findClass(name) æ¥å£è¿›è¡ŒåŠ è½½ã€‚è¯¥æ¥å£æœ€ç»ˆä¼šè°ƒç”¨java.lang.ClassLoader æ¥å£çš„ defineClass ç³»åˆ—çš„ native æ¥å£ åŠ è½½ç›®æ ‡ Java ç±»ã€‚

åŒäº²å§”æ´¾çš„æ¨¡å‹å°±éšè—åœ¨è¿™ç¬¬2å’Œç¬¬3æ­¥ä¸­ã€‚



**3. ä¸¾ä¾‹**

å‡è®¾å½“å‰åŠ è½½çš„æ˜¯ java.lang.Object è¿™ä¸ªç±»ï¼Œå¾ˆæ˜¾ç„¶ï¼Œè¯¥ç±»å±äºIDKä¸­æ ¸å¿ƒå¾—ä¸èƒ½å†æ ¸å¿ƒçš„ä¸€ä¸ªç±»ï¼Œå› æ­¤ä¸€å®šåªèƒ½ç”±å¼•å¯¼ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ã€‚å½“ JVM å‡†å¤‡åŠ è½½ java.lang.0bject æ—¶ï¼ŒJVM é»˜è®¤ä¼šä½¿ç”¨ç³»ç»Ÿç±»åŠ è½½å™¨å»åŠ è½½ï¼ŒæŒ‰ç…§ä¸Šé¢4æ­¥åŠ è½½çš„é€»è¾‘ï¼Œåœ¨ç¬¬1æ­¥ä»ç³»ç»Ÿç±»çš„ç¼“å­˜ä¸­è‚¯å®šæŸ¥æ‰¾ä¸åˆ°è¯¥ç±»ï¼Œäºæ˜¯è¿›å…¥ç¬¬2æ­¥ã€‚ç”±äºä»ç³»ç»Ÿç±»åŠ è½½å™¨çš„çˆ¶åŠ è½½å™¨æ˜¯æ‰©å±•ç±»åŠ è½½ï¼Œäºæ˜¯æ‰©å±•ç±»åŠ è½½å™¨ç»§ç»­ä»ç¬¬1æ­¥å¼€å§‹é‡å¤ã€‚ç”±äºæ‰©å±•ç±»åŠ è½½å™¨çš„ç¼“å­˜ä¸­ä¹Ÿä¸€å®šæŸ¥æ‰¾ä¸åˆ°è¯¥ç±»ï¼Œå› æ­¤è¿›å…¥ç¬¬2æ­¥ã€‚æ‰©å±•ç±»åŠ è½½å™¨çš„çˆ¶åŠ è½½å™¨æ˜¯ nullï¼Œå› æ­¤ç³»ç»Ÿè°ƒç”¨ findClass(String)ï¼Œæœ€ç»ˆé€šè¿‡å¼•å¯¼ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ã€‚



**4. æ€è€ƒ**

å¦‚æœåœ¨è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ä¸­é‡å†™ java.lang.ClassLoader.loadClass(String) æˆ– java.lang.ClassLoader.loadClass(String, boolean) æ–¹æ³•ï¼ŒæŠ¹å»å…¶ä¸­çš„åŒäº²å§”æ´¾æœºåˆ¶ï¼Œä»…ä¿ç•™ä¸Šé¢è¿™4æ­¥ä¸­çš„ç¬¬1æ­¥ä¸ç¬¬4æ­¥ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯å°±èƒ½å¤ŸåŠ è½½æ ¸å¿ƒç±»åº“äº†å‘¢ï¼Ÿ

è¿™ä¹Ÿä¸è¡Œï¼å› ä¸º JDK è¿˜ä¸ºæ ¸å¿ƒç±»åº“æä¾›äº†ä¸€å±‚ä¿æŠ¤æœºåˆ¶ã€‚ä¸ç®¡æ˜¯è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ï¼Œè¿˜æ˜¯ç³»ç»Ÿç±»åŠ è½½å™¨æŠ‘æˆ–æ‰©å±•ç±»åŠ è½½å™¨ï¼Œæœ€ç»ˆéƒ½å¿…é¡»è°ƒç”¨ java.lang.ClassLoader.defineClass(String,  byte[], int, int, ProtectionDomain) æ–¹æ³•ï¼Œè€Œè¯¥æ–¹æ³•ä¼šæ‰§è¡Œ **preDefineClass()** æ¥å£ï¼Œè¯¥æ¥å£ä¸­æä¾›äº†å¯¹JDKæ ¸å¿ƒç±»åº“çš„ä¿æŠ¤ã€‚



**5. åŒäº²å§”æ‰˜æ¨¡å¼çš„å¼Šç«¯**

æ£€æŸ¥ç±»æ˜¯å¦åŠ è½½çš„å§”æ‰˜è¿‡ç¨‹æ˜¯å•å‘çš„ï¼Œè¿™ä¸ªæ–¹å¼è™½ç„¶ä»ç»“æ„ä¸Šè¯´æ¯”è¾ƒæ¸…æ™°ï¼Œä½¿å„ä¸ª ClassLoader çš„èŒè´£éå¸¸æ˜ç¡®ï¼Œä½†æ˜¯åŒæ—¶ä¼šå¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼Œå³é¡¶å±‚çš„ ClassLoader æ— æ³•è®¿é—®åº•å±‚çš„ ClassLoader æ‰€åŠ è½½çš„ç±»ã€‚

é€šå¸¸æƒ…å†µä¸‹ï¼Œå¯åŠ¨ç±»åŠ è½½å™¨ä¸­çš„ç±»ä¸ºç³»ç»Ÿæ ¸å¿ƒç±»ï¼ŒåŒ…æ‹¬ä¸€äº›é‡è¦çš„ç³»ç»Ÿæ¥å£ï¼Œè€Œåœ¨åº”ç”¨ç±»åŠ è½½å™¨ä¸­ï¼Œä¸ºåº”ç”¨ç±»ã€‚æŒ‰ç…§è¿™ç§æ¨¡å¼ï¼Œ**åº”ç”¨ç±»è®¿é—®ç³»ç»Ÿç±»è‡ªç„¶æ˜¯æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯ç³»ç»Ÿç±»è®¿é—®åº”ç”¨ç±»å°±ä¼šå‡ºç°é—®é¢˜ã€‚**æ¯”å¦‚åœ¨ç³»ç»Ÿç±»ä¸­æä¾›äº†ä¸€ä¸ªæ¥å£ï¼Œè¯¥æ¥å£éœ€è¦åœ¨åº”ç”¨ç±»ä¸­å¾—ä»¥å®ç°ï¼Œè¯¥æ¥å£è¿˜ç»‘å®šä¸€ä¸ªå·¥å‚æ–¹æ³•ï¼Œç”¨äºåˆ›å»ºè¯¥æ¥å£çš„å®ä¾‹ï¼Œè€Œæ¥å£å’Œå·¥å‚æ–¹æ³•éƒ½åœ¨å¯åŠ¨ç±»åŠ è½½å™¨ä¸­ã€‚è¿™æ—¶ï¼Œå°±ä¼šå‡ºç°è¯¥å·¥å‚æ–¹æ³•æ— æ³•åˆ›å»ºç”±åº”ç”¨ç±»åŠ è½½å™¨åŠ è½½çš„åº”ç”¨å®ä¾‹çš„é—®é¢˜ã€‚



**6. ç»“è®º**

**ç”±äºJavaè™šæ‹Ÿæœºè§„èŒƒå¹¶æ²¡æœ‰æ˜ç¡®è¦æ±‚ç±»åŠ è½½å™¨çš„åŠ è½½æœºåˆ¶ä¸€å®šè¦ä½¿ç”¨åŒäº²å§”æ´¾æ¨¡å‹ï¼Œåªæ˜¯å»ºè®®é‡‡ç”¨è¿™ç§æ–¹å¼è€Œå·²ã€‚**

æ¯”å¦‚åœ¨ Tomcat ä¸­ï¼Œç±»åŠ è½½å™¨æ‰€é‡‡ç”¨çš„åŠ è½½æœºåˆ¶å°±å’Œä¼ ç»Ÿçš„åŒäº²å§”æ´¾æ¨¡å‹æœ‰ä¸€å®šåŒºåˆ«ï¼Œå½“ç¼ºçœçš„ç±»åŠ è½½å™¨æ¥æ”¶åˆ°ä¸€ä¸ªç±»çš„åŠ è½½ä»»åŠ¡æ—¶ï¼Œé¦–å…ˆä¼šç”±å®ƒè‡ªè¡ŒåŠ è½½ï¼Œå½“å®ƒåŠ è½½å¤±è´¥æ—¶ï¼Œæ‰ä¼šå°†ç±»çš„åŠ è½½ä»»åŠ¡å§”æ´¾ç»™å®ƒçš„è¶…ç±»åŠ è½½å™¨å»æ‰§è¡Œï¼Œè¿™åŒæ—¶ä¹Ÿæ˜¯ Servlet è§„èŒƒæ¨èçš„ä¸€ç§åšæ³•ã€‚



### 3. ç ´ååŒäº²å§”æ´¾æœºåˆ¶

åŒäº²å§”æ´¾æ¨¡å‹å¹¶ä¸æ˜¯ä¸€ä¸ªå…·æœ‰å¼ºåˆ¶æ€§çº¦æŸçš„æ¨¡å‹ï¼Œè€Œæ˜¯ Java è®¾è®¡è€…æ¨èç»™å¼€å‘è€…ä»¬çš„ç±»åŠ è½½å™¨å®ç°æ–¹å¼ã€‚

åœ¨ Java çš„ä¸–ç•Œä¸­å¤§éƒ¨åˆ†çš„ç±»åŠ è½½å™¨éƒ½éµå¾ªè¿™ä¸ªæ¨¡å‹ï¼Œä½†ä¹Ÿæœ‰ä¾‹å¤–çš„æƒ…å†µï¼Œç›´åˆ° Java æ¨¡å—åŒ–å‡ºç°ä¸ºæ­¢ï¼ŒåŒäº²å§”æ´¾æ¨¡å‹ä¸»è¦å‡ºç°è¿‡ 3 æ¬¡è¾ƒå¤§è§„æ¨¡ â€œè¢«ç ´åâ€ çš„æƒ…å†µã€‚

#### 1. ç ´ååŒäº²å§”æ´¾æœºåˆ¶1

**ç¬¬ä¸€æ¬¡ç ´ååŒäº²å§”æ´¾æœºåˆ¶ï¼š**

åŒäº²å§”æ´¾æ¨¡å‹çš„ç¬¬ä¸€æ¬¡ â€œè¢«ç ´åâ€ å…¶å®å‘ç”Ÿåœ¨åŒäº²å§”æ´¾æ¨¡å‹å‡ºç°ä¹‹å‰ ---- å³ JDK1.2 é¢ä¸–ä»¥å‰çš„ â€œè¿œå¤â€ æ—¶ä»£ã€‚

ç”±äºåŒäº²å§”æ´¾æ¨¡å‹åœ¨ JDK1.2 ä¹‹åæ‰è¢«å¼•å…¥ï¼Œä½†æ˜¯ç±»åŠ è½½å™¨çš„æ¦‚å¿µå’ŒæŠ½è±¡ç±» java.lang.ClassLoader åˆ™åœ¨ Java çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ä¸­å°±å·²ç»å­˜åœ¨ï¼Œé¢å¯¹å·²ç»å­˜åœ¨çš„ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„ä»£ç ï¼ŒJava è®¾è®¡è€…ä»¬å¼•å…¥åŒäº²å§”æ´¾æ¨¡å‹æ—¶ä¸å¾—ä¸åšå‡ºä¸€äº›å¦¥åï¼Œä¸ºäº†å…¼å®¹è¿™äº›å·²æœ‰ä»£ç ï¼Œæ— æ³•å†ä»¥æŠ€æœ¯æ‰‹æ®µé¿å… loadClass() è¢«å­ç±»è¦†ç›–çš„å¯èƒ½æ€§ï¼Œåªèƒ½åœ¨ IDK1.2ä¹‹åçš„ java.lang.ClassLoader ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„ protected æ–¹æ³• findClass()ï¼Œå¹¶å¼•å¯¼ç”¨æˆ·ç¼–å†™çš„ç±»åŠ è½½é€»è¾‘æ—¶å°½å¯èƒ½å»é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œè€Œä¸æ˜¯åœ¨ loadClass() ä¸­ç¼–å†™ä»£ç ã€‚ä¸ŠèŠ‚æˆ‘ä»¬å·²ç»åˆ†æè¿‡ loadClass() æ–¹æ³•ï¼ŒåŒäº²å§”æ´¾çš„å…·ä½“é€»è¾‘å°±å®ç°åœ¨è¿™é‡Œé¢ï¼ŒæŒ‰ç…§ loadClass() æ–¹æ³•çš„é€»è¾‘ï¼Œå¦‚æœçˆ¶ç±»åŠ è½½å¤±è´¥ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨è‡ªå·±çš„ findClass() æ–¹æ³•æ¥å®ŒæˆåŠ è½½ï¼Œè¿™æ ·æ—¢ä¸å½±å“ç”¨æˆ·æŒ‰ç…§è‡ªå·±çš„æ„æ„¿å»åŠ è½½ç±»ï¼Œåˆå¯ä»¥ä¿è¯æ–°å†™å‡ºæ¥çš„ç±»åŠ è½½å™¨æ˜¯ç¬¦åˆåŒäº²å§”æ´¾è§„åˆ™çš„ã€‚



#### 2. ç ´ååŒäº²å§”æ´¾æœºåˆ¶2

**ç¬¬äºŒæ¬¡ç ´ååŒäº²å§”æ´¾æœºåˆ¶ï¼šçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨**

åŒäº²å§”æ´¾æ¨¡å‹çš„ç¬¬äºŒæ¬¡ â€œè¢«ç ´åâ€ æ˜¯ç”±è¿™ä¸ªæ¨¡å‹è‡ªèº«çš„ç¼ºé™·å¯¼è‡´çš„ï¼ŒåŒäº²å§”æ´¾å¾ˆå¥½åœ°è§£å†³äº†å„ä¸ªç±»åŠ è½½å™¨åä½œæ—¶åŸºç¡€ç±»å‹çš„ä¸€è‡´æ€§é—®é¢˜**ï¼ˆ==è¶ŠåŸºç¡€çš„ç±»ç”±è¶Šä¸Šå±‚çš„åŠ è½½å™¨è¿›è¡ŒåŠ è½½==ï¼‰**ï¼ŒåŸºç¡€ç±»å‹ä¹‹æ‰€ä»¥è¢«ç§°ä¸º â€œåŸºç¡€â€ï¼Œæ˜¯å› ä¸ºå®ƒä»¬æ€»æ˜¯ä½œä¸ºè¢«ç”¨æˆ·ä»£ç ç»§æ‰¿ã€è°ƒç”¨çš„APIå­˜åœ¨ï¼Œä½†ç¨‹åºè®¾è®¡å¾€å¾€æ²¡æœ‰ç»å¯¹ä¸å˜çš„å®Œç¾è§„åˆ™ï¼Œ**å¦‚æœæœ‰åŸºç¡€ç±»å‹åˆè¦è°ƒç”¨å›ç”¨æˆ·çš„ä»£ç ï¼Œé‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ**

è¿™å¹¶éæ˜¯ä¸å¯èƒ½å‡ºç°çš„äº‹æƒ…ï¼Œä¸€ä¸ªå…¸å‹çš„ä¾‹å­ä¾¿æ˜¯ JNDI æœåŠ¡ï¼ŒJNDI ç°åœ¨å·²ç»æ˜¯ Java çš„æ ‡å‡†æœåŠ¡ï¼Œå®ƒçš„ä»£ç ç”±å¯åŠ¨ç±»åŠ è½½å™¨æ¥å®ŒæˆåŠ è½½ï¼ˆåœ¨JDK1.3æ—¶åŠ å…¥åˆ° rt.jar çš„ï¼‰ï¼Œè‚¯å®šå±äº Java ä¸­å¾ˆåŸºç¡€çš„ç±»å‹äº†ã€‚ä½† JNDI å­˜åœ¨çš„ç›®çš„å°±æ˜¯å¯¹èµ„æºè¿›è¡ŒæŸ¥æ‰¾å’Œé›†ä¸­ç®¡ç†ï¼Œå®ƒéœ€è¦è°ƒç”¨ç”±å…¶ä»–å‚å•†å®ç°å¹¶éƒ¨ç½²åœ¨åº”ç”¨ç¨‹åºçš„ ClassPath ä¸‹çš„ JNDI æœåŠ¡æä¾›è€…æ¥å£ï¼ˆ Service Provider Interfaceï¼ŒSPIï¼‰çš„ä»£ç ï¼Œç°åœ¨é—®é¢˜æ¥äº†ï¼Œ**å¯åŠ¨ç±»åŠ è½½å™¨æ˜¯ç»ä¸å¯èƒ½è®¤è¯†ã€åŠ è½½è¿™äº›ä»£ç çš„ï¼Œé‚£è¯¥æ€ä¹ˆåŠï¼Ÿï¼ˆSPIï¼šåœ¨ Java å¹³å°ä¸­ï¼Œé€šå¸¸æŠŠæ ¸å¿ƒç±» rt.jar ä¸­æä¾›å¤–éƒ¨æœåŠ¡ã€å¯ç”±åº”ç”¨å±‚è‡ªè¡Œå®ç°çš„æ¥å£ç§°ä¸º SPI ï¼‰**

ä¸ºäº†è§£å†³è¿™ä¸ªå›°å¢ƒï¼ŒJava çš„è®¾è®¡å›¢é˜Ÿåªå¥½å¼•å…¥äº†ä¸€ä¸ªä¸å¤ªä¼˜é›…çš„è®¾è®¡ï¼š**çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼ˆThread ContextClassLoaderï¼‰ã€‚**è¿™ä¸ªç±»åŠ è½½å™¨å¯ä»¥é€šè¿‡ java.lang.Thread ç±»çš„ setContextClassLoader() æ–¹æ³•è¿›è¡Œè®¾ç½®ï¼Œå¦‚æœåˆ›å»ºçº¿ç¨‹æ—¶è¿˜æœªè®¾ç½®ï¼Œå®ƒå°†ä¼šä»çˆ¶çº¿ç¨‹ä¸­ç»§æ‰¿ä¸€ä¸ªï¼Œå¦‚æœåœ¨åº”ç”¨ç¨‹åºçš„å…¨å±€èŒƒå›´å†…éƒ½æ²¡æœ‰è®¾ç½®è¿‡çš„è¯ï¼Œé‚£è¿™ä¸ªç±»åŠ è½½å™¨é»˜è®¤å°±æ˜¯åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ã€‚

æœ‰äº†çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼Œç¨‹åºå°±å¯ä»¥åšä¸€äº› â€œèˆå¼Šâ€ çš„äº‹æƒ…äº†ã€‚JNDI æœåŠ¡ä½¿ç”¨è¿™ä¸ªçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨å»åŠ è½½æ‰€éœ€çš„ SPI æœåŠ¡ä»£ç ï¼Œ**è¿™æ˜¯ä¸€ç§çˆ¶ç±»åŠ è½½å™¨å»è¯·æ±‚å­ç±»åŠ è½½å™¨å®Œæˆç±»åŠ è½½çš„è¡Œä¸ºï¼Œè¿™ç§è¡Œä¸ºå®é™…ä¸Šæ˜¯æ‰“é€šäº†åŒäº²å§”æ´¾æ¨¡å‹çš„å±‚æ¬¡ç»“æ„æ¥é€†å‘ä½¿ç”¨ç±»åŠ è½½å™¨ï¼Œå·²ç»è¿èƒŒäº†åŒäº²å§”æ´¾æ¨¡å‹çš„ä¸€èˆ¬æ€§åŸåˆ™ï¼Œ**ä½†ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ã€‚Java ä¸­æ¶‰åŠ SPI çš„åŠ è½½åŸºæœ¬ä¸Šéƒ½é‡‡ç”¨è¿™ç§æ–¹å¼æ¥å®Œæˆï¼Œä¾‹å¦‚ JNDIã€JDBCã€JCEã€JAXB å’Œ JBI ç­‰ã€‚ä¸è¿‡ï¼Œå½“ SPI çš„æœåŠ¡æä¾›è€…å¤šäºä¸€ä¸ªçš„æ—¶å€™ï¼Œä»£ç å°±åªèƒ½æ ¹æ®å…·ä½“æä¾›è€…çš„ç±»å‹æ¥ç¡¬ç¼–ç åˆ¤æ–­ï¼Œä¸ºäº†æ¶ˆé™¤è¿™ç§æä¸ä¼˜é›…çš„å®ç°æ–¹å¼ï¼Œåœ¨ IDK 6 æ—¶ï¼ŒJDK æä¾›äº† java.util.ServiceLoader ç±»ï¼Œä»¥ META-INF/ services ä¸­çš„é…ç½®ä¿¡æ¯ï¼Œè¾…ä»¥è´£ä»»é“¾æ¨¡å¼ï¼Œè¿™æ‰ç®—æ˜¯ç»™ SPI çš„åŠ è½½æä¾›äº†ä¸€ç§ç›¸å¯¹åˆç†çš„è§£å†³æ–¹æ¡ˆã€‚

![](https://gitlab.com/eardh/picture/-/raw/main/jvm_img/202111021804108.png)

é»˜è®¤ä¸Šä¸‹æ–‡åŠ è½½å™¨å°±æ˜¯åº”ç”¨ç±»åŠ è½½å™¨ï¼Œè¿™æ ·ä»¥ä¸Šä¸‹æ–‡åŠ è½½å™¨ä¸ºä¸­ä»‹ï¼Œä½¿å¾—å¯åŠ¨ç±»åŠ è½½å™¨ä¸­çš„ä»£ç ä¹Ÿå¯ä»¥è®¿é—®åº”ç”¨ç±»åŠ è½½å™¨ä¸­çš„ç±»ã€‚



#### 3. ç ´ååŒäº²å§”æ´¾æœºåˆ¶3

**ç¬¬ä¸‰æ¬¡ç ´ååŒäº²å§”æ´¾æœºåˆ¶ï¼š**

åŒäº²å§”æ´¾æ¨¡å‹çš„ç¬¬ä¸‰æ¬¡ â€œè¢«ç ´åâ€ æ˜¯ç”±äºç”¨æˆ·å¯¹ç¨‹åºåŠ¨æ€æ€§çš„è¿½æ±‚è€Œå¯¼è‡´çš„ã€‚å¦‚ï¼š**ä»£ç çƒ­æ›¿æ¢ï¼ˆHot Swapï¼‰ã€æ¨¡å—çƒ­éƒ¨ç½²ï¼ˆHot Deploymentï¼‰**ç­‰

IBM å…¬å¸ä¸»å¯¼çš„ JSRä¸€291ï¼ˆå³OSGiR4.2ï¼‰å®ç°æ¨¡å—åŒ–çƒ­éƒ¨ç½²çš„å…³é”®æ˜¯å®ƒè‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨æœºåˆ¶çš„å®ç°ï¼Œæ¯ä¸€ä¸ªç¨‹åºæ¨¡å—ï¼ˆOSGi ä¸­ç§°ä¸º Bundleï¼‰éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œå½“éœ€è¦æ›´æ¢ä¸€ä¸ª Bundle æ—¶ï¼Œå°±æŠŠ Bundle è¿åŒç±»åŠ è½½å™¨ä¸€èµ·æ¢æ‰ä»¥å®ç°ä»£ç çš„çƒ­æ›¿æ¢ã€‚åœ¨ OSGi ç¯å¢ƒä¸‹ï¼Œç±»åŠ è½½å™¨ä¸å†åŒäº²å§”æ´¾æ¨¡å‹æ¨èçš„æ ‘çŠ¶ç»“æ„ï¼Œè€Œæ˜¯è¿›ä¸€æ­¥å‘å±•ä¸ºæ›´åŠ å¤æ‚çš„**ç½‘çŠ¶ç»“æ„ã€‚**

å½“æ”¶åˆ°ç±»åŠ è½½è¯·æ±‚æ—¶ï¼ŒOSGi å°†æŒ‰ç…§ä¸‹é¢çš„é¡ºåºè¿›è¡Œç±»æœç´¢:

ï¼ˆ1ï¼‰**å°†ä»¥ java.* å¼€å¤´çš„ç±»ï¼Œå§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨åŠ è½½ã€‚**

ï¼ˆ2ï¼‰**å¦åˆ™ï¼Œå°†å§”æ´¾åˆ—è¡¨åå•å†…çš„ç±»ï¼Œå§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨åŠ è½½ã€‚**

ï¼ˆ3ï¼‰å¦åˆ™ï¼Œå°† Import åˆ—è¡¨ä¸­çš„ç±»ï¼Œå§”æ´¾ç»™ Export è¿™ä¸ªç±»çš„ Bundle çš„ç±»åŠ è½½å™¨åŠ è½½ã€‚

ï¼ˆ4ï¼‰å¦åˆ™ï¼ŒæŸ¥æ‰¾å½“å‰ Bundle çš„ ClassPathï¼Œä½¿ç”¨è‡ªå·±çš„ç±»åŠ è½½å™¨åŠ è½½ã€‚

ï¼ˆ5ï¼‰å¦åˆ™ï¼ŒæŸ¥æ‰¾ç±»æ˜¯å¦åœ¨è‡ªå·±çš„ Fragment Bundle ä¸­ï¼Œå¦‚æœåœ¨ï¼Œåˆ™å§”æ´¾ç»™ Fragment Bundle çš„ç±»åŠ è½½å™¨åŠ è½½ã€‚

ï¼ˆ6ï¼‰å¦åˆ™ï¼ŒæŸ¥æ‰¾ Dynamic Import åˆ—è¡¨çš„ Bundleï¼Œå§”æ´¾ç»™å¯¹åº” Bundle çš„ç±»åŠ è½½å™¨åŠ è½½ã€‚

ï¼ˆ7ï¼‰å¦åˆ™ï¼Œç±»æŸ¥æ‰¾å¤±è´¥ã€‚

è¯´æ˜ï¼šåªæœ‰å¼€å¤´ä¸¤ç‚¹ä»ç„¶ç¬¦åˆåŒäº²å§”æ´¾æ¨¡å‹çš„åŸåˆ™ï¼Œå…¶ä½™çš„ç±»æŸ¥æ‰¾éƒ½æ˜¯åœ¨å¹³çº§çš„ç±»åŠ è½½å™¨ä¸­è¿›è¡Œçš„



#### 4. å°ç»“

è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨äº† â€œè¢«ç ´åâ€ è¿™ä¸ªè¯æ¥å½¢å®¹ä¸Šè¿°ä¸ç¬¦åˆåŒäº²å§”æ´¾æ¨¡å‹åŸåˆ™çš„è¡Œä¸ºï¼Œä½†**è¿™é‡Œ â€œè¢«ç ´åâ€ å¹¶ä¸ä¸€å®šæ˜¯å¸¦æœ‰è´¬ä¹‰çš„ã€‚åªè¦æœ‰æ˜ç¡®çš„ç›®çš„å’Œå……åˆ†çš„ç†ç”±ï¼Œçªç ´æ—§æœ‰åŸåˆ™æ— ç–‘æ˜¯ä¸€ç§åˆ›æ–°ã€‚**

æ­£å¦‚ï¼šOSGi ä¸­çš„ç±»åŠ è½½å™¨çš„è®¾è®¡ä¸ç¬¦åˆä¼ ç»Ÿçš„åŒäº²å§”æ´¾çš„ç±»åŠ è½½å™¨æ¶æ„ï¼Œä¸”ä¸šç•Œå¯¹å…¶ä¸ºäº†å®ç°çƒ­éƒ¨ç½²è€Œå¸¦æ¥çš„é¢å¤–çš„é«˜å¤æ‚åº¦è¿˜å­˜åœ¨ä¸å°‘äº‰è®®ï¼Œä½†å¯¹è¿™æ–¹é¢æœ‰äº†è§£çš„æŠ€æœ¯äººå‘˜åŸºæœ¬è¿˜æ˜¯èƒ½è¾¾æˆä¸€ä¸ªå…±è¯†ï¼Œè®¤ä¸º **OSGiä¸­å¯¹ç±»åŠ è½½å™¨çš„è¿ç”¨æ˜¯å€¼å¾—å­¦ä¹ çš„ï¼Œå®Œå…¨å¼„æ‡‚äº†0SGiçš„å®ç°ï¼Œå°±ç®—æ˜¯æŒæ¡äº†ç±»åŠ è½½å™¨çš„ç²¾ç²¹**ã€‚



### 4. çƒ­æ›¿æ¢çš„å®ç°

çƒ­æ›¿æ¢æ˜¯æŒ‡åœ¨ç¨‹åºçš„è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸åœæ­¢æœåŠ¡ï¼Œåªé€šè¿‡æ›¿æ¢ç¨‹åºæ–‡ä»¶æ¥ä¿®æ”¹ç¨‹åºçš„è¡Œä¸ºã€‚**çƒ­æ›¿æ¢çš„å…³é”®éœ€æ±‚åœ¨äºæœåŠ¡ä¸èƒ½ä¸­æ–­ï¼Œä¿®æ”¹å¿…é¡»ç«‹å³è¡¨ç°æ­£åœ¨è¿è¡Œçš„ç³»ç»Ÿä¹‹ä¸­ã€‚**åŸºæœ¬ä¸Šå¤§éƒ¨åˆ†è„šæœ¬è¯­è¨€éƒ½æ˜¯å¤©ç”Ÿæ”¯æŒçƒ­æ›¿æ¢çš„ï¼Œæ¯”å¦‚ï¼šPHPï¼Œåªè¦æ›¿æ¢äº†PHPæºæ–‡ä»¶ï¼Œè¿™ç§æ”¹åŠ¨å°±ä¼šç«‹å³ç”Ÿæ•ˆï¼Œè€Œæ— éœ€é‡å¯WebæœåŠ¡å™¨ã€‚

ä½†å¯¹Javaæ¥è¯´ï¼Œçƒ­æ›¿æ¢å¹¶éå¤©ç”Ÿå°±æ”¯æŒï¼Œ**å¦‚æœä¸€ä¸ªç±»å·²ç»åŠ è½½åˆ°ç³»ç»Ÿä¸­ï¼Œé€šè¿‡ä¿®æ”¹ç±»æ–‡ä»¶ï¼Œå¹¶æ— æ³•è®©ç³»ç»Ÿå†æ¥åŠ è½½å¹¶é‡å®šä¹‰è¿™ä¸ªç±»ã€‚**å› æ­¤ï¼Œåœ¨Javaä¸­å®ç°è¿™ä¸€åŠŸèƒ½çš„ä¸€ä¸ªå¯è¡Œçš„æ–¹æ³•å°±æ˜¯çµæ´»è¿ç”¨ ClassLoaderã€‚

**æ³¨æ„ï¼š** ç”±ä¸åŒ ClassLoader åŠ è½½çš„åŒåç±»å±äºä¸åŒçš„ç±»å‹ï¼Œä¸èƒ½ç›¸äº’è½¬æ¢å’Œå…¼å®¹ã€‚å³ä¸¤ä¸ªä¸åŒçš„ClassLoaderåŠ è½½åŒä¸€ä¸ªç±»ï¼Œåœ¨è™šæ‹Ÿæœºå†…éƒ¨ï¼Œä¼šè®¤ä¸ºè¿™ 2 ä¸ªç±»æ˜¯å®Œå…¨ä¸åŒçš„ã€‚

æ ¹æ®è¿™ä¸ªç‰¹ç‚¹ï¼Œå¯ä»¥ç”¨æ¥æ¨¡æ‹Ÿçƒ­æ›¿æ¢çš„å®ç°ï¼ŒåŸºæœ¬æ€è·¯å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://gitlab.com/eardh/picture/-/raw/main/jvm_img/202111021805486.jpg)



**ä»£ç **
 ç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹æ˜¯æ¯éš”5ç§’è¿›è¡Œä¸€æ¬¡è¾“å‡º

- é¦–å…ˆåœ¨Demo ä¸­å®šä¹‰è¾“å‡ºæ–¹æ³•ï¼Œä½¿ç”¨javacç¼–è¯‘ä¸ºclass
- è¿è¡Œç¨‹åºï¼Œè¾“å‡º `OldDemo`
- ä¿®æ”¹ Demo ä¸­çš„è¾“å‡ºæ–¹æ³•ï¼Œä½¿ç”¨ javac å†æ¬¡ç¼–è¯‘ä¸º class æ–‡ä»¶ï¼Œæ­¤æ—¶ class æ–‡ä»¶å‘ç”Ÿäº†æ›¿æ¢
- è§‚å¯Ÿç¨‹åºè¾“å‡º,ç¨‹åºè¾“å‡ºäº† `OldDemo -> NewDemo`

**Demo.java**

```java
public class Demo {
    public void hot() {
//       System.out.println("OldDemo"); // æ›¿æ¢å‰è¾“å‡º
        System.out.println("OldDemo -> NewDemo"); // æ›¿æ¢åè¾“å‡º
    }
}
```



**è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ï¼šMyClassLoader.java**

```java
/**
 * è‡ªå®šä¹‰ç±»çš„åŠ è½½å™¨
 */
public class MyClassLoader extends ClassLoader {
    private String rootDir;

    public MyClassLoader(String rootDir) {
        this.rootDir = rootDir;
    }

    protected Class<?> findClass(String className) {
        Class clazz = this.findLoadedClass(className);
        FileChannel fileChannel = null;
        WritableByteChannel outChannel = null;
        if (null == clazz) {
            try {
                String classFile = getClassFile(className);
                FileInputStream fis = new FileInputStream(classFile);
                fileChannel = fis.getChannel();
                ByteArrayOutputStream baos = new ByteArrayOutputStream();
                outChannel = Channels.newChannel(baos);
                ByteBuffer buffer = ByteBuffer.allocateDirect(1024);
                while (true) {
                    int i = fileChannel.read(buffer);
                    if (i == 0 || i == -1) {
                        break;
                    }
                    buffer.flip();
                    outChannel.write(buffer);
                    buffer.clear();
                }
                byte[] bytes = baos.toByteArray();
                clazz = defineClass(className, bytes, 0, bytes.length);
            } catch (IOException e) {
                // é‡æ–°ç¼–è¯‘æ—¶å¯èƒ½ç¼–è¯‘æ—¶é—´è¾ƒé•¿ï¼Œæºæ–‡ä»¶è¢«æ›¿æ¢æ˜¯æ—¶é—´ç­‰åŸå› ï¼Œä¸å¤„ç†
                // e.printStackTrace();
            } finally {
                try {
                    if (fileChannel != null)
                        fileChannel.close();
                } catch (IOException e) {
                    e.printStackTrace();
                }
                try {
                    if (outChannel != null)
                        outChannel.close();
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
        }
        return clazz;
    }

    /**
     * ç±»æ–‡ä»¶çš„å®Œå…¨è·¯å¾„
     */
    private String getClassFile(String className) {
        return rootDir + "\\" + className.replace('.', '\\') + ".class";
    }
}
```



**æµ‹è¯•ä»£ç ï¼šLoopRun.java**

```java
public class LoopRun {
    public static void main(String args[]) {
        while (true) {
            try {
                // 1. åˆ›å»ºè‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„å®ä¾‹
                MyClassLoader loader = new MyClassLoader("C:\\Users\\Administrator\\IDEAworkSpace\\test\\out\\production\\study\\");
                // 2. åŠ è½½æŒ‡å®šçš„ç±»
                Class clazz = loader.findClass("jvm.Demo");
                // 3. åˆ›å»ºè¿è¡Œæ—¶ç±»çš„å®ä¾‹
                Object demo = clazz.newInstance();
                // 4. è·å–è¿è¡Œæ—¶ç±»ä¸­æŒ‡å®šçš„æ–¹æ³•
                Method m = clazz.getMethod("hot");
                // 5. è°ƒç”¨æŒ‡å®šçš„æ–¹æ³•
                m.invoke(demo);
                Thread.sleep(5000);
            } catch (Exception e) {
                try {
                    Thread.sleep(5000);
                } catch (InterruptedException ex) {
                    ex.printStackTrace();
                }
            }
        }
    }
}
```



**ç»“æœå›¾ï¼š**

![](https://gitlab.com/eardh/picture/-/raw/main/jvm_img/202111021804220.png)



## 6. æ²™ç®±å®‰å…¨æœºåˆ¶

**æ²™ç®±å®‰å…¨æœºåˆ¶**

- ä¿è¯ç¨‹åºå®‰å…¨
- ä¿æŠ¤JavaåŸç”Ÿçš„JDKä»£ç 

**Javaå®‰å…¨æ¨¡å‹çš„æ ¸å¿ƒå°±æ˜¯Javaæ²™ç®±ï¼ˆsandboxï¼‰**ã€‚ä»€ä¹ˆæ˜¯æ²™ç®±ï¼Ÿæ²™ç®±æ˜¯ä¸€ä¸ªé™åˆ¶ç¨‹åºè¿è¡Œçš„ç¯å¢ƒã€‚

æ²™ç®±æœºåˆ¶å°±æ˜¯å°†Javaä»£ç é™å®šåœ¨è™šæ‹Ÿæœºï¼ˆJVMï¼‰ç‰¹å®šçš„è¿è¡ŒèŒƒå›´ä¸­ï¼Œå¹¶ä¸”ä¸¥æ ¼é™åˆ¶ä»£ç å¯¹æœ¬åœ°ç³»ç»Ÿèµ„æºè®¿é—®ã€‚é€šè¿‡è¿™æ ·çš„æªæ–½æ¥ä¿è¯å¯¹ä»£ç çš„æœ‰é™éš”ç¦»ï¼Œé˜²æ­¢å¯¹æœ¬åœ°ç³»ç»Ÿé€ æˆç ´åã€‚

æ²™ç®±ä¸»è¦é™åˆ¶ç³»ç»Ÿèµ„æºè®¿é—®ï¼Œé‚£ç³»ç»Ÿèµ„æºåŒ…æ‹¬ä»€ä¹ˆï¼ŸCPUã€å†…å­˜ã€æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œã€‚ä¸åŒçº§åˆ«çš„æ²™ç®±å¯¹è¿™äº›èµ„æºè®¿é—®çš„é™åˆ¶ä¹Ÿå¯ä»¥ä¸ä¸€æ ·ã€‚

æ‰€æœ‰çš„ Java ç¨‹åºè¿è¡Œéƒ½å¯ä»¥æŒ‡å®šæ²™ç®±ï¼Œå¯ä»¥å®šåˆ¶å®‰å…¨ç­–ç•¥ã€‚



**1. JDK1.0æ—¶æœŸ**

åœ¨ Java ä¸­å°†æ‰§è¡Œç¨‹åºåˆ†æˆæœ¬åœ°ä»£ç å’Œè¿œç¨‹ä»£ç ä¸¤ç§ï¼Œæœ¬åœ°ä»£ç é»˜è®¤è§†ä¸ºå¯ä¿¡ä»»çš„ï¼Œè€Œè¿œç¨‹ä»£ç åˆ™è¢«çœ‹ä½œæ˜¯ä¸å—ä¿¡çš„ã€‚å¯¹äºæˆä¿¡çš„æœ¬åœ°ä»£ç ï¼Œå¯ä»¥è®¿é—®ä¸€åˆ‡æœ¬åœ°èµ„æºã€‚è€Œå¯¹äºéæˆä¿¡çš„è¿œç¨‹ä»£ç åœ¨æ—©æœŸçš„ Java å®ç°ä¸­ï¼Œå®‰å…¨ä¾èµ–äºæ²™ç®±ï¼ˆ Sandboxï¼‰æœºåˆ¶ã€‚å¦‚ä¸‹å›¾æ‰€ç¤º JDK1.0 å®‰å…¨æ¨¡å‹

![](https://gitlab.com/eardh/picture/-/raw/main/jvm_img/202111021805150.png)



**2. JDK1.1æ—¶æœŸ**

JDK1.0ä¸­å¦‚æ­¤ä¸¥æ ¼çš„å®‰å…¨æœºåˆ¶ä¹Ÿç»™ç¨‹åºçš„åŠŸèƒ½æ‰©å±•å¸¦æ¥éšœç¢ï¼Œæ¯”å¦‚å½“ç”¨æˆ·å¸Œæœ›è¿œç¨‹ä»£ç è®¿é—®æœ¬åœ°ç³»ç»Ÿçš„æ–‡ä»¶æ—¶å€™ï¼Œå°±æ— æ³•å®ç°ã€‚

å› æ­¤åœ¨åç»­çš„Java1.1ç‰ˆæœ¬ä¸­ï¼Œé’ˆå¯¹å®‰å…¨æœºåˆ¶åšäº†æ”¹è¿›ï¼Œå¢åŠ äº†å®‰å…¨ç­–ç•¥ã€‚å…è®¸ç”¨æˆ·æŒ‡å®šä»£ç å¯¹æœ¬åœ°èµ„æºçš„è®¿é—®æƒé™ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºJDK1.1å®‰å…¨æ¨¡å‹

![](https://gitlab.com/eardh/picture/-/raw/main/jvm_img/202111021805212.png)



**3. JDK1.2æ—¶æœŸ**

åœ¨ JDK1.2 ç‰ˆæœ¬ä¸­ï¼Œå†æ¬¡æ”¹è¿›äº†å®‰å…¨æœºåˆ¶ï¼Œå¢åŠ äº†ä»£ç ç­¾åã€‚ä¸è®ºæœ¬åœ°ä»£ç æˆ–æ˜¯è¿œç¨‹ä»£ç ï¼Œéƒ½ä¼šæŒ‰ç…§ç”¨æˆ·çš„å®‰å…¨ç­–ç•¥è®¾å®šï¼Œç”±ç±»åŠ è½½å™¨åŠ è½½åˆ°è™šæ‹Ÿæœºä¸­æƒé™ä¸åŒçš„è¿è¡Œç©ºé—´,æ¥å®ç°å·®å¼‚åŒ–çš„ä»£ç æ‰§è¡Œæƒé™æ§åˆ¶ã€‚å¦‚ä¸‹å›¾æ‰€ç¤º JDK1.2å®‰å…¨æ¨¡å‹

![](https://gitlab.com/eardh/picture/-/raw/main/jvm_img/202111021805447.png)



**4. JDK1.6æ—¶æœŸ**

å½“å‰æœ€æ–°çš„å®‰å…¨æœºåˆ¶å®ç°ï¼Œåˆ™å¼•å…¥äº†åŸŸï¼ˆDomainï¼‰çš„æ¦‚å¿µã€‚

è™šæ‹Ÿæœºä¼šæŠŠæ‰€æœ‰ä»£ç åŠ è½½åˆ°ä¸åŒçš„ç³»ç»ŸåŸŸå’Œåº”ç”¨åŸŸã€‚ç³»ç»ŸåŸŸéƒ¨åˆ†ä¸“é—¨è´Ÿè´£ä¸å…³é”®èµ„æºè¿›è¡Œäº¤äº’ï¼Œè€Œå„ä¸ªåº”ç”¨åŸŸéƒ¨åˆ†åˆ™é€šè¿‡ç³»ç»ŸåŸŸçš„éƒ¨åˆ†ä»£ç†æ¥å¯¹å„ç§éœ€è¦çš„èµ„æºè¿›è¡Œè®¿é—®ã€‚è™šæ‹Ÿæœºä¸­ä¸åŒçš„å—ä¿æŠ¤åŸŸï¼ˆProtected Domainï¼‰ï¼Œå¯¹åº”ä¸ä¸€æ ·çš„æƒé™ ï¼ˆPermissionï¼‰ã€‚å­˜åœ¨äºä¸åŒåŸŸä¸­çš„ç±»æ–‡ä»¶å°±å…·æœ‰äº†å½“å‰åŸŸçš„å…¨éƒ¨æƒé™ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæœ€æ–°çš„å®‰å…¨æ¨¡å‹ï¼ˆjdk1.6ï¼‰

![](https://gitlab.com/eardh/picture/-/raw/main/jvm_img/202111021805743.png)




## 7. è‡ªå®šä¹‰ç±»çš„åŠ è½½å™¨

**1. ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Ÿ**

- **éš”ç¦»åŠ è½½ç±»**

  > åœ¨æŸäº›æ¡†æ¶å†…è¿›è¡Œä¸­é—´ä»¶ä¸åº”ç”¨çš„æ¨¡å—éš”ç¦»ï¼ŒæŠŠç±»åŠ è½½åˆ°ä¸åŒçš„ç¯å¢ƒã€‚æ¯”å¦‚ï¼šé˜¿é‡Œå†…æŸå®¹å™¨æ¡†æ¶é€šè¿‡è‡ªå®šä¹‰ç±»åŠ è½½å™¨ç¡®ä¿åº”ç”¨ä¸­ä¾èµ–çš„ jar åŒ…ä¸ä¼šå½±å“åˆ°ä¸­é—´ä»¶è¿è¡Œæ—¶ä½¿ç”¨çš„ jar åŒ…ã€‚å†æ¯”å¦‚ï¼šTomcat è¿™ç±» Web åº”ç”¨æœåŠ¡å™¨ï¼Œå†…éƒ¨è‡ªå®šä¹‰äº†å¥½å‡ ç§ç±»åŠ è½½å™¨ï¼Œç”¨äºéš”ç¦»åŒä¸€ä¸ª Web åº”ç”¨æœåŠ¡å™¨ä¸Šçš„ä¸åŒåº”ç”¨ç¨‹åºã€‚ï¼ˆç±»çš„ä»²è£ --> ç±»å†²çªï¼‰ã€‚

- **ä¿®æ”¹ç±»åŠ è½½çš„æ–¹å¼**

  > ç±»çš„åŠ è½½æ¨¡å‹å¹¶éå¼ºåˆ¶ï¼Œé™¤ Bootstrap å¤–ï¼Œå…¶ä»–çš„åŠ è½½å¹¶éä¸€å®šè¦å¼•å…¥ï¼Œæˆ–è€…æ ¹æ®å®é™…æƒ…å†µåœ¨æŸä¸ªæ—¶é—´ç‚¹è¿›è¡ŒæŒ‰éœ€è¿›è¡ŒåŠ¨æ€åŠ è½½ã€‚

- **æ‰©å±•åŠ è½½æº**

  æ¯”å¦‚ä»æ•°æ®åº“ã€ç½‘ç»œã€ç”šè‡³æ˜¯ç”µè§†æœºæœºé¡¶ç›’è¿›è¡ŒåŠ è½½ã€‚

- **é˜²æ­¢æºç æ³„æ¼**

  Java ä»£ç å®¹æ˜“è¢«ç¼–è¯‘å’Œç¯¡æ”¹ï¼Œå¯ä»¥è¿›è¡Œç¼–è¯‘åŠ å¯†ã€‚é‚£ä¹ˆç±»åŠ è½½ä¹Ÿéœ€è¦è‡ªå®šä¹‰ï¼Œè¿˜åŸåŠ å¯†çš„å­—èŠ‚ç ã€‚



**2. å¸¸è§çš„åœºæ™¯**

- å®ç°ç±»ä¼¼è¿›ç¨‹å†…éš”ç¦»ï¼Œç±»åŠ è½½å™¨å®é™…ä¸Šç”¨ä½œä¸åŒçš„å‘½åç©ºé—´ï¼Œä»¥æä¾›ç±»ä¼¼å®¹å™¨ã€æ¨¡å—åŒ–çš„æ•ˆæœã€‚ä¾‹å¦‚ï¼Œä¸¤ä¸ªæ¨¡å—ä¾èµ–äºæŸä¸ªç±»åº“çš„ä¸åŒç‰ˆæœ¬ï¼Œå¦‚æœåˆ†åˆ«è¢«ä¸åŒçš„å®¹å™¨åŠ è½½ï¼Œå°±å¯ä»¥äº’ä¸å¹²æ‰°ã€‚è¿™ä¸ªæ–¹é¢çš„é›†å¤§æˆè€…æ˜¯ Java EE å’Œ OSGIã€JPMSç­‰æ¡†æ¶ã€‚
- åº”ç”¨éœ€è¦ä»ä¸åŒçš„æ•°æ®æºè·å–ç±»å®šä¹‰ä¿¡æ¯ï¼Œä¾‹å¦‚ç½‘ç»œæ•°æ®æºï¼Œè€Œä¸æ˜¯æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿã€‚æˆ–è€…æ˜¯éœ€è¦è‡ªå·±æ“çºµå­—èŠ‚ç ï¼ŒåŠ¨æ€ä¿®æ”¹æˆ–è€…ç”Ÿæˆç±»å‹ã€‚



**3. æ³¨æ„**

åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä½¿ç”¨ä¸åŒçš„ç±»åŠ è½½å™¨å»åŠ è½½ä¸åŒçš„åŠŸèƒ½æ¨¡å—ï¼Œä¼šæé«˜åº”ç”¨ç¨‹åºçš„å®‰å…¨æ€§ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ¶‰åŠJavaç±»å‹è½¬æ¢ï¼Œåˆ™åŠ è½½å™¨åè€Œå®¹æ˜“äº§ç”Ÿä¸ç¾å¥½çš„äº‹æƒ…ã€‚åœ¨åš Java ç±»å‹è½¬æ¢æ—¶ï¼Œåªæœ‰ä¸¤ä¸ªç±»å‹éƒ½æ˜¯ç”±åŒä¸€ä¸ªåŠ è½½å™¨æ‰€åŠ è½½ï¼Œæ‰èƒ½è¿›è¡Œç±»å‹è½¬æ¢ï¼Œå¦åˆ™è½¬æ¢æ—¶ä¼šå‘ç”Ÿå¼‚å¸¸ã€‚



### 1. å®ç°æ–¹å¼

ç”¨æˆ·é€šè¿‡å®šåˆ¶è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œè¿™æ ·å¯ä»¥é‡æ–°å®šä¹‰ç±»çš„åŠ è½½è§„åˆ™ï¼Œä»¥ä¾¿å®ç°ä¸€äº›è‡ªå®šä¹‰çš„å¤„ç†é€»è¾‘

**1. å®ç°æ–¹å¼**

- Javaæä¾›äº†æŠ½è±¡ç±» java.lang.ClassLoaderï¼Œæ‰€æœ‰ç”¨æˆ·è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨éƒ½åº”è¯¥ç»§æ‰¿ ClassLoader ç±»ã€‚
- åœ¨è‡ªå®šä¹‰ ClassLoader çš„å­ç±»æ—¶å€™ï¼Œæˆ‘ä»¬å¸¸è§çš„ä¼šæœ‰ä¸¤ç§åšæ³•ï¼š
  - æ–¹å¼ä¸€ï¼šé‡å†™loadClassï¼ˆï¼‰æ–¹æ³•
  - æ–¹å¼äºŒï¼šé‡å†™findClassï¼ˆï¼‰æ–¹æ³•



**2. å¯¹æ¯”**
 è¿™ä¸¤ç§æ–¹æ³•æœ¬è´¨ä¸Šå·®ä¸å¤šï¼Œæ¯•ç«Ÿ loadClass() ä¹Ÿä¼šè°ƒç”¨findClass()ï¼Œä½†æ˜¯ä»é€»è¾‘ä¸Šè®²æˆ‘ä»¬æœ€å¥½ä¸è¦ç›´æ¥ä¿®æ”¹loadClass() çš„å†…éƒ¨é€»è¾‘ã€‚å»ºè®®çš„åšæ³•æ˜¯åªåœ¨ findClass() é‡Œé‡å†™è‡ªå®šä¹‰ç±»çš„åŠ è½½æ–¹æ³•ï¼Œæ ¹æ®å‚æ•°æŒ‡å®šç±»çš„åå­—ï¼Œè¿”å›å¯¹åº”çš„ Class å¯¹è±¡çš„å¼•ç”¨ã€‚

- loadClass() è¿™ä¸ªæ–¹æ³•æ˜¯å®ç°åŒäº²å§”æ´¾æ¨¡å‹é€»è¾‘çš„åœ°æ–¹ï¼Œæ“…è‡ªä¿®æ”¹è¿™ä¸ªæ–¹æ³•ä¼šå¯¼è‡´æ¨¡å‹è¢«ç ´åï¼Œå®¹æ˜“é€ æˆé—®é¢˜ã€‚**å› æ­¤æˆ‘ä»¬æœ€å¥½æ˜¯åœ¨åŒäº²å§”æ´¾æ¨¡å‹æ¡†æ¶å†…è¿›è¡Œå°èŒƒå›´çš„æ”¹åŠ¨ï¼Œä¸ç ´ååŸæœ‰çš„ç¨³å®šç»“æ„**ã€‚åŒæ—¶ï¼Œä¹Ÿé¿å…äº†è‡ªå·±é‡å†™
- loadClass() æ–¹æ³•çš„è¿‡ç¨‹ä¸­å¿…é¡»å†™åŒäº²å§”æ‰˜çš„é‡å¤ä»£ç ï¼Œä»ä»£ç çš„å¤ç”¨æ€§æ¥çœ‹ï¼Œä¸ç›´æ¥ä¿®æ”¹è¿™ä¸ªæ–¹æ³•å§‹ç»ˆæ˜¯æ¯”è¾ƒå¥½çš„é€‰æ‹©ã€‚

- å½“ç¼–å†™å¥½è‡ªå®šä¹‰ç±»åŠ è½½å™¨åï¼Œä¾¿å¯ä»¥åœ¨ç¨‹åºä¸­è°ƒç”¨ loadClass() æ–¹æ³•æ¥å®ç°ç±»åŠ è½½æ“ä½œã€‚



**3. è¯´æ˜**

- å…¶çˆ¶ç±»åŠ è½½å™¨æ˜¯ç³»ç»Ÿç±»åŠ è½½å™¨
- JVM ä¸­çš„æ‰€æœ‰ç±»åŠ è½½éƒ½ä¼šä½¿ç”¨ java.lang.ClassLoader.loadClass(String) æ¥å£ï¼ˆè‡ªå®šä¹‰ç±»åŠ è½½å™¨å¹¶é‡å†™java.lang.ClassLoader.loadClass(String) æ¥å£çš„é™¤å¤–ï¼‰ï¼Œè¿ JDK çš„æ ¸å¿ƒç±»åº“ä¹Ÿä¸èƒ½ä¾‹å¤–ã€‚




### 2. ä»£ç 

**è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼šMyClassLoader.java**

```java
public class MyClassLoader extends ClassLoader {
    private String byteCodePath;

    public MyClassLoader(String byteCodePath) {
        this.byteCodePath = byteCodePath;
    }

    public MyClassLoader(ClassLoader parent, String byteCodePath) {
        super(parent);
        this.byteCodePath = byteCodePath;
    }

    @Override
    protected Class<?> findClass(String className) throws ClassNotFoundException {
        BufferedInputStream bis = null;
        ByteArrayOutputStream baos = null;
        try {
            // è·å–å­—èŠ‚ç æ–‡ä»¶çš„å®Œæ•´è·¯å¾„
            String fileName = byteCodePath + className + ".class";
            // è·å–ä¸€ä¸ªè¾“å…¥æµ
            bis = new BufferedInputStream(new FileInputStream(fileName));
            // è·å–ä¸€ä¸ªè¾“å‡ºæµ
            baos = new ByteArrayOutputStream();
            // å…·ä½“è¯»å…¥æ•°æ®å¹¶å†™å‡ºçš„è¿‡ç¨‹
            int len;
            byte[] data = new byte[1024];
            while ((len = bis.read(data)) != -1) {
                baos.write(data, 0, len);
            }
            // è·å–å†…å­˜ä¸­çš„å®Œæ•´çš„å­—èŠ‚æ•°ç»„çš„æ•°æ®
            byte[] byteCodes = baos.toByteArray();
            // è°ƒç”¨ defineClass()ï¼Œå°†å­—èŠ‚æ•°ç»„çš„æ•°æ®è½¬æ¢ä¸ºClassçš„å®ä¾‹ã€‚
            Class clazz = defineClass(null, byteCodes, 0, byteCodes.length);
            return clazz;
        } catch (IOException e) {
            e.printStackTrace();
        } finally {
            try {
                if (baos != null)
                    baos.close();
            } catch (IOException e) {
                e.printStackTrace();
            }
            try {
                if (bis != null)
                    bis.close();
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
        return null;
    }
}
```



**æµ‹è¯•ä»£ç ï¼š MyClassLoaderTest.java**

```java
public class MyClassLoaderTest {
    public static void main(String[] args) {
        MyClassLoader loader = new MyClassLoader("d:/");
        try {
            Class clazz = loader.loadClass("Demo");
            System.out.println("åŠ è½½æ­¤ç±»çš„ç±»çš„åŠ è½½å™¨ä¸ºï¼š" + clazz.getClassLoader().getClass().getName());
            System.out.println("åŠ è½½å½“å‰ Demo ç±»çš„ç±»çš„åŠ è½½å™¨çš„çˆ¶ç±»åŠ è½½å™¨ä¸ºï¼š" + clazz.getClassLoader().getParent().getClass().getName());
        } catch (ClassNotFoundException e) {
            e.printStackTrace();
        }
    }
}
```



## 8. Java9çš„æ–°ç‰¹æ€§

ä¸ºäº†ä¿è¯å…¼å®¹æ€§ï¼ŒJDK9 æ²¡æœ‰ä»æ ¹æœ¬ä¸Šæ”¹å˜ä¸‰å±‚ç±»åŠ è½½å™¨æ¶æ„å’ŒåŒäº²å§”æ´¾æ¨¡å‹ï¼Œä½†ä¸ºäº†æ¨¡å—åŒ–ç³»ç»Ÿçš„é¡ºåˆ©è¿è¡Œï¼Œä»ç„¶å‘ç”Ÿäº†ä¸€äº›å€¼å¾—è¢«æ³¨æ„çš„å˜åŠ¨ã€‚

1ã€æ‰©å±•æœºåˆ¶è¢«ç§»é™¤ï¼Œæ‰©å±•ç±»åŠ è½½å™¨ç”±äºå‘åå…¼å®¹æ€§çš„åŸå› è¢«ä¿ç•™ï¼Œä¸è¿‡è¢«é‡å‘½åä¸ºå¹³å°ç±»åŠ è½½å™¨ï¼ˆplatform classloaderï¼‰ã€‚å¯ä»¥é€šè¿‡ ClassLoader çš„æ–°æ–¹æ³• getPlatformClassLoader() æ¥è·å–ã€‚

> JDK9 æ—¶åŸºäºæ¨¡å—åŒ–è¿›è¡Œæ„å»ºï¼ˆåŸæ¥çš„ rt.jar å’Œ tools.jar è¢«æ‹†åˆ†æˆæ•°åä¸ª JMOD æ–‡ä»¶ï¼‰ï¼Œå…¶ä¸­çš„ Java ç±»åº“å°±å·²å¤©ç„¶åœ°æ»¡è¶³äº†å¯æ‰©å±•çš„éœ€æ±‚ï¼Œé‚£è‡ªç„¶æ— é¡»å†ä¿ç•™ <JAVA_HOME>\lib\ext ç›®å½•ï¼Œæ­¤å‰ä½¿ç”¨è¿™ä¸ªç›®å½•æˆ–è€… java.ext.dirs ç³»ç»Ÿå˜é‡æ¥æ‰©å±•JDKåŠŸèƒ½çš„æœºåˆ¶å·²ç»æ²¡æœ‰ç»§ç»­å­˜åœ¨çš„ä»·å€¼äº†ã€‚



2ã€å¹³å°ç±»åŠ è½½å™¨å’Œåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨éƒ½ä¸å†ç»§æ‰¿è‡ª java.net.URLClassLoader

> ç°åœ¨å¯åŠ¨ç±»åŠ è½½å™¨ã€å¹³å°ç±»åŠ è½½å™¨ã€åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨å…¨éƒ½ç»§æ‰¿äº jdk.internal.loader.BuiltinClassLoaderã€‚
>
> å¦‚æœæœ‰ç¨‹åºç›´æ¥ä¾èµ–äº†è¿™ç§ç»§æ‰¿å…³ç³»ï¼Œæˆ–è€…ä¾èµ–äº† URLClassLoader ç±»çš„ç‰¹å®šæ–¹æ³•ï¼Œé‚£ä»£ç å¾ˆå¯èƒ½ä¼šåœ¨ JDK9åŠæ›´é«˜ç‰ˆæœ¬çš„ JDK ä¸­å´©æºƒã€‚

![](https://gitlab.com/eardh/picture/-/raw/main/jvm_img/202111021806794.png)




```java
public class ClassLoaderTest {
    public static void main(String[] args) {
        // è·å–ç³»ç»Ÿç±»åŠ è½½å™¨
        System.out.println(ClassLoader.getSystemClassLoader());
        // è·å–å¹³å°ç±»åŠ è½½å™¨
        System.out.println(ClassLoader.getPlatformClassLoader());
        // è·å–ç±»çš„åŠ è½½å™¨çš„åç§°
        System.out.println(ClassLoaderTest.class.getClassLoader().getName());
    }
}
```



3ã€åœ¨ Java 9 ä¸­ï¼Œç±»åŠ è½½å™¨æœ‰äº†åç§°ã€‚è¯¥åç§°åœ¨æ„é€ æ–¹æ³•ä¸­æŒ‡å®šï¼Œå¯ä»¥é€šè¿‡ getName() æ–¹æ³•æ¥è·å–ã€‚å¹³å°ç±»åŠ è½½å™¨çš„åç§°æ˜¯ Platformï¼Œåº”ç”¨ç±»åŠ è½½å™¨çš„åç§°æ˜¯ Appã€‚**ç±»åŠ è½½å™¨çš„åç§°åœ¨è°ƒè¯•ä¸ç±»åŠ è½½å™¨ç›¸å…³çš„é—®é¢˜æ—¶ä¼šéå¸¸æœ‰ç”¨ã€‚**



4ã€å¯åŠ¨ç±»åŠ è½½å™¨ç°åœ¨æ˜¯åœ¨jvmå†…éƒ¨å’Œjavaç±»åº“å…±åŒåä½œå®ç°çš„ç±»åŠ è½½å™¨ï¼ˆä»¥å‰æ˜¯ C++ å®ç°ï¼‰ï¼Œä½†ä¸ºäº†ä¸ä¹‹å‰ä»£ç å…¼å®¹ï¼Œåœ¨è·å–å¯åŠ¨ç±»åŠ è½½å™¨çš„åœºæ™¯ä¸­ä»ç„¶ä¼šè¿”å› nullï¼Œè€Œä¸ä¼šå¾—åˆ° BootClassLoader å®ä¾‹ã€‚



5ã€ç±»åŠ è½½çš„å§”æ´¾å…³ç³»ä¹Ÿå‘ç”Ÿäº†å˜åŠ¨ã€‚

> å½“å¹³å°åŠåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨æ”¶åˆ°ç±»åŠ è½½è¯·æ±‚ï¼Œåœ¨å§”æ´¾ç»™çˆ¶åŠ è½½å™¨åŠ è½½å‰ï¼Œè¦å…ˆåˆ¤æ–­è¯¥ç±»æ˜¯å¦èƒ½å¤Ÿå½’å±åˆ°æŸä¸€ä¸ªç³»ç»Ÿæ¨¡å—ä¸­ï¼Œå¦‚æœå¯ä»¥æ‰¾åˆ°è¿™æ ·çš„å½’å±å…³ç³»ï¼Œå°±è¦ä¼˜å…ˆå§”æ´¾ç»™è´Ÿè´£é‚£ä¸ªæ¨¡å—çš„åŠ è½½å™¨å®ŒæˆåŠ è½½ã€‚

![](https://gitlab.com/eardh/picture/-/raw/main/jvm_img/202111021806108.png)![](https://gitlab.com/eardh/picture/-/raw/main/jvm_img/202111021809868.png)

